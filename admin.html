<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin | La Vaca CR</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
  <script src="products.js"></script>
  <script src="categories.js"></script>
  <style>
    *, *::before, *::after { margin:0; padding:0; box-sizing:border-box; }
    :root {
      --rose: #c8364a;
      --rose-dark: #9f1239;
      --rose-pale: #fff1f2;
      --rose-border: rgba(200,54,74,0.2);
      --text: #1a1a1a;
      --muted: #4b5563;
      --border: #e5e7eb;
      --bg: #f9fafb;
      --white: #ffffff;
      --green: #16a34a;
      --red: #dc2626;
      --orange: #d97706;
      --radius: 10px;
      --shadow: 0 1px 4px rgba(0,0,0,0.08);
      --shadow-md: 0 4px 16px rgba(0,0,0,0.10);
    }
    html, body { height:100%; overflow:hidden; }
    body { font-family:'DM Sans',sans-serif; background:var(--bg); color:var(--text);
           display:flex; flex-direction:column; height:100vh; }

    /* ===== HEADER ===== */
    .admin-header {
      background:var(--white); border-bottom:1px solid var(--border);
      padding:0 32px; height:60px;
      display:flex; align-items:center; justify-content:space-between;
      flex-shrink:0; z-index:100;
      box-shadow:var(--shadow);
    }
    .admin-brand { display:flex; align-items:center; gap:12px; }
    .admin-brand-icon {
      width:36px; height:36px; background:var(--rose); border-radius:10px;
      display:flex; align-items:center; justify-content:center;
      font-size:1.1rem;
    }
    .admin-brand-text h2 { font-size:0.9rem; font-weight:700; color:var(--text); }
    .admin-brand-text span { font-size:0.72rem; color:var(--muted); }
    @media (max-width:480px) { .admin-brand-text span { display:none; } .btn-ver-tienda span { display:none; } }
    .header-actions { display:flex; align-items:center; gap:12px; }
    .btn-ver-tienda {
      display:flex; align-items:center; gap:6px;
      padding:7px 14px; border:1px solid var(--border); border-radius:8px;
      color:var(--muted); font-size:0.82rem; font-weight:500; text-decoration:none;
      background:var(--white); cursor:pointer; transition:all 0.2s;
    }
    .btn-ver-tienda:hover { border-color:var(--rose); color:var(--rose); }
    .btn-salir {
      display:flex; align-items:center; gap:6px;
      padding:7px 16px; background:#1a1a1a; border:none; border-radius:8px;
      color:#fff; font-size:0.82rem; font-weight:600; cursor:pointer;
      font-family:'DM Sans',sans-serif; transition:background 0.2s;
    }
    .btn-salir:hover { background:#333; }

    /* ===== STATS ===== */
    .stats-bar {
      display:grid; grid-template-columns:repeat(4,1fr);
      gap:16px; padding:24px 32px 16px;
      max-width:1200px; margin:0 auto;
      flex-shrink:0;
    }
    .stat-card {
      background:var(--white); border:1px solid var(--border);
      border-radius:var(--radius); padding:18px 20px;
      box-shadow:var(--shadow);
    }
    .stat-label { font-size:0.75rem; color:#374151; font-weight:600; margin-bottom:6px; }
    .stat-val { font-size:1.8rem; font-weight:700; color:var(--text); }
    .stat-val.green { color:var(--green); }
    .stat-val.red { color:var(--red); }
    .stat-val.rose { color:var(--rose); }

    /* ===== NAV TABS ===== */
    .nav-tabs {
      display:flex; gap:6px; padding:10px 16px;
      max-width:100%; margin:0 auto;
      flex-wrap:nowrap; overflow-x:auto;
      scrollbar-width:none; -ms-overflow-style:none;
      background:var(--bg);
      border-bottom:1px solid var(--border);
      box-shadow:0 2px 8px rgba(0,0,0,0.06);
      flex-shrink:0;
    }
    .nav-tabs::-webkit-scrollbar { display:none; }
    @media (max-width:768px) {
      .nav-tabs {
        flex-wrap:nowrap; overflow-x:auto; padding:8px 12px;
        scrollbar-width:none; -ms-overflow-style:none;
        top:60px;
      }
      .nav-tabs::-webkit-scrollbar { display:none; }
    }
    .nav-tab {
      display:flex; align-items:center;
      padding:8px 16px; border:1px solid var(--border);
      border-radius:8px; background:var(--white);
      color:#1a1a1a; font-size:0.82rem; font-weight:600;
      cursor:pointer; transition:all 0.2s;
      font-family:'DM Sans',sans-serif;
      white-space:nowrap;
    }
    .nav-tab:hover { border-color:var(--rose); background:var(--rose-pale); color:#1a1a1a; }
    .nav-tab.active { background:var(--rose); border-color:var(--rose); color:#fff; }

    /* ===== MAIN CONTENT ===== */
    .main-content {
      flex:1; overflow-y:auto; -webkit-overflow-scrolling:touch;
    }
    .main-panel {
      max-width:1200px; margin:0 auto;
      padding:16px 32px 80px;
    }
    .panel-card {
      background:var(--white); border:1px solid var(--border);
      border-radius:14px; padding:28px; box-shadow:var(--shadow);
      scroll-margin-top:130px;
    }
    .panel-title { font-size:1.1rem; font-weight:700; margin-bottom:22px; color:var(--text); }

    /* ===== FORMS ===== */
    .form-grid { display:grid; grid-template-columns:1fr 1fr; gap:16px; }
    .form-grid.full { grid-template-columns:1fr; }
    .form-group { display:flex; flex-direction:column; gap:6px; }
    .form-group.span2 { grid-column:span 2; }
    label { font-size:0.78rem; font-weight:600; color:var(--muted); text-transform:uppercase; letter-spacing:0.5px; }
    input[type=text], input[type=number], input[type=password], input[type=date], input[type=file], select, textarea {
      width:100%; padding:10px 14px;
      background:var(--white); border:1.5px solid var(--border);
      border-radius:8px; color:var(--text);
      font-family:'DM Sans',sans-serif; font-size:0.9rem;
      transition:border-color 0.2s; outline:none;
    }
    input:focus, select:focus, textarea:focus { border-color:var(--rose); }
    input[type=file] { padding:8px 12px; background:var(--bg); cursor:pointer; }
    .help-text { font-size:0.72rem; color:var(--muted); margin-top:3px; }
    .checkbox-row { display:flex; align-items:center; gap:10px; cursor:pointer; }
    .checkbox-row input { width:16px; height:16px; accent-color:var(--rose); cursor:pointer; }
    .checkbox-row span { font-size:0.87rem; font-weight:500; color:var(--text); }

    /* ===== BUTTONS ===== */
    .btn-primary {
      display:inline-flex; align-items:center; gap:8px;
      padding:11px 24px; background:var(--rose); color:#fff;
      border:none; border-radius:999px; font-size:0.87rem; font-weight:700;
      cursor:pointer; font-family:'DM Sans',sans-serif; transition:all 0.2s;
    }
    .btn-primary:hover { background:var(--rose-dark); transform:translateY(-1px); }
    .btn-primary:disabled { background:#ccc; cursor:not-allowed; transform:none; }
    .btn-secondary {
      display:inline-flex; align-items:center; gap:8px;
      padding:11px 24px; background:var(--white); color:var(--text);
      border:1.5px solid var(--border); border-radius:999px;
      font-size:0.87rem; font-weight:600; cursor:pointer;
      font-family:'DM Sans',sans-serif; transition:all 0.2s;
    }
    .btn-secondary:hover { border-color:var(--text); }
    .btn-danger {
      display:inline-flex; align-items:center; gap:8px;
      padding:11px 24px; background:#fff0f0; color:var(--red);
      border:1.5px solid #fecaca; border-radius:999px;
      font-size:0.87rem; font-weight:700; cursor:pointer;
      font-family:'DM Sans',sans-serif; transition:all 0.2s;
    }
    .btn-danger:hover { background:var(--red); color:#fff; border-color:var(--red); }
    .btn-search {
      display:inline-flex; align-items:center; gap:8px;
      padding:10px 20px; background:#1a1a1a; color:#fff;
      border:none; border-radius:8px;
      font-size:0.87rem; font-weight:600; cursor:pointer;
      font-family:'DM Sans',sans-serif; transition:background 0.2s;
    }
    .btn-search:hover { background:#333; }

    /* ===== SEARCH BAR ===== */
    .search-row { display:flex; gap:10px; align-items:center; margin-bottom:22px; }
    .search-input-wrap { position:relative; flex:1; max-width:360px; }
    .search-input-wrap svg { position:absolute; left:12px; top:50%; transform:translateY(-50%); color:var(--muted); }
    .search-input-wrap input { padding-left:38px; }

    /* ===== PRODUCT PREVIEW CARD ===== */
    .product-found {
      display:flex; align-items:center; gap:16px;
      padding:14px 18px; background:var(--bg);
      border:1.5px solid var(--border); border-radius:var(--radius);
      margin-bottom:22px;
    }
    .product-found img { width:60px; height:60px; object-fit:cover; border-radius:8px; background:#eee; }
    .product-found-info { flex:1; }
    .product-found-code { font-size:0.72rem; color:var(--muted); font-weight:600; text-transform:uppercase; }
    .product-found-name { font-size:0.95rem; font-weight:700; margin:2px 0; }
    .product-found-price { display:flex; align-items:center; gap:8px; }
    .price-new { color:var(--rose); font-weight:700; font-size:0.9rem; }
    .price-old { text-decoration:line-through; color:var(--muted); font-size:0.82rem; }
    .badge-discount { background:var(--rose-pale); color:var(--rose); font-size:0.7rem; font-weight:700; padding:2px 8px; border-radius:999px; }

    /* ===== EDIT SECTIONS (accordion style) ===== */
    .edit-section {
      border:1.5px solid var(--border); border-radius:var(--radius);
      margin-bottom:12px; overflow:hidden;
    }
    .edit-section-header {
      display:flex; align-items:center; justify-content:space-between;
      padding:14px 18px; cursor:pointer; background:var(--white);
      transition:background 0.2s; user-select:none;
    }
    .edit-section-header:hover { background:var(--bg); }
    .edit-section-title { display:flex; align-items:center; gap:10px; font-weight:600; font-size:0.9rem; }
    .edit-section-icon { font-size:1rem; }
    .edit-section-arrow { color:var(--muted); transition:transform 0.2s; font-size:0.8rem; }
    .edit-section-arrow.open { transform:rotate(180deg); }
    .edit-section-body { padding:18px; border-top:1px solid var(--border); display:none; }
    .edit-section-body.open { display:block; }

    /* ===== AGOTADO ===== */
    .agotado-badge {
      display:inline-flex; align-items:center; gap:6px;
      background:#fff0f0; color:var(--red);
      border:1px solid #fecaca; border-radius:999px;
      padding:5px 14px; font-size:0.78rem; font-weight:700;
      text-transform:uppercase; letter-spacing:1px;
    }
    .agotado-notice {
      margin-top:10px; padding:10px 14px;
      background:#fff0f0; border:1px solid #fecaca;
      border-radius:8px; font-size:0.8rem; color:#991b1b;
    }

    /* ===== CATEGORIES ===== */
    .cat-row {
      display:flex; align-items:center; justify-content:space-between;
      padding:12px 16px; border:1px solid var(--border); border-radius:8px;
      margin-bottom:8px; background:var(--white);
    }
    .cat-row-left { display:flex; align-items:center; gap:10px; }
    .cat-folder { color:var(--rose); font-size:1rem; }
    .cat-name { font-weight:600; font-size:0.9rem; }
    .cat-badge-visible { background:#dcfce7; color:var(--green); font-size:0.7rem; font-weight:700; padding:2px 10px; border-radius:999px; }
    .cat-badge-hidden { background:#f3f4f6; color:var(--muted); font-size:0.7rem; font-weight:700; padding:2px 10px; border-radius:999px; }
    .cat-actions { display:flex; gap:6px; align-items:center; }
    .cat-btn { padding:5px 10px; border:none; border-radius:6px; font-size:0.75rem; cursor:pointer; font-family:'DM Sans',sans-serif; font-weight:600; }
    .cat-btn-eye { background:var(--bg); color:var(--muted); border:1px solid var(--border); }
    .cat-btn-eye:hover { color:var(--rose); border-color:var(--rose); }
    .cat-btn-del { background:var(--bg); color:var(--muted); border:1px solid var(--border); }
    .cat-btn-del:hover { background:#fff0f0; color:var(--red); border-color:#fecaca; }
    .add-form-row { display:flex; gap:10px; margin-bottom:18px; align-items:flex-end; }
    .add-form-row input { flex:1; }
    .add-form-row .checkbox-row { white-space:nowrap; }

    /* ===== FOTO UPLOAD ===== */
    /* Layout producto: foto izq + campos der */
    .product-layout {
      display:grid; grid-template-columns:300px 1fr; gap:24px; align-items:start;
    }
    .foto-col { position:sticky; top:80px; }
    .foto-upload-area {
      border:2px dashed var(--border); border-radius:var(--radius);
      padding:16px; text-align:center; cursor:pointer;
      transition:border-color 0.2s; position:relative;
      aspect-ratio:4/5; display:flex; flex-direction:column;
      align-items:center; justify-content:center;
      background:var(--bg); overflow:hidden;
    }
    .foto-upload-area:hover { border-color:var(--rose); }
    .foto-upload-area input[type=file] { position:absolute; inset:0; opacity:0; cursor:pointer; width:100%; height:100%; }
    .foto-upload-icon { font-size:2rem; margin-bottom:8px; color:var(--muted); }
    .foto-upload-text { font-size:0.82rem; color:var(--muted); }
    .foto-preview {
      position:absolute; inset:0; width:100%; height:100%;
      object-fit:cover; border-radius:calc(var(--radius) - 2px); display:none;
    }
    .foto-current { width:80px; height:80px; object-fit:cover; border-radius:8px; border:1px solid var(--border); }
    @media (max-width:768px) {
      .product-layout { grid-template-columns:1fr; }
      .foto-col { position:static; }
      .foto-upload-area { aspect-ratio:4/3; }
    }

    /* ===== PORTADA ===== */
    .hero-current { width:100%; border-radius:var(--radius); margin-bottom:16px; max-height:180px; object-fit:cover; }
    .sort-item { display:flex; align-items:center; gap:10px; background:#fff; border:1.5px solid var(--border); border-radius:10px; padding:8px 12px; cursor:grab; user-select:none; transition:background .2s,box-shadow .2s; }
    .sort-item:active { cursor:grabbing; box-shadow:0 4px 16px rgba(0,0,0,.12); }
    .sort-handle { font-size:1.1rem; color:#d1d5db; flex-shrink:0; }

    /* ===== FOOTER INFO ===== */
    .footer-info-grid { display:grid; grid-template-columns:1fr 1fr; gap:16px; }
    .info-block {
      background:var(--bg); border:1px solid var(--border);
      border-radius:var(--radius); padding:18px;
    }
    .info-block-title { font-size:0.75rem; font-weight:700; text-transform:uppercase; letter-spacing:0.5px; color:var(--muted); margin-bottom:10px; }
    .info-tag {
      display:inline-flex; align-items:center; gap:6px;
      background:var(--white); border:1px solid var(--border);
      border-radius:6px; padding:6px 12px; margin:4px;
      font-size:0.82rem; color:var(--text);
    }
    .info-tag-remove { background:none; border:none; color:var(--muted); cursor:pointer; font-size:1rem; line-height:1; padding:0 2px; }
    .info-tag-remove:hover { color:var(--red); }

    /* ===== VENTAS ===== */
    .ventas-conn {
      display:flex; align-items:center; gap:10px;
      padding:12px 16px; background:var(--bg); border:1px solid var(--border);
      border-radius:var(--radius); margin-bottom:16px;
    }
    .ventas-dot { width:10px; height:10px; border-radius:50%; }
    .ventas-dot.on { background:#16a34a; box-shadow:0 0 6px #16a34a; }
    .ventas-dot.off { background:var(--red); }
    .ventas-status { font-size:0.85rem; color:var(--muted); }
    .btn-refresh { margin-left:auto; padding:6px 14px; background:var(--white); border:1px solid var(--border); border-radius:6px; color:var(--muted); cursor:pointer; font-size:0.8rem; font-family:'DM Sans',sans-serif; }
    .btn-refresh:hover { border-color:var(--rose); color:var(--rose); }
    .ventas-stats { display:grid; grid-template-columns:repeat(4,1fr); gap:12px; margin-bottom:18px; }
    .vstat { background:var(--white); border:1px solid var(--border); border-radius:var(--radius); padding:14px 16px; text-align:center; }
    .vstat-val { font-size:1.6rem; font-weight:700; }
    .vstat-label { font-size:0.72rem; color:var(--muted); margin-top:4px; }
    .vstat.yellow .vstat-val { color:var(--orange); }
    .vstat.blue .vstat-val { color:#2563eb; }
    .vstat.purple .vstat-val { color:#7c3aed; }
    .vstat.green .vstat-val { color:var(--green); }
    .ventas-filters { display:flex; gap:10px; margin-bottom:14px; flex-wrap:wrap; align-items:center; }
    .ventas-filters select, .ventas-filters input { padding:9px 12px; border-radius:8px; border:1.5px solid var(--border); background:var(--white); color:var(--text); font-family:'DM Sans',sans-serif; font-size:0.82rem; }
    .ventas-filters input { flex:1; min-width:150px; }
    .ventas-count { color:var(--muted); font-size:0.78rem; margin-left:auto; }
    .order-card { background:var(--white); border:1px solid var(--border); border-radius:var(--radius); padding:16px; margin-bottom:10px; }
    .order-card:hover { border-color:var(--rose-border); }
    .order-top { display:flex; justify-content:space-between; align-items:flex-start; gap:10px; flex-wrap:wrap; }
    .order-prod { font-weight:700; font-size:0.95rem; }
    .order-meta { font-size:0.78rem; color:var(--muted); margin-top:4px; line-height:1.5; }
    .order-total { font-size:1.2rem; font-weight:700; color:var(--green); }
    .order-shipping { font-size:0.72rem; color:var(--muted); }
    .status-pills { display:flex; gap:6px; margin:10px 0; flex-wrap:wrap; }
    .pill { padding:4px 10px; border-radius:20px; font-size:0.68rem; font-weight:700; border:1px solid; }
    .pill.done { opacity:1; }
    .pill.pending { opacity:0.3; }
    .pill-alistado    { background:rgba(217,119,6,0.1);  color:var(--orange); border-color:var(--orange); }
    .pill-en_transito { background:rgba(37,99,235,0.1);  color:#2563eb;       border-color:#2563eb; }
    .pill-entregado   { background:rgba(22,163,74,0.1);  color:var(--green);  border-color:var(--green); }
    .envio-fields { display:none; background:var(--bg); border:1.5px solid var(--border); border-radius:10px; padding:16px; margin-top:14px; }
    .envio-fields.show { display:block; }
    .envio-fields-title { font-size:0.68rem; font-weight:700; text-transform:uppercase; letter-spacing:1px; color:var(--muted); margin-bottom:12px; }
    .order-fields { display:grid; grid-template-columns:repeat(auto-fit,minmax(160px,1fr)); gap:10px; margin-top:10px; }
    .order-field { display:flex; flex-direction:column; gap:4px; }
    .order-field label { font-size:0.68rem; color:var(--muted); text-transform:uppercase; }
    .order-field input, .order-field select { padding:8px 10px; border-radius:6px; border:1px solid var(--border); background:var(--white); color:var(--text); font-family:'DM Sans',sans-serif; font-size:0.82rem; }
    .save-ok { color:var(--green); font-size:0.72rem; margin-left:8px; opacity:0; transition:opacity 0.3s; }
    .save-ok.show { opacity:1; }

    /* ===== MESSAGES ===== */
    .msg { padding:12px 16px; border-radius:8px; margin-bottom:16px; font-size:0.85rem; font-weight:500; }
    .msg.success { background:#f0fdf4; color:var(--green); border:1px solid #bbf7d0; }
    .msg.error { background:#fff0f0; color:var(--red); border:1px solid #fecaca; }

    /* ===== LOGIN ===== */
    .login-wrap { min-height:100vh; display:flex; align-items:center; justify-content:center; background:var(--bg); }
    .login-card { background:var(--white); border:1px solid var(--border); border-radius:16px; padding:40px 36px; width:100%; max-width:380px; box-shadow:var(--shadow-md); text-align:center; }
    .login-logo { width:50px; height:50px; background:var(--rose); border-radius:14px; display:inline-flex; align-items:center; justify-content:center; font-size:1.5rem; margin-bottom:16px; }
    .login-title { font-size:1.2rem; font-weight:700; margin-bottom:4px; }
    .login-sub { font-size:0.85rem; color:var(--muted); margin-bottom:24px; }

    /* ===== HIDDEN ===== */
    .hidden { display:none !important; }

    /* ===== RESPONSIVE ===== */
    @media (max-width:768px) {
      .stats-bar { grid-template-columns:repeat(2,1fr); padding:16px 16px 0; }
      .nav-tabs { padding:14px 16px 0; }
      .main-panel { padding:0 16px; }
      .form-grid { grid-template-columns:1fr; }
      .form-grid .form-group.span2 { grid-column:span 1; }
      .footer-info-grid { grid-template-columns:1fr; }
      .ventas-stats { grid-template-columns:repeat(2,1fr); }
      .admin-header { padding:0 16px; }
      .nav-tab { font-size:0.75rem; padding:7px 10px; }
      .nav-tab .tab-icon { font-size:0.8rem; }
    }
  </style>
</head>
<body>

<!-- ADMIN (sin login para panel de usuario) -->
<div id="adminWrap" style="display:flex;flex-direction:column;height:100vh;">

  <!-- Header -->
  <header class="admin-header">
    <div class="admin-brand">
      <div class="admin-brand-icon">üêÑ</div>
      <div class="admin-brand-text">
        <h2>Panel Administrativo</h2>
        <span>La Vaca CR</span>
      </div>
    </div>
    <div class="header-actions">
      <a href="index.html" target="_blank" class="btn-ver-tienda">
        üè™ <span>Ver Tienda</span>
      </a>

    </div>
  </header>

  <!-- Stats -->
  <div class="stats-bar" id="statsBar">
    <div class="stat-card"><div class="stat-label">Total Productos</div><div class="stat-val" id="statTotal">‚Äî</div></div>
    <div class="stat-card"><div class="stat-label">Disponibles</div><div class="stat-val green" id="statDisp">‚Äî</div></div>
    <div class="stat-card"><div class="stat-label">Agotados</div><div class="stat-val red" id="statAgot">‚Äî</div></div>
    <div class="stat-card"><div class="stat-label">Con Descuento</div><div class="stat-val rose" id="statDesc">‚Äî</div></div>
  </div>

  <!-- Nav Tabs -->
  <nav class="nav-tabs">
    <button class="nav-tab active" onclick="showTab('incluir',this)">Incluir Producto</button>
    <button class="nav-tab" onclick="showTab('ordenar',this)">Buscar Producto</button>
    <button class="nav-tab" onclick="showTab('categorias',this)">Categor√≠as</button>
    <button class="nav-tab" onclick="showTab('subcategorias',this)">Subcategor√≠as</button>
    <button class="nav-tab" onclick="showTab('portada',this)">Portada</button>
    <button class="nav-tab" onclick="showTab('footer',this)">Info Tienda</button>
    <button class="nav-tab" onclick="showTab('ventas',this)">üí∞ Ventas</button>
    <button class="nav-tab" onclick="showTab('contactos',this)">üë• Contactos</button>
    <button class="nav-tab" onclick="showTab('likes',this)">‚ù§Ô∏è Likes</button>
  </nav>

  <div class="main-content">
  <div class="main-panel">

    <!-- ===== INCLUIR PRODUCTO ===== -->
    <div id="seccion-incluir" class="panel-card">
      <div class="panel-title">Incluir Nuevo Producto</div>
      <div id="msgIncluir"></div>
      <form id="productForm" enctype="multipart/form-data">
        <div class="product-layout">

          <!-- Columna foto -->
          <div class="foto-col">
            <label style="display:block;margin-bottom:8px;">Foto del Producto</label>
            <div class="foto-upload-area" onclick="document.getElementById('foto').click()">
              <div class="foto-upload-icon">üì∑</div>
              <div class="foto-upload-text">Clic para subir foto</div>
              <input type="file" name="foto" id="foto" accept="image/*" required onchange="previewImg(this,'previewIncluir')" style="display:none">
              <img id="previewIncluir" class="foto-preview">
            </div>
          </div>

          <!-- Columna campos -->
          <div class="fields-col">
        <div class="form-grid">
          <div class="form-group">
            <label>C√≥digo *</label>
            <input type="text" name="codigo" id="codigo" placeholder="Ej: 117999" required>
          </div>
          <div class="form-group">
            <label>Nombre *</label>
            <input type="text" name="nombre" id="nombre" placeholder="Ej: Blusa Floral" required>
          </div>
          <div class="form-group">
            <label>Precio (‚Ç°) *</label>
            <input type="number" name="precio" id="precio" placeholder="15000" required>
          </div>
          <div class="form-group">
            <label>Descuento (%)</label>
            <input type="number" name="descuento" id="descuento" placeholder="0" value="0">
          </div>
          <div class="form-group">
            <label>Categor√≠a</label>
            <select id="catRoot" onchange="updateSubSelect('catRoot','categoria')"><option value="">Seleccionar...</option></select>
          </div>
          <div class="form-group">
            <label>Subcategor√≠a</label>
            <select name="categoria" id="categoria" required><option value="">Primero eleg√≠ categor√≠a</option></select>
          </div>
          <div class="form-group">
            <label>Tallas <span style="font-weight:400;text-transform:none">(separadas por coma)</span></label>
            <input type="text" name="tallas" id="tallas" placeholder="S, M, L, XL">
          </div>
          <div class="form-group">
            <label>Colores <span style="font-weight:400;text-transform:none">(separados por coma)</span></label>
            <input type="text" name="colores" id="colores" placeholder="Negro, Blanco, Rojo">
          </div>
          <div class="form-group span2">
            <label>Tama√±os <span style="font-weight:400;text-transform:none">(separados por coma)</span></label>
            <input type="text" name="tamanos" id="tamanos" placeholder="Peque√±o, Mediano, Grande">
          </div>
          <div class="form-group span2">
            <label class="checkbox-row">
              <input type="checkbox" name="mostrar_index" id="mostrar_index" value="1" checked>
              <span>Mostrar en p√°gina principal</span>
            </label>
          </div>
        </div>

        <div style="margin-top:20px;">
          <button type="submit" class="btn-primary" id="submitBtn">+ Agregar Producto</button>
        </div>
          </div><!-- /fields-col -->
        </div><!-- /product-layout -->
      </form>
    </div>

    <!-- ===== EDITAR PRODUCTO ===== -->
    <div id="seccion-categorias" class="panel-card" style="display:none;">
      <div class="panel-title">Gestionar Categor√≠as</div>
      <div id="msgCat"></div>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:18px;">
        <div class="form-group">
          <label>ID <span style="font-weight:400;text-transform:none">(ej: caballeros)</span></label>
          <input type="text" id="newRootId" placeholder="caballeros">
        </div>
        <div class="form-group">
          <label>Nombre <span style="font-weight:400;text-transform:none">(ej: CABALLEROS)</span></label>
          <input type="text" id="newRootName" placeholder="CABALLEROS">
        </div>
        <div class="form-group" style="align-self:center;padding-top:8px;">
          <label class="checkbox-row"><input type="checkbox" id="newRootShow" checked><span>Mostrar en inicio</span></label>
        </div>
        <div class="form-group">
          <button class="btn-primary" onclick="addRootCategory()" style="width:100%;justify-content:center;">+ Agregar Categor√≠a</button>
        </div>
      </div>
      <div id="categoriesList"></div>
    </div>

    <!-- ===== SUBCATEGOR√çAS ===== -->
    <div id="seccion-subcategorias" class="panel-card" style="display:none;">
      <div class="panel-title">Gestionar Subcategor√≠as</div>
      <div id="msgSub"></div>
      <div class="form-group" style="margin-bottom:18px;max-width:300px;">
        <label>Seleccionar categor√≠a</label>
        <select id="subRootSelect" onchange="renderSubsForRoot()"><option value="">Seleccionar...</option></select>
      </div>
      <div id="subsContainer" class="hidden">
        <div style="display:flex;gap:10px;margin-bottom:18px;align-items:flex-end;">
          <div class="form-group" style="flex:1">
            <label>Nueva subcategor√≠a</label>
            <input type="text" id="newSubName" placeholder="Ej: Blusas" onkeypress="if(event.key==='Enter')addSubFromTab()">
          </div>
          <button class="btn-primary" onclick="addSubFromTab()" style="flex-shrink:0;height:42px;">+ Agregar</button>
        </div>
        <div id="subsList"></div>
      </div>
    </div>

    <!-- ===== ORDENAR PRODUCTOS ===== -->
    <div id="seccion-ordenar" class="panel-card" style="display:none;">
      <div class="panel-title">üîç Buscar Producto</div>
      <div id="msgOrdenar"></div>

      <!-- Buscador -->
      <div class="search-row" style="margin-bottom:14px;">
        <div class="search-input-wrap">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.35-4.35"/></svg>
          <input type="text" id="sortSearchInput" placeholder="Buscar por nombre o c√≥digo..." onkeydown="if(event.key==='Enter'){runSortSearch();}" style="width:100%;">
        </div>
        <button class="btn-search" onclick="runSortSearch()">Buscar</button>
      </div>

      <p style="font-size:0.82rem;color:#4b5563;margin-bottom:12px;">Arrastr√° las tarjetas para cambiar el orden en el cat√°logo.</p>

      <div style="display:flex;gap:8px;margin-bottom:14px;flex-wrap:wrap;">
        <button class="btn-primary" onclick="saveOrder()" id="saveOrderBtn">üíæ Guardar Orden</button>
        <select id="ordenFiltro" onchange="filterSortList()" style="padding:8px 12px;border:1.5px solid var(--border);border-radius:8px;font-family:'DM Sans',sans-serif;font-size:0.82rem;background:#fff;color:#1a1a1a;">
          <option value="todos">Todos los productos</option>
          <option value="index">Solo los del inicio</option>
        </select>
      </div>

      <!-- Mensajes de edici√≥n (siempre visible) -->
      <div id="msgEditar" style="margin-bottom:8px;"></div>

      <!-- Formulario de edici√≥n (se muestra al presionar Editar) -->
      <div id="editFormWrap" style="display:none;margin-bottom:20px;background:var(--bg);border:1.5px solid var(--border);border-radius:12px;padding:18px;">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:14px;">
          <div style="font-weight:700;font-size:0.95rem;">‚úèÔ∏è Editando: <span id="editCardCode" style="color:var(--rose);"></span> ‚Äî <span id="editCardName" style="font-weight:400;"></span></div>
          <button onclick="closeEditForm()" style="background:none;border:none;font-size:1.3rem;cursor:pointer;color:#9ca3af;" title="Cerrar">‚úï</button>
        </div>
        <div class="product-layout">
          <div class="foto-col">
            <label style="display:block;margin-bottom:8px;">Foto del Producto</label>
            <div class="foto-upload-area" onclick="document.getElementById('editFoto').click()">
              <img id="editImage" class="foto-preview" style="display:block;" onerror="this.style.opacity='0.15'">
              <div class="foto-upload-text" style="font-size:0.75rem;margin-top:6px;">Clic para cambiar foto</div>
              <input type="file" id="editFoto" accept="image/*" onchange="previewImg(this,'editPreviewNew')" style="display:none">
              <img id="editPreviewNew" class="foto-preview" style="display:none;margin-top:8px;">
            </div>
          </div>
          <div class="fields-col">
            <div class="form-grid">
              <div class="form-group">
                <label>C√≥digo *</label>
                <input type="text" id="editCodigo" placeholder="Ej: 117365">
              </div>
              <div class="form-group">
                <label>Nombre *</label>
                <input type="text" id="editNombre" placeholder="Ej: Blusa Floral">
              </div>
              <div class="form-group">
                <label>Precio (‚Ç°) *</label>
                <input type="number" id="editPrecio" placeholder="15000">
              </div>
              <div class="form-group">
                <label>Descuento (%)</label>
                <input type="number" id="editDescuento" placeholder="0" value="0">
              </div>
              <div class="form-group">
                <label>Categor√≠a</label>
                <select id="editCatRoot" onchange="updateSubSelect('editCatRoot','editCategoria')"><option value="">Seleccionar...</option></select>
              </div>
              <div class="form-group">
                <label>Subcategor√≠a</label>
                <select id="editCategoria"><option value="">Primero eleg√≠ categor√≠a</option></select>
              </div>
              <div class="form-group">
                <label>Tallas <span style="font-weight:400;text-transform:none">(separadas por coma)</span></label>
                <input type="text" id="editTallas" placeholder="S, M, L, XL">
              </div>
              <div class="form-group">
                <label>Colores <span style="font-weight:400;text-transform:none">(separados por coma)</span></label>
                <input type="text" id="editColores" placeholder="Negro, Blanco, Rojo">
              </div>
              <div class="form-group span2">
                <label>Tama√±os <span style="font-weight:400;text-transform:none">(separados por coma)</span></label>
                <input type="text" id="editTamanos" placeholder="Peque√±o, Mediano, Grande">
              </div>
              <div class="form-group span2">
                <label class="checkbox-row">
                  <input type="checkbox" id="editIndex" value="1">
                  <span>Mostrar en p√°gina principal</span>
                </label>
              </div>
              <div class="form-group span2">
                <label class="checkbox-row">
                  <input type="checkbox" id="editAgotado" value="1" onchange="document.getElementById('agotadoNotice').classList.toggle('hidden',!this.checked)">
                  <span style="color:#dc2626;font-weight:600;">Marcar como AGOTADO</span>
                </label>
                <div id="agotadoNotice" class="hidden" style="margin-top:6px;padding:8px 12px;background:#fef2f2;border:1px solid #fca5a5;border-radius:8px;font-size:0.8rem;color:#dc2626;">‚ö†Ô∏è Este producto aparecer√° como agotado en la tienda.</div>
              </div>
            </div>
            <div style="display:flex;gap:8px;margin-top:16px;flex-wrap:wrap;">
              <button class="btn-primary" onclick="saveEditProduct()" id="saveEditBtn">üíæ Guardar Cambios</button>
              <button class="btn-danger" onclick="deleteFromEdit()">üóëÔ∏è Eliminar Producto</button>
            </div>
            <div id="msgEditarBottom" style="margin-top:10px;"></div>
          </div>
        </div>
      </div>

      <div id="editForm" class="hidden"></div>
      <input type="hidden" id="editSearchCode">
      <div id="sortList" style="display:flex;flex-direction:column;gap:6px;"></div>
    </div>

    <!-- ===== PORTADA ===== -->
    <div id="seccion-portada" class="panel-card" style="display:none;">
      <div class="panel-title">üñºÔ∏è Cambiar Portada (Hero Slider)</div>
      <div id="msgPortada"></div>
      <p style="font-size:0.82rem;color:#4b5563;margin-bottom:16px;">Proporci√≥n recomendada <strong>3:1</strong> (ej: 1500√ó500 px). Al seleccionar se sube autom√°ticamente.</p>

      <div style="display:flex;flex-direction:column;gap:10px;">

        <!-- Hero 1 -->
        <div style="display:flex;align-items:center;gap:12px;background:var(--bg);border:1.5px solid var(--border);border-radius:10px;padding:10px 12px;">
          <div style="flex-shrink:0;width:90px;height:50px;border-radius:6px;overflow:hidden;border:1px solid var(--border);background:#eee;">
            <img src="img/hero_1.webp" id="heroActual1" style="width:100%;height:100%;object-fit:cover;display:block;" alt="Hero 1" onerror="this.style.opacity='0.15'">
          </div>
          <div style="flex:1;min-width:0;">
            <div style="font-size:0.72rem;font-weight:700;color:var(--muted);text-transform:uppercase;letter-spacing:.5px;">Imagen 1</div>
            <div id="heroNombre1" style="font-size:0.75rem;color:#9ca3af;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:140px;">Sin imagen</div>
            <div id="heroStatus1" style="font-size:0.72rem;color:var(--green);display:none;">‚úì Guardada</div>
          </div>
          <label style="display:inline-flex;align-items:center;gap:5px;background:var(--rose);color:#fff;padding:8px 14px;border-radius:8px;font-size:0.8rem;font-weight:700;cursor:pointer;white-space:nowrap;flex-shrink:0;">
            üì§ Imagen 1
            <input type="file" accept="image/*" style="display:none" onchange="uploadHero(this,1)">
          </label>
        </div>

        <!-- Hero 2 -->
        <div style="display:flex;align-items:center;gap:12px;background:var(--bg);border:1.5px solid var(--border);border-radius:10px;padding:10px 12px;">
          <div style="flex-shrink:0;width:90px;height:50px;border-radius:6px;overflow:hidden;border:1px solid var(--border);background:#eee;">
            <img src="img/hero_2.webp" id="heroActual2" style="width:100%;height:100%;object-fit:cover;display:block;" alt="Hero 2" onerror="this.style.opacity='0.15'">
          </div>
          <div style="flex:1;min-width:0;">
            <div style="font-size:0.72rem;font-weight:700;color:var(--muted);text-transform:uppercase;letter-spacing:.5px;">Imagen 2</div>
            <div id="heroNombre2" style="font-size:0.75rem;color:#9ca3af;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:140px;">Sin imagen</div>
            <div id="heroStatus2" style="font-size:0.72rem;color:var(--green);display:none;">‚úì Guardada</div>
          </div>
          <label style="display:inline-flex;align-items:center;gap:5px;background:var(--rose);color:#fff;padding:8px 14px;border-radius:8px;font-size:0.8rem;font-weight:700;cursor:pointer;white-space:nowrap;flex-shrink:0;">
            üì§ Imagen 2
            <input type="file" accept="image/*" style="display:none" onchange="uploadHero(this,2)">
          </label>
        </div>

        <!-- Hero 3 -->
        <div style="display:flex;align-items:center;gap:12px;background:var(--bg);border:1.5px solid var(--border);border-radius:10px;padding:10px 12px;">
          <div style="flex-shrink:0;width:90px;height:50px;border-radius:6px;overflow:hidden;border:1px solid var(--border);background:#eee;">
            <img src="img/hero_3.webp" id="heroActual3" style="width:100%;height:100%;object-fit:cover;display:block;" alt="Hero 3" onerror="this.style.opacity='0.15'">
          </div>
          <div style="flex:1;min-width:0;">
            <div style="font-size:0.72rem;font-weight:700;color:var(--muted);text-transform:uppercase;letter-spacing:.5px;">Imagen 3</div>
            <div id="heroNombre3" style="font-size:0.75rem;color:#9ca3af;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:140px;">Sin imagen</div>
            <div id="heroStatus3" style="font-size:0.72rem;color:var(--green);display:none;">‚úì Guardada</div>
          </div>
          <label style="display:inline-flex;align-items:center;gap:5px;background:var(--rose);color:#fff;padding:8px 14px;border-radius:8px;font-size:0.8rem;font-weight:700;cursor:pointer;white-space:nowrap;flex-shrink:0;">
            üì§ Imagen 3
            <input type="file" accept="image/*" style="display:none" onchange="uploadHero(this,3)">
          </label>
        </div>

      </div>
    </div>

    <!-- ===== INFO TIENDA (FOOTER) ===== -->
    <div id="seccion-footer" class="panel-card" style="display:none;">
      <div class="panel-title">Informaci√≥n de la Tienda</div>
      <div id="msgFooter"></div>

      <div class="form-grid" style="margin-bottom:16px;">
        <div class="form-group span2">
          <label>Nombre de la Tienda</label>
          <input type="text" id="footerNombre" placeholder="La Vaca CR">
        </div>
        <div class="form-group">
          <label>N√∫mero WhatsApp <span style="font-weight:400;text-transform:none">(con c√≥digo de pa√≠s)</span></label>
          <input type="text" id="footerWA" placeholder="50663262291">
        </div>
        <div class="form-group">
          <label>Tel√©fono</label>
          <input type="text" id="footerTel" placeholder="2237-3335">
        </div>
        <div class="form-group span2">
          <label>Ubicaci√≥n</label>
          <input type="text" id="footerUbicacion" placeholder="Heredia centro, 200 sur de Correos de Costa Rica">
        </div>
        <div class="form-group span2">
          <label>Horario Lunes‚ÄìS√°bado</label>
          <input type="text" id="footerHorarioLS" placeholder="9:00 am ‚Äì 7:00 pm">
        </div>
        <div class="form-group span2">
          <label>Horario Domingo</label>
          <input type="text" id="footerHorarioDom" placeholder="10:00 am ‚Äì 6:00 pm">
        </div>
        <div class="form-group span2">
          <label>Mensaje o descripci√≥n corta</label>
          <input type="text" id="footerDesc" placeholder="Moda femenina de calidad en Heredia">
        </div>
      </div>

      <button class="btn-primary" onclick="saveFooterInfo()">üíæ Guardar Informaci√≥n</button>
      <p class="help-text" style="margin-top:10px;">Los cambios se aplican en el footer del sitio autom√°ticamente.</p>
    </div>

    <!-- ===== VENTA MANUAL ===== -->
    <div id="seccion-venta-manual" class="panel-card" style="display:none;">
      <div class="panel-title">‚úçÔ∏è Registrar Venta Manual</div>
      <div id="msgVentaManual"></div>
      <p style="font-size:0.85rem;color:#4b5563;margin-bottom:20px;">Registr√° una venta que se realiz√≥ fuera del bot de WhatsApp.</p>

      <!-- Datos del cliente -->
      <div style="font-size:0.68rem;font-weight:700;text-transform:uppercase;letter-spacing:1.5px;color:var(--muted);margin-bottom:10px;">üë§ Cliente</div>
      <div class="form-grid" style="margin-bottom:20px;">
        <div class="form-group">
          <label>Nombre del Cliente</label>
          <input type="text" id="vmNombre" placeholder="Ej: Mar√≠a Gonz√°lez">
        </div>
        <div class="form-group">
          <label>Tel√©fono</label>
          <input type="text" id="vmTelefono" placeholder="Ej: 8888-8888">
        </div>
        <div class="form-group">
          <label># Factura</label>
          <input type="text" id="vmFactura" placeholder="Ej: F-00123">
        </div>
        <div class="form-group">
          <label>Fecha Factura</label>
          <input type="date" id="vmFechaFactura">
        </div>
        <div class="form-group">
          <label>M√©todo de Entrega</label>
          <select id="vmMetodo" onchange="toggleEnvioFields()">
            <option value="recoger">üè™ Retiro en Tienda</option>
            <option value="envio">üì¶ Env√≠o a Domicilio</option>
          </select>
        </div>
        <div class="form-group">
          <label>M√©todo de Pago</label>
          <select id="vmPago">
            <option value="sinpe">SINPE M√≥vil</option>
            <option value="efectivo">Efectivo</option>
            <option value="tarjeta">Tarjeta</option>
            <option value="transferencia">Transferencia</option>
          </select>
        </div>
        <div class="form-group span2">
          <label>Notas</label>
          <input type="text" id="vmNotas" placeholder="Ej: Pago confirmado, entregar martes">
        </div>
      </div>

      <!-- Tabla de prendas -->
      <div style="font-size:0.68rem;font-weight:700;text-transform:uppercase;letter-spacing:1.5px;color:var(--muted);margin-bottom:10px;">üëï Prendas</div>
      <div style="overflow-x:auto;">
        <table id="vmPrendasTable" style="width:100%;border-collapse:collapse;font-size:0.82rem;margin-bottom:8px;">
          <thead>
            <tr style="background:var(--bg);border-bottom:2px solid var(--border);">
              <th style="padding:8px 10px;text-align:left;font-size:.68rem;color:var(--muted);font-weight:700;text-transform:uppercase;white-space:nowrap">C√≥digo</th>
              <th style="padding:8px 10px;text-align:left;font-size:.68rem;color:var(--muted);font-weight:700;text-transform:uppercase;">Descripci√≥n / Producto</th>
              <th style="padding:8px 10px;text-align:left;font-size:.68rem;color:var(--muted);font-weight:700;text-transform:uppercase;white-space:nowrap">Talla / Color</th>
              <th style="padding:8px 10px;text-align:center;font-size:.68rem;color:var(--muted);font-weight:700;text-transform:uppercase;">Cant.</th>
              <th style="padding:8px 10px;text-align:right;font-size:.68rem;color:var(--muted);font-weight:700;text-transform:uppercase;white-space:nowrap">Precio unit.</th>
              <th style="padding:8px 10px;text-align:right;font-size:.68rem;color:var(--muted);font-weight:700;text-transform:uppercase;">Subtotal</th>
              <th style="padding:8px 10px;width:30px;"></th>
            </tr>
          </thead>
          <tbody id="vmPrendasBody">
            <!-- filas din√°micas -->
          </tbody>
        </table>
      </div>
      <button class="btn-secondary" onclick="agregarPrenda()" style="font-size:0.8rem;padding:7px 14px;">+ Agregar prenda</button>

      <!-- Campos de env√≠o -->
      <div class="envio-fields" id="vmEnvioFields" style="margin-top:20px;">
        <div class="envio-fields-title">üì¶ Datos de Env√≠o a Domicilio</div>
        <div class="form-grid">
          <div class="form-group span2">
            <label>Direcci√≥n Exacta</label>
            <input type="text" id="vmDireccion" placeholder="Provincia, Cant√≥n, Distrito y se√±as exactas">
          </div>
          <div class="form-group">
            <label>Costo de Env√≠o (‚Ç°)</label>
            <input type="number" id="vmEnvioCosto" placeholder="2500" oninput="calcTotalManual()">
          </div>
          <div class="form-group">
            <label># Gu√≠a Correos CR</label>
            <input type="text" id="vmGuia" placeholder="Ej: 12345678CR">
          </div>
          <div class="form-group">
            <label>Estado del Env√≠o</label>
            <select id="vmEstadoEnvio">
              <option value="alistado">üü° Alistado</option>
              <option value="en_transito">üîµ En tr√°nsito</option>
              <option value="entregado">üü¢ Entregado</option>
            </select>
          </div>
          <div class="form-group">
            <label>Fecha Alistado</label>
            <input type="date" id="vmFechaAlistado">
          </div>
          <div class="form-group">
            <label>Fecha Env√≠o</label>
            <input type="date" id="vmFechaEnvio">
          </div>
          <div class="form-group">
            <label>Fecha Entregado</label>
            <input type="date" id="vmFechaEntregado">
          </div>
        </div>
      </div>

      <!-- Resumen de totales -->
      <div style="margin-top:16px;background:var(--bg);border:1.5px solid var(--border);border-radius:10px;overflow:hidden;">
        <div style="display:flex;justify-content:space-between;padding:10px 16px;border-bottom:1px solid var(--border);font-size:.82rem;">
          <span style="color:var(--muted)">Subtotal prendas</span>
          <span id="vmSubtotalDisplay" style="font-weight:600">‚Ç°0</span>
        </div>
        <div style="display:flex;justify-content:space-between;padding:10px 16px;border-bottom:1px solid var(--border);font-size:.82rem;" id="vmEnvioRow">
          <span style="color:var(--muted)">Costo env√≠o</span>
          <span id="vmEnvioDisplay" style="font-weight:600;color:#2563eb">‚Ç°0</span>
        </div>
        <div style="display:flex;justify-content:space-between;padding:12px 16px;font-size:1rem;">
          <span style="font-weight:700">TOTAL</span>
          <span id="vmTotalDisplay" style="font-weight:700;color:var(--green);font-size:1.3rem;">‚Ç°0</span>
        </div>
        <input type="hidden" id="vmTotal">
      </div>

      <div style="margin-top:16px;display:flex;gap:12px;align-items:center;flex-wrap:wrap;">
        <button class="btn-primary" onclick="registrarVentaManual()" style="background:var(--green);border-color:var(--green);">‚úÖ Registrar Venta</button>
        <button class="btn-secondary" onclick="limpiarVentaManual()">‚úï Limpiar</button>
      </div>
    </div>

    <!-- ===== VENTAS ===== -->
    <div id="seccion-ventas" class="panel-card" style="display:none;">
      <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:16px;flex-wrap:wrap;gap:8px;">
        <div class="panel-title" style="margin:0;">üí∞ Ventas</div>
        <div style="display:flex;gap:8px;align-items:center;">
          <span class="ventas-dot" id="ventasDot"></span>
          <span class="ventas-status" id="ventasStatus" style="font-size:.78rem;color:var(--muted);"></span>
          <button class="btn-refresh" onclick="loadVentas()">‚Üª Actualizar</button>
          <button onclick="toggleNuevaVenta()" id="btnNuevaVenta" style="background:var(--green);color:#fff;border:none;border-radius:8px;padding:7px 14px;font-size:0.82rem;font-weight:600;cursor:pointer;font-family:'DM Sans',sans-serif;">+ Nueva venta</button>
        </div>
      </div>

      <div class="ventas-stats" id="ventasStats">
        <div class="vstat yellow"><div class="vstat-val" id="statAlistado">‚Äî</div><div class="vstat-label">Alistado</div></div>
        <div class="vstat blue"><div class="vstat-val" id="statTransito">‚Äî</div><div class="vstat-label">En tr√°nsito</div></div>
        <div class="vstat green"><div class="vstat-val" id="statEntregado">‚Äî</div><div class="vstat-label">Entregado</div></div>
        <div class="vstat purple"><div class="vstat-val" id="statRetiro">‚Äî</div><div class="vstat-label">Retiros pend.</div></div>
      </div>

      <!-- Formulario nueva venta (colapsable) -->
      <div id="nuevaVentaForm" style="display:none;background:#f9fafb;border:1.5px solid var(--border);border-radius:10px;padding:18px;margin-bottom:16px;">
        <div style="font-size:.82rem;font-weight:700;margin-bottom:12px;color:var(--text);">‚úçÔ∏è Registrar Venta Manual</div>
        <div id="msgNuevaVenta"></div>
        <div style="display:flex;gap:8px;margin-bottom:12px;">
          <button id="nvtE" onclick="setNVMetodo('envio')" style="flex:1;padding:.5rem;border:2px solid var(--green);background:#f0fdf4;color:#166534;border-radius:8px;font-size:.82rem;font-weight:700;cursor:pointer;font-family:'DM Sans',sans-serif;">üì¶ Env√≠o</button>
          <button id="nvtR" onclick="setNVMetodo('recoger')" style="flex:1;padding:.5rem;border:2px solid var(--border);background:#fff;color:var(--muted);border-radius:8px;font-size:.82rem;font-weight:700;cursor:pointer;font-family:'DM Sans',sans-serif;">üè™ Retiro</button>
        </div>
        <div class="form-grid">
          <div class="form-group"><label>Nombre del Cliente</label><input type="text" id="nvNombre" placeholder="Ej: Mar√≠a Gonz√°lez"></div>
          <div class="form-group"><label>Tel√©fono</label><input type="text" id="nvTelefono" placeholder="Ej: 8888-8888"></div>
          <div class="form-group"><label>Producto *</label><input type="text" id="nvProducto" placeholder="Ej: Blusa Floral"></div>
          <div class="form-group"><label>Talla / Color</label><input type="text" id="nvTalla" placeholder="Ej: M, Negro"></div>
          <div class="form-group"><label>Precio (‚Ç°) *</label><input type="number" id="nvPrecio" placeholder="15000" oninput="calcNVTotal()"></div>
          <div class="form-group" id="nvEnvioDiv"><label>Costo Env√≠o (‚Ç°)</label><input type="number" id="nvEnvio" placeholder="2500" oninput="calcNVTotal()"></div>
          <div class="form-group" id="nvDirDiv" style="grid-column:1/-1;"><label>Direcci√≥n</label><input type="text" id="nvDireccion" placeholder="Provincia, Cant√≥n, se√±as..."></div>
          <div class="form-group"><label>Ref. SINPE</label><input type="text" id="nvSinpe" placeholder="Referencia"></div>
          <div class="form-group"><label>Notas</label><input type="text" id="nvNotas" placeholder="Notas internas"></div>
        </div>
        <div style="background:#fff;border:1px solid var(--border);border-radius:8px;padding:10px 14px;margin:10px 0;display:flex;justify-content:space-between;align-items:center;">
          <span style="font-size:.85rem;color:var(--muted);">Total</span>
          <span id="nvTotalDisplay" style="font-size:1.1rem;font-weight:700;color:var(--green);">‚Ç°0</span>
        </div>
        <div style="display:flex;gap:10px;margin-top:4px;">
          <button onclick="toggleNuevaVenta()" style="flex:1;padding:9px;border:1px solid var(--border);border-radius:8px;background:#fff;font-family:'DM Sans',sans-serif;font-size:.85rem;cursor:pointer;">Cancelar</button>
          <button onclick="guardarNuevaVenta()" style="flex:2;padding:9px;background:var(--green);color:#fff;border:none;border-radius:8px;font-family:'DM Sans',sans-serif;font-size:.85rem;font-weight:700;cursor:pointer;">‚úÖ Guardar venta</button>
        </div>
      </div>

      <div class="ventas-filters">
        <select id="ventasFilter" onchange="renderVentas()">
          <option value="all">Todos los estados</option>
          <option value="alistado">üü° Alistado</option>
          <option value="en_transito">üîµ En tr√°nsito</option>
          <option value="entregado">üü¢ Entregado</option>
        </select>
        <select id="ventasMethod" onchange="renderVentas()">
          <option value="all">Todos los m√©todos</option>
          <option value="envio">üì¶ Env√≠o</option>
          <option value="recoger">üè™ Retiro</option>
        </select>
        <input type="text" id="ventasSearch" placeholder="Buscar cliente/producto..." oninput="renderVentas()">
        <span class="ventas-count" id="ventasCount"></span>
      </div>
      <div id="ventasList"></div>
    </div>

    <!-- CONTACTOS -->
    <div id="seccion-contactos" class="panel-card" style="display:none;">
      <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:16px;flex-wrap:wrap;gap:8px;">
        <div class="panel-title" style="margin:0;">üë• Contactos</div>
        <div style="display:flex;gap:8px;align-items:center;">
          <span id="ctTotalLbl" style="font-size:.8rem;color:var(--muted);"></span>
          <button onclick="openAddContactAdmin()" style="background:var(--green);color:#fff;border:none;border-radius:8px;padding:7px 14px;font-size:.82rem;font-weight:600;cursor:pointer;font-family:'DM Sans',sans-serif;">+ Agregar</button>
        </div>
      </div>
      <div id="msgContactos"></div>
      <div style="background:#f9fafb;border:1px solid var(--border);border-radius:10px;padding:14px;margin-bottom:16px;">
        <div style="font-size:.72rem;font-weight:700;color:var(--muted);text-transform:uppercase;letter-spacing:.04em;margin-bottom:10px;">üèÜ Top 20 compradores</div>
        <div id="ctTopList"><div style="color:var(--muted);font-size:.82rem;">Cargando...</div></div>
      </div>
      <div style="display:flex;gap:8px;margin-bottom:12px;">
        <input type="text" id="ctSearch" placeholder="üîç Buscar contacto..." oninput="renderContactosAdmin()" style="flex:1;padding:8px 12px;border:1.5px solid var(--border);border-radius:8px;font-size:.85rem;font-family:'DM Sans',sans-serif;">
      </div>
      <div id="ctList"></div>
    </div>

    <!-- Modal contacto -->
    <div id="ctModal" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,.45);z-index:999;align-items:center;justify-content:center;">
      <div style="background:#fff;border-radius:14px;padding:24px;max-width:400px;width:92%;box-shadow:0 8px 32px rgba(0,0,0,.15);">
        <div id="ctModalTitle" style="font-size:1rem;font-weight:700;margin-bottom:14px;">üë§ Agregar Contacto</div>
        <input type="hidden" id="ctEditId">
        <div style="margin-bottom:10px;"><label style="font-size:.7rem;font-weight:700;color:var(--muted);text-transform:uppercase;display:block;margin-bottom:4px;">Nombre</label><input type="text" id="ctEditN" placeholder="Nombre completo" style="width:100%;padding:.6rem .8rem;border:1.5px solid var(--border);border-radius:8px;font-size:.9rem;font-family:'DM Sans',sans-serif;"></div>
        <div style="margin-bottom:10px;"><label style="font-size:.7rem;font-weight:700;color:var(--muted);text-transform:uppercase;display:block;margin-bottom:4px;">Tel√©fono / WhatsApp</label><input type="tel" id="ctEditTel" placeholder="50688881234" style="width:100%;padding:.6rem .8rem;border:1.5px solid var(--border);border-radius:8px;font-size:.9rem;font-family:'DM Sans',sans-serif;"></div>
        <div style="margin-bottom:10px;"><label style="font-size:.7rem;font-weight:700;color:var(--muted);text-transform:uppercase;display:block;margin-bottom:4px;">Notas</label><input type="text" id="ctEditNt" placeholder="Notas" style="width:100%;padding:.6rem .8rem;border:1.5px solid var(--border);border-radius:8px;font-size:.9rem;font-family:'DM Sans',sans-serif;"></div>
        <div style="margin-bottom:14px;display:flex;align-items:center;justify-content:space-between;padding:10px 12px;background:#fff8e1;border-radius:10px;border:1px solid #ffe082;">
          <div><div style="font-size:.85rem;font-weight:700;color:#f57f17;">ü§ñ Solo modo humano</div><div style="font-size:.72rem;color:#9ca3af;">El bot no responde a este contacto</div></div>
          <label style="position:relative;display:inline-block;width:44px;height:24px;cursor:pointer;flex-shrink:0;">
            <input type="checkbox" id="ctEditBotDisabled" style="opacity:0;width:0;height:0;" onchange="toggleBDSlider(this.checked)">
            <span id="ctBDSlider" style="position:absolute;inset:0;background:#ccc;border-radius:24px;transition:.3s;"></span>
            <span id="ctBDThumb" style="position:absolute;left:3px;top:3px;width:18px;height:18px;background:#fff;border-radius:50%;transition:.3s;"></span>
          </label>
        </div>
        <div style="display:flex;gap:8px;">
          <button onclick="closeAddContactAdmin()" style="flex:1;padding:.75rem;border:1px solid var(--border);border-radius:8px;background:#fff;font-family:'DM Sans',sans-serif;cursor:pointer;">Cancelar</button>
          <button onclick="saveContactAdmin()" style="flex:2;padding:.75rem;background:var(--green);color:#fff;border:none;border-radius:8px;font-weight:700;font-family:'DM Sans',sans-serif;cursor:pointer;">üíæ Guardar</button>
        </div>
      </div>
    </div>

    <div id="seccion-likes" class="panel-card" style="display:none;">
      <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:4px;">
        <h2 style="font-family:'Playfair Display',serif;font-size:1.2rem;color:var(--rose);margin:0;">‚ù§Ô∏è Estad√≠sticas de Likes</h2>
        <button onclick="loadLikesStats()" style="background:var(--rose);color:#fff;border:none;border-radius:8px;padding:7px 16px;font-size:0.8rem;font-weight:600;cursor:pointer;">‚Üª Actualizar</button>
      </div>
      <p style="font-size:0.82rem;color:var(--muted);margin-bottom:20px;">Productos m√°s y menos gustados por los clientes</p>
      <div id="msgLikes" style="margin-bottom:12px;"></div>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:20px;">
        <div>
          <div style="font-weight:700;font-size:0.88rem;color:#dc2626;margin-bottom:12px;">üî• Top 20 ‚Äî M√°s gustados</div>
          <div id="likesTop" style="display:flex;flex-direction:column;gap:8px;"></div>
        </div>
        <div>
          <div style="font-weight:700;font-size:0.88rem;color:var(--muted);margin-bottom:12px;">üìâ Bottom 20 ‚Äî Menos gustados</div>
          <div id="likesBottom" style="display:flex;flex-direction:column;gap:8px;"></div>
        </div>
      </div>

      <!-- Todos los productos ordenados por likes -->
      <div style="margin-top:28px;">
        <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:12px;">
          <div style="font-weight:700;font-size:0.88rem;color:var(--text);">üìã Todos los productos ‚Äî ordenados por likes</div>
          <div style="display:flex;gap:8px;align-items:center;">
            <input type="text" id="likesAllSearch" placeholder="Buscar..." oninput="filterLikesAll()" style="padding:6px 12px;border:1.5px solid var(--border);border-radius:8px;font-size:0.8rem;font-family:'DM Sans',sans-serif;width:160px;">
            <select id="likesAllSort" onchange="filterLikesAll()" style="padding:6px 10px;border:1.5px solid var(--border);border-radius:8px;font-size:0.8rem;font-family:'DM Sans',sans-serif;">
              <option value="desc">Mayor a menor</option>
              <option value="asc">Menor a mayor</option>
            </select>
          </div>
        </div>
        <div id="likesAll" style="display:flex;flex-direction:column;gap:6px;"></div>
      </div>
    </div>

  </div><!-- /main-panel -->

  <!-- ===== MODAL CONTACTO ===== -->
  <div id="modalContacto" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,0.5);z-index:999;align-items:center;justify-content:center;" onclick="if(event.target===this)cerrarModalContacto()">
    <div style="background:#fff;border-radius:16px;padding:1.5rem;width:92%;max-width:400px;position:relative;">
      <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:1rem;">
        <div id="tituloModalContacto" style="font-size:1rem;font-weight:700;">üë§ Contacto</div>
        <button onclick="cerrarModalContacto()" style="background:none;border:none;font-size:1.3rem;cursor:pointer;">‚úï</button>
      </div>
      <input type="hidden" id="ctEditId">
      <div style="margin-bottom:10px;"><label style="font-size:.68rem;font-weight:700;color:#6b7280;text-transform:uppercase;">Nombre</label><input id="ctNombre" type="text" placeholder="Nombre completo" style="width:100%;padding:.55rem .75rem;border:1.5px solid #e5e7eb;border-radius:10px;font-size:.9rem;font-family:'DM Sans',sans-serif;margin-top:2px;background:#fafafa;"></div>
      <div style="margin-bottom:10px;"><label style="font-size:.68rem;font-weight:700;color:#6b7280;text-transform:uppercase;">Tel√©fono / WhatsApp</label><input id="ctTelefono" type="tel" placeholder="50688881234" inputmode="numeric" style="width:100%;padding:.55rem .75rem;border:1.5px solid #e5e7eb;border-radius:10px;font-size:.9rem;font-family:'DM Sans',sans-serif;margin-top:2px;background:#fafafa;"></div>
      <div style="margin-bottom:14px;"><label style="font-size:.68rem;font-weight:700;color:#6b7280;text-transform:uppercase;">Notas</label><input id="ctNotas" type="text" placeholder="Notas" style="width:100%;padding:.55rem .75rem;border:1.5px solid #e5e7eb;border-radius:10px;font-size:.9rem;font-family:'DM Sans',sans-serif;margin-top:2px;background:#fafafa;"></div>
      <div style="display:flex;gap:10px;">
        <button onclick="cerrarModalContacto()" style="flex:1;padding:.75rem;background:#f3f4f6;border:none;border-radius:10px;cursor:pointer;font-family:'DM Sans',sans-serif;">Cancelar</button>
        <button onclick="guardarContacto()" style="flex:2;padding:.75rem;background:var(--green);color:#fff;border:none;border-radius:10px;font-weight:700;cursor:pointer;font-family:'DM Sans',sans-serif;">üíæ Guardar</button>
      </div>
    </div>
  </div>
  </div><!-- /main-content -->
</div><!-- /adminWrap -->

<script>
  const PASS = "2002";
  var allCategories = [];
  var editingCode = "";

  // ===== INIT (sin login) =====
  function logout() { /* sin acci√≥n en panel de usuario */ }

  // ===== TABS =====
  // Secciones disponibles
  var SECCIONES = ['incluir','ordenar','categorias','subcategorias','portada','footer','ventas','contactos','likes'];

  var currentTab = 'incluir';

  function showTab(name, el, fromPopState) {
    // 1. Marcar bot√≥n activo
    document.querySelectorAll('.nav-tab').forEach(function(t) { t.classList.remove('active'); });
    if (el) {
      var btn = el;
      while (btn && !btn.classList.contains('nav-tab')) btn = btn.parentElement;
      if (btn) btn.classList.add('active');
    } else {
      document.querySelectorAll('.nav-tab').forEach(function(t) {
        if ((t.getAttribute('onclick') || '').includes("'" + name + "'")) t.classList.add('active');
      });
    }

    // 2. Ocultar todas las secciones
    SECCIONES.forEach(function(s) {
      var sec = document.getElementById('seccion-' + s);
      if (sec) sec.style.display = 'none';
    });

    // 3. Mostrar secci√≥n pedida
    var target = document.getElementById('seccion-' + name);
    if (target) target.style.display = 'block';

    if (name === 'ventas') loadVentas();
    if (name === 'contactos') loadContactosAdmin();
    if (name === 'ordenar') renderSortList();

    // 4. Manejo de historial
    if (!fromPopState) {
      try { history.pushState({ tab: name }, '', '#' + name); } catch(e) {}
    }
    currentTab = name;
  }

  // Bot√≥n atr√°s: navegar entre secciones, no salir
  window.addEventListener('popstate', function(e) {
    if (e.state && e.state.tab) {
      showTab(e.state.tab, null, true);
    } else {
      // No hay m√°s historial interno ‚Äî preguntar si desea salir
      if (confirm('¬øSeguro que desea salir del panel de administraci√≥n?')) {
        history.go(-1);
      } else {
        try { history.pushState({ tab: currentTab }, '', '#' + currentTab); } catch(e) {}
      }
    }
  });

  // Confirmar al cerrar pesta√±a o navegar fuera
  window.addEventListener('beforeunload', function(e) {
    e.preventDefault();
    e.returnValue = '';
  });

  // ===== UTILS =====
  function showMsg(id, text, type) {
    var el = document.getElementById(id);
    if (!el) return;
    el.innerHTML = '<div class="msg ' + type + '">' + text + '</div>';
    setTimeout(() => { el.innerHTML = ''; }, 5000);
  }
  function previewImg(input, previewId) {
    var preview = document.getElementById(previewId);
    if (input.files && input.files[0]) {
      var reader = new FileReader();
      reader.onload = function(e) { preview.src = e.target.result; preview.style.display = 'block'; };
      reader.readAsDataURL(input.files[0]);
    }
  }
  function previewImgEdit(input) {
    if (input.files && input.files[0]) {
      var reader = new FileReader();
      reader.onload = function(e) {
        document.getElementById('editImage').src = e.target.result;
        var big = document.getElementById('editImageBig');
        if (big) { big.src = e.target.result; }
        var prev = document.getElementById('editPreviewNew');
        if (prev) { prev.src = e.target.result; prev.style.display = 'block'; }
      };
      reader.readAsDataURL(input.files[0]);
    }
  }
  function toggleSection(header) {
    var body = header.nextElementSibling;
    var arrow = header.querySelector('.edit-section-arrow');
    var isOpen = body.classList.contains('open');
    body.classList.toggle('open', !isOpen);
    arrow.classList.toggle('open', !isOpen);
  }
  function toggleAgotado(cb) {
    document.getElementById('agotadoNotice').classList.toggle('hidden', !cb.checked);
  }

  // ===== STATS ‚Äî obtenidas desde admin.php, con fallback a products.js =====
  async function loadLikesStats() {
    var topEl    = document.getElementById('likesTop');
    var botEl    = document.getElementById('likesBottom');
    var msgEl    = document.getElementById('msgLikes');
    topEl.innerHTML = '<div style="color:var(--muted);font-size:0.82rem;">‚è≥ Cargando...</div>';
    botEl.innerHTML = '';
    if (msgEl) msgEl.innerHTML = '';
    try {
      var r = await fetch('admin.php?action=likes_stats&pass=' + PASS);
      var d = await r.json();
      if (!d.success) { if(msgEl) msgEl.innerHTML = '<div class="msg error">' + (d.error||'Error') + '</div>'; return; }

      // Read product names from PRODUCTS global if available via products.js
      var nameMap = {};
      try {
        var pr = await fetch('products.js?v=' + Date.now());
        var pt = await pr.text();
        var pm = pt.match(/\["([^"]+)",\s*"([^"]+)"/g);
        if (pm) pm.forEach(function(m) {
          var parts = m.match(/\["([^"]+)",\s*"([^"]+)"/);
          if (parts) nameMap[parts[1].replace(/_[B-Z]$/, '')] = parts[2];
        });
      } catch(ex) {}

      function renderList(el, obj, isTop) {
        var entries = Object.entries(obj);
        entries.sort(function(a, b) { return isTop ? b[1] - a[1] : a[1] - b[1]; });
        if (isTop && entries.length === 0) {
          el.innerHTML = '<div style="color:var(--muted);font-size:0.82rem;padding:12px;">A√∫n no hay likes ‚Äî aparecer√°n aqu√≠ cuando las clientas comiencen a dar ‚ù§Ô∏è</div>';
          return;
        }
        if (entries.length === 0) {
          el.innerHTML = '<div style="color:var(--muted);font-size:0.82rem;padding:12px;">Sin datos a√∫n</div>';
          return;
        }
        el.innerHTML = entries.map(function(e, i) {
          var codigo     = e[0];
          var count      = e[1];
          var codigoBase = codigo.replace(/_[B-Z]$/, '');
          var nombre     = nameMap[codigoBase] || nameMap[codigo] || codigo;
          var medal      = isTop ? (i===0 ? 'ü•á' : i===1 ? 'ü•à' : i===2 ? 'ü•â' : '') : '';
          var countColor = count === 0 ? '#9ca3af' : '#6b1225';
          return '<div style="display:flex;align-items:center;gap:10px;padding:8px 12px;background:#fff;border:1.5px solid var(--border);border-radius:9px;">'
            + '<img src="img/' + codigoBase + '.webp" onerror="this.style.opacity=0.15" style="width:42px;height:42px;object-fit:cover;border-radius:6px;flex-shrink:0;">'
            + '<div style="flex:1;min-width:0;">'
              + '<div style="font-size:0.8rem;font-weight:600;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">' + medal + ' ' + nombre + '</div>'
              + '<div style="font-size:0.72rem;color:var(--muted);">C√≥digo: ' + codigoBase + '</div>'
            + '</div>'
            + '<div style="display:flex;align-items:center;gap:4px;flex-shrink:0;">'
              + '<svg viewBox="0 0 24 24" width="14" height="14" fill="' + countColor + '"><path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"/></svg>'
              + '<span style="font-size:0.88rem;font-weight:800;color:' + countColor + ';">' + count + '</span>'
            + '</div>'
          + '</div>';
        }).join('');
      }

      renderList(topEl, d.top, true);
      renderList(botEl, d.bottom, false);

      // Render full list
      window._likesAllData = { all: d.all, nameMap: nameMap, maxCount: d.maxCount || 0 };
      filterLikesAll();
    } catch(e) {
      if(msgEl) msgEl.innerHTML = '<div class="msg error">Error: ' + e.message + '</div>';
    }
  }

  function filterLikesAll() {
    var allEl  = document.getElementById('likesAll');
    if (!allEl || !window._likesAllData) return;
    var query  = (document.getElementById('likesAllSearch') ? document.getElementById('likesAllSearch').value.toLowerCase().trim() : '');
    var sort   = document.getElementById('likesAllSort') ? document.getElementById('likesAllSort').value : 'desc';
    var nameMap = window._likesAllData.nameMap || {};
    var entries = Object.entries(window._likesAllData.all || {});
    // Sort
    entries.sort(function(a, b) { return sort === 'desc' ? b[1] - a[1] : a[1] - b[1]; });
    // Filter
    if (query) {
      entries = entries.filter(function(e) {
        var cb = e[0].replace(/_[B-Z]$/, '');
        var nm = (nameMap[cb] || nameMap[e[0]] || e[0]).toLowerCase();
        return nm.includes(query) || cb.includes(query);
      });
    }
    if (entries.length === 0) { allEl.innerHTML = '<div style="color:var(--muted);font-size:0.82rem;padding:12px;">Sin resultados</div>'; return; }
    allEl.innerHTML = entries.map(function(e, i) {
      var codigo = e[0];
      var count  = e[1];
      var codigoBase = codigo.replace(/_[B-Z]$/, '');
      var nombre = nameMap[codigoBase] || nameMap[codigo] || codigo;
      var barPct = window._likesAllData.maxCount > 0 ? Math.round((count / window._likesAllData.maxCount) * 100) : 0;
      return '<div style="display:flex;align-items:center;gap:10px;padding:8px 12px;background:#fff;border:1.5px solid var(--border);border-radius:9px;">' +
        '<span style="font-size:0.72rem;color:var(--muted);width:22px;text-align:right;flex-shrink:0;">' + (i+1) + '</span>' +
        '<img src="img/' + codigoBase + '.webp" onerror="this.style.opacity=0.15" style="width:38px;height:38px;object-fit:cover;border-radius:6px;flex-shrink:0;">' +
        '<div style="flex:1;min-width:0;">' +
          '<div style="font-size:0.8rem;font-weight:600;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">' + nombre + '</div>' +
          '<div style="font-size:0.7rem;color:var(--muted);margin-top:2px;">' +
            '<div style="height:5px;background:#f3e8eb;border-radius:3px;margin-top:3px;">' +
              '<div style="height:5px;background:#6b1225;border-radius:3px;width:' + barPct + '%;transition:width 0.4s;"></div>' +
            '</div>' +
          '</div>' +
        '</div>' +
        '<div style="display:flex;align-items:center;gap:4px;flex-shrink:0;">' +
          '<svg viewBox="0 0 24 24" width="13" height="13" fill="#6b1225"><path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"/></svg>' +
          '<span style="font-size:0.88rem;font-weight:800;color:#6b1225;">' + count + '</span>' +
        '</div>' +
      '</div>';
    }).join('');
  }

  async function loadStats() {
    try {
      var r = await fetch("admin.php?action=stats&pass=" + PASS);
      if (!r.ok) throw new Error("HTTP " + r.status);
      var d = await r.json();
      if (d.success) {
        document.getElementById('statTotal').textContent = d.total ?? '‚Äî';
        document.getElementById('statDisp').textContent = d.disponibles ?? '‚Äî';
        document.getElementById('statAgot').textContent = d.agotados ?? '‚Äî';
        document.getElementById('statDesc').textContent = d.descuentos ?? '‚Äî';
        return;
      }
    } catch(e) {}
    // Fallback: leer products.js directamente
    try {
      var r2 = await fetch('products.js');
      var text = await r2.text();
      var match = text.match(/(?:const|var|let)\s+PRODUCT(?:OS|S)\s*=\s*(\[[\s\S]*?\]);/);
      if (match) {
        var arr = JSON.parse(match[1]);
        var total = arr.length;
        // Cada item es array: [codigo, nombre, precio, descuento, showIndex, categoria, tallas, colores, tamanos, agotado]
        var agotados   = arr.filter(function(p){ return Array.isArray(p) ? (p[9]||0)==1 : p.agotado==1; }).length;
        var descuentos = arr.filter(function(p){ return Array.isArray(p) ? (p[3]||0)>0  : (p.descuento||0)>0; }).length;
        document.getElementById('statTotal').textContent = total;
        document.getElementById('statDisp').textContent = total - agotados;
        document.getElementById('statAgot').textContent = agotados;
        document.getElementById('statDesc').textContent = descuentos;
      }
    } catch(e2) {
      // √öltimo intento: usar la variable global si ya carg√≥
      var _prods = (typeof PRODUCTS !== 'undefined') ? PRODUCTS : (typeof PRODUCTOS !== 'undefined') ? PRODUCTOS : null;
      if (_prods) {
        var total = _prods.length;
        var agotados   = _prods.filter(function(p){ return Array.isArray(p) ? (p[9]||0)==1 : p.agotado==1; }).length;
        var descuentos = _prods.filter(function(p){ return Array.isArray(p) ? (p[3]||0)>0  : (p.descuento||0)>0; }).length;
        document.getElementById('statTotal').textContent = total;
        document.getElementById('statDisp').textContent = total - agotados;
        document.getElementById('statAgot').textContent = agotados;
        document.getElementById('statDesc').textContent = descuentos;
      }
    }
  }

  // ===== INCLUIR PRODUCTO =====
  document.getElementById("productForm").addEventListener("submit", async function(e) {
    e.preventDefault();
    var btn = document.getElementById("submitBtn");
    btn.disabled = true; btn.textContent = "Guardando...";
    var formData = new FormData(this);
    formData.append("pass", PASS);
    formData.append("action", "product");
    try {
      var r = await fetch("admin.php", { method:"POST", body:formData });
      var d = await r.json();
      if (d.success) {
        showMsg("msgIncluir", "‚úÖ Producto agregado correctamente", "success");
        this.reset();
        document.getElementById("previewIncluir").style.display = "none";
        document.getElementById("mostrar_index").checked = true;
        loadStats();
      } else { showMsg("msgIncluir", d.error || "Error al guardar", "error"); }
    } catch(e) { showMsg("msgIncluir", "Error de conexi√≥n", "error"); }
    btn.disabled = false; btn.textContent = "+ Agregar Producto";
  });

  // ===== EDITAR PRODUCTO =====
  async function searchEditProduct() {
    var code = document.getElementById("editSearchCode").value.trim();
    if (!code) { alert("Ingres√° un c√≥digo"); return; }
    var codeBase = code.replace(/_[B-Z]$/, '');
    try {
      var r = await fetch("admin.php?action=search_variants&codigo=" + encodeURIComponent(codeBase) + "&pass=" + PASS);
      var d = await r.json();
      if (d.success && d.variants && d.variants.length > 0) {
        if (d.variants.length === 1) {
          loadProductToEdit(d.variants[0]);
        } else {
          showVariantSelector(d.variants);
        }
      } else {
        showMsg("msgEditar", d.error || "Producto no encontrado", "error");
        document.getElementById("editForm").classList.add("hidden");
        var sel = document.getElementById("variantSelector");
        if (sel) sel.style.display = "none";
      }
    } catch(e) { showMsg("msgEditar", "Error de conexi√≥n", "error"); }
  }

  function showVariantSelector(variants) {
    document.getElementById("editForm").classList.add("hidden");
    var sel = document.getElementById("variantSelector");
    if (!sel) {
      sel = document.createElement("div");
      sel.id = "variantSelector";
      document.getElementById("editForm").parentNode.insertBefore(sel, document.getElementById("editForm"));
    }
    sel.style.display = "block";
    sel.innerHTML = '<div style="font-size:0.8rem;font-weight:700;color:var(--muted);text-transform:uppercase;letter-spacing:.5px;margin-bottom:10px;">Se encontraron ' + variants.length + ' variantes ‚Äî seleccion√° cu√°l editar:</div>' +
      variants.map(function(v) {
        var codigoDisplay = v.codigo.replace(/_[B-Z]$/, '');
        return '<div style="display:flex;align-items:center;gap:12px;background:var(--bg);border:1.5px solid var(--border);border-radius:10px;padding:10px 14px;margin-bottom:8px;cursor:pointer;" onclick="loadProductToEdit(' + JSON.stringify(v).replace(/"/g,'&quot;') + ')">' +
          '<img src="img/' + v.codigo + '.webp" style="width:56px;height:56px;object-fit:cover;border-radius:6px;border:1px solid var(--border);flex-shrink:0;" onerror="this.style.opacity=0.2">' +
          '<div style="flex:1;min-width:0;">' +
            '<div style="font-weight:700;font-size:0.88rem;">' + v.nombre + '</div>' +
            '<div style="font-size:0.75rem;color:var(--muted);">C√≥digo: ' + codigoDisplay + (v.codigo !== codigoDisplay ? ' <span style="color:#9ca3af">(' + v.codigo + ')</span>' : '') + '</div>' +
            '<div style="font-size:0.75rem;color:var(--muted);">‚Ç°' + Number(v.precio).toLocaleString() + (v.descuento ? ' ¬∑ -' + v.descuento + '%' : '') + '</div>' +
          '</div>' +
          '<div style="color:var(--rose);font-size:1.2rem;">‚Ä∫</div>' +
        '</div>';
      }).join('');
  }

  function loadProductToEdit(p) {
    var sel = document.getElementById("variantSelector");
    if (sel) sel.style.display = "none";
    editingCode = p.codigo;
    document.getElementById("editImage").src = "img/" + p.codigo + ".webp?" + Date.now();
    var big = document.getElementById("editImageBig");
    if (big) big.src = "img/" + p.codigo + ".webp?" + Date.now();
    var codigoDisplay = p.codigo.replace(/_[B-Z]$/, '');
    document.getElementById("editCardCode").textContent = codigoDisplay;
    document.getElementById("editCardName").textContent = p.nombre;
    document.getElementById("editCodigo").value = p.codigo;
    document.getElementById("editNombre").value = p.nombre;
    document.getElementById("editPrecio").value = p.precio;
    document.getElementById("editDescuento").value = p.descuento;
    document.getElementById("editTallas").value = p.tallas || "";
    document.getElementById("editColores").value = p.colores || "";
    document.getElementById("editTamanos").value = p.tamanos || "";
    document.getElementById("editIndex").checked = p.showIndex == 1;
    var isAgotado = p.agotado == 1;
    document.getElementById("editAgotado").checked = isAgotado;
    document.getElementById("agotadoNotice").classList.toggle("hidden", !isAgotado);
    var foundRoot = "";
    for (var i = 0; i < allCategories.length; i++) {
      var cat = allCategories[i];
      for (var j = 0; j < cat.subs.length; j++) {
        if (cat.subs[j].id === p.categoria) { foundRoot = cat.id; break; }
      }
      if (foundRoot) break;
    }
    document.getElementById("editCatRoot").value = foundRoot;
    updateSubSelect("editCatRoot", "editCategoria");
    setTimeout(() => { document.getElementById("editCategoria").value = p.categoria; }, 50);
    document.getElementById("editFoto").value = "";
    document.getElementById("editPreviewNew").style.display = "none";
    document.getElementById("editFormWrap").style.display = "block";
    document.getElementById("editForm").classList.remove("hidden");
    document.getElementById("msgEditar").innerHTML = "";
  }

  async function saveEditProduct() {
    if (!editingCode) return;
    var btn = document.getElementById("saveEditBtn");
    btn.disabled = true; btn.textContent = "Guardando...";
    var formData = new FormData();
    formData.append("pass", PASS);
    formData.append("action", "edit");
    formData.append("codigo", editingCode);
    formData.append("nuevoCodigo", document.getElementById("editCodigo").value.trim());
    formData.append("nombre", document.getElementById("editNombre").value.trim());
    formData.append("precio", document.getElementById("editPrecio").value);
    formData.append("descuento", document.getElementById("editDescuento").value || "0");
    formData.append("categoria", document.getElementById("editCategoria").value);
    formData.append("tallas", document.getElementById("editTallas").value.trim());
    formData.append("colores", document.getElementById("editColores").value.trim());
    formData.append("tamanos", document.getElementById("editTamanos").value.trim());
    formData.append("mostrar_index", document.getElementById("editIndex").checked ? "1" : "0");
    formData.append("agotado", document.getElementById("editAgotado").checked ? "1" : "0");
    var fotoInput = document.getElementById("editFoto");
    if (fotoInput.files && fotoInput.files[0]) { formData.append("foto", fotoInput.files[0]); }
    try {
      var r = await fetch("admin.php", { method:"POST", body:formData });
      var d = await r.json();
      if (d.success) {
        showMsg("msgEditarBottom", "‚úÖ Producto actualizado", "success");
        document.getElementById("editImage").src = "img/" + editingCode + ".webp?" + Date.now();
        loadStats();
      } else { showMsg("msgEditarBottom", d.error || "Error al guardar", "error"); }
    } catch(e) { showMsg("msgEditarBottom", "Error de conexi√≥n", "error"); }
    btn.disabled = false; btn.textContent = "üíæ Guardar Cambios";
  }

  async function deleteFromEdit() {
    if (!editingCode) return;
    if (!confirm("¬øSeguro que quer√©s eliminar " + editingCode + "?")) return;
    var formData = new FormData();
    formData.append("pass", PASS); formData.append("action", "delete"); formData.append("codigo", editingCode);
    try {
      var r = await fetch("admin.php", { method:"POST", body:formData });
      var d = await r.json();
      if (d.success) {
        document.getElementById("editFormWrap").style.display = "none";
        document.getElementById("editForm").classList.add("hidden");
        document.getElementById("editSearchCode").value = "";
        editingCode = "";
        renderSortList();
        loadStats();
      } else { showMsg("msgEditar", d.error || "Error al eliminar", "error"); }
    } catch(e) { showMsg("msgEditar", "Error de conexi√≥n", "error"); }
  }

  // ===== ORDENAR PRODUCTOS =====
  var sortableData = [];      // items visibles (lo que se arrastra)
  var sortableHidden = [];   // items no visibles cuando se filtra por "index"
  var dragSrcIdx = null;

  var allSortData = []; // full dataset

  function renderSortList() {
    var filtro = document.getElementById('ordenFiltro').value;
    fetch('products.js?' + Date.now())
      .then(function(r){ return r.text(); })
      .then(function(txt){
        var all = [];
        var re = /\["([^"]+)",\s*"([^"]*)",\s*(\d+),\s*(\d+),\s*(\d+),\s*"([^"]*)"/g;
        var m;
        while ((m = re.exec(txt)) !== null) {
          all.push({ codigo: m[1], nombre: m[2], precio: parseInt(m[3]), descuento: parseInt(m[4]), showIndex: parseInt(m[5]), categoria: m[6] });
        }
        all.sort(function(a,b){ return parseInt(b.codigo) - parseInt(a.codigo); });
        allSortData = all;
        filterSortList();
      });
  }

  function clearSortSearch() {
    document.getElementById('sortSearchInput').value = '';
    filterSortList();
  }

  function runSortSearch() {
    filterSortList();
    document.getElementById('sortSearchInput').value = '';
  }

  function filterSortList() {
    var filtro = document.getElementById('ordenFiltro') ? document.getElementById('ordenFiltro').value : 'todos';
    var query = (document.getElementById('sortSearchInput') ? document.getElementById('sortSearchInput').value : '').toLowerCase().trim();
    var base = allSortData;
    if (filtro === 'index') {
      base = allSortData.filter(function(p){ return p.showIndex === 1; });
    }
    if (query) {
      base = base.filter(function(p){
        var codigoBase = p.codigo.replace(/_[B-Z]$/, '');
        return p.nombre.toLowerCase().includes(query) || codigoBase.toLowerCase().includes(query);
      });
    }
    sortableData = base;
    sortableHidden = filtro === 'index' ? allSortData.filter(function(p){ return p.showIndex !== 1; }) : [];
    buildSortDOM();
    // Show count if searching
    var msg = document.getElementById('msgOrdenar');
    if (query && base.length === 0) {
      msg.innerHTML = '<div style="padding:8px 12px;background:#fef2f2;border:1px solid #fca5a5;border-radius:8px;font-size:0.82rem;color:#dc2626;">No se encontraron productos para "<strong>' + query + '</strong>"</div>';
    } else if (query) {
      msg.innerHTML = '<div style="padding:8px 12px;background:#f0fdf4;border:1px solid #86efac;border-radius:8px;font-size:0.82rem;color:#16a34a;display:flex;align-items:center;justify-content:space-between;">' + base.length + ' producto(s) encontrado(s) <button onclick="clearSortSearch()" style="background:#fff;border:1.5px solid #86efac;border-radius:7px;padding:4px 12px;font-size:0.78rem;color:#16a34a;cursor:pointer;font-weight:700;">‚úï Ver todos</button></div>';
    } else {
      msg.innerHTML = '';
    }
  }

  function buildSortDOM() {
    var list = document.getElementById('sortList');
    list.innerHTML = sortableData.map(function(p, i) {
      var codigoBase = p.codigo.replace(/_[B-Z]$/, '');
      var pf = p.descuento > 0 ? Math.round(p.precio * (1 - p.descuento/100)) : p.precio;
      return '<div class="sort-item" draggable="true" data-idx="' + i + '" ' +
        'ondragstart="sortDragStart(event,'+i+')" ondragover="sortDragOver(event,'+i+')" ondrop="sortDrop(event,'+i+')" ondragend="sortDragEnd()" ' +
        'ontouchstart="sortTouchStart(event,'+i+')" ontouchmove="sortTouchMove(event)" ontouchend="sortTouchEnd(event,'+i+')">' +
        '<span class="sort-handle" title="Arrastr√° para reordenar">‚ò∞</span>' +
        '<img src="img/' + p.codigo + '.webp" onerror="this.style.opacity=0.15" onclick="previewSortImg(\'' + p.codigo + '\')" style="width:46px;height:46px;object-fit:cover;border-radius:6px;border:1px solid var(--border);flex-shrink:0;cursor:zoom-in;" title="Ver foto grande">' +
        '<div style="flex:1;min-width:0;">' +
          '<div style="font-weight:600;font-size:0.85rem;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">' + p.nombre + '</div>' +
          '<div style="font-size:0.72rem;color:var(--muted);">C√≥digo: ' + codigoBase + ' ¬∑ ‚Ç°' + Number(pf).toLocaleString() + (p.showIndex ? ' ¬∑ <span style="color:var(--green)">Inicio</span>' : '') + '</div>' +
        '</div>' +
        '<div style="display:flex;gap:5px;flex-shrink:0;">' +
          '<button onclick="editFromSort(\'' + p.codigo + '\')" style="background:none;border:1.5px solid var(--border);border-radius:7px;padding:5px 10px;font-size:0.75rem;color:var(--rose);cursor:pointer;font-weight:700;">‚úèÔ∏è Editar</button>' +
          '<button onclick="deleteFromSort(\'' + p.codigo + '\',\'' + p.nombre + '\',this)" style="background:none;border:1.5px solid #fca5a5;border-radius:7px;padding:5px 10px;font-size:0.75rem;color:#dc2626;cursor:pointer;font-weight:700;">üóëÔ∏è Borrar</button>' +
        '</div>' +
        '<span style="font-size:0.72rem;color:#d1d5db;">#' + (i+1) + '</span>' +
      '</div>';
    }).join('');
  }

  function editFromSort(codigo) {
    var codigoBase = codigo.replace(/_[B-Z]$/, '');
    document.getElementById('editSearchCode').value = codigoBase;
    document.getElementById('msgEditar').innerHTML = '<div class="msg">‚è≥ Cargando producto...</div>';
    document.getElementById('editFormWrap').style.display = 'none';
    document.getElementById('seccion-ordenar').scrollIntoView({behavior:'smooth', block:'start'});
    searchEditProduct();
  }

  function previewSortImg(codigo) {
    var overlay = document.getElementById('sortImgOverlay');
    document.getElementById('sortImgBig').src = 'img/' + codigo + '.webp?' + Date.now();
    overlay.style.display = 'flex';
  }

  function closeEditForm() {
    document.getElementById('editFormWrap').style.display = 'none';
    document.getElementById('msgEditar').innerHTML = '';
    document.getElementById('msgEditarBottom').innerHTML = '';
    editingCode = '';
  }

  async function deleteFromSort(codigo, nombre, btn) {
    if (!confirm('¬øSeguro que quer√©s eliminar "' + nombre + '" (' + codigo + ')?')) return;
    btn.disabled = true; btn.textContent = '‚è≥';
    var fd = new FormData();
    fd.append('pass', PASS); fd.append('action', 'delete'); fd.append('codigo', codigo);
    try {
      var r = await fetch('admin.php', { method: 'POST', body: fd });
      var d = await r.json();
      if (d.success) {
        sortableData = sortableData.filter(function(p){ return p.codigo !== codigo; });
        sortableHidden = sortableHidden.filter(function(p){ return p.codigo !== codigo; });
        buildSortDOM();
        loadStats();
      } else {
        btn.disabled = false; btn.textContent = 'üóëÔ∏è Borrar';
        alert(d.error || 'Error al eliminar');
      }
    } catch(e) {
      btn.disabled = false; btn.textContent = 'üóëÔ∏è Borrar';
      alert('Error de conexi√≥n');
    }
  }

  // Drag & Drop desktop
  function sortDragStart(e, i) { dragSrcIdx = i; e.currentTarget.style.opacity = '0.4'; }
  function sortDragOver(e, i) { e.preventDefault(); if (i !== dragSrcIdx) e.currentTarget.style.background = 'var(--rose-pale)'; }
  function sortDrop(e, i) {
    e.preventDefault();
    if (dragSrcIdx === null || dragSrcIdx === i) return;
    var moved = sortableData.splice(dragSrcIdx, 1)[0];
    sortableData.splice(i, 0, moved);
    buildSortDOM();
    dragSrcIdx = null;
  }
  function sortDragEnd() { dragSrcIdx = null; buildSortDOM(); }

  // Touch drag (mobile)
  var touchSrcIdx = null, touchClone = null;
  function sortTouchStart(e, i) {
    touchSrcIdx = i;
    var el = e.currentTarget;
    touchClone = el.cloneNode(true);
    touchClone.style.cssText = 'position:fixed;opacity:.7;pointer-events:none;z-index:9999;width:' + el.offsetWidth + 'px;background:#fff;border-radius:10px;box-shadow:0 4px 20px rgba(0,0,0,.2);';
    document.body.appendChild(touchClone);
    el.style.opacity = '.3';
  }
  function sortTouchMove(e) {
    if (!touchClone) return;
    e.preventDefault();
    var t = e.touches[0];
    touchClone.style.left = (t.clientX - 30) + 'px';
    touchClone.style.top  = (t.clientY - 30) + 'px';
  }
  function sortTouchEnd(e, i) {
    if (touchClone) { document.body.removeChild(touchClone); touchClone = null; }
    var t = e.changedTouches[0];
    var els = document.querySelectorAll('.sort-item');
    var targetIdx = null;
    els.forEach(function(el) {
      var r = el.getBoundingClientRect();
      if (t.clientY >= r.top && t.clientY <= r.bottom) targetIdx = parseInt(el.dataset.idx);
    });
    if (targetIdx !== null && targetIdx !== touchSrcIdx) {
      var moved = sortableData.splice(touchSrcIdx, 1)[0];
      sortableData.splice(targetIdx, 0, moved);
    }
    touchSrcIdx = null;
    buildSortDOM();
  }

  async function saveOrder() {
    var btn = document.getElementById('saveOrderBtn');
    btn.disabled = true; btn.textContent = '‚è≥ Guardando...';
    // Enviar: primero los visibles en el orden actual, luego los ocultos al final
    var order = sortableData.concat(sortableHidden).map(function(p){ return p.codigo; });
    var fd = new FormData();
    fd.append('pass', PASS);
    fd.append('action', 'reorder');
    fd.append('order', JSON.stringify(order));
    try {
      var r = await fetch('admin.php', { method:'POST', body:fd });
      var d = await r.json();
      if (d.success) { showMsg('msgOrdenar','‚úÖ Orden guardado correctamente','success'); }
      else { showMsg('msgOrdenar', d.error || 'Error al guardar','error'); }
    } catch(e) { showMsg('msgOrdenar','Error de conexi√≥n','error'); }
    btn.disabled = false; btn.textContent = 'üíæ Guardar Orden';
  }

  // ===== PORTADA HERO (3 im√°genes) =====
  async function uploadHero(input, n) {
    var file = input.files[0];
    if (!file) return;
    document.getElementById('heroNombre'+n).textContent = file.name;
    document.getElementById('heroStatus'+n).style.display = 'none';
    var label = input.closest('label');
    var origText = 'üì§ Imagen ' + n;
    label.childNodes[0].textContent = '‚è≥ Subiendo... ';
    label.style.opacity = '0.7';
    label.style.pointerEvents = 'none';
    var formData = new FormData();
    formData.append('pass', PASS);
    formData.append('action', 'hero');
    formData.append('hero', file);
    formData.append('hero_index', n);
    try {
      var r = await fetch('admin.php', { method:'POST', body:formData });
      var d = await r.json();
      if (d.success) {
        var img = document.getElementById('heroActual'+n);
        img.src = 'img/hero_'+n+'.webp?' + Date.now();
        img.style.opacity = '1';
        var st = document.getElementById('heroStatus'+n);
        st.style.display = 'block';
        setTimeout(function(){ st.style.display='none'; }, 3000);
        showMsg('msgPortada', '‚úÖ Imagen '+n+' actualizada correctamente', 'success');
      } else {
        showMsg('msgPortada', d.error || 'Error al guardar', 'error');
      }
    } catch(e) {
      showMsg('msgPortada', 'Error de conexi√≥n: ' + e.message, 'error');
    }
    label.childNodes[0].textContent = origText + ' ';
    label.style.opacity = '1';
    label.style.pointerEvents = 'auto';
    input.value = '';
  }

  // ===== FOOTER INFO =====
  async function loadFooterInfo() {
    try {
      var r = await fetch("admin.php?action=footer_get&pass=" + PASS);
      var d = await r.json();
      if (d.success && d.data) {
        document.getElementById("footerNombre").value = d.data.nombre || "La Vaca CR";
        document.getElementById("footerWA").value = d.data.whatsapp || "50663262291";
        document.getElementById("footerTel").value = d.data.telefono || "2237-3335";
        document.getElementById("footerUbicacion").value = d.data.ubicacion || "";
        document.getElementById("footerHorarioLS").value = d.data.horario_ls || "9:00 am - 7:00 pm";
        document.getElementById("footerHorarioDom").value = d.data.horario_dom || "10:00 am - 6:00 pm";
        document.getElementById("footerDesc").value = d.data.descripcion || "";
      }
    } catch(e) {}
  }
  async function saveFooterInfo() {
    var formData = new FormData();
    formData.append("pass", PASS);
    formData.append("action", "footer_save");
    formData.append("nombre", document.getElementById("footerNombre").value.trim());
    formData.append("whatsapp", document.getElementById("footerWA").value.trim());
    formData.append("telefono", document.getElementById("footerTel").value.trim());
    formData.append("ubicacion", document.getElementById("footerUbicacion").value.trim());
    formData.append("horario_ls", document.getElementById("footerHorarioLS").value.trim());
    formData.append("horario_dom", document.getElementById("footerHorarioDom").value.trim());
    formData.append("descripcion", document.getElementById("footerDesc").value.trim());
    try {
      var r = await fetch("admin.php", { method:"POST", body:formData });
      var d = await r.json();
      if (d.success) { showMsg("msgFooter", "‚úÖ Informaci√≥n guardada correctamente", "success"); }
      else { showMsg("msgFooter", d.error || "Error al guardar", "error"); }
    } catch(e) { showMsg("msgFooter", "Error de conexi√≥n", "error"); }
  }

  // ===== CATEGOR√çAS =====
  async function loadCategories() {
    try {
      var r = await fetch("categories.php?pass=" + PASS);
      var d = await r.json();
      if (d.success) {
        allCategories = d.categories;
        renderCategories();
        updateCategorySelects();
        updateSubRootSelect();
      }
    } catch(e) {}
  }

  function renderCategories() {
    var list = document.getElementById("categoriesList");
    if (allCategories.length === 0) { list.innerHTML = '<p style="color:var(--muted);text-align:center;padding:20px">No hay categor√≠as</p>'; return; }
    list.innerHTML = allCategories.map(function(cat) {
      var visible = Number(cat.showIndex) === 1;
      return '<div class="cat-row">' +
        '<div class="cat-row-left">' +
          '<span class="cat-folder">üìÅ</span>' +
          '<span class="cat-name">' + cat.name + '</span>' +
          '<span class="' + (visible ? 'cat-badge-visible' : 'cat-badge-hidden') + '">' + (visible ? 'Visible' : 'Oculta') + '</span>' +
        '</div>' +
        '<div class="cat-actions">' +
          '<button class="cat-btn cat-btn-eye" onclick="toggleShowIndex(\'' + cat.id + '\',' + (visible ? 0 : 1) + ')" title="' + (visible ? 'Ocultar' : 'Mostrar') + '">' + (visible ? 'üëÅÔ∏è' : 'üö´') + '</button>' +
          '<button class="cat-btn cat-btn-del" onclick="deleteRoot(\'' + cat.id + '\')" title="Eliminar">üóëÔ∏è</button>' +
        '</div>' +
      '</div>';
    }).join('');
  }

  function updateCategorySelects() {
    var opts = '<option value="">Seleccionar...</option>';
    allCategories.forEach(function(cat) { opts += '<option value="' + cat.id + '">' + cat.name + '</option>'; });
    document.getElementById("catRoot").innerHTML = opts;
    document.getElementById("editCatRoot").innerHTML = opts;
    document.getElementById("categoria").innerHTML = '<option value="">Primero eleg√≠ categor√≠a</option>';
    document.getElementById("editCategoria").innerHTML = '<option value="">Primero eleg√≠ categor√≠a</option>';
  }

  function updateSubSelect(rootId, subId) {
    var rootVal = document.getElementById(rootId).value;
    var subSel = document.getElementById(subId);
    if (!rootVal) { subSel.innerHTML = '<option value="">Primero eleg√≠ categor√≠a</option>'; return; }
    var cat = allCategories.find(function(c) { return c.id === rootVal; });
    if (!cat) return;
    var opts = '<option value="">Seleccionar...</option>';
    cat.subs.forEach(function(s) { if (!s.id.startsWith('todos_')) { opts += '<option value="' + s.id + '">' + s.name + '</option>'; } });
    subSel.innerHTML = opts;
  }

  async function addRootCategory() {
    var id = document.getElementById("newRootId").value.trim().toLowerCase().replace(/\s+/g,'_');
    var name = document.getElementById("newRootName").value.trim();
    var show = document.getElementById("newRootShow").checked ? "1" : "0";
    if (!id || !name) { alert("Complet√° ID y nombre"); return; }
    var formData = new FormData();
    formData.append("pass", PASS); formData.append("action", "add_root");
    formData.append("id", id); formData.append("name", name); formData.append("show_index", show);
    try {
      var r = await fetch("categories.php", { method:"POST", body:formData });
      var d = await r.json();
      if (d.success) { showMsg("msgCat","‚úÖ Categor√≠a agregada","success"); document.getElementById("newRootId").value=""; document.getElementById("newRootName").value=""; loadCategories(); }
      else { showMsg("msgCat", d.error, "error"); }
    } catch(e) { showMsg("msgCat","Error de conexi√≥n","error"); }
  }

  function toggleShowIndex(id, val) {
    var fd = new FormData(); fd.append("pass",PASS); fd.append("action","edit_root"); fd.append("id",id); fd.append("show_index",val.toString());
    fetch("categories.php",{method:"POST",body:fd}).then(r=>r.json()).then(d=>{ if(d.success){loadCategories();} else showMsg("msgCat",d.error||"Error","error"); });
  }
  function deleteRoot(id) {
    if (!confirm("¬øEliminar esta categor√≠a y todas sus subcategor√≠as?")) return;
    var fd = new FormData(); fd.append("pass",PASS); fd.append("action","delete_root"); fd.append("id",id);
    fetch("categories.php",{method:"POST",body:fd}).then(r=>r.json()).then(d=>{ if(d.success){showMsg("msgCat","‚úÖ Eliminada","success");loadCategories();} else showMsg("msgCat",d.error,"error"); });
  }

  // ===== SUBCATEGOR√çAS =====
  function updateSubRootSelect() {
    var sel = document.getElementById("subRootSelect");
    var opts = '<option value="">Seleccionar...</option>';
    allCategories.forEach(function(cat) { opts += '<option value="' + cat.id + '">' + cat.name + '</option>'; });
    sel.innerHTML = opts;
  }
  function renderSubsForRoot() {
    var rootId = document.getElementById("subRootSelect").value;
    var container = document.getElementById("subsContainer");
    var list = document.getElementById("subsList");
    if (!rootId) { container.classList.add("hidden"); return; }
    container.classList.remove("hidden");
    var cat = allCategories.find(function(c){ return c.id === rootId; });
    if (!cat) return;
    var subs = cat.subs.filter(function(s){ return !s.id.startsWith('todos_'); });
    if (subs.length === 0) { list.innerHTML = '<p style="color:var(--muted);padding:12px">No hay subcategor√≠as</p>'; return; }
    list.innerHTML = subs.map(function(s) {
      return '<div class="cat-row"><div class="cat-row-left"><span class="cat-folder">üìÇ</span><span class="cat-name">' + s.name + '</span><span style="font-size:0.72rem;color:var(--muted)">ID: ' + s.id + '</span></div>' +
      '<div class="cat-actions"><button class="cat-btn cat-btn-del" onclick="deleteSub(\'' + rootId + '\',\'' + s.id + '\')">üóëÔ∏è</button></div></div>';
    }).join('');
  }
  function addSubFromTab() {
    var rootId = document.getElementById("subRootSelect").value;
    var name = document.getElementById("newSubName").value.trim();
    if (!rootId) { alert("Seleccion√° una categor√≠a"); return; }
    if (!name) { alert("Ingres√° un nombre"); return; }
    var fd = new FormData(); fd.append("pass",PASS); fd.append("action","add_sub"); fd.append("root_id",rootId); fd.append("name",name);
    fetch("categories.php",{method:"POST",body:fd}).then(r=>r.json()).then(d=>{ if(d.success){showMsg("msgSub","‚úÖ Subcategor√≠a agregada","success");document.getElementById("newSubName").value="";loadCategories();renderSubsForRoot();} else showMsg("msgSub",d.error,"error"); });
  }
  function deleteSub(rootId, subId) {
    if (!confirm("¬øEliminar esta subcategor√≠a?")) return;
    var fd = new FormData(); fd.append("pass",PASS); fd.append("action","delete_sub"); fd.append("root_id",rootId); fd.append("id",subId);
    fetch("categories.php",{method:"POST",body:fd}).then(r=>r.json()).then(d=>{ if(d.success){showMsg("msgSub","‚úÖ Eliminada","success");loadCategories();renderSubsForRoot();} else showMsg("msgSub",d.error,"error"); });
  }

  // ===== VENTAS =====
  var BOT_URL = "https://tico-bot-lite.onrender.com";
  var BOT_PWD = "usuario2026";
  let allVentas = [];

  async function loadVentas() {
    document.getElementById("ventasStatus").textContent = "Cargando...";
    document.getElementById("ventasDot").className = "ventas-dot";
    try {
      const r = await fetch(BOT_URL + "/api/admin/dashboard?pwd=" + BOT_PWD);
      if (!r.ok) throw new Error("Error " + r.status);
      const data = await r.json();
      document.getElementById("ventasDot").className = "ventas-dot " + (data.connection === "connected" ? "on" : "off");
      document.getElementById("ventasStatus").textContent = data.connection === "connected"
        ? "üì± WhatsApp conectado" + (data.storeOpen ? " ‚Ä¢ Tienda abierta" : " ‚Ä¢ Tienda cerrada")
        : "WhatsApp desconectado";
      allVentas = data.sales?.recent || [];
      const counts = { alistado:0, en_transito:0, entregado:0, retiro_pend:0 };
      allVentas.forEach(s => {
        const st = s.status || "alistado";
        if (s.method === 'recoger' && st !== 'entregado') counts.retiro_pend++;
        else if (counts[st] !== undefined) counts[st]++;
      });
      document.getElementById("statAlistado").textContent  = counts.alistado;
      document.getElementById("statTransito").textContent  = counts.en_transito;
      document.getElementById("statEntregado").textContent = counts.entregado;
      document.getElementById("statRetiro").textContent    = counts.retiro_pend;
      renderVentas();
    } catch(e) {
      document.getElementById("ventasDot").className = "ventas-dot off";
      document.getElementById("ventasStatus").textContent = "Sin conexi√≥n";
      document.getElementById("ventasList").innerHTML = '<div style="text-align:center;padding:40px;color:var(--muted)">No se pudo conectar al bot</div>';
    }
  }

  function renderVentas() {
    var filter = document.getElementById("ventasFilter").value;
    var method = document.getElementById("ventasMethod").value;
    var search = document.getElementById("ventasSearch").value.toLowerCase();
    var filtered = allVentas.filter(s => {
      if (filter !== "all" && (s.status || "alistado") !== filter) return false;
      if (method !== "all" && s.method !== method) return false;
      if (search && !JSON.stringify(s).toLowerCase().includes(search)) return false;
      return true;
    });
    document.getElementById("ventasCount").textContent = filtered.length + " resultados";
    if (filtered.length === 0) {
      document.getElementById("ventasList").innerHTML = '<div style="text-align:center;padding:40px;color:var(--muted)">No hay resultados</div>';
      return;
    }

    const STEPS_ENV = ["alistado","en_transito","entregado"];
    const STEPS_REC = ["alistado","entregado"];
    const stLabel   = { alistado:"Alistado", en_transito:"En tr√°nsito", entregado:"Entregado" };

    document.getElementById("ventasList").innerHTML = filtered.map(s => {
      const st    = s.status || "alistado";
      const isEnv = s.method === 'envio';
      const steps = isEnv ? STEPS_ENV : STEPS_REC;
      const stIdx = steps.indexOf(st);

      // Pills de estado
      const pills = steps.map((p,pi) =>
        '<span class="pill pill-' + p + ' ' + (pi <= stIdx ? 'done' : 'pending') + '">' + stLabel[p] + '</span>' +
        (pi < steps.length-1 ? ' <span style="color:#d1d5db;font-size:.8rem">‚Ä∫</span> ' : '')
      ).join('');

      // Badges
      const mBadge = isEnv
        ? '<span style="background:rgba(37,99,235,0.1);color:#2563eb;font-size:0.68rem;padding:2px 8px;border-radius:999px;font-weight:700;">üì¶ Env√≠o</span>'
        : '<span style="background:rgba(124,58,237,0.1);color:#7c3aed;font-size:0.68rem;padding:2px 8px;border-radius:999px;font-weight:700;">üè™ Retiro</span>';
      const oBadge = s.manual
        ? '<span style="background:rgba(168,85,247,0.1);color:#9333ea;font-size:0.68rem;padding:2px 8px;border-radius:999px;font-weight:700;">‚úçÔ∏è Manual</span>'
        : '<span style="background:rgba(22,163,74,0.1);color:#16a34a;font-size:0.68rem;padding:2px 8px;border-radius:999px;font-weight:700;">ü§ñ Bot</span>';

      const dateStr = s.date ? new Date(s.date).toLocaleDateString('es-CR',{day:'2-digit',month:'short',hour:'2-digit',minute:'2-digit'}) : '-';
      const sid = s.id;

      // Datos del cliente y pedido (solo lectura)
      var infoGrid =
        '<div class="order-field"><label>Cliente</label><div style="font-size:.84rem;font-weight:600">' + escHtml(s.name||'‚Äî') + '</div></div>' +
        '<div class="order-field"><label>Tel√©fono</label><div style="font-size:.84rem">' + escHtml(s.phone||'‚Äî') + '</div></div>' +
        '<div class="order-field"><label>C√≥digo</label><div style="font-size:.84rem">' + escHtml(s.codigo||'‚Äî') + '</div></div>' +
        '<div class="order-field"><label>Talla / Color</label><div style="font-size:.84rem">' + escHtml(s.talla_color||'‚Äî') + '</div></div>' +
        '<div class="order-field"><label>Precio</label><div style="font-size:.84rem">‚Ç°' + (s.precio||0).toLocaleString() + '</div></div>' +
        (isEnv ? '<div class="order-field"><label>Costo Env√≠o</label><div style="font-size:.84rem;color:#2563eb">‚Ç°' + (s.shipping||0).toLocaleString() + '</div></div>' : '') +
        '<div class="order-field"><label>Total</label><div style="font-size:.94rem;font-weight:700;color:var(--green)">‚Ç°' + (s.total||0).toLocaleString() + '</div></div>' +
        (s.sinpe_reference ? '<div class="order-field"><label>Ref SINPE</label><div style="font-size:.84rem">' + escHtml(s.sinpe_reference) + '</div></div>' : '') +
        (isEnv ? '<div class="order-field" style="grid-column:span 2"><label>Direcci√≥n</label><div style="font-size:.84rem">' + escHtml(s.envio_datos||s.zone||'‚Äî') + '</div></div>' : '') +
        (s.notas ? '<div class="order-field" style="grid-column:span 2"><label>Notas</label><div style="font-size:.84rem">' + escHtml(s.notas) + '</div></div>' : '');

      // Campos editables
      var editFields = '';
      if (isEnv) {
        editFields =
          '<div style="background:var(--bg);border:1.5px solid var(--border);border-radius:8px;padding:14px;margin-top:10px">' +
          '<div style="font-size:.65rem;font-weight:700;text-transform:uppercase;letter-spacing:1px;color:var(--muted);margin-bottom:10px">‚úèÔ∏è Actualizar Env√≠o</div>' +
          '<div class="order-fields">' +
            '<div class="order-field"><label>Estado</label>' +
              '<select onchange="updateVenta(\'' + sid + '\',\'status\',this.value)">' +
              STEPS_ENV.map(p => '<option value="' + p + '"' + (st===p?' selected':'') + '>' + stLabel[p] + '</option>').join('') +
              '</select></div>' +
            '<div class="order-field"><label># Gu√≠a Correos CR</label>' +
              '<input type="text" value="' + escHtml(s.guia_correos||'') + '" placeholder="Ej: 12345678CR"' +
              ' onchange="updateVenta(\'' + sid + '\',\'guia_correos\',this.value)"></div>' +
            '<div class="order-field"><label>Fecha Alistado</label>' +
              '<input type="date" value="' + (s.fecha_alistado||'') + '" onchange="updateVenta(\'' + sid + '\',\'fecha_alistado\',this.value)"></div>' +
            '<div class="order-field"><label>Fecha Env√≠o</label>' +
              '<input type="date" value="' + (s.fecha_envio||'') + '" onchange="updateVenta(\'' + sid + '\',\'fecha_envio\',this.value)"></div>' +
            '<div class="order-field"><label>Fecha Entregado</label>' +
              '<input type="date" value="' + (s.fecha_entregado||'') + '" onchange="updateVenta(\'' + sid + '\',\'fecha_entregado\',this.value)"></div>' +
          '</div></div>';
      } else {
        editFields =
          '<div style="margin-top:10px"><div class="order-fields">' +
          '<div class="order-field"><label>Estado</label>' +
            '<select onchange="updateVenta(\'' + sid + '\',\'status\',this.value)">' +
            STEPS_REC.map(p => '<option value="' + p + '"' + (st===p?' selected':'') + '>' + stLabel[p] + '</option>').join('') +
            '</select></div>' +
          '</div></div>';
      }

      return '<div class="order-card">' +
        '<div class="order-top"><div>' +
          '<div class="order-prod">' + escHtml(s.producto||'Art√≠culo') + ' ' + mBadge + ' ' + oBadge + '</div>' +
          '<div class="order-meta">' + escHtml(s.name||s.phone||'‚Äî') + ' ¬∑ ' + dateStr + '</div>' +
        '</div><div style="text-align:right">' +
          '<div class="order-total">‚Ç°' + (s.total||0).toLocaleString() + '</div>' +
          (isEnv ? '<div class="order-shipping">+‚Ç°' + (s.shipping||0).toLocaleString() + ' env√≠o</div>' : '') +
        '</div></div>' +
        '<div class="status-pills" style="margin:10px 0 8px">' + pills + '</div>' +
        '<div class="order-fields">' + infoGrid + '</div>' +
        editFields +
        '<span class="save-ok" id="ok-' + sid + '">‚úì Guardado</span>' +
      '</div>';
    }).join('');
  }

  async function updateVenta(id, field, value) {
    try {
      const r = await fetch(BOT_URL + "/api/admin/sales/update?pwd=" + BOT_PWD, {
        method:"POST", headers:{"Content-Type":"application/json"},
        body: JSON.stringify({ saleId:id, field:field, value:value })
      });
      const d = await r.json();
      if (d && d.success) {
        const s = allVentas.find(x => x.id === id);
        if (s && d.sale) Object.assign(s, d.sale);
        renderVentas();
        const ok = document.getElementById("ok-" + id);
        if (ok) { ok.classList.add("show"); setTimeout(() => ok.classList.remove("show"), 2000); }
      } else { alert("Error al guardar: " + (d.error||"desconocido")); }
    } catch(e) { alert("Error de conexi√≥n"); }
  }

  // Auto-iniciar sin login
  document.addEventListener('DOMContentLoaded', function() {
    // Ocultar todas las secciones excepto la primera
    ['ordenar','categorias','subcategorias','portada','footer','ventas','venta-manual'].forEach(function(s) {
      var sec = document.getElementById('seccion-' + s);
      if (sec) sec.style.display = 'none';
    });
    // Empujar estado inicial para que el bot√≥n atr√°s tenga punto de referencia
    try { history.replaceState({ tab: 'incluir' }, '', '#incluir'); } catch(e) {}
    loadCategories();
    loadStats();
    loadFooterInfo();
  });

  // ===== VENTA MANUAL =====
  // ‚îÄ‚îÄ PRENDAS ‚îÄ‚îÄ
  var vmPrendas = []; // [{codigo, producto, talla_color, cantidad, precio}]

  function agregarPrenda() {
    var idx = vmPrendas.length;
    vmPrendas.push({ codigo:'', producto:'', talla_color:'', cantidad:1, precio:0 });
    renderPrendasTable();
    // Focus en el c√≥digo de la nueva fila
    setTimeout(function(){ var el=document.getElementById('pCod-'+idx); if(el) el.focus(); }, 50);
  }

  function eliminarPrenda(idx) {
    vmPrendas.splice(idx, 1);
    renderPrendasTable();
    calcTotalManual();
  }

  function renderPrendasTable() {
    var tbody = document.getElementById('vmPrendasBody');
    if (!tbody) return;
    if (vmPrendas.length === 0) {
      tbody.innerHTML = '<tr><td colspan="7" style="padding:16px;text-align:center;color:var(--muted);font-size:.82rem">Sin prendas ‚Äî presion√° "+ Agregar prenda"</td></tr>';
      return;
    }
    tbody.innerHTML = vmPrendas.map(function(p, i) {
      var sub = (p.cantidad||0) * (p.precio||0);
      return '<tr style="border-bottom:1px solid var(--border);">' +
        '<td style="padding:6px 8px"><input type="text" value="' + escHtml(p.codigo) + '" placeholder="117371" style="width:90px;padding:6px 8px;border:1.5px solid var(--border);border-radius:6px;font-family:\'DM Sans\',sans-serif;font-size:.8rem" onchange="vmPrendas['+i+'].codigo=this.value"></td>' +
        '<td style="padding:6px 8px"><input id="pProd-'+i+'" type="text" value="' + escHtml(p.producto) + '" placeholder="Nombre del producto" style="width:100%;min-width:150px;padding:6px 8px;border:1.5px solid var(--border);border-radius:6px;font-family:\'DM Sans\',sans-serif;font-size:.8rem" onchange="vmPrendas['+i+'].producto=this.value"></td>' +
        '<td style="padding:6px 8px"><input type="text" value="' + escHtml(p.talla_color) + '" placeholder="M / Negro" style="width:100px;padding:6px 8px;border:1.5px solid var(--border);border-radius:6px;font-family:\'DM Sans\',sans-serif;font-size:.8rem" onchange="vmPrendas['+i+'].talla_color=this.value"></td>' +
        '<td style="padding:6px 8px;text-align:center"><input id="pCod-'+i+'" type="number" value="' + p.cantidad + '" min="1" style="width:60px;padding:6px 8px;border:1.5px solid var(--border);border-radius:6px;font-family:\'DM Sans\',sans-serif;font-size:.8rem;text-align:center" oninput="vmPrendas['+i+'].cantidad=parseInt(this.value)||1;calcTotalManual()"></td>' +
        '<td style="padding:6px 8px;text-align:right"><input type="number" value="' + p.precio + '" placeholder="0" style="width:90px;padding:6px 8px;border:1.5px solid var(--border);border-radius:6px;font-family:\'DM Sans\',sans-serif;font-size:.8rem;text-align:right" oninput="vmPrendas['+i+'].precio=parseFloat(this.value)||0;calcTotalManual()"></td>' +
        '<td style="padding:6px 8px;text-align:right;font-weight:600;font-size:.84rem;color:var(--green);white-space:nowrap">‚Ç°' + sub.toLocaleString('es-CR') + '</td>' +
        '<td style="padding:6px 8px;text-align:center"><button onclick="eliminarPrenda('+i+')" style="background:none;border:none;color:var(--muted);cursor:pointer;font-size:1rem;padding:2px 6px;border-radius:4px" title="Eliminar">‚úï</button></td>' +
      '</tr>';
    }).join('');
  }

  function toggleEnvioFields() {
    var metodo = document.getElementById("vmMetodo").value;
    var el = document.getElementById("vmEnvioFields");
    if (metodo === 'envio') el.classList.add('show');
    else el.classList.remove('show');
    calcTotalManual();
  }

  function calcTotalManual() {
    var subtotal = vmPrendas.reduce(function(s,p){ return s + ((p.cantidad||0)*(p.precio||0)); }, 0);
    var metodo   = document.getElementById("vmMetodo").value;
    var envio    = metodo === 'envio' ? (parseFloat(document.getElementById("vmEnvioCosto").value)||0) : 0;
    var total    = subtotal + envio;
    document.getElementById("vmTotal").value = total;
    document.getElementById("vmSubtotalDisplay").textContent = '‚Ç°' + subtotal.toLocaleString('es-CR');
    document.getElementById("vmEnvioDisplay").textContent    = '‚Ç°' + envio.toLocaleString('es-CR');
    document.getElementById("vmTotalDisplay").textContent    = '‚Ç°' + total.toLocaleString('es-CR');
    // Actualizar subtotales en la tabla
    renderPrendasTable();
  }

  async function registrarVentaManual() {
    var nombre   = document.getElementById("vmNombre").value.trim();
    var telefono = document.getElementById("vmTelefono").value.trim();
    var metodo   = document.getElementById("vmMetodo").value;
    var pago     = document.getElementById("vmPago").value;
    var notas    = document.getElementById("vmNotas").value.trim();
    var factura  = document.getElementById("vmFactura").value.trim();
    var fechaFact= document.getElementById("vmFechaFactura").value;
    var total    = parseFloat(document.getElementById("vmTotal").value) || 0;

    if (!nombre) { showMsg("msgVentaManual","‚ö†Ô∏è Ingres√° el nombre del cliente","error"); return; }
    if (vmPrendas.length === 0) { showMsg("msgVentaManual","‚ö†Ô∏è Agreg√° al menos una prenda","error"); return; }
    var prendasValidas = vmPrendas.filter(function(p){ return p.producto && p.precio>0; });
    if (prendasValidas.length === 0) { showMsg("msgVentaManual","‚ö†Ô∏è Complet√° producto y precio en las prendas","error"); return; }

    var isEnvio       = metodo === 'envio';
    var direccion     = isEnvio ? document.getElementById("vmDireccion").value.trim() : '';
    var envioCosto    = isEnvio ? (parseFloat(document.getElementById("vmEnvioCosto").value)||0) : 0;
    var guia          = isEnvio ? document.getElementById("vmGuia").value.trim() : '';
    var fechaAlistado = isEnvio ? document.getElementById("vmFechaAlistado").value : '';
    var fechaEnvio    = isEnvio ? document.getElementById("vmFechaEnvio").value : '';
    var fechaEntregado= isEnvio ? document.getElementById("vmFechaEntregado").value : '';
    var estadoEnvio   = isEnvio ? document.getElementById("vmEstadoEnvio").value : 'alistado';
    var statusFinal   = fechaEntregado ? 'entregado' : fechaEnvio ? 'en_transito' : estadoEnvio;

    // Resumen de prendas para el campo producto/talla
    var subtotal      = vmPrendas.reduce(function(s,p){ return s+((p.cantidad||0)*(p.precio||0)); },0);
    var productoResumen = vmPrendas.map(function(p){ return (p.codigo?p.codigo+' - ':'')+p.producto+(p.talla_color?' ('+p.talla_color+')':'')+(p.cantidad>1?' x'+p.cantidad:''); }).join(' | ');
    var tallaResumen    = vmPrendas.map(function(p){ return p.talla_color||''; }).filter(Boolean).join(', ');
    var codigoResumen   = vmPrendas.map(function(p){ return p.codigo||''; }).filter(Boolean).join(', ');

    try {
      var body = {
        producto:     productoResumen,
        name:         nombre,
        phone:        telefono,
        talla_color:  tallaResumen,
        codigo:       codigoResumen,
        precio:       subtotal,
        shipping:     envioCosto,
        total:        total,
        method:       metodo,
        pago,
        notas:        (factura ? '# Factura: '+factura+' | ' : '') + (fechaFact ? 'Fecha fact: '+fechaFact+' | ' : '') + notas,
        envio_datos:  direccion,
        guia_correos: guia,
        fecha_alistado:  fechaAlistado,
        fecha_envio:     fechaEnvio,
        fecha_entregado: fechaEntregado,
        status:          statusFinal,
        // Datos estructurados de prendas
        prendas: vmPrendas.map(function(p){ return { codigo:p.codigo, producto:p.producto, talla_color:p.talla_color, cantidad:p.cantidad, precio:p.precio, subtotal:p.cantidad*p.precio }; }),
        factura:       factura,
        fecha_factura: fechaFact
      };
      var r = await fetch(BOT_URL + "/api/admin/sales/manual?pwd=" + BOT_PWD, {
        method:"POST", headers:{"Content-Type":"application/json"}, body:JSON.stringify(body)
      });
      var d = await r.json();
      if (d.success) {
        showMsg("msgVentaManual","‚úÖ Venta registrada ‚Äî ID: " + d.sale.id, "success");
        limpiarVentaManual();
        if (document.getElementById("seccion-ventas").style.display !== 'none') loadVentas();
    if (document.getElementById("seccion-likes") && document.getElementById("seccion-likes").style.display !== 'none') loadLikesStats();
      } else {
        showMsg("msgVentaManual", d.error || "Error al registrar", "error");
      }
    } catch(e) {
      showMsg("msgVentaManual","Error de conexi√≥n: " + e.message,"error");
    }
  }

  function limpiarVentaManual() {
    ["vmNombre","vmTelefono","vmFactura","vmFechaFactura",
     "vmEnvioCosto","vmDireccion","vmGuia",
     "vmFechaAlistado","vmFechaEnvio","vmFechaEntregado","vmNotas"
    ].forEach(function(id){ var el=document.getElementById(id); if(el) el.value=""; });
    document.getElementById("vmTotal").value = "";
    document.getElementById("vmTotalDisplay").textContent = "‚Ç°0";
    document.getElementById("vmSubtotalDisplay").textContent = "‚Ç°0";
    document.getElementById("vmEnvioDisplay").textContent = "‚Ç°0";
    document.getElementById("vmMetodo").selectedIndex = 0;
    document.getElementById("vmPago").selectedIndex = 0;
    document.getElementById("vmEnvioFields").classList.remove('show');
    vmPrendas = [];
    renderPrendasTable();
  }

  // Inicializar tabla vac√≠a al cargar
  document.addEventListener('DOMContentLoaded', function() {
    renderPrendasTable();
  });

  function formatPhone(p) { if (!p) return "?"; p = String(p).replace(/\D/g,""); if (p.length>8) p=p.slice(-8); return p.slice(0,4)+"-"+p.slice(4); }
  function escHtml(t) { return (t||"").replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;"); }
</script>
<!-- Modal de limpieza -->
<div id="purgeModal" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,0.4);z-index:9999;align-items:center;justify-content:center;">
  <div style="background:#fff;border-radius:14px;padding:28px 28px 24px;max-width:400px;width:92%;box-shadow:0 8px 32px rgba(0,0,0,0.18);">
    <div style="font-size:1rem;font-weight:700;margin-bottom:6px;">üóëÔ∏è Limpiar datos</div>
    <p style="font-size:0.82rem;color:#4b5563;margin-bottom:16px;" id="purgeDesc"></p>
    <div style="margin-bottom:16px;">
      <label style="font-size:0.72rem;font-weight:700;color:#6b7280;display:block;margin-bottom:6px;text-transform:uppercase;">Borrar todo hasta (incluyendo):</label>
      <input type="date" id="purgeDate" style="width:100%;padding:9px 12px;border:1.5px solid #e5e7eb;border-radius:8px;font-family:'DM Sans',sans-serif;font-size:0.9rem;">
    </div>
    <div style="background:#fff0f0;border:1px solid #fecaca;border-radius:8px;padding:10px 14px;font-size:0.78rem;color:#dc2626;margin-bottom:18px;">
      ‚ö†Ô∏è Esta acci√≥n es <strong>irreversible</strong>. Los datos eliminados no se pueden recuperar.
    </div>
    <div style="display:flex;gap:10px;justify-content:flex-end;">
      <button onclick="closePurgeModal()" style="padding:9px 18px;border:1px solid #e5e7eb;border-radius:8px;background:#fff;font-family:'DM Sans',sans-serif;font-size:0.82rem;font-weight:600;cursor:pointer;">Cancelar</button>
      <button onclick="executePurge()" style="padding:9px 18px;background:#dc2626;color:#fff;border:none;border-radius:8px;font-family:'DM Sans',sans-serif;font-size:0.82rem;font-weight:700;cursor:pointer;">Borrar datos</button>
    </div>
  </div>
</div>

<script>
var purgeTarget = null;
function showPurgeModal(target) {
  purgeTarget = target;
  const labels = { ventas:'ventas', chats:'conversaciones' };
  document.getElementById('purgeDesc').textContent = 'Se eliminar√°n todas las ' + (labels[target]||target) + ' anteriores a la fecha seleccionada (incluyendo ese d√≠a).';
  const d = new Date(); d.setDate(0);
  document.getElementById('purgeDate').value = d.toISOString().slice(0,10);
  document.getElementById('purgeModal').style.display = 'flex';
}
function closePurgeModal() {
  document.getElementById('purgeModal').style.display = 'none';
  purgeTarget = null;
}
async function executePurge() {
  const date = document.getElementById('purgeDate').value;
  if (!date) { alert('Seleccion√° una fecha'); return; }
  const cutoff = new Date(date); cutoff.setDate(cutoff.getDate()+1);
  const body = {
    beforeDate:    cutoff.toISOString(),
    purgeSales:    purgeTarget === 'ventas',
    purgeHistory:  purgeTarget === 'chats',
    purgeAlerts:   false,
    purgeSessions: purgeTarget === 'chats'
  };
  try {
    const r = await fetch(BOT_URL + '/api/admin/purge?pwd=' + BOT_PWD, {
      method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(body)
    });
    const d = await r.json();
    if (d.success) {
      const n = (d.salesDeleted||0) + (d.historyDeleted||0) + (d.sessionsDeleted||0);
      closePurgeModal();
      alert('‚úÖ Limpieza completada ‚Äî ' + n + ' registros eliminados');
      if (purgeTarget === 'ventas' || document.getElementById('seccion-ventas').style.display !== 'none') loadVentas();
    } else { alert('Error: ' + (d.error||'desconocido')); }
  } catch(e) { alert('Error de conexi√≥n: ' + e.message); }
}

  // ===== NUEVA VENTA (form toggle) =====
  var nvMetodo = 'envio';
  function toggleNuevaVenta() {
    var form = document.getElementById('nuevaVentaForm');
    var btn = document.getElementById('btnNuevaVenta');
    if (form.style.display === 'none') {
      form.style.display = 'block';
      btn.textContent = '‚úï Cancelar';
      btn.style.background = '#6b7280';
    } else {
      form.style.display = 'none';
      btn.textContent = '+ Nueva venta';
      btn.style.background = 'var(--green)';
    }
  }
  function setNVMetodo(m) {
    nvMetodo = m;
    var eBtn = document.getElementById('nvtE');
    var rBtn = document.getElementById('nvtR');
    eBtn.style.borderColor = m==='envio' ? 'var(--green)' : 'var(--border)';
    eBtn.style.background  = m==='envio' ? '#f0fdf4' : '#fff';
    eBtn.style.color       = m==='envio' ? '#166534' : 'var(--muted)';
    rBtn.style.borderColor = m==='recoger' ? 'var(--green)' : 'var(--border)';
    rBtn.style.background  = m==='recoger' ? '#f0fdf4' : '#fff';
    rBtn.style.color       = m==='recoger' ? '#166534' : 'var(--muted)';
    document.getElementById('nvEnvioDiv').style.display = m==='envio' ? '' : 'none';
    document.getElementById('nvDirDiv').style.display   = m==='envio' ? '' : 'none';
  }
  function calcNVTotal() {
    var p = parseInt(document.getElementById('nvPrecio').value)||0;
    var e = parseInt(document.getElementById('nvEnvio').value)||0;
    document.getElementById('nvTotalDisplay').textContent = '‚Ç°' + (p+(nvMetodo==='envio'?e:0)).toLocaleString('es-CR');
  }
  async function guardarNuevaVenta() {
    var prod = (document.getElementById('nvProducto').value||'').trim();
    var prec = parseInt(document.getElementById('nvPrecio').value)||0;
    if (!prod || !prec) { showMsg('msgNuevaVenta','‚ö†Ô∏è Producto y precio son obligatorios','error'); return; }
    var body = {
      producto: prod,
      precio: prec,
      talla_color: (document.getElementById('nvTalla').value||'').trim(),
      method: nvMetodo,
      shipping: nvMetodo==='envio' ? (parseInt(document.getElementById('nvEnvio').value)||0) : 0,
      name: (document.getElementById('nvNombre').value||'').trim(),
      phone: (document.getElementById('nvTelefono').value||'').replace(/\D/g,''),
      envio_datos: (document.getElementById('nvDireccion').value||'').trim(),
      sinpe_reference: (document.getElementById('nvSinpe').value||'').trim(),
      notas: (document.getElementById('nvNotas').value||'').trim()
    };
    try {
      var r = await fetch(BOT_URL + '/api/admin/sales/manual?pwd=' + BOT_PWD, {
        method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(body)
      });
      var d = await r.json();
      if (d.success) {
        showMsg('msgNuevaVenta','‚úÖ Venta registrada correctamente','success');
        ['nvNombre','nvTelefono','nvProducto','nvTalla','nvPrecio','nvEnvio','nvDireccion','nvSinpe','nvNotas'].forEach(function(id){ var el=document.getElementById(id); if(el) el.value=''; });
        document.getElementById('nvTotalDisplay').textContent = '‚Ç°0';
        toggleNuevaVenta();
        loadVentas();
      } else { showMsg('msgNuevaVenta','‚ùå Error: '+(d.error||'desconocido'),'error'); }
    } catch(e) { showMsg('msgNuevaVenta','‚ùå Error de conexi√≥n: '+e.message,'error'); }
  }

  // ===== CONTACTOS =====
  var allContactosAdmin = [];
  async function loadContactosAdmin() {
    try {
      var r = await fetch(BOT_URL + '/api/admin/contacts?pwd=' + BOT_PWD);
      var d = await r.json();
      allContactosAdmin = d.contacts || [];
      document.getElementById('ctTotalLbl').textContent = allContactosAdmin.length + ' contactos';
      renderTopContactos();
      renderContactosAdmin();
    } catch(e) {
      showMsg('msgContactos','Error de conexion: ' + e.message,'error');
    }
  }
  function renderTopContactos() {
    var top = allContactosAdmin.filter(function(c){ return (c.purchases||0)>0; }).slice(0,20);
    var el = document.getElementById('ctTopList');
    if (!top.length) { el.innerHTML = '<div style="color:var(--muted);font-size:.82rem;">Sin compras registradas</div>'; return; }
    el.innerHTML = top.map(function(c,i){
      var medal = i===0?'(1)':i===1?'(2)':i===2?'(3)':(i+1)+'.';
      return '<div style="display:flex;align-items:center;gap:8px;padding:6px 0;border-bottom:1px solid var(--border);">'
        + '<span style="font-size:.85rem;min-width:20px;">' + medal + '</span>'
        + '<div style="flex:1;min-width:0;"><div style="font-size:.85rem;font-weight:600;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">' + esc(c.name||c.waId||'-') + '</div>'
        + '<div style="font-size:.72rem;color:var(--muted);">' + (c.waId||'') + '</div></div>'
        + '<div style="font-size:.8rem;font-weight:700;color:var(--green);text-align:right;">' + (c.purchases||0) + ' compras<br>&#8353;' + (c.total_spent||0).toLocaleString('es-CR') + '</div>'
        + '</div>';
    }).join('');
  }
  function renderContactosAdmin() {
    var sr = (document.getElementById('ctSearch')?.value||'').toLowerCase();
    var list = allContactosAdmin.filter(function(c){ return !sr||(c.name||'').toLowerCase().includes(sr)||(c.waId||'').includes(sr); });
    var el = document.getElementById('ctList');
    if (!list.length) { el.innerHTML = '<div style="text-align:center;color:var(--muted);padding:24px;">Sin contactos</div>'; return; }
    var colors = ['#075E54','#128C7E','#2c6e49','#1565c0','#6a1b9a'];
    el.innerHTML = list.map(function(c){
      var col = colors[(c.waId||'x').charCodeAt((c.waId||'x').length-1)%5];
      var ini = (c.name||c.waId||'?').slice(0,2).toUpperCase();
      var wid = (c.waId||'').replace(/'/g, "\\'");
      var html = '<div style="display:flex;align-items:center;gap:10px;padding:10px;background:#fff;border:1px solid var(--border);border-radius:8px;margin-bottom:6px;">';
      html += '<div style="width:36px;height:36px;border-radius:50%;background:'+col+';color:#fff;display:flex;align-items:center;justify-content:center;font-weight:700;font-size:.82rem;flex-shrink:0;">'+ini+'</div>';
      html += '<div style="flex:1;min-width:0;">';
      html += '<div style="font-weight:600;font-size:.88rem;">' + esc(c.name||'-') + (c.botDisabled ? '<span style="font-size:.68rem;background:#fff8e1;color:#f57f17;border:1px solid #ffe082;border-radius:8px;padding:1px 6px;margin-left:4px;">solo humano</span>' : '') + '</div>';
      html += '<div style="font-size:.75rem;color:var(--muted);">' + (c.waId||c.phone||'') + '  -  ' + (c.purchases||0) + ' compras  -  CRC ' + (c.total_spent||0).toLocaleString('es-CR') + '</div>';
      if (c.notes) html += '<div style="font-size:.72rem;color:var(--muted);">'+esc(c.notes)+'</div>';
      html += '</div>';
      html += '<div style="display:flex;gap:5px;">';
      html += '<button onclick="openAddContactAdmin(\'' + wid + '\')" style="background:none;border:1px solid var(--border);border-radius:6px;padding:5px 8px;cursor:pointer;font-size:.82rem;">editar</button>';
      html += '<button onclick="deleteContactAdmin(\'' + wid + '\')" style="background:none;border:1px solid #fecaca;border-radius:6px;padding:5px 8px;cursor:pointer;font-size:.82rem;color:var(--red);">borrar</button>';
      html += '</div></div>';
      return html;
    }).join('');
  }

  function openAddContactAdmin(waId) {
    var c = waId ? allContactosAdmin.find(function(x){ return x.waId===waId; }) : null;
    document.getElementById('ctModalTitle').textContent = c ? '‚úèÔ∏è Editar Contacto' : 'üë§ Agregar Contacto';
    document.getElementById('ctEditId').value = waId||'';
    document.getElementById('ctEditN').value = c?.name||'';
    document.getElementById('ctEditTel').value = c?.waId||c?.phone||'';
    document.getElementById('ctEditNt').value = c?.notes||'';
    var bd = c?.botDisabled || false;
    document.getElementById('ctEditBotDisabled').checked = bd;
    toggleBDSlider(bd);
    var modal = document.getElementById('ctModal');
    modal.style.display = 'flex';
  }
  function closeAddContactAdmin() { document.getElementById('ctModal').style.display = 'none'; }
  function toggleBDSlider(on) {
    document.getElementById('ctBDSlider').style.background = on ? '#f57f17' : '#ccc';
    document.getElementById('ctBDThumb').style.left = on ? '23px' : '3px';
  }
  async function saveContactAdmin() {
    var tel = (document.getElementById('ctEditTel').value||'').replace(/\D/g,'');
    if (!tel) { alert('Tel√©fono requerido'); return; }
    var editId = document.getElementById('ctEditId').value;
    var waId = editId||tel;
    try {
      var r = await fetch(BOT_URL + '/api/admin/contacts?pwd=' + BOT_PWD, {
        method:'POST', headers:{'Content-Type':'application/json'},
        body: JSON.stringify({ waId:waId, name:document.getElementById('ctEditN').value.trim(), phone:tel, notes:document.getElementById('ctEditNt').value.trim(), botDisabled:document.getElementById('ctEditBotDisabled').checked })
      });
      if (r.ok) { closeAddContactAdmin(); await loadContactosAdmin(); showMsg('msgContactos','‚úÖ Contacto guardado','success'); }
      else { alert('Error al guardar'); }
    } catch(e) { alert('Error: '+e.message); }
  }
  async function deleteContactAdmin(waId) {
    if (!confirm('¬øEliminar este contacto?')) return;
    try {
      var r = await fetch(BOT_URL + '/api/admin/contacts/' + encodeURIComponent(waId) + '?pwd=' + BOT_PWD, { method:'DELETE' });
      if (r.ok) { await loadContactosAdmin(); showMsg('msgContactos','üóëÔ∏è Eliminado','success'); }
      else { alert('Error al eliminar'); }
    } catch(e) { alert('Error: '+e.message); }
  }

</script>

<!-- Preview foto grande admin -->
<div id="sortImgOverlay" onclick="this.style.display='none'" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,0.88);z-index:9999;align-items:center;justify-content:center;cursor:zoom-out;">
  <img id="sortImgBig" src="" style="max-width:90vw;max-height:90vh;object-fit:contain;border-radius:10px;box-shadow:0 8px 40px rgba(0,0,0,0.6);">
  <div style="position:absolute;top:16px;right:20px;color:#fff;font-size:1.8rem;cursor:pointer;opacity:0.7;" onclick="document.getElementById('sortImgOverlay').style.display='none'">‚úï</div>
</div>

</body>
</html>
