<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="theme-color" content="#1a1f25">
  <title>TICObot üêÑ</title>
  <style>
    :root {
      --primary: #1a1f25;
      --primary-light: #25D366;
      --bg: #f0f2f5;
      --card: #fff;
      --text: #1a1f25;
      --text-muted: #667781;
      --danger: #E74C3C;
      --success: #25D366;
      --warning: #F39C12;
      --action-bg: #fff3cd;
      --action-border: #ffc107;
      --sinpe-bg: #e3f2fd;
      --sinpe-border: #2196f3;
    }
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: var(--bg); color: var(--text); height: 100vh; overflow: hidden; }

    /* ===== LOGIN ===== */
    #login { position: fixed; inset: 0; background: var(--primary); display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 2rem; z-index: 1000; }
    #login.hidden { display: none; }
    .login-title { color: #fff; font-size: 2.5rem; font-weight: 700; margin-bottom: 0.5rem; }
    .login-subtitle { color: rgba(255,255,255,0.6); margin-bottom: 2rem; }
    .pin-box { display: flex; gap: 0.75rem; margin-bottom: 1.5rem; }
    .pin-digit { width: 55px; height: 65px; font-size: 1.8rem; text-align: center; border: 2px solid rgba(255,255,255,0.2); border-radius: 12px; background: rgba(255,255,255,0.05); color: #fff; outline: none; }
    .pin-digit:focus { border-color: var(--primary-light); }
    .login-btn { background: var(--primary-light); color: #fff; border: none; padding: 1rem 3rem; font-size: 1.1rem; font-weight: 600; border-radius: 25px; cursor: pointer; }
    .login-btn:disabled { opacity: 0.5; }
    .login-error { color: #FF6B6B; margin-top: 1rem; }

    /* ===== MAIN LAYOUT ===== */
    #app { display: none; height: 100vh; }
    #app.active { display: flex; flex-direction: column; }

    /* Header */
    .header { background: var(--primary); color: #fff; padding: 0.6rem 1rem; display: flex; justify-content: space-between; align-items: center; }
    .header-left { display: flex; align-items: center; gap: 0.8rem; }
    .header-title { font-size: 1.1rem; font-weight: 700; }
    .conn-badge { padding: 0.2rem 0.5rem; border-radius: 12px; font-size: 0.65rem; font-weight: 700; }
    .conn-badge.on { background: var(--success); }
    .conn-badge.off { background: var(--danger); cursor: pointer; }
    .conn-badge.wait { background: var(--warning); }
    .header-right { display: flex; align-items: center; gap: 0.5rem; }
    .bot-toggle { padding: 0.3rem 0.6rem; border-radius: 12px; font-size: 0.75rem; font-weight: 600; border: none; cursor: pointer; }
    .bot-toggle.active { background: var(--success); color: #fff; }
    .bot-toggle.paused { background: var(--warning); color: #fff; }
    .notif-btn { background: rgba(255,255,255,0.15); border: none; color: #fff; padding: 0.3rem 0.6rem; border-radius: 8px; font-size: 0.8rem; cursor: pointer; }
    .notif-btn.enabled { background: var(--success); }

    /* Main container */
    .main-container { flex: 1; display: flex; overflow: hidden; }

    /* Sidebar - Lista de chats */
    .sidebar { width: 320px; background: #fff; border-right: 1px solid #e0e0e0; display: flex; flex-direction: column; }
    .sidebar-header { padding: 0.8rem; border-bottom: 1px solid #e0e0e0; }
    .search-input { width: 100%; padding: 0.6rem 1rem; border: none; border-radius: 20px; background: var(--bg); font-size: 0.9rem; outline: none; }
    .chat-list { flex: 1; overflow-y: auto; }
    .chat-item { display: flex; align-items: center; gap: 0.8rem; padding: 0.8rem 1rem; cursor: pointer; border-bottom: 1px solid #f0f0f0; transition: background 0.2s; }
    .chat-item:hover { background: #f5f5f5; }
    .chat-item.active { background: #e8f5e9; }
    .chat-item.has-action { background: #fff8e1; }
    .chat-avatar { width: 45px; height: 45px; border-radius: 50%; background: var(--primary-light); color: #fff; display: flex; align-items: center; justify-content: center; font-weight: 700; font-size: 0.9rem; position: relative; flex-shrink: 0; }
    .chat-avatar .badge { position: absolute; top: -2px; right: -2px; width: 18px; height: 18px; background: var(--danger); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 0.6rem; color: #fff; border: 2px solid #fff; }
    .chat-info { flex: 1; min-width: 0; }
    .chat-name { font-weight: 600; font-size: 0.95rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .chat-preview { font-size: 0.8rem; color: var(--text-muted); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .chat-meta { text-align: right; flex-shrink: 0; }
    .chat-time { font-size: 0.7rem; color: var(--text-muted); }
    .chat-action-icon { font-size: 1rem; margin-top: 0.2rem; }

    /* Chat area */
    .chat-area { flex: 1; display: flex; flex-direction: column; background: #e5ddd5; }
    .chat-area.empty { align-items: center; justify-content: center; }
    .empty-chat { text-align: center; color: var(--text-muted); }
    .empty-chat-icon { font-size: 4rem; margin-bottom: 1rem; opacity: 0.5; }
    .empty-chat-text { font-size: 1.1rem; }

    /* Chat header */
    .chat-header { background: #fff; padding: 0.6rem 1rem; display: flex; align-items: center; gap: 0.8rem; border-bottom: 1px solid #e0e0e0; }
    .chat-header-back { display: none; background: none; border: none; font-size: 1.3rem; cursor: pointer; padding: 0.3rem; }
    .chat-header-avatar { width: 40px; height: 40px; border-radius: 50%; background: var(--primary-light); color: #fff; display: flex; align-items: center; justify-content: center; font-weight: 700; }
    .chat-header-info { flex: 1; }
    .chat-header-name { font-weight: 600; }
    .chat-header-status { font-size: 0.75rem; color: var(--text-muted); }
    .chat-header-actions { display: flex; gap: 0.5rem; }
    .chat-header-btn { background: var(--bg); border: none; padding: 0.4rem 0.6rem; border-radius: 8px; cursor: pointer; font-size: 0.8rem; }

    /* Messages */
    .messages-container { flex: 1; overflow-y: auto; padding: 1rem; display: flex; flex-direction: column; gap: 0.3rem; }
    .message { max-width: 70%; padding: 0.5rem 0.8rem; border-radius: 10px; font-size: 0.9rem; position: relative; }
    .message.in { background: #fff; align-self: flex-start; border-bottom-left-radius: 4px; }
    .message.out { background: #d9fdd3; align-self: flex-end; border-bottom-right-radius: 4px; }
    .message-text { word-wrap: break-word; }
    .message-time { font-size: 0.65rem; color: var(--text-muted); text-align: right; margin-top: 0.2rem; }

    /* Action cards inside chat */
    .action-card { background: var(--action-bg); border: 2px solid var(--action-border); border-radius: 12px; padding: 1rem; margin: 0.5rem 0; align-self: center; width: 90%; max-width: 400px; }
    .action-card.sinpe { background: var(--sinpe-bg); border-color: var(--sinpe-border); }
    .action-card-header { display: flex; align-items: center; gap: 0.5rem; font-weight: 700; margin-bottom: 0.8rem; font-size: 0.9rem; }
    .action-card-icon { font-size: 1.2rem; }
    .action-card-details { background: rgba(255,255,255,0.7); padding: 0.6rem; border-radius: 8px; font-size: 0.85rem; margin-bottom: 0.8rem; }
    .action-card-detail { margin-bottom: 0.3rem; }
    .action-card-buttons { display: flex; gap: 0.5rem; }
    .action-btn { flex: 1; padding: 0.7rem; border: none; border-radius: 8px; font-weight: 600; font-size: 0.85rem; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 0.3rem; }
    .action-btn:disabled { opacity: 0.5; cursor: not-allowed; }
    .action-btn.primary { background: var(--success); color: #fff; }
    .action-btn.danger { background: var(--danger); color: #fff; }
    .action-btn.info { background: #2196f3; color: #fff; }
    .action-resolved { text-align: center; padding: 0.5rem; font-weight: 600; color: var(--text-muted); }

    /* Chat input */
    .chat-input-area { background: #fff; padding: 0.6rem 1rem; display: flex; gap: 0.5rem; align-items: center; }
    .chat-input { flex: 1; padding: 0.7rem 1rem; border: none; border-radius: 20px; background: var(--bg); font-size: 0.95rem; outline: none; }
    .chat-send-btn { width: 42px; height: 42px; border-radius: 50%; background: var(--primary-light); border: none; color: #fff; font-size: 1.2rem; cursor: pointer; display: flex; align-items: center; justify-content: center; }

    /* QR Section */
    .qr-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.8); display: none; align-items: center; justify-content: center; z-index: 200; }
    .qr-overlay.active { display: flex; }
    .qr-modal { background: #fff; padding: 2rem; border-radius: 16px; text-align: center; max-width: 350px; }
    .qr-modal img { width: 220px; height: 220px; margin: 1rem 0; }
    .qr-instructions { color: var(--text-muted); font-size: 0.9rem; line-height: 1.5; }
    .qr-close { margin-top: 1rem; background: var(--danger); color: #fff; border: none; padding: 0.6rem 1.5rem; border-radius: 20px; cursor: pointer; }

    /* Shipping Modal */
    .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.6); display: none; align-items: center; justify-content: center; z-index: 200; }
    .modal-overlay.active { display: flex; }
    .modal { background: #fff; padding: 1.5rem; border-radius: 16px; width: 90%; max-width: 400px; }
    .modal-title { font-size: 1.2rem; font-weight: 700; text-align: center; margin-bottom: 1rem; }
    .modal-info { background: var(--bg); padding: 0.8rem; border-radius: 10px; margin-bottom: 1rem; }
    .modal-info-row { display: flex; justify-content: space-between; margin-bottom: 0.3rem; font-size: 0.9rem; }
    .modal-input { width: 100%; padding: 1rem; font-size: 1.3rem; font-weight: 700; border: 2px solid var(--bg); border-radius: 12px; text-align: center; outline: none; }
    .modal-input:focus { border-color: var(--primary-light); }
    .quick-prices { display: grid; grid-template-columns: repeat(3, 1fr); gap: 0.4rem; margin: 1rem 0; }
    .quick-price { padding: 0.6rem; background: var(--bg); border: none; border-radius: 8px; font-weight: 600; cursor: pointer; }
    .quick-price:hover { background: var(--primary-light); color: #fff; }
    .modal-buttons { display: flex; gap: 0.5rem; }
    .modal-btn { flex: 1; padding: 0.8rem; border: none; border-radius: 10px; font-weight: 600; cursor: pointer; }
    .modal-btn.cancel { background: var(--bg); }
    .modal-btn.confirm { background: var(--primary-light); color: #fff; }
    .modal-btn.danger { background: var(--danger); color: #fff; margin-top: 0.5rem; width: 100%; }

    /* Toast */
    .toast { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%) translateY(100px); background: #333; color: #fff; padding: 0.8rem 1.5rem; border-radius: 25px; opacity: 0; transition: all 0.3s; z-index: 300; }
    .toast.show { transform: translateX(-50%) translateY(0); opacity: 1; }
    .toast.success { background: var(--success); }
    .toast.error { background: var(--danger); }

    /* Responsive */
    @media (max-width: 768px) {
      .sidebar { width: 100%; position: absolute; inset: 0; z-index: 10; display: flex; }
      .sidebar.hidden { display: none; }
      .chat-area { position: absolute; inset: 0; z-index: 20; display: none; }
      .chat-area.active { display: flex; }
      .chat-header-back { display: block; }
      .main-container { position: relative; }
    }
  </style>
</head>
<body>
  <!-- LOGIN -->
  <div id="login">
    <div class="login-title">üêÑ TICObot</div>
    <p class="login-subtitle">Ingres√° tu PIN</p>
    <div class="pin-box">
      <input type="tel" class="pin-digit" maxlength="1" inputmode="numeric">
      <input type="tel" class="pin-digit" maxlength="1" inputmode="numeric">
      <input type="tel" class="pin-digit" maxlength="1" inputmode="numeric">
      <input type="tel" class="pin-digit" maxlength="1" inputmode="numeric">
    </div>
    <button class="login-btn" id="loginBtn" disabled>Entrar</button>
    <p class="login-error" id="loginError"></p>
  </div>

  <!-- APP -->
  <div id="app">
    <!-- Header -->
    <div class="header">
      <div class="header-left">
        <span class="header-title">üêÑ TICObot</span>
        <span class="conn-badge off" id="connBadge" onclick="showQR()">CONECTAR</span>
      </div>
      <div class="header-right">
        <button class="notif-btn" id="notifBtn" onclick="requestNotifications()">üîî</button>
        <button class="bot-toggle active" id="botToggle">‚ñ∂Ô∏è Bot</button>
      </div>
    </div>

    <!-- Main -->
    <div class="main-container">
      <!-- Sidebar -->
      <div class="sidebar" id="sidebar">
        <div class="sidebar-header">
          <input type="text" class="search-input" id="searchInput" placeholder="üîç Buscar chat...">
        </div>
        <div class="chat-list" id="chatList">
          <!-- Chats se renderizan aqu√≠ -->
        </div>
      </div>

      <!-- Chat Area -->
      <div class="chat-area empty" id="chatArea">
        <div class="empty-chat">
          <div class="empty-chat-icon">üí¨</div>
          <div class="empty-chat-text">Seleccion√° un chat para empezar</div>
        </div>
      </div>
    </div>
  </div>

  <!-- QR Modal -->
  <div class="qr-overlay" id="qrOverlay">
    <div class="qr-modal">
      <h3>üì± Conectar WhatsApp</h3>
      <div id="qrContent">
        <p class="qr-instructions">Cargando...</p>
      </div>
      <button class="qr-close" onclick="hideQR()">Cerrar</button>
    </div>
  </div>

  <!-- Shipping Modal -->
  <div class="modal-overlay" id="shippingModal">
    <div class="modal">
      <div class="modal-title">üì¶ Costo de Env√≠o</div>
      <div class="modal-info">
        <div class="modal-info-row"><span>üì± Cliente:</span><span id="shipClient">-</span></div>
        <div class="modal-info-row"><span>üìç Zona:</span><span id="shipZone">-</span></div>
        <div class="modal-info-row"><span>üí∞ Producto:</span><span id="shipPrice">-</span></div>
      </div>
      <input type="number" class="modal-input" id="shipInput" placeholder="‚Ç°0" inputmode="numeric">
      <div class="quick-prices">
        <button class="quick-price" onclick="setShip(2000)">‚Ç°2,000</button>
        <button class="quick-price" onclick="setShip(2500)">‚Ç°2,500</button>
        <button class="quick-price" onclick="setShip(3000)">‚Ç°3,000</button>
        <button class="quick-price" onclick="setShip(3500)">‚Ç°3,500</button>
        <button class="quick-price" onclick="setShip(4000)">‚Ç°4,000</button>
        <button class="quick-price" onclick="setShip(5000)">‚Ç°5,000</button>
      </div>
      <div class="modal-buttons">
        <button class="modal-btn cancel" onclick="hideShipModal()">Cancelar</button>
        <button class="modal-btn confirm" onclick="sendShipping()">Enviar ‚úì</button>
      </div>
      <button class="modal-btn danger" onclick="noShipping()">üö´ No env√≠o a esa zona</button>
    </div>
  </div>

  <!-- Toast -->
  <div class="toast" id="toast"></div>

  <!-- Audio for notifications -->
  <audio id="notifSound" preload="auto">
    <source src="data:audio/mp3;base64,SUQzBAAAAAAAI1RTU0UAAAAPAAADTGF2ZjU4Ljc2LjEwMAAAAAAAAAAAAAAA//tQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAWGluZwAAAA8AAAACAAABhgC7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7//////////////////////////////////////////////////////////////////8AAAAATGF2YzU4LjEzAAAAAAAAAAAAAAAAJAAAAAAAAAAAAYYNBrv4AAAAAAAAAAAAAAAAAAAAAP/7UGQAD/AAADSAAAAAAgAANIAAAAQAAAGkAAAAIAAANIAAAARMQU1FMy4xMDBVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVV//tQZB4P8AAAaQAAAAgAAA0gAAABAAABpAAAACAAADSAAAAEVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVQ==" type="audio/mpeg">
  </audio>

  <script src="/socket.io/socket.io.js"></script>
  <script>
    // ===== GLOBALS =====
    let socket, currentChat = null, shipClient = null;
    let chats = {}, pending = {}, contacts = {};
    let notificationsEnabled = false;

    const $ = id => document.getElementById(id);
    const $$ = sel => document.querySelectorAll(sel);

    // ===== HELPERS =====
    function formatPhone(w) {
      const d = String(w).replace(/\D/g, '');
      return d.length === 11 && d.startsWith('506') ? d.slice(0,3) + ' ' + d.slice(3,7) + '-' + d.slice(7) : w;
    }
    function timeAgo(d) {
      if (!d) return '';
      const s = Math.floor((Date.now() - new Date(d)) / 1000);
      if (s < 60) return 'ahora';
      if (s < 3600) return Math.floor(s/60) + 'm';
      if (s < 86400) return Math.floor(s/3600) + 'h';
      return Math.floor(s/86400) + 'd';
    }
    function escapeHtml(t) {
      return String(t || '').replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
    }
    function toast(msg, type = '') {
      const t = $('toast');
      t.textContent = msg;
      t.className = 'toast show ' + type;
      setTimeout(() => t.classList.remove('show'), 3000);
    }
    function playSound() {
      try { $('notifSound').play(); } catch(e) {}
    }

    // ===== NOTIFICATIONS =====
    function requestNotifications() {
      if (!('Notification' in window)) {
        toast('Tu navegador no soporta notificaciones', 'error');
        return;
      }
      Notification.requestPermission().then(perm => {
        if (perm === 'granted') {
          notificationsEnabled = true;
          $('notifBtn').classList.add('enabled');
          toast('üîî Notificaciones activadas', 'success');
        } else {
          toast('Notificaciones denegadas', 'error');
        }
      });
    }
    function showNotification(title, body) {
      if (notificationsEnabled && Notification.permission === 'granted') {
        new Notification(title, { body, icon: 'üêÑ' });
      }
      playSound();
    }

    // ===== LOGIN =====
    const pins = $$('.pin-digit');
    pins.forEach((p, i) => {
      p.addEventListener('input', e => {
        if (e.target.value && i < 3) pins[i+1].focus();
        $('loginBtn').disabled = getPin().length !== 4;
      });
      p.addEventListener('keydown', e => {
        if (e.key === 'Backspace' && !e.target.value && i > 0) pins[i-1].focus();
      });
    });
    function getPin() { return Array.from(pins).map(p => p.value).join(''); }

    $('loginBtn').onclick = () => connect(getPin());
    const savedPin = localStorage.getItem('ticobot_pin');
    if (savedPin) connect(savedPin);
    else pins[0].focus();

    // ===== SOCKET CONNECTION =====
    function connect(pin) {
      socket = io();
      socket.on('connect', () => socket.emit('auth', pin));
      socket.on('auth_success', () => {
        localStorage.setItem('ticobot_pin', pin);
        $('login').classList.add('hidden');
        $('app').classList.add('active');
        toast('‚úÖ Conectado', 'success');
        // Check notification permission
        if (Notification.permission === 'granted') {
          notificationsEnabled = true;
          $('notifBtn').classList.add('enabled');
        }
      });
      socket.on('auth_error', msg => {
        $('loginError').textContent = msg;
        pins.forEach(p => p.value = '');
        pins[0].focus();
        localStorage.removeItem('ticobot_pin');
      });

      // Connection status
      socket.on('connection_status', data => {
        const badge = $('connBadge');
        if (data.status === 'connected') {
          badge.className = 'conn-badge on';
          badge.textContent = 'üü¢ CONECTADO';
          badge.onclick = null;
          hideQR();
        } else if (data.status === 'qr' || data.status === 'connecting') {
          badge.className = 'conn-badge wait';
          badge.textContent = 'üü° CONECTANDO';
        } else {
          badge.className = 'conn-badge off';
          badge.textContent = 'üî¥ CONECTAR';
          badge.onclick = showQR;
        }
      });

      // QR Code
      socket.on('qr_code', data => {
        $('qrContent').innerHTML = `<img src="${data.qr}" alt="QR"><p class="qr-instructions">1. Abr√≠ WhatsApp<br>2. ‚ãÆ ‚Üí Dispositivos vinculados<br>3. Escane√° el QR</p>`;
      });

      // Bot status
      socket.on('bot_status', data => {
        const btn = $('botToggle');
        if (data.paused) {
          btn.textContent = '‚è∏Ô∏è Pausado';
          btn.className = 'bot-toggle paused';
        } else {
          btn.textContent = '‚ñ∂Ô∏è Bot';
          btn.className = 'bot-toggle active';
        }
      });

      // Init data
      socket.on('init_data', data => {
        // Process history into chats
        chats = {};
        (data.history || []).forEach(m => {
          if (!chats[m.waId]) chats[m.waId] = { messages: [], pending: null };
          chats[m.waId].messages.push(m);
        });
        // Process pending
        (data.pending || []).forEach(p => {
          if (!chats[p.waId]) chats[p.waId] = { messages: [], pending: null };
          chats[p.waId].pending = p;
        });
        // Contacts
        (data.contacts || []).forEach(c => contacts[c.waId] = c);
        renderChatList();
      });

      // New message
      socket.on('new_message', msg => {
        if (!chats[msg.waId]) chats[msg.waId] = { messages: [], pending: null };
        chats[msg.waId].messages.push(msg);
        renderChatList();
        if (currentChat === msg.waId) renderChat();
        if (msg.direction === 'in') {
          showNotification('üì• Nuevo mensaje', msg.text?.slice(0, 50) || 'Mensaje recibido');
        }
      });

      // New pending (stock query)
      socket.on('new_pending', item => {
        if (!chats[item.waId]) chats[item.waId] = { messages: [], pending: null };
        chats[item.waId].pending = item;
        renderChatList();
        if (currentChat === item.waId) renderChat();
        showNotification('üì• Nueva consulta', `${item.producto || 'Producto'} - ${formatPhone(item.waId)}`);
      });

      // SINPE received
      socket.on('sinpe_received', data => {
        if (!chats[data.waId]) chats[data.waId] = { messages: [], pending: null };
        chats[data.waId].pending = { ...data, tipo: 'sinpe' };
        renderChatList();
        if (currentChat === data.waId) renderChat();
        showNotification('üí∞ SINPE recibido', formatPhone(data.waId));
      });

      // Zone received - show shipping modal
      socket.on('zone_received', data => {
        shipClient = data.waId;
        $('shipClient').textContent = formatPhone(data.waId);
        $('shipZone').textContent = data.zone || '-';
        $('shipPrice').textContent = '‚Ç°' + (data.precio || 0).toLocaleString();
        $('shipInput').value = '';
        $('shippingModal').classList.add('active');
        showNotification('üìç Zona recibida', data.zone);
      });

      // Pending resolved
      socket.on('pending_resolved', data => {
        if (chats[data.waId]) {
          chats[data.waId].pending = null;
        }
        renderChatList();
        if (currentChat === data.waId) renderChat();
      });

      // Action result
      socket.on('action_result', r => {
        toast(r.success ? '‚úÖ ' + r.message : '‚ùå ' + r.message, r.success ? 'success' : 'error');
        hideShipModal();
      });

      // Contacts
      socket.on('contacts_list', data => {
        (data.contacts || []).forEach(c => contacts[c.waId] = c);
      });
    }

    // ===== QR =====
    function showQR() {
      $('qrOverlay').classList.add('active');
      socket.emit('connect_whatsapp');
    }
    function hideQR() {
      $('qrOverlay').classList.remove('active');
    }

    // ===== RENDER CHAT LIST =====
    function renderChatList() {
      const list = $('chatList');
      const filter = $('searchInput').value.toLowerCase();
      
      // Sort by last message time, pending first
      const sorted = Object.keys(chats).sort((a, b) => {
        const ap = chats[a].pending ? 1 : 0;
        const bp = chats[b].pending ? 1 : 0;
        if (ap !== bp) return bp - ap;
        const aLast = chats[a].messages[chats[a].messages.length - 1];
        const bLast = chats[b].messages[chats[b].messages.length - 1];
        return new Date(bLast?.timestamp || 0) - new Date(aLast?.timestamp || 0);
      });

      list.innerHTML = sorted.filter(waId => {
        if (!filter) return true;
        const c = contacts[waId];
        return waId.includes(filter) || (c?.name || '').toLowerCase().includes(filter);
      }).map(waId => {
        const chat = chats[waId];
        const last = chat.messages[chat.messages.length - 1];
        const contact = contacts[waId];
        const name = contact?.name || formatPhone(waId);
        const hasPending = !!chat.pending;
        const isSinpe = chat.pending?.tipo === 'sinpe';
        const actionIcon = isSinpe ? 'üí∞' : hasPending ? 'üîî' : '';
        
        return `
          <div class="chat-item ${currentChat === waId ? 'active' : ''} ${hasPending ? 'has-action' : ''}" onclick="openChat('${waId}')">
            <div class="chat-avatar">
              ${waId.slice(-2).toUpperCase()}
              ${hasPending ? `<span class="badge">${actionIcon || '!'}</span>` : ''}
            </div>
            <div class="chat-info">
              <div class="chat-name">${escapeHtml(name)}</div>
              <div class="chat-preview">${escapeHtml(last?.text?.slice(0, 35) || '')}</div>
            </div>
            <div class="chat-meta">
              <div class="chat-time">${timeAgo(last?.timestamp)}</div>
              ${hasPending ? `<div class="chat-action-icon">${actionIcon}</div>` : ''}
            </div>
          </div>
        `;
      }).join('');
    }

    $('searchInput').oninput = renderChatList;

    // ===== OPEN/RENDER CHAT =====
    function openChat(waId) {
      currentChat = waId;
      renderChatList();
      renderChat();
      
      // Mobile: show chat area
      $('sidebar').classList.add('hidden');
      $('chatArea').classList.add('active');
      $('chatArea').classList.remove('empty');
    }

    function renderChat() {
      if (!currentChat || !chats[currentChat]) return;
      
      const chat = chats[currentChat];
      const contact = contacts[currentChat];
      const name = contact?.name || formatPhone(currentChat);
      
      $('chatArea').innerHTML = `
        <div class="chat-header">
          <button class="chat-header-back" onclick="closeChat()">‚Üê</button>
          <div class="chat-header-avatar">${currentChat.slice(-2).toUpperCase()}</div>
          <div class="chat-header-info">
            <div class="chat-header-name">${escapeHtml(name)}</div>
            <div class="chat-header-status">${formatPhone(currentChat)}</div>
          </div>
          <div class="chat-header-actions">
            <button class="chat-header-btn" onclick="deleteChat()">üóëÔ∏è</button>
          </div>
        </div>
        <div class="messages-container" id="messagesContainer">
          ${renderMessages(chat)}
        </div>
        <div class="chat-input-area">
          <input type="text" class="chat-input" id="chatInput" placeholder="Escrib√≠ un mensaje...">
          <button class="chat-send-btn" onclick="sendMessage()">‚û§</button>
        </div>
      `;
      
      // Enter to send
      $('chatInput').onkeypress = e => { if (e.key === 'Enter') sendMessage(); };
      
      // Scroll to bottom
      const container = $('messagesContainer');
      container.scrollTop = container.scrollHeight;
    }

    function renderMessages(chat) {
      let html = '';
      
      // Render messages
      chat.messages.forEach(m => {
        const time = new Date(m.timestamp).toLocaleTimeString('es-CR', { hour: '2-digit', minute: '2-digit' });
        html += `
          <div class="message ${m.direction}">
            <div class="message-text">${escapeHtml(m.text)}</div>
            <div class="message-time">${time}</div>
          </div>
        `;
      });
      
      // Render pending action card if exists
      if (chat.pending) {
        const p = chat.pending;
        const isSinpe = p.tipo === 'sinpe';
        
        html += `
          <div class="action-card ${isSinpe ? 'sinpe' : ''}" id="actionCard">
            <div class="action-card-header">
              <span class="action-card-icon">${isSinpe ? 'üí∞' : 'üîî'}</span>
              <span>${isSinpe ? 'CONFIRMAR PAGO SINPE' : 'CONFIRMAR DISPONIBILIDAD'}</span>
            </div>
            <div class="action-card-details">
              <div class="action-card-detail">üì¶ <strong>${escapeHtml(p.producto || 'Producto')}</strong></div>
              ${p.codigo ? `<div class="action-card-detail">üè∑Ô∏è C√≥digo: ${escapeHtml(p.codigo)}</div>` : ''}
              ${p.talla_color ? `<div class="action-card-detail">üëï ${escapeHtml(p.talla_color)}</div>` : ''}
              ${!isSinpe && p.precio ? `<div class="action-card-detail">üí∞ ‚Ç°${(p.precio || 0).toLocaleString()}</div>` : ''}
            </div>
            <div class="action-card-buttons">
              ${isSinpe ? `
                <button class="action-btn primary" onclick="confirmAction('PAGADO')">üí∞ Confirmar Pago</button>
              ` : `
                <button class="action-btn primary" onclick="confirmAction('SI_HAY')">‚úÖ S√≠ Hay</button>
                <button class="action-btn danger" onclick="confirmAction('NO_HAY')">‚ùå No Hay</button>
              `}
            </div>
          </div>
        `;
      }
      
      return html;
    }

    function closeChat() {
      currentChat = null;
      $('sidebar').classList.remove('hidden');
      $('chatArea').classList.remove('active');
      $('chatArea').classList.add('empty');
      $('chatArea').innerHTML = `
        <div class="empty-chat">
          <div class="empty-chat-icon">üí¨</div>
          <div class="empty-chat-text">Seleccion√° un chat para empezar</div>
        </div>
      `;
      renderChatList();
    }

    // ===== ACTIONS =====
    function confirmAction(type) {
      if (!currentChat) return;
      const btn = event.target;
      btn.disabled = true;
      btn.textContent = '‚è≥...';
      
      socket.emit('action', { clientWaId: currentChat, actionType: type });
      
      // Mark pending as resolved locally
      setTimeout(() => {
        if (chats[currentChat]) {
          chats[currentChat].pending = null;
          renderChat();
          renderChatList();
        }
      }, 1000);
    }

    function sendMessage() {
      const input = $('chatInput');
      const text = input.value.trim();
      if (!text || !currentChat) return;
      
      socket.emit('action', { clientWaId: currentChat, actionType: 'MENSAJE', payload: { texto: text } });
      input.value = '';
    }

    function deleteChat() {
      if (confirm('¬øBorrar este chat?')) {
        socket.emit('delete_chats', { waId: currentChat });
        delete chats[currentChat];
        closeChat();
      }
    }

    // ===== SHIPPING MODAL =====
    function setShip(val) { $('shipInput').value = val; }
    function hideShipModal() { $('shippingModal').classList.remove('active'); }
    function sendShipping() {
      const val = parseInt($('shipInput').value) || 0;
      if (val < 100) { toast('‚ö†Ô∏è Monto inv√°lido', 'error'); return; }
      socket.emit('action', { clientWaId: shipClient, actionType: 'ENVIO', payload: { shipping: val } });
    }
    function noShipping() {
      socket.emit('action', { clientWaId: shipClient, actionType: 'NO_ENVIO_ZONA' });
      hideShipModal();
    }

    // ===== BOT TOGGLE =====
    $('botToggle').onclick = () => socket.emit('toggle_bot');
  </script>
</body>
</html>
