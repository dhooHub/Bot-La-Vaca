<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="apple-mobile-web-app-capable" content="no">
  <meta name="theme-color" content="#1a1f25">
  <meta name="description" content="Panel de control TICObot - La Vaca CR">
  <!-- NO manifest para evitar modo PWA standalone que rompe links -->
  <link rel="apple-touch-icon" href="/icon-192.png">
  <title>TICObot üêÑ</title>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Nunito:wght@400;500;600;700&display=swap');
    :root {
      --wa-green: #25D366;
      --wa-green-dark: #075E54;
      --wa-green-teal: #128C7E;
      --wa-bg: #efeae2;
      --wa-sidebar-bg: #ffffff;
      --wa-header: #202c33;
      --wa-bubble-in: #ffffff;
      --wa-bubble-out: #dcf8c6;
      --wa-text: #111b21;
      --wa-muted: #667781;
      --wa-border: #e9edef;
      --wa-input-bg: #f0f2f5;
      --wa-hover: #f5f6f6;
      --danger: #e53935;
      --warning: #f57c00;
      --sinpe-bg: #e3f2fd;
      --sinpe-border: #1565c0;
      /* alias para compatibilidad con JS que usa --primary-light */
      --primary-light: #25D366;
      --primary: #202c33;
      --bg: #f0f2f5;
      --card: #fff;
      --text: #111b21;
      --text-muted: #667781;
      --success: #25D366;
      --action-bg: #fff8e1;
      --action-border: #ffc107;
    }
    * { margin: 0; padding: 0; box-sizing: border-box; }
    html, body { height: 100%; overflow: hidden; }
    body { font-family: 'Nunito', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; background: var(--wa-bg); color: var(--wa-text); }

    /* ===== SCROLLBARS ===== */
    ::-webkit-scrollbar { width: 5px; }
    ::-webkit-scrollbar-track { background: transparent; }
    ::-webkit-scrollbar-thumb { background: #ccc; border-radius: 3px; }

    /* ===== LOGIN ===== */
    #login { position: fixed; inset: 0; background: var(--wa-header); display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 2rem; z-index: 1000; }
    #login.hidden { display: none; }
    .login-title { color: #fff; font-size: 2.5rem; font-weight: 700; margin-bottom: 0.5rem; letter-spacing: -0.5px; }
    .login-subtitle { color: rgba(255,255,255,0.55); margin-bottom: 2rem; font-size: 1rem; }
    .pin-box { display: flex; gap: 0.75rem; margin-bottom: 1.5rem; }
    .pin-digit { width: 56px; height: 66px; font-size: 1.9rem; text-align: center; border: 2px solid rgba(255,255,255,0.15); border-radius: 14px; background: rgba(255,255,255,0.07); color: #fff; outline: none; transition: border-color .2s; }
    .pin-digit:focus { border-color: var(--wa-green); }
    .login-btn { background: var(--wa-green); color: #fff; border: none; padding: 1rem 3rem; font-size: 1.1rem; font-weight: 700; border-radius: 30px; cursor: pointer; letter-spacing: 0.3px; transition: background .2s; }
    .login-btn:disabled { opacity: 0.4; cursor: not-allowed; }
    .login-btn:not(:disabled):hover { background: #20c45a; }
    .login-error { color: #ff6b6b; margin-top: 1rem; font-size: 0.9rem; }

    /* ===== MAIN LAYOUT ===== */
    #app { display: none; height: 100vh; flex-direction: column; }
    #app.active { display: flex; }

    /* ===== TOP HEADER BAR ===== */
    .header { background: var(--wa-header); color: #fff; padding: 0 1rem; height: 56px; display: flex; justify-content: space-between; align-items: center; flex-shrink: 0; }
    .header-left { display: flex; align-items: center; gap: 0.75rem; }
    .header-title { font-size: 1.15rem; font-weight: 700; letter-spacing: -0.3px; }
    .conn-badge { padding: 0.25rem 0.6rem; border-radius: 10px; font-size: 0.75rem; font-weight: 700; letter-spacing: 0.3px; cursor: pointer; }
    .conn-badge.on { background: var(--wa-green); }
    .conn-badge.off { background: var(--danger); animation: pulse-notif 2s infinite; }
    .conn-badge.wait { background: var(--warning); }
    .pending-indicator { background: var(--danger); color: #fff; padding: 0.25rem 0.6rem; border-radius: 10px; font-size: 0.75rem; font-weight: 700; display: none; animation: blink 1.2s infinite; }
    .pending-indicator.active { display: inline-block; }
    .header-right { display: flex; align-items: center; gap: 0.5rem; }
    .notif-btn { background: rgba(255,255,255,0.12); border: none; color: #fff; width: 36px; height: 36px; border-radius: 50%; font-size: 1rem; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: background .2s; }
    .notif-btn:hover { background: rgba(255,255,255,0.22); }
    .notif-btn.enabled { background: var(--wa-green); }
    .notif-btn:not(.enabled) { animation: pulse-notif 2.5s infinite; }
    .bot-toggle { padding: 0.35rem 0.8rem; border-radius: 20px; font-size: 0.82rem; font-weight: 700; border: none; cursor: pointer; transition: all .2s; }
    .bot-toggle.active { background: var(--wa-green); color: #fff; }
    .bot-toggle.paused { background: var(--warning); color: #fff; }
    @keyframes pulse-notif { 0%,100%{transform:scale(1)} 50%{transform:scale(1.08)} }
    @keyframes blink { 0%,100%{opacity:1} 50%{opacity:0.4} }

    /* ===== MAIN CONTAINER ===== */
    .main-container { flex: 1; display: flex; overflow: hidden; min-height: 0; }

    /* ===== SIDEBAR ===== */
    .sidebar { width: 360px; min-width: 300px; background: var(--wa-sidebar-bg); border-right: 1px solid var(--wa-border); display: flex; flex-direction: column; flex-shrink: 0; }
    
    /* Sidebar top: search + tabs */
    .sidebar-header { padding: 0.6rem 0.75rem 0; background: var(--wa-sidebar-bg); border-bottom: 1px solid var(--wa-border); }
    .search-wrap { position: relative; margin-bottom: 0.6rem; }
    .search-icon { position: absolute; left: 12px; top: 50%; transform: translateY(-50%); color: var(--wa-muted); font-size: 0.9rem; pointer-events: none; }
    .search-input { width: 100%; padding: 0.6rem 1rem 0.6rem 2.4rem; border: none; border-radius: 8px; background: var(--wa-input-bg); font-size: 0.95rem; outline: none; color: var(--wa-text); font-family: inherit; }
    .search-input::placeholder { color: var(--wa-muted); }
    
    /* Filter tabs */
    .sidebar-tabs { display: flex; gap: 0; border-bottom: none; }
    .sidebar-tab { flex: 1; padding: 0.55rem 0; font-size: 0.82rem; font-weight: 700; text-align: center; background: none; border: none; cursor: pointer; color: var(--wa-muted); border-bottom: 2px solid transparent; transition: all .2s; letter-spacing: 0.4px; text-transform: uppercase; }
    .sidebar-tab.active { color: var(--wa-green-teal); border-bottom-color: var(--wa-green-teal); }

    /* Chat list */
    .chat-list { flex: 1; overflow-y: auto; }
    .chat-item { display: flex; align-items: center; gap: 0.75rem; padding: 0.75rem 1rem; cursor: pointer; border-bottom: 1px solid var(--wa-border); transition: background .15s; position: relative; }
    .chat-item:hover { background: var(--wa-hover); }
    .chat-item.active { background: #f0f2f5; }
    .chat-item.has-action { background: #fffde7; }
    .chat-item.human-mode { border-left: 3px solid var(--warning); }
    
    /* Avatar c√≠rculo */
    .chat-avatar { width: 49px; height: 49px; border-radius: 50%; background: var(--wa-green-teal); color: #fff; display: flex; align-items: center; justify-content: center; font-weight: 700; font-size: 1rem; flex-shrink: 0; position: relative; overflow: visible; user-select: none; }
    .chat-avatar .badge { position: absolute; bottom: -2px; right: -2px; min-width: 19px; height: 19px; background: var(--wa-green); border-radius: 10px; display: flex; align-items: center; justify-content: center; font-size: 0.68rem; font-weight: 700; color: #fff; border: 2px solid #fff; padding: 0 3px; }
    .chat-avatar .badge.alert { background: var(--danger); animation: blink 1s infinite; }
    
    /* Chat info */
    .chat-info { flex: 1; min-width: 0; }
    .chat-name { font-weight: 700; font-size: 1.05rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; color: #000; }
    .chat-preview { font-size: 0.92rem; color: #444; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; margin-top: 1px; }
    .chat-preview .bot-icon { font-size: 0.75rem; }
    
    /* Chat meta */
    .chat-meta { text-align: right; flex-shrink: 0; display: flex; flex-direction: column; align-items: flex-end; gap: 4px; }
    .chat-time { font-size: 0.78rem; color: #555; white-space: nowrap; font-weight: 600; }
    .chat-unread { min-width: 20px; height: 20px; padding: 0 5px; background: var(--wa-green); border-radius: 10px; font-size: 0.72rem; font-weight: 700; color: #fff; display: flex; align-items: center; justify-content: center; }
    .chat-action-icon { font-size: 1rem; }

    /* ===== CHAT AREA ===== */
    .chat-area { flex: 1; display: flex; flex-direction: column; background: var(--wa-bg); position: relative; overflow: hidden; min-width: 0; }
    .chat-area::before { content: ''; position: absolute; inset: 0; background-image: url("data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='none' fill-rule='evenodd'%3E%3Cg fill='%23d4cbb4' fill-opacity='0.3'%3E%3Cpath d='M36 34v-4h-2v4h-4v2h4v4h2v-4h4v-2h-4zm0-30V0h-2v4h-4v2h4v4h2V6h4V4h-4zM6 34v-4H4v4H0v2h4v4h2v-4h4v-2H6zM6 4V0H4v4H0v2h4v4h2V6h4V4H6z'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E"); pointer-events: none; opacity: 0.5; }
    .chat-area.empty { align-items: center; justify-content: center; }
    .empty-chat { text-align: center; color: var(--wa-muted); background: rgba(255,255,255,0.8); border-radius: 16px; padding: 2.5rem 3rem; position: relative; }
    .empty-chat-icon { font-size: 4rem; margin-bottom: 1rem; opacity: 0.6; }
    .empty-chat-text { font-size: 1rem; font-weight: 500; }

    /* Chat header */
    .chat-header { background: var(--wa-header); color: #fff; padding: 0 1rem; height: 56px; display: flex; align-items: center; gap: 0.75rem; flex-shrink: 0; position: relative; z-index: 2; }
    .chat-header-back { background: none; border: none; color: rgba(255,255,255,0.7); font-size: 1.3rem; cursor: pointer; padding: 4px 6px; border-radius: 50%; display: none; transition: color .2s; }
    .chat-header-back:hover { color: #fff; }
    .chat-header-avatar { width: 40px; height: 40px; border-radius: 50%; background: var(--wa-green-teal); display: flex; align-items: center; justify-content: center; font-weight: 700; font-size: 0.9rem; color: #fff; flex-shrink: 0; cursor: pointer; }
    .chat-header-info { flex: 1; min-width: 0; }
    .chat-header-name { font-weight: 600; font-size: 1rem; }
    .chat-header-status { font-size: 0.78rem; color: rgba(255,255,255,0.65); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .chat-header-actions { display: flex; gap: 0.4rem; }
    .chat-header-btn { background: rgba(255,255,255,0.12); border: none; color: #fff; padding: 0.35rem 0.75rem; border-radius: 18px; font-size: 0.8rem; font-weight: 700; cursor: pointer; transition: background .2s; white-space: nowrap; }
    .chat-header-btn:hover { background: rgba(255,255,255,0.22); }

    /* Human mode banner */
    .human-banner { background: #fff3e0; border-bottom: 2px solid var(--warning); padding: 0.45rem 1rem; font-size: 0.88rem; color: #bf360c; text-align: center; flex-shrink: 0; position: relative; z-index: 2; }

    /* Messages area */
    .messages-container { flex: 1; overflow-y: auto; padding: 0.75rem 1rem; display: flex; flex-direction: column; gap: 2px; position: relative; z-index: 1; }

    /* Bubbles */
    .message { display: flex; flex-direction: column; max-width: 68%; margin-bottom: 2px; }
    .message.in { align-self: flex-start; }
    .message.out { align-self: flex-end; }
    .message-bubble { padding: 0.55rem 0.85rem 0.3rem; border-radius: 8px; position: relative; box-shadow: 0 1px 0.5px rgba(11,20,26,.13); }
    .message.in .message-bubble { background: var(--wa-bubble-in); border-radius: 0px 8px 8px 8px; }
    .message.out .message-bubble { background: var(--wa-bubble-out); border-radius: 8px 0px 8px 8px; }
    .message-text { font-size: 1.05rem; line-height: 1.5; color: #000; white-space: pre-wrap; word-break: break-word; }
    .message-text a { color: #1a73e8; text-decoration: underline; }
    .message-time { font-size: 0.75rem; color: #555; text-align: right; margin-top: 2px; }
    .message-image { max-width: 240px; max-height: 200px; border-radius: 6px; cursor: pointer; display: block; margin-bottom: 4px; object-fit: cover; }
    
    /* Date separator */
    .date-separator { text-align: center; margin: 10px 0; }
    .date-separator span { background: #d9fdd3; border-radius: 8px; padding: 3px 10px; font-size: 0.78rem; color: var(--wa-muted); font-weight: 600; box-shadow: 0 1px 0.5px rgba(0,0,0,0.1); }

    /* Action cards */
    .action-card { background: #fff; border-radius: 12px; border: 1px solid var(--wa-border); padding: 1rem; margin: 0.5rem auto; max-width: 380px; width: 100%; box-shadow: 0 2px 8px rgba(0,0,0,0.08); align-self: center; }
    .action-card.sinpe { border-color: var(--sinpe-border); background: var(--sinpe-bg); }
    .action-card.tienda { border-color: #7b1fa2; background: #f3e5f5; }
    .action-card.foto-externa { border-color: #e65100; background: #fff3e0; }
    .action-card-header { display: flex; align-items: center; gap: 0.5rem; font-weight: 700; font-size: 0.88rem; color: var(--wa-muted); text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 0.75rem; }
    .action-card-icon { font-size: 1.2rem; }
    .action-card-image { width: 100%; max-height: 200px; object-fit: contain; border-radius: 8px; margin-bottom: 0.75rem; cursor: pointer; }
    .action-card-details { margin-bottom: 0.75rem; }
    .action-card-detail { font-size: 0.9rem; padding: 3px 0; color: var(--wa-text); }
    .action-card-buttons { display: flex; gap: 0.5rem; flex-wrap: wrap; }
    .action-btn { flex: 1; padding: 0.6rem 0.75rem; border: none; border-radius: 8px; font-size: 0.88rem; font-weight: 700; cursor: pointer; transition: opacity .2s; min-width: 80px; font-family: inherit; }
    .action-btn.primary { background: var(--wa-green); color: #fff; }
    .action-btn.danger { background: var(--danger); color: #fff; }
    .action-btn.info { background: #1565c0; color: #fff; }
    .action-btn:hover { opacity: 0.88; }
    .action-btn:disabled { opacity: 0.35; cursor: not-allowed; }

    /* ===== BOTTOM INPUT AREA ===== */
    .chat-input-wrapper { background: var(--wa-input-bg); flex-shrink: 0; position: relative; z-index: 2; padding-bottom: env(safe-area-inset-bottom, 0); }
    
    /* Emoji picker */
    .emoji-panel { background: #fff; border-top: 1px solid var(--wa-border); padding: 0.5rem 0.75rem; display: none; flex-wrap: wrap; gap: 3px; max-height: 120px; overflow-y: auto; }
    .emoji-panel.open { display: flex; }
    .emoji-btn { background: none; border: none; font-size: 1.4rem; cursor: pointer; padding: 3px; border-radius: 6px; line-height: 1; transition: background .15s; }
    .emoji-btn:hover { background: var(--wa-border); }
    
    /* Quick replies bar */
    .quick-replies-bar { background: #fff; border-top: 1px solid var(--wa-border); padding: 0.4rem 0.75rem; display: flex; gap: 0.35rem; align-items: center; overflow-x: auto; overflow-y: hidden; flex-wrap: nowrap; -webkit-overflow-scrolling: touch; scrollbar-width: none; }
    .quick-replies-bar::-webkit-scrollbar { display: none; }
    .qr-chip { background: #fff; border: 2px solid #aaa; border-radius: 16px; padding: 0.35rem 0.75rem; font-size: 0.88rem; font-weight: 700; cursor: pointer; white-space: nowrap; flex-shrink: 0; transition: all .15s; color: #111; font-family: inherit; }
    .qr-chip:hover { background: var(--wa-green); color: #fff; border-color: var(--wa-green); }
    .qr-chip-manage { background: none; border: 2px dashed #888; color: #555; border-radius: 16px; padding: 0.35rem 0.75rem; font-size: 0.85rem; cursor: pointer; font-family: inherit; white-space: nowrap; flex-shrink: 0; }
    .qr-chip-manage:hover { border-color: var(--wa-green-teal); color: var(--wa-green-teal); }

    /* Input row */
    .chat-input-area { display: flex; align-items: flex-end; gap: 0.5rem; padding: 0.5rem 0.75rem; background: var(--wa-input-bg); border-top: 1px solid var(--wa-border); }
    .input-icon-btn { background: none; border: none; color: var(--wa-muted); font-size: 1.35rem; cursor: pointer; padding: 6px; border-radius: 50%; flex-shrink: 0; width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; transition: color .2s, background .2s; }
    .input-icon-btn:hover { color: var(--wa-green-teal); background: rgba(0,0,0,0.06); }
    .chat-input { flex: 1; background: #fff; border: none; border-radius: 22px; padding: 0.6rem 1rem; font-size: 0.97rem; outline: none; resize: none; max-height: 120px; line-height: 1.4; font-family: inherit; color: var(--wa-text); box-shadow: 0 1px 2px rgba(0,0,0,0.07); }
    .chat-input::placeholder { color: var(--wa-muted); }
    .chat-send-btn { background: var(--wa-green-teal); border: none; color: #fff; width: 42px; height: 42px; border-radius: 50%; font-size: 1.15rem; cursor: pointer; display: flex; align-items: center; justify-content: center; flex-shrink: 0; transition: background .2s; }
    .chat-send-btn:hover { background: var(--wa-green-dark); }
    
    /* Hidden file input */
    #fileAttachInput { display: none; }

    /* ===== MODALS ===== */
    .qr-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.75); display: none; align-items: center; justify-content: center; z-index: 200; }
    .qr-overlay.active { display: flex; }
    .qr-modal { background: #fff; padding: 2rem; border-radius: 16px; text-align: center; max-width: 360px; width: 95%; }
    .qr-modal h3 { margin-bottom: 0.5rem; font-size: 1.1rem; }
    .qr-modal img { width: 230px; height: 230px; margin: 1rem 0; }
    .qr-instructions { color: var(--wa-muted); font-size: 0.9rem; line-height: 1.5; }
    .qr-close { margin-top: 1rem; background: var(--danger); color: #fff; border: none; padding: 0.6rem 1.5rem; border-radius: 20px; cursor: pointer; font-weight: 700; }

    .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.55); display: none; align-items: center; justify-content: center; z-index: 200; }
    .modal-overlay.active { display: flex; }
    .modal { background: #fff; padding: 1.5rem; border-radius: 16px; width: 92%; max-width: 400px; }
    .modal-title { font-size: 1.15rem; font-weight: 700; text-align: center; margin-bottom: 1rem; }
    .modal-info { background: var(--wa-input-bg); padding: 0.8rem; border-radius: 10px; margin-bottom: 1rem; }
    .modal-info-row { display: flex; justify-content: space-between; margin-bottom: 0.3rem; font-size: 0.9rem; }
    .modal-input { width: 100%; padding: 0.9rem; font-size: 1.3rem; font-weight: 700; border: 2px solid var(--wa-border); border-radius: 12px; text-align: center; outline: none; font-family: inherit; }
    .modal-input:focus { border-color: var(--wa-green); }
    .quick-prices { display: grid; grid-template-columns: repeat(3, 1fr); gap: 0.4rem; margin: 0.75rem 0; }
    .quick-price { padding: 0.55rem; background: var(--wa-input-bg); border: none; border-radius: 8px; font-weight: 700; cursor: pointer; font-size: 0.88rem; transition: all .15s; font-family: inherit; }
    .quick-price:hover { background: var(--wa-green); color: #fff; }
    .modal-buttons { display: flex; gap: 0.5rem; }
    .modal-btn { flex: 1; padding: 0.8rem; border: none; border-radius: 10px; font-weight: 700; cursor: pointer; font-size: 0.95rem; font-family: inherit; }
    .modal-btn.cancel { background: var(--wa-input-bg); color: var(--wa-text); }
    .modal-btn.confirm { background: var(--wa-green); color: #fff; }
    .modal-btn.danger { background: var(--danger); color: #fff; margin-top: 0.5rem; width: 100%; }

    .resumen-modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.55); display: none; align-items: flex-end; justify-content: center; z-index: 300; }
    .resumen-modal-overlay.active { display: flex; }
    .resumen-modal-box { background: #fff; border-radius: 20px 20px 0 0; padding: 1.5rem; width: 100%; max-width: 640px; max-height: 92vh; overflow-y: auto; }
    .resumen-modal-title { font-size: 1.1rem; font-weight: 700; margin-bottom: 1rem; }
    .resumen-tipo-tabs { display: flex; gap: 0.5rem; margin-bottom: 1.2rem; }
    .resumen-tab { flex: 1; padding: 0.6rem; border: 2px solid var(--wa-border); border-radius: 10px; background: var(--wa-input-bg); font-size: 0.9rem; font-weight: 700; cursor: pointer; text-align: center; font-family: inherit; }
    .resumen-tab.active { border-color: var(--wa-green); background: #e8f5e9; color: #1b5e20; }
    .resumen-field { margin-bottom: 0.9rem; }
    .resumen-field label { display: block; font-size: 0.78rem; font-weight: 700; color: var(--wa-muted); margin-bottom: 0.3rem; text-transform: uppercase; letter-spacing: 0.04em; }
    .resumen-field input, .resumen-field textarea { width: 100%; padding: 0.7rem 0.9rem; border: 1.5px solid var(--wa-border); border-radius: 10px; font-size: 0.95rem; outline: none; transition: border-color .2s; background: #fafafa; font-family: inherit; }
    .resumen-field input:focus, .resumen-field textarea:focus { border-color: var(--wa-green); background: #fff; }
    .resumen-field textarea { resize: vertical; min-height: 70px; }
    .resumen-preview { background: #f0fdf4; border: 1.5px solid #a7f3d0; border-radius: 10px; padding: 0.9rem; font-size: 0.88rem; white-space: pre-wrap; margin-bottom: 1rem; color: #111; line-height: 1.5; max-height: 200px; overflow-y: auto; }
    .resumen-preview-label { font-size: 0.76rem; font-weight: 700; color: var(--wa-muted); text-transform: uppercase; margin-bottom: 0.4rem; letter-spacing: 0.04em; }
    .resumen-actions { display: flex; gap: 0.5rem; }
    .resumen-send-btn { flex: 2; padding: 0.9rem; background: var(--wa-green); color: #fff; border: none; border-radius: 12px; font-size: 1rem; font-weight: 700; cursor: pointer; font-family: inherit; }
    .resumen-cancel-btn { flex: 1; padding: 0.9rem; background: var(--wa-input-bg); border: none; border-radius: 12px; font-size: 0.95rem; cursor: pointer; font-family: inherit; }
    .resumen-row { display: grid; grid-template-columns: 1fr 1fr; gap: 0.6rem; }

    /* Quick Replies Manager */
    .qr-modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.55); display: none; align-items: center; justify-content: center; z-index: 300; }
    .qr-modal-overlay.active { display: flex; }
    .qr-modal-box { background: #fff; border-radius: 16px; padding: 1.5rem; width: 96%; max-width: 520px; max-height: 88vh; overflow-y: auto; }
    .qr-modal-title { font-size: 1.1rem; font-weight: 700; margin-bottom: 0.3rem; }
    .qr-modal-sub { font-size: 0.85rem; color: var(--wa-muted); margin-bottom: 1rem; }
    .qr-item { display: grid; grid-template-columns: 90px 1fr 36px; gap: 0.5rem; align-items: start; margin-bottom: 0.6rem; }
    .qr-item-code { padding: 0.5rem; border: 1px solid var(--wa-border); border-radius: 8px; font-size: 0.9rem; font-weight: 700; font-family: monospace; }
    .qr-item-text { padding: 0.5rem; border: 1px solid var(--wa-border); border-radius: 8px; font-size: 0.88rem; resize: vertical; min-height: 55px; font-family: inherit; }
    .qr-item-del { background: #fee; border: 1px solid #fcc; color: var(--danger); border-radius: 8px; cursor: pointer; font-size: 1rem; display: flex; align-items: center; justify-content: center; height: 36px; }
    .qr-add-btn { background: #e8f5e9; color: #2e7d32; border: 1px solid #a5d6a7; border-radius: 10px; padding: 0.5rem 1rem; font-size: 0.9rem; cursor: pointer; margin-bottom: 1rem; font-weight: 700; font-family: inherit; }
    .qr-save-btn { background: var(--wa-green-dark); color: #fff; border: none; border-radius: 10px; padding: 0.8rem; width: 100%; font-size: 1rem; font-weight: 700; cursor: pointer; margin-top: 0.5rem; font-family: inherit; }

    /* Toast */
    .toast { position: fixed; bottom: 90px; left: 50%; transform: translateX(-50%) translateY(60px); background: #303030; color: #fff; padding: 0.7rem 1.4rem; border-radius: 24px; opacity: 0; transition: all .3s; z-index: 400; font-size: 0.9rem; white-space: nowrap; }
    .toast.show { transform: translateX(-50%) translateY(0); opacity: 1; }
    .toast.success { background: var(--wa-green-dark); }
    .toast.error { background: var(--danger); }

    /* Sales modal */
    #salesModal .modal-inner { background: #fff; border-radius: 14px; padding: 1.5rem; max-width: 520px; width: 95%; max-height: 88vh; overflow-y: auto; position: relative; }

    /* ===== RESPONSIVE ===== */
    @media (max-width: 768px) {
      .sidebar { width: 100%; min-width: unset; position: absolute; inset: 0; z-index: 10; top: 56px; bottom: 0; }
      .sidebar.hidden { display: none; }
      .chat-area { position: absolute; inset: 0; z-index: 20; display: none; }
      .chat-area.active { display: flex; }
      .chat-header-back { display: flex !important; }
      .main-container { position: relative; }
    }

  </style>
</head>
<body>
  <!-- LOGIN -->
  <div id="login">
    <div class="login-title">üêÑ TICObot</div>
    <p class="login-subtitle">Ingres√° tu PIN</p>
    <div class="pin-box">
      <input type="tel" class="pin-digit" maxlength="1" inputmode="numeric">
      <input type="tel" class="pin-digit" maxlength="1" inputmode="numeric">
      <input type="tel" class="pin-digit" maxlength="1" inputmode="numeric">
      <input type="tel" class="pin-digit" maxlength="1" inputmode="numeric">
    </div>
    <button class="login-btn" id="loginBtn" disabled>Entrar</button>
    <p class="login-error" id="loginError"></p>
  </div>

  <!-- APP -->
  <div id="app">
    <!-- Header -->
    <div class="header">
      <div class="header-left">
        <span class="header-title">üêÑ TICObot</span>
        <span class="conn-badge off" id="connBadge" onclick="showQR()">CONECTAR</span>
        <span class="pending-indicator" id="pendingIndicator">0 PENDIENTES</span>
      </div>
      <div class="header-right">
        <button class="notif-btn" onclick="showSales()" title="Ventas">üí∞</button>
        <button class="notif-btn" onclick="showContacts()" title="Contactos">üë•</button>
        <button class="notif-btn" id="notifBtn" onclick="requestNotifications()" title="Activar notificaciones">üîî</button>
        <button class="bot-toggle active" id="botToggle">‚ñ∂Ô∏è Bot</button>
      </div>
    </div>

    <!-- Main -->
    <div class="main-container">
      <!-- Sidebar -->
      <div class="sidebar" id="sidebar">
        <div class="sidebar-header">
          <div class="search-wrap">
            <span class="search-icon">üîç</span>
            <input type="text" class="search-input" id="searchInput" placeholder="Buscar chat...">
          </div>
          <div class="sidebar-tabs">
            <button class="sidebar-tab active" id="tabTodos" onclick="setTabFilter('todos')">Todos</button>
            <button class="sidebar-tab" id="tabNoLeidos" onclick="setTabFilter('noleidos')">No le√≠dos</button>
          </div>
        </div>
        <div class="chat-list" id="chatList"></div>
      </div>

      <!-- Chat Area -->
      <div class="chat-area empty" id="chatArea">
        <div class="empty-chat">
          <div class="empty-chat-icon">üí¨</div>
          <div class="empty-chat-text">Seleccion√° un chat para empezar</div>
        </div>
      </div>
    </div>
  </div>

  <!-- QR Modal -->
  <div class="qr-overlay" id="qrOverlay">
    <div class="qr-modal">
      <h3>üì± Conectar WhatsApp</h3>
      <div id="qrContent">
        <p class="qr-instructions">Cargando...</p>
      </div>
      <button class="qr-close" onclick="hideQR()">Cerrar</button>
    </div>
  </div>

  <!-- Shipping Modal -->
  <div class="modal-overlay" id="shippingModal">
    <div class="modal">
      <div class="modal-title">üì¶ Costo de Env√≠o</div>
      <div class="modal-info">
        <div class="modal-info-row"><span>üì± Cliente:</span><span id="shipClient">-</span></div>
        <div class="modal-info-row"><span>üìç Zona:</span><span id="shipZone">-</span></div>
        <div class="modal-info-row"><span>üí∞ Producto:</span><span id="shipPrice">-</span></div>
      </div>
      <input type="number" class="modal-input" id="shipInput" placeholder="‚Ç°0" inputmode="numeric">
      <div class="quick-prices">
        <button class="quick-price" onclick="setShip(2000)">‚Ç°2,000</button>
        <button class="quick-price" onclick="setShip(2500)">‚Ç°2,500</button>
        <button class="quick-price" onclick="setShip(3000)">‚Ç°3,000</button>
        <button class="quick-price" onclick="setShip(3500)">‚Ç°3,500</button>
        <button class="quick-price" onclick="setShip(4000)">‚Ç°4,000</button>
        <button class="quick-price" onclick="setShip(5000)">‚Ç°5,000</button>
      </div>
      <div class="modal-buttons">
        <button class="modal-btn cancel" onclick="hideShipModal()">Cancelar</button>
        <button class="modal-btn confirm" onclick="sendShipping()">Enviar ‚úì</button>
      </div>
      <button class="modal-btn danger" onclick="noShipping()">üö´ No env√≠o a esa zona</button>
    </div>
  </div>

  <!-- Image Viewer Modal -->
  <div class="modal-overlay" id="imageViewer" onclick="hideImageViewer()">
    <img id="viewerImage" src="" style="max-width:95%; max-height:90vh; border-radius:8px;">
  </div>

  <!-- Sales Modal (Ventas unificadas) -->
  <div class="modal-overlay" id="salesModal">
    <div class="modal-inner" style="background:#fff;border-radius:14px;padding:1.25rem;max-width:540px;width:95%;max-height:90vh;overflow-y:auto;position:relative;">
      <button onclick="hideSales()" style="position:absolute;top:10px;right:14px;background:none;border:none;font-size:20px;cursor:pointer;color:#667781;">‚úï</button>
      <h2 style="margin:0 0 10px;font-size:1.05rem;font-weight:700;">üí∞ Ventas</h2>

      <!-- Stats r√°pidas -->
      <div id="salesSummary" style="background:#f0fdf4;padding:10px;border-radius:10px;margin-bottom:12px;"></div>

      <!-- Toggle form -->
      <button onclick="toggleSaleForm()" id="saleFormToggle" style="width:100%;padding:.6rem;background:#25D366;color:#fff;border:none;border-radius:10px;font-size:.9rem;font-weight:700;cursor:pointer;margin-bottom:10px;font-family:inherit;">+ Nueva venta</button>

      <!-- Nueva venta form -->
      <div id="newSaleForm" style="display:none;background:#f8f9fa;border-radius:10px;padding:12px;margin-bottom:12px;border:1px solid #e9edef;">
        <div style="font-size:.85rem;font-weight:700;margin-bottom:8px;">üìù Registrar venta</div>
        <div style="display:flex;gap:6px;margin-bottom:8px;">
          <button id="nsftE" onclick="setNSFMetodo('envio')" style="flex:1;padding:.45rem;border:2px solid #25D366;background:#e8f5e9;color:#1b5e20;border-radius:8px;font-size:.82rem;font-weight:700;cursor:pointer;font-family:inherit;">üöö Env√≠o</button>
          <button id="nsftR" onclick="setNSFMetodo('retiro')" style="flex:1;padding:.45rem;border:2px solid #e9edef;background:#fff;color:#667781;border-radius:8px;font-size:.82rem;font-weight:700;cursor:pointer;font-family:inherit;">üè™ Retiro</button>
        </div>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:6px;margin-bottom:6px;">
          <div><label style="font-size:.68rem;font-weight:700;color:#667781;text-transform:uppercase;">Producto *</label><input id="nsfP" type="text" placeholder="Nombre" style="width:100%;padding:.45rem .6rem;border:1.5px solid #e9edef;border-radius:8px;font-size:.85rem;font-family:inherit;background:#fff;"></div>
          <div><label style="font-size:.68rem;font-weight:700;color:#667781;text-transform:uppercase;">Talla/Color</label><input id="nsfTC" type="text" placeholder="Ej: M, Negro" style="width:100%;padding:.45rem .6rem;border:1.5px solid #e9edef;border-radius:8px;font-size:.85rem;font-family:inherit;background:#fff;"></div>
        </div>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:6px;margin-bottom:6px;">
          <div><label style="font-size:.68rem;font-weight:700;color:#667781;text-transform:uppercase;">Precio (‚Ç°) *</label><input id="nsfPr" type="number" placeholder="0" inputmode="numeric" style="width:100%;padding:.45rem .6rem;border:1.5px solid #e9edef;border-radius:8px;font-size:.85rem;font-family:inherit;background:#fff;"></div>
          <div id="nsfEnvioDiv"><label style="font-size:.68rem;font-weight:700;color:#667781;text-transform:uppercase;">Env√≠o (‚Ç°)</label><input id="nsfEn" type="number" placeholder="0" inputmode="numeric" style="width:100%;padding:.45rem .6rem;border:1.5px solid #e9edef;border-radius:8px;font-size:.85rem;font-family:inherit;background:#fff;"></div>
        </div>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:6px;margin-bottom:6px;">
          <div><label style="font-size:.68rem;font-weight:700;color:#667781;text-transform:uppercase;">Nombre cliente</label><input id="nsfN" type="text" placeholder="Mar√≠a Gonz√°lez" style="width:100%;padding:.45rem .6rem;border:1.5px solid #e9edef;border-radius:8px;font-size:.85rem;font-family:inherit;background:#fff;"></div>
          <div><label style="font-size:.68rem;font-weight:700;color:#667781;text-transform:uppercase;">Tel√©fono</label><input id="nsfTel" type="tel" placeholder="8888-1234" inputmode="numeric" style="width:100%;padding:.45rem .6rem;border:1.5px solid #e9edef;border-radius:8px;font-size:.85rem;font-family:inherit;background:#fff;"></div>
        </div>
        <div id="nsfDirDiv" style="margin-bottom:6px;"><label style="font-size:.68rem;font-weight:700;color:#667781;text-transform:uppercase;">Direcci√≥n</label><textarea id="nsfDir" placeholder="Se√±as de env√≠o..." rows="2" style="width:100%;padding:.45rem .6rem;border:1.5px solid #e9edef;border-radius:8px;font-size:.85rem;font-family:inherit;background:#fff;"></textarea></div>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:6px;margin-bottom:8px;">
          <div><label style="font-size:.68rem;font-weight:700;color:#667781;text-transform:uppercase;">Ref. SINPE</label><input id="nsfSinpe" type="text" placeholder="Referencia" style="width:100%;padding:.45rem .6rem;border:1.5px solid #e9edef;border-radius:8px;font-size:.85rem;font-family:inherit;background:#fff;"></div>
          <div><label style="font-size:.68rem;font-weight:700;color:#667781;text-transform:uppercase;">Notas</label><input id="nsfNt" type="text" placeholder="Notas" style="width:100%;padding:.45rem .6rem;border:1.5px solid #e9edef;border-radius:8px;font-size:.85rem;font-family:inherit;background:#fff;"></div>
        </div>
        <button onclick="saveNewSale()" style="width:100%;padding:.7rem;background:#075E54;color:#fff;border:none;border-radius:10px;font-size:.92rem;font-weight:700;cursor:pointer;font-family:inherit;">üíæ Guardar venta</button>
      </div>

      <!-- Ventas list -->
      <div id="salesList" style="font-size:14px;"></div>
    </div>
  </div>

  <!-- Contacts Modal -->
  <div class="modal-overlay" id="contactsModal">
    <div class="modal-inner" style="background:#fff;border-radius:14px;padding:1.25rem;max-width:540px;width:95%;max-height:90vh;overflow-y:auto;position:relative;">
      <button onclick="hideContacts()" style="position:absolute;top:10px;right:14px;background:none;border:none;font-size:20px;cursor:pointer;color:#667781;">‚úï</button>
      <h2 style="margin:0 0 10px;font-size:1.05rem;font-weight:700;">üë• Contactos</h2>
      <div style="display:flex;gap:8px;margin-bottom:10px;align-items:center;">
        <input type="text" id="ctSearchInput" placeholder="üîç Buscar..." oninput="renderContactsModal()" style="flex:1;padding:.5rem .75rem;border:1px solid #e9edef;border-radius:20px;font-size:.88rem;background:#f0f2f5;font-family:inherit;outline:none;">
        <span id="ctCountLbl" style="font-size:.78rem;color:#667781;white-space:nowrap;"></span>
        <button onclick="openAddContact()" style="background:#25D366;color:#fff;border:none;border-radius:8px;padding:.45rem .8rem;font-size:.82rem;font-weight:700;cursor:pointer;font-family:inherit;white-space:nowrap;">+ Agregar</button>
      </div>
      <div id="contactsListModal"></div>
    </div>
  </div>

  <!-- Add/Edit Contact Modal -->
  <div class="modal-overlay" id="addContactModal">
    <div class="modal-inner" style="background:#fff;border-radius:14px;padding:1.25rem;max-width:400px;width:95%;position:relative;">
      <button onclick="closeAddContact()" style="position:absolute;top:10px;right:14px;background:none;border:none;font-size:20px;cursor:pointer;color:#667781;">‚úï</button>
      <h2 id="addContactTitle" style="margin:0 0 12px;font-size:1rem;font-weight:700;">üë§ Agregar Contacto</h2>
      <input type="hidden" id="editCtId">
      <div style="margin-bottom:8px;"><label style="font-size:.7rem;font-weight:700;color:#667781;text-transform:uppercase;">Nombre</label><input id="editCtN" type="text" placeholder="Nombre completo" style="width:100%;padding:.55rem .75rem;border:1.5px solid #e9edef;border-radius:10px;font-size:.9rem;font-family:inherit;background:#fafafa;margin-top:3px;"></div>
      <div style="margin-bottom:8px;"><label style="font-size:.7rem;font-weight:700;color:#667781;text-transform:uppercase;">Tel√©fono</label><input id="editCtTel" type="tel" placeholder="50688881234" inputmode="numeric" style="width:100%;padding:.55rem .75rem;border:1.5px solid #e9edef;border-radius:10px;font-size:.9rem;font-family:inherit;background:#fafafa;margin-top:3px;"></div>
      <div style="margin-bottom:12px;"><label style="font-size:.7rem;font-weight:700;color:#667781;text-transform:uppercase;">Notas</label><input id="editCtNt" type="text" placeholder="Notas" style="width:100%;padding:.55rem .75rem;border:1.5px solid #e9edef;border-radius:10px;font-size:.9rem;font-family:inherit;background:#fafafa;margin-top:3px;"></div>
      <div style="display:flex;gap:8px;">
        <button onclick="closeAddContact()" style="flex:1;padding:.75rem;background:#f0f2f5;border:none;border-radius:10px;cursor:pointer;font-family:inherit;">Cancelar</button>
        <button onclick="saveContactModal()" style="flex:2;padding:.75rem;background:#25D366;color:#fff;border:none;border-radius:10px;font-weight:700;cursor:pointer;font-family:inherit;">üíæ Guardar</button>
      </div>
    </div>
  </div>

  <!-- Hidden file input for attachments -->
  <input type="file" id="fileAttachInput" accept="image/*,video/*,.pdf,.doc,.docx" onchange="handleFileAttach(this)">

  <!-- Resumen Modal -->
  <div class="resumen-modal-overlay" id="resumenModal">
    <div class="resumen-modal-box">
      <div class="resumen-modal-title">üìã Resumen de Pedido</div>

      <!-- Tabs env√≠o / retiro -->
      <div class="resumen-tipo-tabs">
        <button class="resumen-tab active" id="tabEnvio" onclick="setResumenTipo('envio')">üì¶ Env√≠o</button>
        <button class="resumen-tab" id="tabRetiro" onclick="setResumenTipo('retiro')">üè™ Retiro en tienda</button>
      </div>

      <!-- Campos -->
      <div class="resumen-row">
        <div class="resumen-field">
          <label>Producto</label>
          <input type="text" id="rProducto" placeholder="Nombre del producto">
        </div>
        <div class="resumen-field">
          <label>Talla / Color</label>
          <input type="text" id="rTalla" placeholder="Ej: M, Negro">
        </div>
      </div>
      <div class="resumen-row">
        <div class="resumen-field">
          <label>Precio producto (‚Ç°)</label>
          <input type="number" id="rPrecio" placeholder="0" oninput="updateResumenPreview()">
        </div>
        <div class="resumen-field" id="rEnvioField">
          <label>Costo env√≠o (‚Ç°)</label>
          <input type="number" id="rEnvio" placeholder="0" oninput="updateResumenPreview()">
        </div>
      </div>
      <div class="resumen-field" id="rDireccionField">
        <label>Direcci√≥n de env√≠o</label>
        <textarea id="rDireccion" placeholder="Nombre, tel√©fono, provincia, cant√≥n, distrito, se√±as..."></textarea>
      </div>

      <!-- Preview -->
      <div class="resumen-preview-label">Vista previa del mensaje al cliente:</div>
      <div class="resumen-preview" id="resumenPreview"></div>

      <div class="resumen-actions">
        <button class="resumen-cancel-btn" onclick="closeResumenModal()">Cancelar</button>
        <button class="resumen-send-btn" onclick="sendResumen()">üì§ Enviar al cliente</button>
      </div>
    </div>
  </div>

  <!-- Quick Replies Manager Modal -->
  <div class="qr-modal-overlay" id="qrManagerOverlay">
    <div class="qr-modal-box">
      <div class="qr-modal-title">‚ö° Respuestas R√°pidas</div>
      <p class="qr-modal-sub">Escrib√≠ un c√≥digo corto (ej: <strong>envio</strong>) y el mensaje completo que se enviar√° al cliente.</p>
      <div id="qrItemsList"></div>
      <button class="qr-add-btn" onclick="addQrItem()">+ Agregar respuesta</button>
      <button class="qr-save-btn" onclick="saveQuickReplies()">üíæ Guardar</button>
      <button onclick="closeQrManager()" style="width:100%;margin-top:0.5rem;padding:0.7rem;border:none;border-radius:10px;background:var(--bg);cursor:pointer;font-size:0.95rem;">Cancelar</button>
    </div>
  </div>


  <!-- Toast -->
  <div class="toast" id="toast"></div>

  <!-- Audio for notifications - Tono m√°s fuerte -->
  <audio id="notifSound" preload="auto">
    <source src="https://cdn.freesound.org/previews/536/536420_11943129-lq.mp3" type="audio/mpeg">
    <source src="data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2teleRT5NJ7W5buNOOV4u9vYonVEfZK9vZ2Ce2V0jqq6s5J9aF5tbHx+fnxzcHJzd319fHl3d3p8fn9/fX18fX5/gICAf39/f4CAgICAgIB/f39/f4CAgICAf39/f4CAgIB/f39/gICAgH9/f3+AgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgH9/f39/f39/f3+AgICAf39/f3+AgICAgICAgICAgH9/f39/f39/gICAgICAgIB/f39/gICAgH9/f3+AgIB/f39/gICAf39/f4CAgH9/f3+AgIB/f39/gICAgH9/f4CAgH9/f3+AgIB/f39/gICAgH9/f4CAgH9/f3+AgIB/f39/gICAgICAgICAgH9/f3+AgICAgIB/f39/gICAgH9/f3+AgICAgICAgICAgICAgICAgH9/f3+AgICAf39/f4CAgIB/f39/gICAgICAgICAgICAgIB/gICAgICAgIB/f3+AgICAgICAgH9/f3+AgIB/f4CAgIB/f3+AgIB/f39/gICAgICAgH9/f4CAgH9/gICAgH9/f4CAgICAgICAgH9/gICAgH9/f3+AgIB/f4CAf39/gICAf39/f4CAgH9/f4CAf3+AgIB/f3+AgH9/f4CAgH9/f4CAf3+AgIB/f3+AgH9/gICAgH9/gIB/f3+AgH9/gICAf39/gH9/gICAf39/gH9/gICAf3+AgH9/f4B/f4CAgH9/gH9/f4CAgH9/gH9/f4CAgH9/gH9/f4CAf3+Af39/gICAgH+Af39/gICAf3+Af39/gICAgICAgH9/gICAgICAgH9/gICAgICAgH9/gICAgICAgH9/f4CAgICAgH9/f4CAgICAgICAgICAgICAgH9/f4CAgICAgH9/f4CAgICAgIB/f3+AgICAgICAf39/gICAgICAgH9/f4CAgICAgIB/f3+AgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgH9/f3+AgICAf3+AgICAgICAgICAgICAgH9/f3+AgICAgICAgICAf39/f39/f4CAgH9/f3+AgICAgH9/f3+AgICAgIB/f39/gICAgH9/f39/gICAgICAgICAgICAgIB/f39/gICAgICAgICAgICAgICAgH9/f3+AgICAgICAgIB/f3+AgICAgICAgICAgICAgIB/f3+AgICAgICAgICAgICAgIB/f39/gICAgICAgICAf39/f4CAgICAgICAf39/f4CAgICAgICAgH9/f3+AgICAgICAgH9/f39/gICAgICAf39/f3+AgICAgICAgICAgIB/f39/gICAgICAgICAgH9/f4CAgICAgIB/f39/gICAgICAgICAgICAgIB/f39/gICAgICAf39/f4CAgICAgICAgICAgIB/f39/gICAgICAgICAgIB/f39/gICAgICAgIB/f39/gICAgICAgH9/f39/gICAgICAgICAgH9/f4CAgICAgICAgICAgICAgICAgICAgH9/f4CAgICAgH9/f39/gICAgIB/f39/gICAgICAgH9/f39/gICAgICAgIB/f39/gICAgICAgIB/f39/gICAgICAgICAf39/f4CAgICAgICAgICAgIB/f39/gICAgICAgICAgICAgICAgH9/f3+AgICAgICAgICAgICAgIB/f39/gICAgICAgICAgICAgICAgH9/f4CAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgA==" type="audio/wav">
  </audio>

  <script src="/socket.io/socket.io.js"></script>
<script>
// Anti-cach√©: recargar si es versi√≥n vieja
if (!location.search.includes('v=')) {
  location.replace(location.pathname + '?v=' + Date.now());
}
    // ===== GLOBALS =====
    let socket, currentChat = null, shipClient = null;
    let allSales = [];
    let chats = {}, pending = {}, contacts = {};
    let humanModeChats = new Set(); // Chats en modo humano
    let activeSessions = {}; // Datos de sesi√≥n activa por waId
    let notificationsEnabled = false;

    // ===== QUICK REPLIES =====
    const DEFAULT_QUICK_REPLIES = [
      { code: 'hola', text: '¬°Hola! Pura vida üôå ¬øEn qu√© te puedo ayudar? üòä' },
      { code: 'horario', text: 'üìÖ Nuestro horario de atenci√≥n es:\n\nLunes a S√°bado: 9am - 7pm\nDomingos: 10am - 6pm\n\nüìç Estamos en Heredia centro, 100 mts sur de la esquina del Testy\n\nüåê Visitanos en www.lavacacr.com para estar al d√≠a con nuevos ingresos y promociones üôå' },
      { code: 'direccion', text: 'üìç Nos encontramos en:\n\nHeredia centro, 100 mts sur de la esquina del Testy\n\nüïí Horario: Lunes a S√°bado 9am - 7pm | Domingos 10am - 6pm\n\nüåê Visitanos en www.lavacacr.com para estar al d√≠a con nuevos ingresos y promociones üôå' },
      { code: 'sinpe', text: 'üí≥ El pago se hace por SINPE M√≥vil:\n\nüì± N√∫mero: 6326-2291\nüë§ Nombre: Moda Exclusiva Agort Ltda\n\nPor favor indic√° tu nombre completo al realizar el SINPE y una vez hecho el pago, mandame la foto del comprobante por este medio üßæ\n\nüåê Visitanos en www.lavacacr.com para estar al d√≠a con nuevos ingresos y promociones üôå' },
      { code: 'info-envios', text: 'üì¶ Hacemos env√≠os a todo el pa√≠s por medio de Correos de Costa Rica:\n\n‚Ä¢ GAM: ‚Ç°2,500\n‚Ä¢ Fuera del GAM: ‚Ç°3,000\n\n‚è±Ô∏è El paquete tarda aproximadamente 8 d√≠as h√°biles en llegar.\n\nüåê Visitanos en www.lavacacr.com para estar al d√≠a con nuevos ingresos y promociones üôå' },
      { code: 'datos-envio', text: 'Para coordinar el env√≠o necesito los siguientes datos üìã\n\n‚Ä¢ Nombre completo\n‚Ä¢ Tel√©fono\n‚Ä¢ Provincia\n‚Ä¢ Cant√≥n\n‚Ä¢ Distrito\n‚Ä¢ Direcci√≥n por se√±as\n\n(Ej: Mar√≠a L√≥pez, 8888-1234, Heredia, Central, Mercedes, frente a la iglesia)' },
      { code: 'gracias', text: '¬°Muchas gracias por tu compra! üéâ\n\nFue un placer atenderte. Cualquier consulta, aqu√≠ estamos con gusto üôå\n\nüåê Visitanos en www.lavacacr.com para estar al d√≠a con nuevos ingresos y promociones. ¬°Pura vida! üêÑ' },
      { code: 'no-hay', text: 'De momento no contamos con ese producto üòî\n\nCualquier otra consulta estamos para servirte con gusto üôå\n\nüåê Visitanos en www.lavacacr.com para estar al d√≠a con nuevos ingresos y promociones.' },
      { code: 'apartados', text: '‚ú® ¬°S√≠ hacemos apartados! üõçÔ∏è\n\nPara apartar tu producto necesit√°s cancelar la tercera parte del costo y ten√©s 2 meses para retirarlo en tienda.\n\n‚ö†Ô∏è Los apartados NO SE CAMBIAN.\n\nüìç Visitanos en www.lavacacr.com para conocer todo nuestro cat√°logo üêÑ' },
      { code: 'cambios', text: 'üîÑ Pol√≠tica de Cambios y Garant√≠a\n\nEs indispensable presentar la factura de compra.\n‚è±Ô∏è Ten√©s 30 d√≠as desde la fecha de compra para hacer el cambio.\n\nSi es cambio por talla o estilo, el producto debe venir en perfecto estado:\n‚ùå NO USADO\n‚ùå SIN OLOR A PERFUME\n‚ùå SIN OLOR A DETERGENTE\n\nüìç Visitanos en www.lavacacr.com üêÑ' }
    ];
    const QR_VERSION = 4; // Incrementar para forzar recarga de defaults
    const savedQr = localStorage.getItem('ticobot_qr');
    const savedVersion = parseInt(localStorage.getItem('ticobot_qr_v') || '0');
    let quickReplies = (savedQr && savedVersion >= QR_VERSION) ? JSON.parse(savedQr) : DEFAULT_QUICK_REPLIES;

    // ===== RESUMEN MODAL =====
    let resumenTipo = 'envio';

    function openResumenModal() {
      if (!currentChat) return;
      const chat = chats[currentChat];
      const session = activeSessions[currentChat] || {};

      // Pre-llenar con datos de sesi√≥n si existen
      document.getElementById('rProducto').value = session.producto || '';
      document.getElementById('rTalla').value = session.talla_color || '';
      document.getElementById('rPrecio').value = session.precio || '';
      document.getElementById('rEnvio').value = session.shipping_cost || '';

      // Buscar la √∫ltima direcci√≥n que escribi√≥ el cliente en el historial
      const msgs = chat?.messages || [];
      const lastClientMsg = [...msgs].reverse().find(m =>
        m.direction === 'in' &&
        m.text && m.text.length > 20 &&
        /provincia|canton|cant√≥n|distrito|se√±as|senas|heredia|san jose|alajuela|cartago/i.test(m.text)
      );
      document.getElementById('rDireccion').value = lastClientMsg?.text || session.envio_datos_raw || '';

      setResumenTipo('envio');
      updateResumenPreview();
      document.getElementById('resumenModal').classList.add('active');
    }

    function closeResumenModal() {
      document.getElementById('resumenModal').classList.remove('active');
    }

    function setResumenTipo(tipo) {
      resumenTipo = tipo;
      document.getElementById('tabEnvio').classList.toggle('active', tipo === 'envio');
      document.getElementById('tabRetiro').classList.toggle('active', tipo === 'retiro');
      document.getElementById('rEnvioField').style.display = tipo === 'envio' ? '' : 'none';
      document.getElementById('rDireccionField').style.display = tipo === 'envio' ? '' : 'none';
      updateResumenPreview();
    }

    function updateResumenPreview() {
      const producto = document.getElementById('rProducto').value.trim() || '(producto)';
      const talla = document.getElementById('rTalla').value.trim();
      const precio = parseInt(document.getElementById('rPrecio').value) || 0;
      const envio = parseInt(document.getElementById('rEnvio').value) || 0;
      const direccion = document.getElementById('rDireccion').value.trim();
      const total = precio + (resumenTipo === 'envio' ? envio : 0);

      let msg = 'üìã *Resumen de tu pedido*\n';
      msg += '‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n';
      msg += `üì¶ ${producto}\n`;
      if (talla) msg += `üëï ${talla}\n`;
      msg += `üí∞ Precio: ‚Ç°${precio.toLocaleString('es-CR')}\n`;
      if (resumenTipo === 'envio') {
        msg += `üöö Env√≠o: ‚Ç°${envio.toLocaleString('es-CR')}\n`;
      }
      msg += `üíµ *Total a pagar: ‚Ç°${total.toLocaleString('es-CR')}*\n`;
      msg += '‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n';

      if (resumenTipo === 'envio' && direccion) {
        msg += `üìç *Datos de env√≠o*\n${direccion}\n`;
        msg += '‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n';
      } else if (resumenTipo === 'retiro') {
        msg += `üè™ *Retiro en tienda*\nHeredia centro, 100 mts sur de la esquina del Testy\nüïí Lunes a S√°b 9am-7pm | Dom 10am-6pm\n`;
        msg += '‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n';
      }

      msg += `\nüí≥ *Pago por SINPE M√≥vil*\n`;
      msg += `üì± 6326-2291\n`;
      msg += `üë§ Moda Exclusiva Agort Ltda\n\n`;
      msg += `Por favor indic√° tu nombre al realizar el SINPE y mandame la foto del comprobante por este medio üßæ`;

      document.getElementById('resumenPreview').textContent = msg.replace(/\\n/g, '\n');
    }

    function sendResumen() {
      if (!currentChat) return;
      const producto = document.getElementById('rProducto').value.trim();
      const talla = document.getElementById('rTalla').value.trim();
      const precio = parseInt(document.getElementById('rPrecio').value) || 0;
      const envio = parseInt(document.getElementById('rEnvio').value) || 0;
      const direccion = document.getElementById('rDireccion').value.trim();
      const total = precio + (resumenTipo === 'envio' ? envio : 0);

      let msg = 'üìã *Resumen de tu pedido*\n';
      msg += '‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n';
      msg += `üì¶ ${producto || '(producto)'}\n`;
      if (talla) msg += `üëï ${talla}\n`;
      msg += `üí∞ Precio: ‚Ç°${precio.toLocaleString('es-CR')}\n`;
      if (resumenTipo === 'envio') msg += `üöö Env√≠o: ‚Ç°${envio.toLocaleString('es-CR')}\n`;
      msg += `üíµ *Total a pagar: ‚Ç°${total.toLocaleString('es-CR')}*\n`;
      msg += '‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n';

      if (resumenTipo === 'envio' && direccion) {
        msg += `üìç *Datos de env√≠o*\n${direccion}\n`;
        msg += '‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n';
      } else if (resumenTipo === 'retiro') {
        msg += `üè™ *Retiro en tienda*\nHeredia centro, 100 mts sur de la esquina del Testy\nüïí Lunes a S√°b 9am-7pm | Dom 10am-6pm\n`;
        msg += '‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n';
      }

      msg += `\nüí≥ *Pago por SINPE M√≥vil*\n`;
      msg += `üì± 6326-2291\n`;
      msg += `üë§ Moda Exclusiva Agort Ltda\n\n`;
      msg += `Por favor indic√° tu nombre al realizar el SINPE y mandame la foto del comprobante por este medio üßæ`;

      socket.emit('action', { clientWaId: currentChat, actionType: 'MENSAJE', payload: { texto: msg } });
      closeResumenModal();
      toast('üìã Resumen enviado al cliente', 'success');
    }

    function saveQuickRepliesLocal() {
      localStorage.setItem('ticobot_qr', JSON.stringify(quickReplies));
      localStorage.setItem('ticobot_qr_v', String(QR_VERSION));
    }

    function applyQuickReply(code) {
      const qr = quickReplies.find(r => r.code === code);
      if (!qr) return;
      const input = $('chatInput');
      if (input) {
        input.value = qr.text;
        input.focus();
        input.style.height = 'auto';
        input.style.height = Math.min(input.scrollHeight, 120) + 'px';
        // Close emoji panel
        const ep = $('emojiPanel');
        if (ep) ep.classList.remove('open');
      }
    }

    function renderQuickRepliesBar() {
      const bar = $('quickRepliesBar');
      if (!bar) return;
      bar.innerHTML = 
        `<button class="qr-chip" style="background:#e8f5e9;border-color:#a5d6a7;color:#2e7d32;font-weight:700;" onclick="openResumenModal()" title="Generar resumen de pedido">üìã resumen</button>` +
        quickReplies.map(qr =>
          `<button class="qr-chip" onclick="applyQuickReply('${qr.code}')" title="${qr.text.slice(0,60)}...">‚ö° ${qr.code}</button>`
        ).join('') + `<button class="qr-chip-manage" onclick="openQrManager()">‚úèÔ∏è</button>`;
    }

    function openQrManager() {
      renderQrManagerItems();
      $('qrManagerOverlay').classList.add('active');
    }

    function closeQrManager() {
      $('qrManagerOverlay').classList.remove('active');
    }


    function renderQrManagerItems() {
      const list = $('qrItemsList');
      list.innerHTML = quickReplies.map((qr, i) => `
        <div class="qr-item" id="qrItem_${i}">
          <input class="qr-item-code" type="text" value="${qr.code}" placeholder="c√≥digo" id="qrCode_${i}">
          <textarea class="qr-item-text" id="qrText_${i}" placeholder="Mensaje completo...">${qr.text}</textarea>
          <button class="qr-item-del" onclick="deleteQrItem(${i})">‚úï</button>
        </div>
      `).join('');
    }

    function addQrItem() {
      quickReplies.push({ code: 'nuevo', text: '' });
      renderQrManagerItems();
      // Scroll al final y focus en el nuevo
      const list = $('qrItemsList');
      list.scrollTop = list.scrollHeight;
      const lastCode = document.getElementById('qrCode_' + (quickReplies.length - 1));
      if (lastCode) { lastCode.focus(); lastCode.select(); }
    }

    function deleteQrItem(i) {
      quickReplies.splice(i, 1);
      renderQrManagerItems();
    }

    function saveQuickReplies() {
      // Leer valores del DOM
      quickReplies = quickReplies.map((_, i) => {
        const code = (document.getElementById('qrCode_' + i)?.value || '').trim().toLowerCase().replace(/\s+/g, '_');
        const text = document.getElementById('qrText_' + i)?.value || '';
        return { code, text };
      }).filter(qr => qr.code && qr.text);
      saveQuickRepliesLocal();
      closeQrManager();
      renderQuickRepliesBar();
      toast('‚úÖ Respuestas guardadas', 'success');
    }
    let swRegistration = null;
    let alertInterval = null; // Para repetir sonido

    const $ = id => document.getElementById(id);
    const $$ = sel => document.querySelectorAll(sel);

    // ===== LIMPIAR PWA ANTERIOR =====
    // Desregistrar service workers para salir del modo PWA
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.getRegistrations().then(regs => {
        regs.forEach(r => r.unregister());
        if (regs.length > 0) console.log('üßπ Service Workers limpiados');
      });
    }

    // ===== HELPERS =====
    function formatPhone(w) {
      const d = String(w).replace(/\D/g, '');
      return d.length === 11 && d.startsWith('506') ? d.slice(0,3) + ' ' + d.slice(3,7) + '-' + d.slice(7) : w;
    }
    function timeAgo(d) {
      if (!d) return '';
      const s = Math.floor((Date.now() - new Date(d)) / 1000);
      if (s < 60) return 'ahora';
      if (s < 3600) return Math.floor(s/60) + 'm';
      if (s < 86400) return Math.floor(s/3600) + 'h';
      return Math.floor(s/86400) + 'd';
    }
    function escapeHtml(t) {
      return String(t || '').replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
    }
    function linkify(text) {
      const escaped = escapeHtml(text);
      const urlRegex = /(https?:\/\/[^\s<]+)/g;
      return escaped.replace(urlRegex, '<a href="$1" target="_blank" rel="noopener" style="color:#1a73e8;text-decoration:underline;">$1</a>');
    }
    function toast(msg, type = '') {
      const t = $('toast');
      t.textContent = msg;
      t.className = 'toast show ' + type;
      setTimeout(() => t.classList.remove('show'), 3000);
    }
    // Variable para el audio
    let audioContext = null;
    let audioUnlocked = false;
    
    function playSound() {
      console.log('üîä Intentando reproducir sonido...');
      try {
        const audio = $('notifSound');
        audio.currentTime = 0;
        audio.volume = 1.0;
        
        // Intentar reproducir
        const playPromise = audio.play();
        if (playPromise !== undefined) {
          playPromise.then(() => {
            console.log('üîä Sonido reproducido');
          }).catch(e => {
            console.log('üîä Audio bloqueado:', e.message);
          });
        }
      } catch(e) {
        console.log('üîä Error:', e);
      }
    }
    
    // Desbloquear audio con el primer toque del usuario
    document.addEventListener('touchstart', function unlockAudio() {
      const audio = $('notifSound');
      audio.play().then(() => {
        audio.pause();
        audio.currentTime = 0;
        audioUnlocked = true;
        console.log('üîä Audio desbloqueado');
      }).catch(e => {});
      document.removeEventListener('touchstart', unlockAudio);
    }, { once: true });
    
    // Tambi√©n intentar con click
    document.addEventListener('click', function unlockAudioClick() {
      const audio = $('notifSound');
      audio.play().then(() => {
        audio.pause();
        audio.currentTime = 0;
        audioUnlocked = true;
        console.log('üîä Audio desbloqueado (click)');
      }).catch(e => {});
      document.removeEventListener('click', unlockAudioClick);
    }, { once: true });
    
    // ===== FORCE UPDATE UI =====
    let updatePending = false;
    function forceUpdate() {
      if (updatePending) return;
      updatePending = true;
      
      // Usar setTimeout 0 para salir del contexto actual
      setTimeout(() => {
        updatePending = false;
        console.log('üîÑ forceUpdate ejecutando');
        
        // Siempre re-renderizar la lista
        renderChatList();
        
        // Si hay chat abierto, actualizar el contenido
        if (currentChat && chats[currentChat]) {
          // Solo actualizar el contenedor de mensajes, no todo el chatArea
          const container = $('messagesContainer');
          if (container) {
            const chat = chats[currentChat];
            container.innerHTML = renderMessages(chat);
            container.scrollTop = container.scrollHeight;
          } else {
            // Si no existe el contenedor, re-renderizar todo
            renderChat();
          }
        }
      }, 0);
    }

    // ===== NOTIFICATIONS =====
    function requestNotifications() {
      if (!('Notification' in window)) {
        toast('Tu navegador no soporta notificaciones', 'error');
        return;
      }
      Notification.requestPermission().then(perm => {
        if (perm === 'granted') {
          notificationsEnabled = true;
          $('notifBtn').classList.add('enabled');
          toast('üîî Notificaciones activadas', 'success');
          // Test notification via Service Worker
          if (swRegistration) {
            swRegistration.showNotification('‚úÖ TICObot Activado', { 
              body: 'Las notificaciones est√°n funcionando. Pod√©s cerrar el navegador.', 
              icon: '/icon-192.svg',
              badge: '/icon-192.svg',
              requireInteraction: true,
              vibrate: [200, 100, 200]
            });
          } else {
            new Notification('‚úÖ TICObot Activado', { 
              body: 'Las notificaciones est√°n funcionando', 
              icon: 'üêÑ',
              requireInteraction: true
            });
          }
        } else {
          toast('Notificaciones denegadas', 'error');
        }
      });
    }
    
    function showNotification(title, body) {
      // Detener alerta anterior si existe
      stopAlert();
      
      // Iniciar alerta repetitiva (sonido cada 15 segundos por 2 minutos)
      startAlert();
      
      // Notificaci√≥n via Service Worker (funciona con pantalla apagada)
      if (swRegistration && Notification.permission === 'granted') {
        swRegistration.showNotification(title, { 
          body, 
          icon: '/icon-192.svg',
          badge: '/icon-192.svg',
          tag: 'ticobot-action',
          requireInteraction: true,
          vibrate: [200, 100, 200, 100, 200, 100, 200],
          actions: [
            { action: 'open', title: 'üì± Abrir' }
          ]
        });
      } else if (notificationsEnabled && Notification.permission === 'granted') {
        const notif = new Notification(title, { 
          body, 
          icon: 'üêÑ',
          tag: 'ticobot-action',
          requireInteraction: true,
          silent: false
        });
        notif.onclick = () => {
          window.focus();
          notif.close();
          stopAlert();
        };
      }
      
      // Vibrar si est√° disponible (m√≥vil)
      if (navigator.vibrate) {
        navigator.vibrate([200, 100, 200, 100, 200, 100, 200]);
      }
      
      // Cambiar t√≠tulo de la pesta√±a para llamar atenci√≥n
      const originalTitle = document.title;
      let blink = true;
      const blinkInterval = setInterval(() => {
        document.title = blink ? 'üî¥ ¬°ACCI√ìN REQUERIDA!' : originalTitle;
        blink = !blink;
      }, 1000);
      
      // Parar el parpadeo despu√©s de 2 minutos o cuando se enfoque la ventana
      setTimeout(() => {
        clearInterval(blinkInterval);
        document.title = originalTitle;
      }, 120000);
      
      window.addEventListener('focus', () => {
        clearInterval(blinkInterval);
        document.title = originalTitle;
        stopAlert();
      }, { once: true });
    }
    
    function startAlert() {
      playSound();
      // Repetir sonido cada 15 segundos por 2 minutos
      let count = 0;
      alertInterval = setInterval(() => {
        count++;
        if (count > 8) { // 8 * 15 = 2 minutos
          stopAlert();
          return;
        }
        playSound();
        // Vibrar tambi√©n
        if (navigator.vibrate) {
          navigator.vibrate([200, 100, 200, 100, 200]);
        }
      }, 15000);
    }
    
    function stopAlert() {
      if (alertInterval) {
        clearInterval(alertInterval);
        alertInterval = null;
      }
    }
    
    function playSound() {
      try {
        const audio = $('notifSound');
        audio.currentTime = 0;
        audio.volume = 1.0;
        audio.play().catch(e => console.log('Audio blocked:', e));
        // Repetir sonido 2 veces m√°s
        setTimeout(() => { audio.currentTime = 0; audio.play().catch(e=>{}); }, 400);
        setTimeout(() => { audio.currentTime = 0; audio.play().catch(e=>{}); }, 800);
      } catch(e) {}
    }

    // ===== LOGIN =====
    const pins = $$('.pin-digit');
    pins.forEach((p, i) => {
      p.addEventListener('input', e => {
        if (e.target.value && i < 3) pins[i+1].focus();
        $('loginBtn').disabled = getPin().length !== 4;
      });
      p.addEventListener('keydown', e => {
        if (e.key === 'Backspace' && !e.target.value && i > 0) pins[i-1].focus();
      });
    });
    function getPin() { return Array.from(pins).map(p => p.value).join(''); }

    $('loginBtn').onclick = () => connect(getPin());
    const savedPin = localStorage.getItem('ticobot_pin');
    if (savedPin) connect(savedPin);
    else pins[0].focus();

    // ===== SOCKET CONNECTION =====
    function connect(pin) {
      socket = io({
        reconnection: true,
        reconnectionAttempts: Infinity,
        reconnectionDelay: 1000,
        reconnectionDelayMax: 5000
      });
      
      socket.on('connect', () => {
        console.log('üîå Socket conectado');
        socket.emit('auth', pin);
      });
      
      socket.on('disconnect', () => {
        console.log('üîå Socket desconectado');
      });
      
      socket.on('reconnect', () => {
        console.log('üîå Socket reconectado - solicitando datos frescos');
        socket.emit('auth', pin);
      });
      
      socket.on('auth_success', () => {
        localStorage.setItem('ticobot_pin', pin);
        $('login').classList.add('hidden');
        $('app').classList.add('active');
        toast('‚úÖ Conectado', 'success');
        // Check notification permission
        if (Notification.permission === 'granted') {
          notificationsEnabled = true;
          $('notifBtn').classList.add('enabled');
        }
      });
      socket.on('auth_error', msg => {
        $('loginError').textContent = msg;
        pins.forEach(p => p.value = '');
        pins[0].focus();
        localStorage.removeItem('ticobot_pin');
      });

      // Connection status
      socket.on('connection_status', data => {
        const badge = $('connBadge');
        if (data.status === 'connected') {
          badge.className = 'conn-badge on';
          badge.textContent = 'üü¢ CONECTADO';
          badge.onclick = null;
          hideQR();
        } else if (data.status === 'qr' || data.status === 'connecting') {
          badge.className = 'conn-badge wait';
          badge.textContent = 'üü° CONECTANDO';
        } else {
          badge.className = 'conn-badge off';
          badge.textContent = 'üî¥ CONECTAR';
          badge.onclick = showQR;
        }
      });

      // QR Code
      socket.on('qr_code', data => {
        $('qrContent').innerHTML = `<img src="${data.qr}" alt="QR"><p class="qr-instructions">1. Abr√≠ WhatsApp<br>2. ‚ãÆ ‚Üí Dispositivos vinculados<br>3. Escane√° el QR</p>`;
      });

      // Bot status
      socket.on('bot_status', data => {
        const btn = $('botToggle');
        if (data.paused) {
          btn.textContent = '‚è∏Ô∏è Pausado';
          btn.className = 'bot-toggle paused';
        } else {
          btn.textContent = '‚ñ∂Ô∏è Bot';
          btn.className = 'bot-toggle active';
        }
      });

      // Init data
      socket.on('init_data', data => {
        // Process history into chats
        chats = {};
        (data.history || []).forEach(m => {
          if (!chats[m.waId]) chats[m.waId] = { messages: [], pending: null };
          chats[m.waId].messages.push(m);
        });
        // Process pending
        (data.pending || []).forEach(p => {
          if (!chats[p.waId]) chats[p.waId] = { messages: [], pending: null };
          // Detectar si es multi-producto (tiene products array o type='multi')
          if (p.products || p.type === 'multi') {
            chats[p.waId].pending = { ...p, tipo: 'multi' };
          } else {
            chats[p.waId].pending = p;
          }
        });
        // Contacts
        (data.contacts || []).forEach(c => contacts[c.waId] = c);
        // Sales
        if(data.sales) allSales = data.sales;
        // Human mode chats
        humanModeChats = new Set(data.humanModeChats || []);
        // Active sessions for resumen
        activeSessions = data.activeSessions || {};
        renderChatList();
        if (currentChat) renderChat();
        
        // Auto-abrir chat espec√≠fico si viene de Pushover (?chat=XXXX)
        const urlParams = new URLSearchParams(window.location.search);
        const chatParam = urlParams.get('chat');
        if (chatParam && chats[chatParam]) {
          openChat(chatParam);
          // Limpiar URL para que no reabra al refrescar
          window.history.replaceState({}, '', window.location.pathname);
        }
        
        // Auto-abrir modal de env√≠o si hay zonas pendientes
        if (data.pendingZones && data.pendingZones.length > 0) {
          const z = data.pendingZones[0];
          shipClient = z.waId;
          $('shipClient').textContent = formatPhone(z.waId);
          $('shipZone').textContent = z.zone || '-';
          $('shipPrice').textContent = '‚Ç°' + (z.precio || 0).toLocaleString();
          $('shipInput').value = '';
          $('shippingModal').classList.add('active');
        }
      });

      // New message - NO notificar (solo actualizar UI)
      socket.on('new_message', msg => {
        console.log('üì© new_message:', msg.waId);
        if (!chats[msg.waId]) chats[msg.waId] = { messages: [], pending: null };
        chats[msg.waId].messages.push(msg);
        forceUpdate();
      });

      // New pending (stock query)
      socket.on('new_pending', item => {
        console.log('üì• new_pending:', item.waId, 'foto_url:', item.foto_url ? item.foto_url.substring(0, 50) + '...' : 'null');
        if (!chats[item.waId]) chats[item.waId] = { messages: [], pending: null };
        chats[item.waId].pending = item;
        forceUpdate();
        showNotification('üì• Nueva consulta', `${item.producto || 'Producto'} - ${formatPhone(item.waId)}`);
      });

      // Multi-producto received
      socket.on('new_pending_multi', item => {
        console.log('üì• new_pending_multi:', item.waId, item.products?.length + ' productos');
        if (!chats[item.waId]) chats[item.waId] = { messages: [], pending: null };
        chats[item.waId].pending = { ...item, tipo: 'multi' };
        forceUpdate();
        showNotification('üìã Lista de productos', `${item.products?.length || '?'} productos - ${formatPhone(item.waId)}`);
      });

      // SINPE received
      socket.on('sinpe_received', data => {
        if (!chats[data.waId]) chats[data.waId] = { messages: [], pending: null };
        chats[data.waId].pending = { ...data, tipo: 'sinpe' };
        forceUpdate();
        showNotification('üí∞ SINPE recibido', formatPhone(data.waId));
      });

      // Zone received - show shipping modal
      socket.on('zone_received', data => {
        shipClient = data.waId;
        $('shipClient').textContent = formatPhone(data.waId);
        $('shipZone').textContent = data.zone || '-';
        $('shipPrice').textContent = '‚Ç°' + (data.precio || 0).toLocaleString();
        $('shipInput').value = '';
        $('shippingModal').classList.add('active');
        showNotification('üìç Zona recibida', data.zone);
      });

      // Producto de tienda f√≠sica (no en cat√°logo online)
      socket.on('store_product_inquiry', data => {
        if (!chats[data.waId]) chats[data.waId] = { messages: [], pending: null };
        chats[data.waId].pending = { 
          ...data, 
          tipo: 'tienda',
          producto: data.producto
        };
        renderChatList();
        if (currentChat === data.waId) renderChat();
        showNotification('üè™ Producto de tienda', `${data.producto?.slice(0,30)} - ${formatPhone(data.waId)}`);
      });

      // Pending resolved
      socket.on('pending_resolved', data => {
        if (chats[data.waId]) {
          chats[data.waId].pending = null;
        }
        renderChatList();
        if (currentChat === data.waId) renderChat();
      });

      // Sale completed
      socket.on('sale_completed', sale => {
        allSales.push(sale);
        toast(`üí∞ Venta: ‚Ç°${(sale.total||0).toLocaleString()} - ${sale.producto||'Producto'}`, 'success');
        if (chats[sale.waId]) chats[sale.waId].pending = null;
        renderChatList();
      });

      // Action result
      socket.on('action_result', r => {
        if (r.success && r.sessionData) {
          fillResumenModal(r.sessionData);
          return;
        }
        toast(r.success ? '‚úÖ ' + r.message : '‚ùå ' + r.message, r.success ? 'success' : 'error');
        hideShipModal();
      });

      // Session data updates (for resumen modal pre-fill)
      socket.on('session_updated', data => {
        if (data.waId) {
          activeSessions[data.waId] = {
            producto: data.producto,
            precio: data.precio,
            talla_color: data.talla_color,
            shipping_cost: data.shipping_cost,
            envio_datos_raw: data.envio_datos_raw,
            delivery_method: data.delivery_method,
            client_zone: data.client_zone
          };
        }
      });

      // Human mode events
      socket.on('human_mode_changed', data => {
        if (data.humanMode) {
          humanModeChats.add(data.waId);
        } else {
          humanModeChats.delete(data.waId);
        }
        renderChatList();
        if (currentChat === data.waId) renderChat();
      });

      socket.on('human_mode_message', data => {
        // Mensaje lleg√≥ mientras humano tiene el chat ‚Äî solo notificar con sonido
        if (currentChat === data.waId) return; // Ya lo ve en pantalla
        playSound();
        showNotification('üí¨ Mensaje nuevo', `${data.text?.slice(0,30)} ‚Äî ${data.phone}`);
      });

      // Contacts
      socket.on('contacts_list', data => {
        (data.contacts || []).forEach(c => contacts[c.waId] = c);
      });
    }

    // ===== QR =====
    function showQR() {
      $('qrOverlay').classList.add('active');
      socket.emit('connect_whatsapp');
    }
    function hideQR() {
      $('qrOverlay').classList.remove('active');
    }

    // ===== TAB FILTER =====
    let currentTabFilter = 'todos';
    function setTabFilter(filter) {
      currentTabFilter = filter;
      document.getElementById('tabTodos').classList.toggle('active', filter === 'todos');
      document.getElementById('tabNoLeidos').classList.toggle('active', filter === 'noleidos');
      renderChatList();
    }

    // ===== RENDER CHAT LIST =====
    function renderChatList() {
      const list = $('chatList');
      const filter = $('searchInput').value.toLowerCase();
      
      // Contar pendientes y actualizar indicador
      const pendingCount = Object.values(chats).filter(c => c.pending).length;
      const indicator = $('pendingIndicator');
      if (pendingCount > 0) {
        indicator.textContent = `${pendingCount} PENDIENTE${pendingCount > 1 ? 'S' : ''}`;
        indicator.classList.add('active');
      } else {
        indicator.classList.remove('active');
      }
      
      // Sort: pending first, then by last message time
      const sorted = Object.keys(chats).sort((a, b) => {
        const ap = chats[a].pending ? 1 : 0;
        const bp = chats[b].pending ? 1 : 0;
        if (ap !== bp) return bp - ap;
        const aLast = chats[a].messages[chats[a].messages.length - 1];
        const bLast = chats[b].messages[chats[b].messages.length - 1];
        return new Date(bLast?.timestamp || 0) - new Date(aLast?.timestamp || 0);
      });

      const filtered = sorted.filter(waId => {
        const c = contacts[waId];
        const nameMatch = waId.includes(filter) || (c?.name || '').toLowerCase().includes(filter);
        if (!nameMatch) return false;
        if (currentTabFilter === 'noleidos') {
          const chat = chats[waId];
          const unread = chat.unread_count || 0;
          const hasPending = !!chat.pending;
          return unread > 0 || hasPending;
        }
        return true;
      });

      list.innerHTML = filtered.map(waId => {
        const chat = chats[waId];
        const last = chat.messages[chat.messages.length - 1];
        const contact = contacts[waId];
        const name = contact?.name || formatPhone(waId);
        const hasPending = !!chat.pending;
        const isHumanMode = humanModeChats.has(waId);
        const isSinpe = chat.pending?.tipo === 'sinpe';
        const unread = chat.unread_count || (hasPending ? 1 : 0);
        
        const colorIdx = waId.charCodeAt(waId.length-1) % 5;
        const avatarColors = ['#075E54','#128C7E','#2c6e49','#1565c0','#6a1b9a'];
        const avatarBg = avatarColors[colorIdx];
        const initials = name.slice(0,2).toUpperCase();
        const isBot = last?.direction === 'out';
        const previewIcon = isBot ? 'ü§ñ ' : '';
        const previewText = last?.text?.slice(0,42) || (last?.imageUrl ? 'üì∑ Imagen' : '');

        let rightBadge = '';
        if (unread > 0) {
          const badgeCls = hasPending ? 'alert' : '';
          const badgeLabel = hasPending ? (isSinpe ? 'üí∞' : (isHumanMode ? 'üë§' : '!')) : unread;
          rightBadge = `<span class="chat-unread ${badgeCls}">${badgeLabel}</span>`;
        }
        
        return `
          <div class="chat-item ${currentChat === waId ? 'active' : ''} ${hasPending ? 'has-action' : ''} ${isHumanMode ? 'human-mode' : ''}" onclick="openChat('${waId}')">
            <div class="chat-avatar" style="background:${avatarBg}">${initials}</div>
            <div class="chat-info">
              <div class="chat-name">${escapeHtml(name)}</div>
              <div class="chat-preview"><span class="bot-icon">${previewIcon}</span>${escapeHtml(previewText)}</div>
            </div>
            <div class="chat-meta">
              <div class="chat-time">${timeAgo(last?.timestamp)}</div>
              ${rightBadge}
            </div>
          </div>
        `;
      }).join('') || `<div style="text-align:center;padding:2rem;color:var(--wa-muted);font-size:0.9rem;">Sin chats</div>`;
    }

    $('searchInput').oninput = renderChatList;
   function openChat(waId) {
  currentChat = waId;
  renderChatList();
  renderChat();
  
  // Mobile: show chat area
  $('sidebar').classList.add('hidden');
  $('chatArea').classList.add('active');
  $('chatArea').classList.remove('empty');

  // Agregar al historial para que el bot√≥n atr√°s funcione
  history.pushState({ chat: waId }, '', '');
      
      // Scroll al fondo despu√©s del layout change
      setTimeout(() => {
        const c = $('messagesContainer');
        if(c) c.scrollTop = c.scrollHeight;
      }, 200);
    }

    function renderChat() {
      if (!currentChat || !chats[currentChat]) return;
      
      const chat = chats[currentChat];
      const contact = contacts[currentChat];
      const name = contact?.name || formatPhone(currentChat);
      const isHuman = humanModeChats.has(currentChat);
      const colorIdx = currentChat.charCodeAt(currentChat.length-1) % 5;
      const avatarColors = ['#075E54','#128C7E','#2c6e49','#1565c0','#6a1b9a'];
      const avatarBg = avatarColors[colorIdx];
      
      $('chatArea').innerHTML = `
        <div class="chat-header">
          <button class="chat-header-back" onclick="closeChat()">‚Üê</button>
          <div class="chat-header-avatar" style="background:${avatarBg}">${name.slice(0,2).toUpperCase()}</div>
          <div class="chat-header-info">
            <div class="chat-header-name">${escapeHtml(name)}</div>
            <div class="chat-header-status">${isHuman ? 'üë§ Modo humano activo' : 'ü§ñ Bot activo ¬∑ ' + formatPhone(currentChat)}</div>
          </div>
          <div class="chat-header-actions">
            ${isHuman 
              ? `<button class="chat-header-btn" onclick="liberarChat()">ü§ñ Dar al bot</button>`
              : `<button class="chat-header-btn" onclick="tomarChat()">üë§ Tomar chat</button>`
            }
            <button class="chat-header-btn" onclick="deleteChat()">üóëÔ∏è</button>
          </div>
        </div>
        ${isHuman ? `<div class="human-banner">üë§ <strong>Modo humano</strong> ‚Äî el bot no responde en este chat. Vos control√°s.</div>` : ''}
        <div class="messages-container" id="messagesContainer">
          ${renderMessages(chat)}
        </div>
        <div class="chat-input-wrapper">
          <div id="emojiPanel" class="emoji-panel"></div>
          <div id="quickRepliesBar" class="quick-replies-bar"></div>
          <div class="chat-input-area">
            <button class="input-icon-btn" onclick="toggleEmojiPanel()" title="Emojis">üòä</button>
            <button class="input-icon-btn" onclick="document.getElementById('fileAttachInput').click()" title="Adjuntar archivo">üìé</button>
            <textarea class="chat-input" id="chatInput" rows="1" placeholder="${isHuman ? 'Escrib√≠ tu respuesta...' : 'Respuesta manual...'}" oninput="handleInputChange(this)" onkeydown="handleKeyDown(event)"></textarea>
            <button class="chat-send-btn" onclick="sendMessage()" title="Enviar">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor"><path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/></svg>
            </button>
          </div>
        </div>
      `;
      
      // Render quick replies bar
      renderQuickRepliesBar();
      renderEmojiPanel();
      
      // Auto-resize textarea
      const textarea = $('chatInput');
      textarea.addEventListener('input', () => {
        textarea.style.height = 'auto';
        textarea.style.height = Math.min(textarea.scrollHeight, 120) + 'px';
      });
      
      // Scroll to bottom
      const container = $('messagesContainer');
      container.scrollTop = container.scrollHeight;
      setTimeout(() => { container.scrollTop = container.scrollHeight; }, 100);
      setTimeout(() => { container.scrollTop = container.scrollHeight; }, 500);
    }

    function tomarChat() {
      if (!currentChat) return;
      socket.emit('action', { clientWaId: currentChat, actionType: 'TOMAR_CHAT' });
      humanModeChats.add(currentChat);
      renderChat();
      renderChatList();
    }

    function liberarChat() {
      if (!currentChat) return;
      socket.emit('action', { clientWaId: currentChat, actionType: 'LIBERAR_CHAT' });
      humanModeChats.delete(currentChat);
      renderChat();
      renderChatList();
    }

    function renderMessages(chat) {
      let html = '';
      let lastDate = '';
      
      chat.messages.forEach(m => {
        const msgDate = new Date(m.timestamp);
        const dateStr = msgDate.toLocaleDateString('es-CR', { weekday: 'long', day: 'numeric', month: 'long' });
        const timeStr = msgDate.toLocaleTimeString('es-CR', { hour: '2-digit', minute: '2-digit' });
        
        // Date separator
        if (dateStr !== lastDate) {
          lastDate = dateStr;
          const today = new Date().toLocaleDateString('es-CR', { weekday: 'long', day: 'numeric', month: 'long' });
          const yesterday = new Date(Date.now()-86400000).toLocaleDateString('es-CR', { weekday: 'long', day: 'numeric', month: 'long' });
          const label = dateStr === today ? 'HOY' : dateStr === yesterday ? 'AYER' : dateStr.toUpperCase();
          html += `<div class="date-separator"><span>${label}</span></div>`;
        }
        
        const hasImg = m.imageUrl && m.imageUrl.length > 100;
        const imgSrc = hasImg ? (m.imageUrl.startsWith('data:') ? m.imageUrl : `data:image/jpeg;base64,${m.imageUrl}`) : null;
        
        html += `<div class="message ${m.direction}">
          <div class="message-bubble">
            ${hasImg ? `<img class="message-image" src="${imgSrc}" onclick="viewImage(this.src)" alt="Imagen">` : ''}
            ${m.text ? `<div class="message-text">${linkify(m.text)}</div>` : ''}
            <div class="message-time">${timeStr}</div>
          </div>
        </div>`;
      });
      
      // Pending action card
      if (chat.pending) {
        const p = chat.pending;
        const isSinpe = p.tipo === 'sinpe' || p.type === 'sinpe';
        const isTienda = p.tipo === 'tienda' || p.type === 'tienda';
        const isMulti = p.tipo === 'multi' || p.type === 'multi';
        const isFotoExterna = p.foto_externa;
        
        if (isMulti) {
          const prods = p.products || [];
          let multiHtml = `
            <div class="action-card" id="actionCard" style="background:#f0f4ff;border-color:#3b82f6;">
              <div class="action-card-header"><span class="action-card-icon">üìã</span><span>LISTA DE PRODUCTOS (${prods.length})</span></div>
              <div style="font-size:0.85rem;margin-bottom:10px;">`;
          prods.forEach((prod, i) => {
            multiHtml += `<div style="display:flex;align-items:center;gap:8px;padding:8px;margin:4px 0;background:#fff;border-radius:8px;border:1px solid #e0e0e0;">
              <span style="font-weight:bold;font-size:1.1rem;min-width:24px;color:#3b82f6;">${i+1}.</span>
              <input type="checkbox" id="mp_${i}" data-idx="${i}" checked style="width:20px;height:20px;cursor:pointer;">
              ${prod.foto_url ? `<img src="${prod.foto_url}" style="width:50px;height:50px;object-fit:cover;border-radius:6px;cursor:pointer;" onclick="viewImage(this.src)" onerror="this.style.display='none'">` : ''}
              <div style="flex:1;">
                <div style="font-weight:600;">${prod.producto_url ? `<a href="${prod.producto_url}" target="_blank" style="color:#1a73e8;text-decoration:none;">${escapeHtml(prod.producto || 'Producto')} üîó</a>` : escapeHtml(prod.producto || 'Producto')}</div>
                <div style="font-size:0.8rem;color:#666;">${prod.codigo || ''} ${prod.talla ? '¬∑ ' + prod.talla : ''} ${prod.color ? '¬∑ ' + prod.color : ''}</div>
              </div>
              <input type="number" id="mpPrecio_${i}" value="${prod.precio || 0}" style="width:80px;padding:4px 6px;border:1px solid #ddd;border-radius:6px;font-size:0.85rem;text-align:right;" placeholder="Precio">
            </div>`;
          });
          multiHtml += `</div>
              <div class="action-card-buttons" style="flex-direction:column;gap:8px;">
                <div style="display:flex;gap:8px;">
                  <button class="action-btn primary" onclick="confirmMulti('${p.waId}')">‚úÖ S√≠ Hay Todos</button>
                  <button class="action-btn danger" onclick="confirmAction('NO_HAY')">‚ùå No Hay</button>
                </div>
                <div style="display:flex;gap:8px;align-items:center;">
                  <button class="action-btn" style="background:#f59e0b;flex:1;" onclick="confirmMultiParcial('${p.waId}')">‚ö†Ô∏è Solo Hay</button>
                  <input type="text" id="multiParcial_${p.waId}" placeholder="Ej: 1,3" style="width:80px;padding:8px;border:1px solid #ddd;border-radius:8px;font-size:14px;text-align:center;">
                </div>
              </div>
            </div>`;
          html += multiHtml;
        } else {
          let cardClass = isSinpe ? 'sinpe' : isTienda ? 'tienda' : isFotoExterna ? 'foto-externa' : '';
          let icon = isSinpe ? 'üí∞' : isTienda ? 'üè™' : isFotoExterna ? 'üì∑' : 'üîî';
          let title = isSinpe ? 'CONFIRMAR PAGO SINPE' : isTienda ? 'PRODUCTO DE TIENDA F√çSICA' : isFotoExterna ? 'PRODUCTO DE FOTO' : 'CONFIRMAR DISPONIBILIDAD';
          
          html += `<div class="action-card ${cardClass}" id="actionCard">
            <div class="action-card-header"><span class="action-card-icon">${icon}</span><span>${title}</span></div>
            ${p.foto_url ? `<img class="action-card-image" src="${p.foto_url}" onclick="viewImage(this.src)" onerror="this.style.display='none'" alt="Foto producto">` : ''}
            <div class="action-card-details">
              <div class="action-card-detail">üì¶ <strong>${p.producto_url ? `<a href="${p.producto_url}" target="_blank" style="color:#1a73e8;text-decoration:none;">${escapeHtml(p.producto || 'Producto')} üîó</a>` : escapeHtml(p.producto || 'Producto')}</strong></div>
              ${p.codigo ? `<div class="action-card-detail">üè∑Ô∏è C√≥digo: ${escapeHtml(p.codigo)}</div>` : ''}
              ${p.talla_color ? `<div class="action-card-detail">üëï ${escapeHtml(p.talla_color)}</div>` : ''}
              ${!isSinpe && !isTienda && !isFotoExterna && p.precio ? `<div class="action-card-detail">üí∞ ‚Ç°${(p.precio || 0).toLocaleString()}</div>` : ''}
              ${isSinpe ? `
                <div class="action-card-detail">üí∞ Producto: ‚Ç°${(p.precio || 0).toLocaleString()}</div>
                ${p.shipping_cost ? `<div class="action-card-detail">üöö Env√≠o: ‚Ç°${(p.shipping_cost || 0).toLocaleString()}</div>` : ''}
                <div class="action-card-detail"><strong>üíµ Total: ‚Ç°${(p.total || 0).toLocaleString()}</strong></div>
                ${p.zone ? `<div class="action-card-detail">üìç Zona: ${escapeHtml(p.zone)}</div>` : ''}
                <div class="action-card-detail">üì± ${escapeHtml(p.method === 'envio' ? 'Env√≠o' : 'Retiro en tienda')}</div>
                <div style="margin:10px 0;padding:8px;background:#fff3cd;border-radius:8px;text-align:center">
                  <div style="font-weight:bold;margin-bottom:6px">üßæ COMPROBANTE SINPE</div>
                  ${p.comprobante_url ? `<img src="${p.comprobante_url}" onclick="viewImage(this.src)" style="max-width:100%;max-height:250px;border-radius:8px;cursor:pointer;border:2px solid #ddd" alt="Comprobante">` : '<div style="color:#999;font-style:italic">üì∑ El cliente no adjunt√≥ foto</div>'}
                  ${p.reference ? `<div style="margin-top:6px;font-size:0.85rem">üìù Ref: ${escapeHtml(p.reference)}</div>` : ''}
                </div>
              ` : ''}
              ${isTienda ? `<div class="action-card-detail" style="color:#666;font-style:italic;">‚ö†Ô∏è Este producto no est√° en cat√°logo online.<br>El cliente fue invitado a visitar la tienda.</div>` : ''}
            </div>
            <div class="action-card-buttons">
              ${isSinpe ? `
                <button class="action-btn primary" onclick="confirmAction('PAGADO')">‚úÖ Pago Confirmado</button>
                <button class="action-btn danger" onclick="confirmAction('SINPE_ERROR')">‚ùå Error Comprobante</button>
              ` : isTienda ? `
                <button class="action-btn info" onclick="dismissAction()">‚úì Visto</button>
              ` : `
                <button class="action-btn primary" onclick="confirmAction('SI_HAY')">‚úÖ S√≠ Hay</button>
                <button class="action-btn danger" onclick="confirmAction('NO_HAY')">‚ùå No Hay</button>
              `}
            </div>
          </div>`;
        }
      }
      
      return html;
    }

    function closeChat() {
      currentChat = null;
      $('sidebar').classList.remove('hidden');
      $('chatArea').classList.remove('active');
      $('chatArea').classList.add('empty');
      $('chatArea').innerHTML = `
        <div class="empty-chat">
          <div class="empty-chat-icon">üí¨</div>
          <div class="empty-chat-text">Seleccion√° un chat para empezar</div>
        </div>
      `;
      renderChatList();
    }

    // ===== ACTIONS =====
    function dismissAction() {
      if (!currentChat || !chats[currentChat]) return;
      stopAlert(); // Detener alarma
      chats[currentChat].pending = null;
      renderChat();
      renderChatList();
      toast('‚úì Marcado como visto', 'success');
    }

    function confirmAction(type) {
      if (!currentChat) return;
      
      // Mensaje de confirmaci√≥n seg√∫n tipo
      const mensajes = {
        'SI_HAY': '¬øPresionaste S√ç HAY, est√°s seguro?',
        'NO_HAY': '¬øPresionaste NO HAY, est√°s seguro?',
        'PAGADO': '¬øPresionaste PAGO CONFIRMADO, est√°s seguro?',
        'SINPE_ERROR': '¬øPresionaste ERROR COMPROBANTE, est√°s seguro?'
      };
      const msg = mensajes[type] || '¬øEst√°s seguro de esta acci√≥n?';
      if (!confirm(msg)) return;
      
      stopAlert();
      
      // Deshabilitar TODOS los botones de acci√≥n
      const allBtns = document.querySelectorAll('.action-btn');
      allBtns.forEach(b => {
        b.disabled = true;
        b.style.opacity = '0.4';
      });
      const btn = event.target;
      btn.textContent = '‚è≥ Enviando...';
      btn.style.background = '#999';
      
      socket.emit('action', { clientWaId: currentChat, actionType: type });
      
      setTimeout(() => {
        if (chats[currentChat]) {
          chats[currentChat].pending = null;
          renderChat();
          renderChatList();
        }
      }, 1000);
    }

    function confirmMulti(waId) {
      if (!confirm('¬øPresionaste S√ç HAY TODOS, est√°s seguro?')) return;
      
      stopAlert();
      // Recoger checkboxes marcados y precios
      const disponibles = [];
      const precios = {};
      const checkboxes = document.querySelectorAll('[id^="mp_"]');
      checkboxes.forEach(cb => {
        const idx = parseInt(cb.dataset.idx);
        const precioEl = document.getElementById('mpPrecio_' + idx);
        if (cb.checked) {
          disponibles.push(idx);
          if (precioEl) precios[String(idx)] = parseInt(precioEl.value) || 0;
        }
      });
      
      // Deshabilitar botones
      const allBtns = document.querySelectorAll('.action-btn');
      allBtns.forEach(b => { b.disabled = true; b.style.opacity = '0.4'; });
      event.target.textContent = '‚è≥ Enviando...';
      
      socket.emit('action', { 
        clientWaId: waId, 
        actionType: 'MULTI_DISPONIBILIDAD', 
        payload: { disponibles, precios } 
      });
      
      setTimeout(() => {
        if (chats[waId]) {
          chats[waId].pending = null;
          renderChat();
          renderChatList();
        }
      }, 1000);
    }

    function confirmMultiParcial(waId) {
      const input = document.getElementById('multiParcial_' + waId);
      const nums = input ? input.value.trim() : '';
      
      if (!nums) {
        alert('Escrib√≠ los n√∫meros de productos disponibles (ej: 1,3)');
        return;
      }
      
      // Parsear n√∫meros: "1,3" o "1 3" o "1, 3"
      const indices = nums.split(/[\s,]+/).map(n => parseInt(n.trim()) - 1).filter(n => !isNaN(n) && n >= 0);
      
      if (indices.length === 0) {
        alert('N√∫meros inv√°lidos. Us√° formato: 1,3 o 1 3');
        return;
      }
      
      // Mostrar los n√∫meros originales (1-indexed) en la confirmaci√≥n
      const numerosOriginales = indices.map(i => i + 1).join(', ');
      if (!confirm(`¬øPresionaste SOLO HAY #${numerosOriginales}, est√°s seguro?`)) return;
      
      stopAlert();
      
      // Recoger precios de los disponibles
      const precios = {};
      indices.forEach(idx => {
        const precioEl = document.getElementById('mpPrecio_' + idx);
        if (precioEl) precios[String(idx)] = parseInt(precioEl.value) || 0;
      });
      
      // Deshabilitar botones
      const allBtns = document.querySelectorAll('.action-btn');
      allBtns.forEach(b => { b.disabled = true; b.style.opacity = '0.4'; });
      event.target.textContent = '‚è≥ Enviando...';
      
      socket.emit('action', { 
        clientWaId: waId, 
        actionType: 'MULTI_DISPONIBILIDAD', 
        payload: { disponibles: indices, precios } 
      });
      
      setTimeout(() => {
        if (chats[waId]) {
          chats[waId].pending = null;
          renderChat();
          renderChatList();
        }
      }, 1000);
    }

    function sendMessage() {
      const input = $('chatInput');
      const raw = input.value.trim();
      if (!raw || !currentChat) return;

      // Atajo especial: resumen abre el modal editable
      if (raw.toLowerCase() === 'resumen') {
        input.value = '';
        input.style.height = 'auto';
        input.style.outline = 'none';
        openResumenModal();
        return;
      }
      
      // Expandir shortcode si coincide exactamente
      const match = quickReplies.find(r => r.code === raw.toLowerCase());
      const text = match ? match.text : raw;
      
      socket.emit('action', { clientWaId: currentChat, actionType: 'MENSAJE', payload: { texto: text } });
      input.value = '';
      input.style.height = 'auto';
      input.style.outline = 'none';
      // Close emoji panel if open
      const ep = $('emojiPanel');
      if (ep) ep.classList.remove('open');
    }

    function handleKeyDown(e) {
      if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        sendMessage();
      }
    }

    function handleInputChange(input) {
      const val = input.value.toLowerCase().trim();
      const match = quickReplies.find(r => r.code === val);
      input.style.outline = match ? '2px solid var(--wa-green)' : 'none';
      input.title = match ? '‚ö° Atajo detectado: se enviar√° este mensaje' : '';
      // Auto-resize
      input.style.height = 'auto';
      input.style.height = Math.min(input.scrollHeight, 120) + 'px';
    }

    // ===== EMOJI PANEL =====
    const FREQUENT_EMOJIS = ['üòä','üòÑ','üòÇ','üôå','üëç','‚ù§Ô∏è','üéâ','üòç','üôè','üëÄ','‚úÖ','‚ùå','üí∞','üì¶','üöö','üì∑','üìã','‚ö°','ü§ù','üòÖ','ü•∞','üíØ','üî•','‚≠ê','üéä','üõçÔ∏è','üëó','üíÉ','üåü','üòé'];
    
    function renderEmojiPanel() {
      const panel = $('emojiPanel');
      if (!panel) return;
      panel.innerHTML = FREQUENT_EMOJIS.map(e => 
        `<button class="emoji-btn" onclick="insertEmoji('${e}')">${e}</button>`
      ).join('');
    }
    
    function toggleEmojiPanel() {
      const panel = $('emojiPanel');
      if (!panel) return;
      panel.classList.toggle('open');
    }
    
    function insertEmoji(emoji) {
      const input = $('chatInput');
      if (!input) return;
      const pos = input.selectionStart || input.value.length;
      input.value = input.value.slice(0, pos) + emoji + input.value.slice(pos);
      input.focus();
      input.selectionStart = input.selectionEnd = pos + emoji.length;
    }

    // ===== FILE ATTACH =====
    function handleFileAttach(input) {
      const file = input.files[0];
      if (!file || !currentChat) return;
      // Currently just notifies ‚Äî full upload would need backend support
      toast(`üìé ${file.name} ‚Äî Funci√≥n de adjuntar pr√≥ximamente`, '');
      input.value = '';
    }

    function deleteChat() {
      if (confirm('¬øBorrar este chat?')) {
        socket.emit('delete_chats', { waId: currentChat });
        delete chats[currentChat];
        closeChat();
      }
    }

    // ===== SHIPPING MODAL =====
    function setShip(val) { $('shipInput').value = val; }
    function hideShipModal() { $('shippingModal').classList.remove('active'); }
    function sendShipping() {
      const val = parseInt($('shipInput').value) || 0;
      if (val < 100) { toast('‚ö†Ô∏è Monto inv√°lido', 'error'); return; }
      // Deshabilitar botones del modal
      const modalBtns = document.querySelectorAll('#shippingModal .modal-btn, #shippingModal .quick-price');
      modalBtns.forEach(b => { b.disabled = true; b.style.opacity = '0.4'; });
      socket.emit('action', { clientWaId: shipClient, actionType: 'ENVIO', payload: { shipping: val } });
    }
    function noShipping() {
      const modalBtns = document.querySelectorAll('#shippingModal .modal-btn, #shippingModal .quick-price');
      modalBtns.forEach(b => { b.disabled = true; b.style.opacity = '0.4'; });
      socket.emit('action', { clientWaId: shipClient, actionType: 'NO_ENVIO_ZONA' });
      setTimeout(() => hideShipModal(), 500);
    }

    // ===== IMAGE VIEWER =====
    function viewImage(src) {
      $('viewerImage').src = src;
      $('imageViewer').classList.add('active');
    }
    function hideImageViewer() {
      $('imageViewer').classList.remove('active');
    }

    // ===== VENTAS =====
    function showSales() {
      const modal = $('salesModal');
      const summary = $('salesSummary');
      const list = $('salesList');
      
      const today = new Date().toISOString().slice(0,10);
      const todaySales = allSales.filter(s => s.date?.startsWith(today));
      const todayRevenue = todaySales.reduce((sum,s) => sum + (s.total||0), 0);
      const thisMonth = new Date().toISOString().slice(0,7);
      const monthSales = allSales.filter(s => s.date?.startsWith(thisMonth));
      const monthRevenue = monthSales.reduce((sum,s) => sum + (s.total||0), 0);
      const totalRevenue = allSales.reduce((sum,s) => sum + (s.total||0), 0);
      
      summary.innerHTML = `<div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px;text-align:center;">
        <div><div style="font-size:11px;color:#666;">Hoy</div><div style="font-size:18px;font-weight:bold;color:#25d366;">${todaySales.length}</div><div style="font-size:12px;color:#333;">‚Ç°${todayRevenue.toLocaleString()}</div></div>
        <div><div style="font-size:11px;color:#666;">Este mes</div><div style="font-size:18px;font-weight:bold;color:#25d366;">${monthSales.length}</div><div style="font-size:12px;color:#333;">‚Ç°${monthRevenue.toLocaleString()}</div></div>
        <div><div style="font-size:11px;color:#666;">Total</div><div style="font-size:18px;font-weight:bold;color:#25d366;">${allSales.length}</div><div style="font-size:12px;color:#333;">‚Ç°${totalRevenue.toLocaleString()}</div></div>
      </div>`;
      
      const sorted = [...allSales].reverse().slice(0, 80);
      if(!sorted.length){
        list.innerHTML = '<p style="text-align:center;color:#999;padding:20px;">No hay ventas a√∫n</p>';
      } else {
        list.innerHTML = sorted.map(s => {
          const date = new Date(s.date);
          const dateStr = date.toLocaleDateString('es-CR',{day:'2-digit',month:'short'});
          const timeStr = date.toLocaleTimeString('es-CR',{hour:'2-digit',minute:'2-digit'});
          const method = s.method === 'envio' ? 'üöö' : 'üè™';
          return `<div style="display:flex;align-items:center;gap:10px;padding:10px;border-bottom:1px solid #eee;">
            <div style="width:40px;height:40px;border-radius:6px;background:#f0f0f0;display:flex;align-items:center;justify-content:center;font-size:1.1rem;flex-shrink:0;">üì¶</div>
            <div style="flex:1;min-width:0;">
              <div style="font-weight:600;font-size:13px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">${s.producto||'Producto'}${s.talla_color?' ¬∑ '+s.talla_color:''}</div>
              <div style="font-size:11px;color:#666;">${s.name||formatPhone(s.waId||s.phone||'')}</div>
              <div style="font-size:11px;color:#999;">${dateStr} ${timeStr} ${method}${s.method==='envio'?(s.zone?' '+s.zone:''):'Retiro'}${s.guia_correos?' üì¶ '+s.guia_correos:''}</div>
            </div>
            <div style="text-align:right;flex-shrink:0;">
              <div style="font-weight:bold;color:#25d366;">‚Ç°${(s.total||0).toLocaleString()}</div>
              <div style="font-size:10px;color:#999;">${s.status||''}</div>
            </div>
          </div>`;
        }).join('');
      }
      modal.classList.add('active');
    }
    
    function hideSales() { $('salesModal').classList.remove('active'); }

    // Toggle sale form
    let nsfMetodo = 'envio';
    function toggleSaleForm() {
      const form = $('newSaleForm');
      const btn = $('saleFormToggle');
      if(form.style.display === 'none') { form.style.display='block'; btn.textContent='‚úï Cancelar'; btn.style.background='#667781'; }
      else { form.style.display='none'; btn.textContent='+ Nueva venta'; btn.style.background='#25D366'; }
    }
    function setNSFMetodo(m) {
      nsfMetodo=m;
      $('nsftE').style.cssText = m==='envio' ? 'flex:1;padding:.45rem;border:2px solid #25D366;background:#e8f5e9;color:#1b5e20;border-radius:8px;font-size:.82rem;font-weight:700;cursor:pointer;font-family:inherit;' : 'flex:1;padding:.45rem;border:2px solid #e9edef;background:#fff;color:#667781;border-radius:8px;font-size:.82rem;font-weight:700;cursor:pointer;font-family:inherit;';
      $('nsftR').style.cssText = m==='retiro' ? 'flex:1;padding:.45rem;border:2px solid #25D366;background:#e8f5e9;color:#1b5e20;border-radius:8px;font-size:.82rem;font-weight:700;cursor:pointer;font-family:inherit;' : 'flex:1;padding:.45rem;border:2px solid #e9edef;background:#fff;color:#667781;border-radius:8px;font-size:.82rem;font-weight:700;cursor:pointer;font-family:inherit;';
      $('nsfEnvioDiv').style.display = m==='envio'?'':'none';
      $('nsfDirDiv').style.display = m==='envio'?'':'none';
    }
    async function saveNewSale() {
      const prod = $('nsfP')?.value?.trim();
      const prec = parseInt($('nsfPr')?.value)||0;
      if(!prod||!prec){ showToast('‚ö†Ô∏è Producto y precio son requeridos'); return; }
      const body = {
        producto:prod, precio:prec, talla_color:$('nsfTC')?.value?.trim()||'',
        method:nsfMetodo, shipping:parseInt($('nsfEn')?.value)||0,
        name:$('nsfN')?.value?.trim()||'', phone:($('nsfTel')?.value||'').replace(/\D/g,''),
        envio_datos:$('nsfDir')?.value?.trim()||'',
        sinpe_reference:$('nsfSinpe')?.value?.trim()||'',
        notas:$('nsfNt')?.value?.trim()||''
      };
      try {
        const authSep = typeof ADMIN_TOKEN !== 'undefined' && ADMIN_TOKEN ? '?token='+encodeURIComponent(ADMIN_TOKEN) : '';
        const r = await fetch('/api/admin/sales/manual'+authSep, {method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(body)});
        if(r.ok){
          const d = await r.json();
          allSales.push(d.sale);
          ['nsfP','nsfTC','nsfPr','nsfEn','nsfN','nsfTel','nsfDir','nsfSinpe','nsfNt'].forEach(id=>{ const el=$(id); if(el) el.value=''; });
          toggleSaleForm();
          showSales();
          showToast('‚úÖ Venta registrada');
        } else showToast('Error al guardar');
      } catch(e){ showToast('Error de conexi√≥n'); }
    }

    // ===== CONTACTS MODAL =====
    let allContactsList = [];
    function showContacts() {
      // Refresh from socket contacts object
      allContactsList = Object.values(contacts||{}).filter(c=>c.waId);
      renderContactsModal();
      $('contactsModal').classList.add('active');
    }
    function hideContacts(){ $('contactsModal').classList.remove('active'); }
    function renderContactsModal() {
      const sr = ($('ctSearchInput')?.value||'').toLowerCase();
      let list = allContactsList.filter(c => !sr||(c.name||'').toLowerCase().includes(sr)||(c.waId||'').includes(sr));
      $('ctCountLbl').textContent = list.length+' contactos';
      if(!list.length){ $('contactsListModal').innerHTML='<p style="text-align:center;color:#999;padding:20px;">Sin contactos</p>'; return; }
      const avColors=['#075E54','#128C7E','#2c6e49','#1565c0','#6a1b9a'];
      $('contactsListModal').innerHTML = list.map(c=>{
        const col=avColors[(c.waId||'x').charCodeAt((c.waId||'x').length-1)%5];
        const ini=(c.name||c.waId||'?').slice(0,2).toUpperCase();
        // find purchases from sales
        const purchases = allSales.filter(s=>(s.waId||s.phone||'')===(c.waId||'')).length;
        return `<div style="display:flex;align-items:center;gap:10px;padding:10px;border-bottom:1px solid #f0f2f5;">
          <div style="width:38px;height:38px;border-radius:50%;background:${col};color:#fff;display:flex;align-items:center;justify-content:center;font-weight:700;font-size:.85rem;flex-shrink:0;">${ini}</div>
          <div style="flex:1;min-width:0;">
            <div style="font-weight:600;font-size:.9rem;">${escapeHtml(c.name||'‚Äî')}</div>
            <div style="font-size:.75rem;color:#667781;">${formatPhone(c.waId||c.phone||'')} ¬∑ ${purchases} compras</div>
            ${c.notes?`<div style="font-size:.72rem;color:#999;">${escapeHtml(c.notes)}</div>`:''}
          </div>
          <div style="display:flex;gap:5px;">
            <button onclick="openAddContact('${escapeHtml(c.waId)}')" style="background:none;border:1px solid #e9edef;border-radius:6px;padding:.28rem .45rem;cursor:pointer;font-size:.82rem;">‚úèÔ∏è</button>
            <button onclick="deleteContactModal('${escapeHtml(c.waId)}')" style="background:none;border:1px solid rgba(229,57,53,.3);border-radius:6px;padding:.28rem .45rem;cursor:pointer;font-size:.82rem;color:#e53935;">üóëÔ∏è</button>
          </div>
        </div>`;
      }).join('');
    }
    function openAddContact(waId) {
      const c = waId ? allContactsList.find(x=>x.waId===waId) : null;
      $('addContactTitle').textContent = c ? '‚úèÔ∏è Editar Contacto' : 'üë§ Agregar Contacto';
      $('editCtId').value = waId||'';
      $('editCtN').value = c?.name||'';
      $('editCtTel').value = c?.waId||c?.phone||'';
      $('editCtNt').value = c?.notes||'';
      $('addContactModal').classList.add('active');
    }
    function closeAddContact(){ $('addContactModal').classList.remove('active'); }
    async function saveContactModal() {
      const tel = ($('editCtTel')?.value||'').replace(/\D/g,'');
      if(!tel){ showToast('‚ö†Ô∏è Tel√©fono requerido'); return; }
      const editId = $('editCtId')?.value||'';
      const waId = editId||tel;
      try {
        const authSep = typeof ADMIN_TOKEN !== 'undefined' && ADMIN_TOKEN ? '?token='+encodeURIComponent(ADMIN_TOKEN) : '';
        const r = await fetch('/api/admin/contacts'+authSep,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({waId,name:$('editCtN')?.value?.trim()||'',phone:tel,notes:$('editCtNt')?.value?.trim()||''})});
        if(r.ok){
          closeAddContact();
          // Refresh contacts from API
          const cr = await fetch('/api/admin/contacts'+authSep);
          if(cr.ok){ const cd=await cr.json(); cd.contacts.forEach(c=>{ contacts[c.waId]=c; }); }
          allContactsList = Object.values(contacts);
          renderContactsModal();
          showToast('‚úÖ Contacto guardado');
        } else showToast('Error al guardar');
      } catch(e){ showToast('Error de conexi√≥n'); }
    }
    async function deleteContactModal(waId) {
      if(!confirm('¬øEliminar este contacto?')) return;
      try {
        const authSep = typeof ADMIN_TOKEN !== 'undefined' && ADMIN_TOKEN ? '?token='+encodeURIComponent(ADMIN_TOKEN) : '';
        const r = await fetch('/api/admin/contacts/'+encodeURIComponent(waId)+authSep,{method:'DELETE'});
        if(r.ok){ delete contacts[waId]; allContactsList=Object.values(contacts); renderContactsModal(); showToast('üóëÔ∏è Eliminado'); }
        else showToast('Error');
      } catch(e){ showToast('Error'); }
    }
    function escapeHtml(t){ return String(t||'').replace(/[&<>"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }

    // ===== BOT TOGGLE =====
    $('botToggle').onclick = () => socket.emit('toggle_bot');
    
    // ===== ACTUALIZAR AL VOLVER A LA APP =====
    document.addEventListener('visibilitychange', () => {
      if (document.visibilityState === 'visible' && socket) {
        console.log('üëÅÔ∏è App visible - volviendo a lista principal...');
        
        // SIEMPRE volver a la lista de chats (no quedarse en un chat espec√≠fico)
        closeChat();
        
        // Si el socket est√° desconectado, reconectar
        if (!socket.connected) {
          socket.connect();
        }
        // Pedir datos frescos
        const pin = localStorage.getItem('ticobot_pin');
        if (pin) {
          socket.emit('auth', pin);
        }
      }
    });
    
    // Tambi√©n detectar cuando se desbloquea el tel√©fono
    window.addEventListener('focus', () => {
      console.log('üëÅÔ∏è Window focus');
      
      // Volver a lista principal
      closeChat();
      
      if (socket && !socket.connected) {
        console.log('üëÅÔ∏è Reconectando socket...');
        socket.connect();
        const pin = localStorage.getItem('ticobot_pin');
        if (pin) {
          setTimeout(() => socket.emit('auth', pin), 500);
        }
      }
    // Forzar actualizaci√≥n
      forceUpdate();
    });

    // ===== MANEJAR BOT√ìN ATR√ÅS DEL NAVEGADOR =====
    window.addEventListener('popstate', (e) => {
      if (currentChat) {
        closeChat();
      }
    });
  
    
  </script>

  </body></html>
