<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="theme-color" content="#075E54">
  <title>La Vaca CR ‚Äî Admin</title>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Nunito:wght@400;500;600;700;800&display=swap');
    :root {
      --primary:#075E54; --green:#25D366; --bg:#f0f2f5; --card:#fff;
      --border:#e9edef; --text:#111b21; --muted:#667781;
      --danger:#e53935; --warning:#f57c00; --info:#1565c0; --purple:#7b1fa2;
    }
    *{margin:0;padding:0;box-sizing:border-box;}
    html,body{height:100%;overflow:hidden;font-family:'Nunito',sans-serif;background:var(--bg);color:var(--text);}
    ::-webkit-scrollbar{width:5px;} ::-webkit-scrollbar-thumb{background:#ccc;border-radius:3px;}

    /* HEADER */
    .hdr{background:var(--primary);color:#fff;padding:0 1rem;height:56px;display:flex;align-items:center;justify-content:space-between;flex-shrink:0;}
    .hdr h1{font-size:1.1rem;font-weight:800;} .hdr h1 span{color:var(--green);}
    .hdr-r{display:flex;align-items:center;gap:.5rem;}
    .role-badge{background:rgba(255,255,255,.15);padding:.2rem .6rem;border-radius:12px;font-size:.72rem;font-weight:700;}
    .sdot{width:10px;height:10px;border-radius:50%;background:var(--green);flex-shrink:0;}
    .sdot.off{background:var(--danger);}
    .phone-lbl{font-size:.78rem;color:rgba(255,255,255,.7);}
    .ref-btn{background:rgba(255,255,255,.12);border:none;color:#fff;width:32px;height:32px;border-radius:50%;font-size:1rem;cursor:pointer;display:flex;align-items:center;justify-content:center;}

    /* TABS */
    .tabs{background:#fff;border-bottom:1px solid var(--border);display:flex;flex-shrink:0;overflow-x:auto;}
    .tab{padding:.7rem 1.2rem;background:none;border:none;border-bottom:3px solid transparent;font-size:.88rem;font-weight:700;cursor:pointer;color:var(--muted);white-space:nowrap;font-family:inherit;transition:all .2s;}
    .tab.active{color:var(--primary);border-bottom-color:var(--primary);}

    /* PAGES */
    .page{display:none;flex-direction:column;flex:1;overflow:hidden;min-height:0;}
    .page.active{display:flex;}
    .scroll{flex:1;overflow-y:auto;padding:1rem;}

    /* STATS ROW */
    .stats-row{display:grid;grid-template-columns:repeat(4,1fr);gap:.6rem;margin-bottom:.9rem;}
    .scard{background:var(--card);border:1px solid var(--border);border-radius:12px;padding:.7rem .5rem;text-align:center;}
    .scard-val{font-size:1.45rem;font-weight:800;color:var(--primary);line-height:1;}
    .scard-lbl{font-size:.68rem;color:var(--muted);font-weight:700;text-transform:uppercase;margin-top:2px;}
    .scard-sub{font-size:.75rem;font-weight:600;color:var(--text);margin-top:1px;}

    /* FILTERS */
    .filters{background:var(--card);border:1px solid var(--border);border-radius:12px;padding:.7rem;margin-bottom:.7rem;display:flex;gap:.5rem;flex-wrap:wrap;align-items:center;}
    .fsel,.finp{background:var(--bg);border:1px solid var(--border);color:var(--text);padding:.45rem .7rem;border-radius:8px;font-size:.82rem;outline:none;font-family:inherit;}
    .finp{flex:1;min-width:130px;}
    .fcnt{color:var(--muted);font-size:.8rem;font-weight:600;white-space:nowrap;}
    .add-btn{background:var(--green);color:#fff;border:none;border-radius:8px;padding:.45rem .9rem;font-size:.82rem;font-weight:700;cursor:pointer;white-space:nowrap;font-family:inherit;}

    /* SALE ITEMS */
    .sale-item{background:var(--card);border:1px solid var(--border);border-radius:12px;padding:.8rem 1rem;margin-bottom:.55rem;cursor:pointer;transition:border-color .15s;}
    .sale-item:hover{border-color:var(--green);}
    .sale-item.open{border-color:var(--primary);}
    .sale-row{display:flex;align-items:center;gap:.7rem;}
    .sale-ico{width:40px;height:40px;border-radius:8px;background:var(--bg);display:flex;align-items:center;justify-content:center;font-size:1.2rem;flex-shrink:0;}
    .sale-inf{flex:1;min-width:0;}
    .sale-nm{font-weight:700;font-size:.92rem;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
    .sale-mt{font-size:.77rem;color:var(--muted);margin-top:1px;}
    .sale-rgt{text-align:right;flex-shrink:0;}
    .sale-tot{font-size:1.1rem;font-weight:800;color:var(--primary);}
    .sale-dt{font-size:.72rem;color:var(--muted);}

    /* BADGES */
    .bdg{display:inline-block;font-size:.65rem;padding:.12rem .45rem;border-radius:10px;font-weight:700;}
    .bdg.envio{background:rgba(37,211,102,.15);color:#1b8a44;}
    .bdg.retiro,.bdg.recoger{background:rgba(21,101,192,.18);color:var(--info);}
    .bdg.alistado{background:rgba(245,158,11,.18);color:#b45309;}
    .bdg.en_transito{background:rgba(59,130,246,.18);color:var(--info);}
    .bdg.entregado{background:rgba(37,211,102,.18);color:#1b8a44;}
    .bdg.manual{background:rgba(123,31,162,.15);color:var(--purple);}

    /* DETAIL PANEL */
    .sale-detail{display:none;margin-top:.7rem;padding-top:.7rem;border-top:1px solid var(--border);}
    .sale-item.open .sale-detail{display:block;}
    .det-grid{display:grid;grid-template-columns:1fr 1fr;gap:.45rem;margin-bottom:.7rem;}
    .det-f{background:var(--bg);border-radius:8px;padding:.45rem .7rem;}
    .det-lbl{font-size:.67rem;color:var(--muted);font-weight:700;text-transform:uppercase;letter-spacing:.03em;}
    .det-val{font-size:.85rem;font-weight:600;margin-top:1px;}
    .det-full{grid-column:1/-1;}
    .det-actions{display:flex;gap:.4rem;flex-wrap:wrap;margin-bottom:.5rem;}
    .st-btn{padding:.35rem .75rem;border-radius:18px;border:2px solid;background:transparent;font-size:.75rem;font-weight:700;cursor:pointer;font-family:inherit;transition:all .15s;}
    .st-btn.alistado{border-color:#b45309;color:#b45309;} .st-btn.alistado.on{background:#b45309;color:#fff;}
    .st-btn.en_transito{border-color:var(--info);color:var(--info);} .st-btn.en_transito.on{background:var(--info);color:#fff;}
    .st-btn.entregado{border-color:#1b8a44;color:#1b8a44;} .st-btn.entregado.on{background:#1b8a44;color:#fff;}
    .guia-row{display:flex;gap:.4rem;align-items:center;margin-top:.4rem;}
    .guia-inp{flex:1;padding:.4rem .7rem;border:1px solid var(--border);border-radius:8px;font-size:.82rem;background:var(--bg);font-family:inherit;}
    .guia-sav{background:var(--primary);color:#fff;border:none;border-radius:8px;padding:.4rem .7rem;font-size:.78rem;font-weight:700;cursor:pointer;font-family:inherit;}
    .del-btn{background:rgba(229,57,53,.1);color:var(--danger);border:1px solid rgba(229,57,53,.3);border-radius:8px;padding:.35rem .7rem;font-size:.77rem;font-weight:700;cursor:pointer;font-family:inherit;}

    /* CONVERSION FOOTER */
    .conv-bar{background:var(--card);border-top:1px solid var(--border);padding:.6rem 1rem;display:flex;gap:.8rem;flex-wrap:wrap;align-items:center;flex-shrink:0;overflow-x:auto;}
    .cv-item{display:flex;flex-direction:column;align-items:center;min-width:56px;}
    .cv-val{font-size:1rem;font-weight:800;}
    .cv-lbl{font-size:.62rem;color:var(--muted);font-weight:700;text-transform:uppercase;white-space:nowrap;}
    .cv-div{width:1px;height:32px;background:var(--border);flex-shrink:0;}

    /* CONTACTS */
    .top-box{background:var(--card);border:1px solid var(--border);border-radius:12px;padding:.85rem;margin-bottom:.75rem;}
    .top-box h3{font-size:.78rem;font-weight:700;color:var(--muted);text-transform:uppercase;letter-spacing:.04em;margin-bottom:.6rem;}
    .top-row{display:flex;align-items:center;gap:.55rem;padding:.35rem 0;border-bottom:1px solid var(--border);}
    .top-row:last-child{border-bottom:none;}
    .top-rank{width:22px;height:22px;border-radius:50%;background:var(--primary);color:#fff;font-size:.68rem;font-weight:700;display:flex;align-items:center;justify-content:center;flex-shrink:0;}
    .top-rank.g{background:#f59e0b;} .top-rank.s{background:#9ca3af;} .top-rank.b{background:#92400e;}
    .top-inf{flex:1;min-width:0;}
    .top-nm{font-size:.85rem;font-weight:600;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
    .top-ph{font-size:.72rem;color:var(--muted);}
    .top-rgt{font-size:.8rem;font-weight:700;color:var(--primary);text-align:right;}
    .ct-item{background:var(--card);border:1px solid var(--border);border-radius:10px;padding:.7rem 1rem;margin-bottom:.45rem;display:flex;align-items:center;gap:.7rem;}
    .ct-ava{width:38px;height:38px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-weight:700;font-size:.88rem;color:#fff;flex-shrink:0;}
    .ct-inf{flex:1;min-width:0;}
    .ct-nm{font-weight:600;font-size:.9rem;}
    .ct-ph{font-size:.75rem;color:var(--muted);}
    .ct-st{font-size:.72rem;color:var(--muted);}
    .ct-btns{display:flex;gap:.35rem;}
    .ico-btn{background:none;border:1px solid var(--border);border-radius:6px;padding:.28rem .45rem;cursor:pointer;font-size:.82rem;}
    .ico-btn.del{border-color:rgba(229,57,53,.3);color:var(--danger);}

    /* MODAL */
    .overlay{position:fixed;inset:0;background:rgba(0,0,0,.55);display:none;align-items:flex-end;justify-content:center;z-index:200;}
    .overlay.on{display:flex;}
    .mbox{background:#fff;border-radius:20px 20px 0 0;padding:1.4rem;width:100%;max-width:600px;max-height:92vh;overflow-y:auto;}
    .mtitle{font-size:1rem;font-weight:700;margin-bottom:.85rem;}
    .ftabs{display:flex;gap:.4rem;margin-bottom:.7rem;}
    .ftab{flex:1;padding:.5rem;border:2px solid var(--border);border-radius:8px;font-size:.83rem;font-weight:700;cursor:pointer;background:var(--bg);text-align:center;font-family:inherit;}
    .ftab.on{border-color:var(--green);background:#e8f5e9;color:#1b5e20;}
    .frow{display:grid;grid-template-columns:1fr 1fr;gap:.55rem;margin-bottom:.55rem;}
    .ff{margin-bottom:.55rem;}
    .ff label{display:block;font-size:.7rem;font-weight:700;color:var(--muted);margin-bottom:.2rem;text-transform:uppercase;}
    .fi{width:100%;padding:.6rem .8rem;border:1.5px solid var(--border);border-radius:10px;font-size:.9rem;outline:none;font-family:inherit;background:#fafafa;}
    .fi:focus{border-color:var(--green);background:#fff;}
    .mbtns{display:flex;gap:.5rem;margin-top:.7rem;}
    .mbtn-ok{flex:2;padding:.85rem;background:var(--green);color:#fff;border:none;border-radius:12px;font-size:.95rem;font-weight:700;cursor:pointer;font-family:inherit;}
    .mbtn-no{flex:1;padding:.85rem;background:var(--bg);border:none;border-radius:12px;cursor:pointer;font-family:inherit;}

    /* CONTACT MODAL */
    .c-overlay{position:fixed;inset:0;background:rgba(0,0,0,.55);display:none;align-items:center;justify-content:center;z-index:300;}
    .c-overlay.on{display:flex;}
    .c-mbox{background:#fff;border-radius:16px;padding:1.4rem;width:92%;max-width:400px;}

    /* TOAST */
    .toast{position:fixed;bottom:80px;left:50%;transform:translateX(-50%) translateY(60px);background:#303030;color:#fff;padding:.6rem 1.2rem;border-radius:20px;opacity:0;transition:all .3s;z-index:500;font-size:.85rem;white-space:nowrap;}
    .toast.on{transform:translateX(-50%) translateY(0);opacity:1;}
    .toast.ok{background:var(--primary);}
    .toast.err{background:var(--danger);}

    .empty{text-align:center;padding:2.5rem 1rem;color:var(--muted);}
    .empty-ico{font-size:2.5rem;opacity:.4;margin-bottom:.4rem;}

    @media(max-width:480px){
      .stats-row{grid-template-columns:repeat(2,1fr);}
      .det-grid{grid-template-columns:1fr;}
      .frow{grid-template-columns:1fr;}
    }
  </style>
</head>
<body>

<!-- HEADER -->
<header class="hdr">
  <h1>üêÑ <span>La Vaca</span> Admin</h1>
  <div class="hdr-r">
    <span class="role-badge">üëë Due√±o</span>
    <span class="sdot off" id="sdot"></span>
    <span class="phone-lbl" id="phoneNum">Conectando...</span>
    <button class="ref-btn" onclick="loadAll()" title="Actualizar">‚Üª</button>
  </div>
</header>

<!-- TABS -->
<nav class="tabs">
  <button class="tab active" data-tab="ventas">üì¶ Ventas</button>
  <button class="tab" data-tab="contactos">üë• Contactos</button>
  <button class="tab" data-tab="config">‚öôÔ∏è Config</button>
</nav>

<!-- PAGE: VENTAS -->
<div class="page active" id="page-ventas">
  <div class="scroll" id="ventasScroll">
    <div class="stats-row">
      <div class="scard"><div class="scard-val" id="stH">0</div><div class="scard-lbl">Hoy</div><div class="scard-sub" id="stHR">‚Ç°0</div></div>
      <div class="scard"><div class="scard-val" id="stS">0</div><div class="scard-lbl">Semana</div><div class="scard-sub" id="stSR">‚Ç°0</div></div>
      <div class="scard"><div class="scard-val" id="stM">0</div><div class="scard-lbl">Mes</div><div class="scard-sub" id="stMR">‚Ç°0</div></div>
      <div class="scard"><div class="scard-val" id="stT">0</div><div class="scard-lbl">Total</div><div class="scard-sub" id="stTR">‚Ç°0</div></div>
    </div>
    <div class="filters">
      <select class="fsel" id="fSt" onchange="renderSales()">
        <option value="">Todos los estados</option>
        <option value="alistado">Alistado</option>
        <option value="en_transito">En tr√°nsito</option>
        <option value="entregado">Entregado</option>
      </select>
      <select class="fsel" id="fMt" onchange="renderSales()">
        <option value="">Todos</option>
        <option value="envio">Env√≠o</option>
        <option value="retiro">Retiro</option>
      </select>
      <input class="finp" id="fSr" placeholder="Buscar cliente/producto..." oninput="renderSales()">
      <span class="fcnt" id="fCnt">0 ventas</span>
      <button class="add-btn" onclick="openSaleModal()">+ Nueva venta</button>
    </div>
    <div id="salesList"><div class="empty"><div class="empty-ico">üì¶</div><p>Cargando...</p></div></div>
  </div>
  <!-- Conversion footer -->
  <div class="conv-bar">
    <div class="cv-item"><div class="cv-val" id="cvChats">0</div><div class="cv-lbl">Chats</div></div>
    <div class="cv-div"></div>
    <div class="cv-item"><div class="cv-val" id="cvVentas">0</div><div class="cv-lbl">Ventas</div></div>
    <div class="cv-div"></div>
    <div class="cv-item"><div class="cv-val" id="cvConv" style="color:var(--green)">0%</div><div class="cv-lbl">Conversi√≥n</div></div>
    <div class="cv-div"></div>
    <div class="cv-item"><div class="cv-val" id="cvTicket">‚Ç°0</div><div class="cv-lbl">Ticket prom.</div></div>
    <div class="cv-div"></div>
    <div class="cv-item"><div class="cv-val" id="cvNeto">‚Ç°0</div><div class="cv-lbl">Neto mes</div></div>
  </div>
</div>

<!-- PAGE: CONTACTOS -->
<div class="page" id="page-contactos">
  <div class="scroll">
    <div class="top-box">
      <h3>üèÜ Top 20 compradores</h3>
      <div id="topList"><div class="empty"><div class="empty-ico">üèÜ</div><p>Sin datos</p></div></div>
    </div>
    <div class="filters">
      <input class="finp" id="fCtSr" placeholder="Buscar contacto..." oninput="renderContacts()">
      <span class="fcnt" id="fCtCnt">0 contactos</span>
      <button class="add-btn" onclick="openContactModal()">+ Agregar</button>
    </div>
    <div id="contactsList"><div class="empty"><div class="empty-ico">üë•</div><p>Cargando...</p></div></div>
  </div>
</div>

<!-- PAGE: CONFIG -->
<div class="page" id="page-config">
  <div class="scroll">
    <div style="background:var(--card);border:1px solid var(--border);border-radius:12px;padding:1rem;margin-bottom:.75rem;">
      <div style="font-weight:700;margin-bottom:.6rem;">üóëÔ∏è Purgar Datos</div>
      <p style="font-size:.82rem;color:var(--muted);margin-bottom:.7rem;">Eliminar datos anteriores a una fecha. No se puede deshacer.</p>
      <div style="display:flex;gap:.5rem;flex-wrap:wrap;align-items:flex-end;">
        <div style="flex:1;min-width:150px;">
          <label style="color:var(--muted);font-size:.72rem;font-weight:700;">Antes de:</label>
          <input type="date" id="purgeDate" class="fi" style="margin-top:3px;">
        </div>
        <button onclick="purgarDatos()" style="background:var(--danger);color:#fff;border:none;padding:.55rem 1.1rem;border-radius:8px;font-weight:700;cursor:pointer;font-family:inherit;">üóëÔ∏è Eliminar</button>
      </div>
      <div style="display:flex;gap:1rem;margin-top:.65rem;flex-wrap:wrap;">
        <label style="font-size:.82rem;display:flex;align-items:center;gap:5px;cursor:pointer;"><input type="checkbox" id="purgeS" checked> Sesiones</label>
        <label style="font-size:.82rem;display:flex;align-items:center;gap:5px;cursor:pointer;"><input type="checkbox" id="purgeV"> Ventas</label>
        <label style="font-size:.82rem;display:flex;align-items:center;gap:5px;cursor:pointer;"><input type="checkbox" id="purgeH" checked> Historial</label>
      </div>
      <div id="purgeResult" style="margin-top:.65rem;font-size:.82rem;"></div>
    </div>
  </div>
</div>

<!-- MODAL: Nueva Venta -->
<div class="overlay" id="saleOverlay">
  <div class="mbox">
    <div class="mtitle">üì¶ Nueva Venta Manual</div>
    <div class="ftabs">
      <button class="ftab on" id="ftE" onclick="setSaleMet('envio')">üöö Env√≠o</button>
      <button class="ftab" id="ftR" onclick="setSaleMet('retiro')">üè™ Retiro</button>
    </div>
    <div class="frow">
      <div class="ff"><label>Producto *</label><input class="fi" id="sP" placeholder="Nombre del producto"></div>
      <div class="ff"><label>Talla / Color</label><input class="fi" id="sTC" placeholder="Ej: M, Negro"></div>
    </div>
    <div class="frow">
      <div class="ff"><label>Precio (‚Ç°) *</label><input class="fi" id="sPr" type="number" placeholder="0" inputmode="numeric"></div>
      <div class="ff" id="envioF"><label>Costo env√≠o (‚Ç°)</label><input class="fi" id="sEn" type="number" placeholder="0" inputmode="numeric"></div>
    </div>
    <div class="frow">
      <div class="ff"><label>Nombre cliente</label><input class="fi" id="sN" placeholder="Mar√≠a Gonz√°lez"></div>
      <div class="ff"><label>Tel√©fono</label><input class="fi" id="sTel" type="tel" placeholder="8888-1234" inputmode="numeric"></div>
    </div>
    <div class="ff" id="dirF"><label>Direcci√≥n / Se√±as</label><textarea class="fi" id="sDir" rows="2" placeholder="Provincia, cant√≥n, se√±as..."></textarea></div>
    <div class="frow">
      <div class="ff"><label>Ref. SINPE</label><input class="fi" id="sSinpe" placeholder="Referencia"></div>
      <div class="ff"><label>Notas internas</label><input class="fi" id="sNt" placeholder="Notas"></div>
    </div>
    <div class="mbtns">
      <button class="mbtn-no" onclick="closeSaleModal()">Cancelar</button>
      <button class="mbtn-ok" onclick="saveSale()">üíæ Guardar venta</button>
    </div>
  </div>
</div>

<!-- MODAL: Contacto -->
<div class="c-overlay" id="ctOverlay">
  <div class="c-mbox">
    <div class="mtitle" id="ctTitle">üë§ Agregar Contacto</div>
    <input type="hidden" id="ctId">
    <div class="ff"><label>Nombre</label><input class="fi" id="ctN" placeholder="Nombre completo"></div>
    <div class="ff"><label>Tel√©fono / WhatsApp</label><input class="fi" id="ctTel" type="tel" placeholder="50688881234" inputmode="numeric"></div>
    <div class="ff"><label>Notas</label><input class="fi" id="ctNt" placeholder="Notas"></div>
    <div class="mbtns">
      <button class="mbtn-no" onclick="closeContactModal()">Cancelar</button>
      <button class="mbtn-ok" onclick="saveContact()">üíæ Guardar</button>
    </div>
  </div>
</div>

<div class="toast" id="toast"></div>

<script src="/socket.io/socket.io.js"></script>
<script>
  const ADMIN_TOKEN_INJECTED = '';
  const API_BASE = '';
  const au = url => ADMIN_TOKEN_INJECTED ? url + (url.includes('?')?'&':'?') + 'token=' + encodeURIComponent(ADMIN_TOKEN_INJECTED) : url;

  let socket, allSales = [], allContacts = [], dashboard = {}, saleMet = 'envio', expandedId = null;

  // ===== TABS =====
  document.querySelectorAll('.tab').forEach(t => {
    t.addEventListener('click', () => {
      document.querySelectorAll('.tab').forEach(x => x.classList.remove('active'));
      document.querySelectorAll('.page').forEach(x => x.classList.remove('active'));
      t.classList.add('active');
      document.getElementById('page-' + t.dataset.tab).classList.add('active');
      if (t.dataset.tab === 'contactos') loadContacts();
    });
  });

  // ===== INIT =====
  async function init() {
    socket = io({ transports: ['websocket','polling'] });
    socket.on('connect', () => socket.emit('auth', 'auto'));
    socket.on('auth_error', () => socket.emit('auth', '1234'));
    socket.on('connection_status', d => {
      document.getElementById('sdot').classList.toggle('off', d.status !== 'connected');
      document.getElementById('phoneNum').textContent = d.status === 'connected' ? (d.phone||'Conectado') : 'Desconectado';
    });
    socket.on('init_data', d => { if(d.sales){ allSales = d.sales; renderSales(); }});
    socket.on('sale_completed', s => { allSales.unshift(s); renderSales(); loadDashboard(); });
    loadAll();
  }

  async function loadAll() { await loadDashboard(); await loadSales(); }

  async function loadDashboard() {
    try { const r = await fetch(au(API_BASE+'/api/admin/dashboard')); if(r.ok){ dashboard = await r.json(); updateStats(); }} catch(e){}
  }
  async function loadSales() {
    try { const r = await fetch(au(API_BASE+'/api/admin/sales?limit=300')); if(r.ok){ const d=await r.json(); allSales=d.sales||[]; renderSales(); }} catch(e){}
  }
  async function loadContacts() {
    try { const r = await fetch(au(API_BASE+'/api/admin/contacts')); if(r.ok){ const d=await r.json(); allContacts=d.contacts||[]; renderContacts(); renderTopBuyers(); }} catch(e){}
  }

  // ===== STATS =====
  function updateStats() {
    const d = dashboard; if(!d.sales) return;
    const f = n => '‚Ç°'+(n||0).toLocaleString('es-CR');
    document.getElementById('stH').textContent = d.sales.today?.count||0;
    document.getElementById('stHR').textContent = f(d.sales.today?.revenue);
    document.getElementById('stS').textContent = d.sales.week?.count||0;
    document.getElementById('stSR').textContent = f(d.sales.week?.revenue);
    document.getElementById('stM').textContent = d.sales.month?.count||0;
    document.getElementById('stMR').textContent = f(d.sales.month?.revenue);
    document.getElementById('stT').textContent = d.sales.all?.count||0;
    document.getElementById('stTR').textContent = f(d.sales.all?.revenue);
    // Conv footer
    const chats = d.metrics?.chats_total || 0;
    const ventas = d.sales.all?.count || 0;
    const conv = chats > 0 ? Math.round((ventas/chats)*100) : 0;
    const ticket = ventas > 0 ? Math.round((d.sales.all?.revenue||0)/ventas) : 0;
    const neto = (d.sales.month?.revenue||0) - (d.sales.month?.shipping||0);
    document.getElementById('cvChats').textContent = chats;
    document.getElementById('cvVentas').textContent = ventas;
    document.getElementById('cvConv').textContent = conv+'%';
    document.getElementById('cvConv').style.color = conv>=15?'#1b8a44':conv>=5?'#f57c00':'#e53935';
    document.getElementById('cvTicket').textContent = '‚Ç°'+ticket.toLocaleString('es-CR');
    document.getElementById('cvNeto').textContent = '‚Ç°'+neto.toLocaleString('es-CR');
  }

  // ===== RENDER SALES =====
  function renderSales() {
    const st = document.getElementById('fSt').value;
    const mt = document.getElementById('fMt').value;
    const sr = document.getElementById('fSr').value.toLowerCase();
    let list = allSales.filter(s => {
      if(st && s.status !== st) return false;
      if(mt) { const sm = s.method||''; if(mt==='retiro' && sm!=='retiro' && sm!=='recoger') return false; if(mt==='envio' && sm!=='envio') return false; }
      if(sr) { if(!((s.name||'')+(s.phone||'')+(s.producto||'')+(s.waId||'')).toLowerCase().includes(sr)) return false; }
      return true;
    });
    document.getElementById('fCnt').textContent = list.length+' ventas';
    if(!list.length){ document.getElementById('salesList').innerHTML='<div class="empty"><div class="empty-ico">üì¶</div><p>Sin ventas con estos filtros</p></div>'; return; }
    document.getElementById('salesList').innerHTML = list.map(s => {
      const open = expandedId === s.id;
      const fecha = s.date ? new Date(s.date).toLocaleDateString('es-CR',{day:'2-digit',month:'short',year:'2-digit'}) : '?';
      const hora = s.date ? new Date(s.date).toLocaleTimeString('es-CR',{hour:'2-digit',minute:'2-digit'}) : '';
      const mt = (s.method==='envio')?'envio':'retiro';
      const st2 = s.status||'alistado';
      const manual = s.manual||s.id?.startsWith('VM-');
      return `<div class="sale-item ${open?'open':''}" id="si_${s.id}" onclick="toggleSale('${s.id}')">
        <div class="sale-row">
          <div class="sale-ico">üì¶</div>
          <div class="sale-inf">
            <div class="sale-nm">${eh(s.producto||'Producto')}</div>
            <div class="sale-mt">${eh(s.name||fp(s.waId||s.phone||''))} ${s.talla_color?'¬∑ '+eh(s.talla_color):''}
              <span class="bdg ${mt}" style="margin-left:3px;">${mt==='envio'?'üöö Env√≠o':'üè™ Retiro'}</span>
              <span class="bdg ${st2}" style="margin-left:3px;">${st2.replace('_',' ')}</span>
              ${manual?'<span class="bdg manual" style="margin-left:3px;">Manual</span>':''}
            </div>
          </div>
          <div class="sale-rgt">
            <div class="sale-tot">‚Ç°${(s.total||0).toLocaleString('es-CR')}</div>
            <div class="sale-dt">${fecha} ${hora}</div>
          </div>
        </div>
        <div class="sale-detail">
          <div class="det-grid">
            <div class="det-f"><div class="det-lbl">Cliente</div><div class="det-val">${eh(s.name||'‚Äî')}</div></div>
            <div class="det-f"><div class="det-lbl">Tel√©fono</div><div class="det-val">${fp(s.waId||s.phone||'‚Äî')}</div></div>
            <div class="det-f"><div class="det-lbl">Producto</div><div class="det-val">${eh(s.producto||'‚Äî')}${s.talla_color?' ¬∑ '+eh(s.talla_color):''}</div></div>
            <div class="det-f"><div class="det-lbl">Precio ¬∑ Env√≠o ¬∑ Total</div><div class="det-val">‚Ç°${(s.precio||0).toLocaleString()} + ‚Ç°${(s.shipping||0).toLocaleString()} = <strong>‚Ç°${(s.total||0).toLocaleString()}</strong></div></div>
            ${s.envio_datos?`<div class="det-f det-full"><div class="det-lbl">Direcci√≥n</div><div class="det-val" style="white-space:pre-wrap;">${eh(s.envio_datos)}</div></div>`:''}
            ${s.zone?`<div class="det-f"><div class="det-lbl">Zona</div><div class="det-val">${eh(s.zone)}</div></div>`:''}
            ${s.sinpe_reference?`<div class="det-f"><div class="det-lbl">Ref. SINPE</div><div class="det-val">${eh(s.sinpe_reference)}</div></div>`:''}
            ${s.notas?`<div class="det-f det-full"><div class="det-lbl">Notas</div><div class="det-val">${eh(s.notas)}</div></div>`:''}
            <div class="det-f"><div class="det-lbl">ID</div><div class="det-val" style="font-family:monospace;font-size:.75rem;">${s.id||'‚Äî'}</div></div>
            <div class="det-f"><div class="det-lbl">Fecha</div><div class="det-val">${fecha} ${hora}</div></div>
          </div>
          <div class="det-actions">
            <span style="font-size:.72rem;font-weight:700;color:var(--muted);align-self:center;">Estado:</span>
            <button class="st-btn alistado ${st2==='alistado'?'on':''}" onclick="chgSt(event,'${s.id}','alistado')">üìã Alistado</button>
            <button class="st-btn en_transito ${st2==='en_transito'?'on':''}" onclick="chgSt(event,'${s.id}','en_transito')">üöö En tr√°nsito</button>
            <button class="st-btn entregado ${st2==='entregado'?'on':''}" onclick="chgSt(event,'${s.id}','entregado')">‚úÖ Entregado</button>
          </div>
          ${s.method==='envio'?`<div class="guia-row"><input class="guia-inp" id="guia_${s.id}" value="${eh(s.guia_correos||'')}" placeholder="Gu√≠a Correos CR"><button class="guia-sav" onclick="saveGuia(event,'${s.id}')">Guardar gu√≠a</button></div>`:''}
          <div style="display:flex;justify-content:flex-end;margin-top:.5rem;">
            <button class="del-btn" onclick="delSale(event,'${s.id}')">üóëÔ∏è Eliminar venta</button>
          </div>
        </div>
      </div>`;
    }).join('');
  }

  function toggleSale(id) {
    expandedId = expandedId===id ? null : id;
    renderSales();
    if(expandedId) { setTimeout(()=>{ const el=document.getElementById('si_'+id); if(el) el.scrollIntoView({behavior:'smooth',block:'nearest'}); },50); }
  }

  async function chgSt(e,id,st) {
    e.stopPropagation();
    const s = allSales.find(x=>x.id===id); if(!s) return;
    s.status = st;
    try { await fetch(au(API_BASE+'/api/admin/sales/update'),{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({saleId:id,field:'status',value:st})}); toast('‚úÖ Estado actualizado','ok'); } catch(e){ toast('Error','err'); }
    renderSales();
  }

  async function saveGuia(e,id) {
    e.stopPropagation();
    const val = document.getElementById('guia_'+id)?.value||'';
    const s = allSales.find(x=>x.id===id); if(s) s.guia_correos=val;
    try { await fetch(au(API_BASE+'/api/admin/sales/update'),{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({saleId:id,field:'guia_correos',value:val})}); toast('‚úÖ Gu√≠a guardada','ok'); } catch(e){ toast('Error','err'); }
  }

  async function delSale(e,id) {
    e.stopPropagation();
    if(!confirm('¬øEliminar esta venta? No se puede deshacer.')) return;
    try {
      const r = await fetch(au(API_BASE+'/api/admin/sales/'+id),{method:'DELETE'});
      if(r.ok){ allSales=allSales.filter(s=>s.id!==id); expandedId=null; renderSales(); loadDashboard(); toast('üóëÔ∏è Venta eliminada','ok'); }
      else toast('Error al eliminar','err');
    } catch(e){ toast('Error','err'); }
  }

  // ===== SALE MODAL =====
  function setSaleMet(m) {
    saleMet=m;
    document.getElementById('ftE').classList.toggle('on',m==='envio');
    document.getElementById('ftR').classList.toggle('on',m==='retiro');
    document.getElementById('envioF').style.display=m==='envio'?'':'none';
    document.getElementById('dirF').style.display=m==='envio'?'':'none';
  }
  function openSaleModal() {
    ['sP','sTC','sPr','sEn','sN','sTel','sDir','sSinpe','sNt'].forEach(id=>{ const el=document.getElementById(id); if(el) el.value=''; });
    setSaleMet('envio');
    document.getElementById('saleOverlay').classList.add('on');
  }
  function closeSaleModal(){ document.getElementById('saleOverlay').classList.remove('on'); }
  async function saveSale() {
    const prod = document.getElementById('sP').value.trim();
    const prec = parseInt(document.getElementById('sPr').value)||0;
    if(!prod||!prec){ toast('‚ö†Ô∏è Producto y precio son requeridos','err'); return; }
    const body = {
      producto:prod, precio:prec, talla_color:document.getElementById('sTC').value.trim(), method:saleMet,
      shipping:parseInt(document.getElementById('sEn').value)||0,
      name:document.getElementById('sN').value.trim(), phone:document.getElementById('sTel').value.trim().replace(/\D/g,''),
      envio_datos:document.getElementById('sDir').value.trim(), sinpe_reference:document.getElementById('sSinpe').value.trim(),
      notas:document.getElementById('sNt').value.trim()
    };
    try {
      const r = await fetch(au(API_BASE+'/api/admin/sales/manual'),{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(body)});
      if(r.ok){ const d=await r.json(); allSales.unshift(d.sale); closeSaleModal(); renderSales(); loadDashboard(); toast('‚úÖ Venta registrada','ok'); }
      else toast('Error al guardar','err');
    } catch(e){ toast('Error de conexi√≥n','err'); }
  }

  // ===== CONTACTS =====
  function renderContacts() {
    const sr = document.getElementById('fCtSr')?.value?.toLowerCase()||'';
    let list = allContacts.filter(c => !sr || (c.name||'').toLowerCase().includes(sr)||(c.waId||'').includes(sr));
    document.getElementById('fCtCnt').textContent = list.length+' contactos';
    if(!list.length){ document.getElementById('contactsList').innerHTML='<div class="empty"><div class="empty-ico">üë•</div><p>Sin contactos</p></div>'; return; }
    const avColors = ['#075E54','#128C7E','#2c6e49','#1565c0','#6a1b9a'];
    document.getElementById('contactsList').innerHTML = list.map(c => {
      const col = avColors[(c.waId||'x').charCodeAt((c.waId||'x').length-1)%5];
      const ini = (c.name||c.waId||'?').slice(0,2).toUpperCase();
      return `<div class="ct-item">
        <div class="ct-ava" style="background:${col}">${ini}</div>
        <div class="ct-inf">
          <div class="ct-nm">${eh(c.name||'‚Äî')}</div>
          <div class="ct-ph">${fp(c.waId||c.phone||'')}</div>
          <div class="ct-st">${c.purchases||0} compras ¬∑ ‚Ç°${(c.total_spent||0).toLocaleString('es-CR')}${c.last_purchase?' ¬∑ √öltima: '+new Date(c.last_purchase).toLocaleDateString('es-CR',{day:'2-digit',month:'short'}):''}</div>
        </div>
        <div class="ct-btns">
          <button class="ico-btn" onclick="openContactModal('${eh(c.waId)}')">‚úèÔ∏è</button>
          <button class="ico-btn del" onclick="delContact('${eh(c.waId)}')">üóëÔ∏è</button>
        </div>
      </div>`;
    }).join('');
  }

  function renderTopBuyers() {
    const top = allContacts.filter(c=>(c.purchases||0)>0).slice(0,20);
    if(!top.length){ document.getElementById('topList').innerHTML='<p style="color:var(--muted);font-size:.82rem;">Sin compras registradas a√∫n</p>'; return; }
    document.getElementById('topList').innerHTML = top.map((c,i)=>{
      const rc = i===0?'g':i===1?'s':i===2?'b':'';
      return `<div class="top-row">
        <div class="top-rank ${rc}">${i+1}</div>
        <div class="top-inf"><div class="top-nm">${eh(c.name||fp(c.waId||''))}</div><div class="top-ph">${fp(c.waId||c.phone||'')}</div></div>
        <div class="top-rgt">${c.purchases} compras<br>‚Ç°${(c.total_spent||0).toLocaleString('es-CR')}</div>
      </div>`;
    }).join('');
  }

  function openContactModal(waId) {
    const c = waId ? allContacts.find(x=>x.waId===waId) : null;
    document.getElementById('ctTitle').textContent = c ? '‚úèÔ∏è Editar Contacto' : 'üë§ Agregar Contacto';
    document.getElementById('ctId').value = waId||'';
    document.getElementById('ctN').value = c?.name||'';
    document.getElementById('ctTel').value = c?.waId||c?.phone||'';
    document.getElementById('ctNt').value = c?.notes||'';
    document.getElementById('ctOverlay').classList.add('on');
  }
  function closeContactModal(){ document.getElementById('ctOverlay').classList.remove('on'); }
  async function saveContact() {
    const tel = document.getElementById('ctTel').value.trim().replace(/\D/g,'');
    if(!tel){ toast('‚ö†Ô∏è Tel√©fono requerido','err'); return; }
    const editId = document.getElementById('ctId').value;
    const waId = editId||tel;
    try {
      const r = await fetch(au(API_BASE+'/api/admin/contacts'),{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({waId,name:document.getElementById('ctN').value.trim(),phone:tel,notes:document.getElementById('ctNt').value.trim()})});
      if(r.ok){ closeContactModal(); await loadContacts(); toast('‚úÖ Contacto guardado','ok'); }
      else toast('Error','err');
    } catch(e){ toast('Error de conexi√≥n','err'); }
  }
  async function delContact(waId) {
    if(!confirm('¬øEliminar este contacto?')) return;
    try {
      const r = await fetch(au(API_BASE+'/api/admin/contacts/'+encodeURIComponent(waId)),{method:'DELETE'});
      if(r.ok){ await loadContacts(); toast('üóëÔ∏è Eliminado','ok'); } else toast('Error','err');
    } catch(e){ toast('Error','err'); }
  }

  // ===== CONFIG =====
  async function purgarDatos() {
    const fecha = document.getElementById('purgeDate').value;
    if(!fecha){ alert('Seleccion√° una fecha'); return; }
    const ps=document.getElementById('purgeS').checked, pv=document.getElementById('purgeV').checked, ph=document.getElementById('purgeH').checked;
    if(!ps&&!pv&&!ph){ alert('Seleccion√° al menos una opci√≥n'); return; }
    const items=[ps&&'sesiones',pv&&'ventas',ph&&'historial'].filter(Boolean);
    if(!confirm('¬øSeguro? Se eliminar√°n '+items.join(', ')+' anteriores al '+fecha+'.\n\nNo se puede deshacer.')) return;
    try {
      const r = await fetch(au(API_BASE+'/api/admin/purge'),{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({before:fecha,purgeSessions:ps,purgeSales:pv,purgeHistory:ph,token:ADMIN_TOKEN_INJECTED})});
      const d = await r.json();
      document.getElementById('purgeResult').innerHTML='<span style="color:var(--green)">‚úÖ '+(d.message||'Datos eliminados')+'</span>';
    } catch(e){ document.getElementById('purgeResult').innerHTML='<span style="color:var(--danger)">Error: '+e.message+'</span>'; }
  }

  // ===== HELPERS =====
  function eh(t){ return String(t||'').replace(/[&<>"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }
  function fp(w){ const d=String(w).replace(/\D/g,''); return d.length===11&&d.startsWith('506')?d.slice(0,3)+' '+d.slice(3,7)+'-'+d.slice(7):d.length>=8?d.slice(-8,-4)+'-'+d.slice(-4):w; }
  function toast(msg,type){ const t=document.getElementById('toast'); t.textContent=msg; t.className='toast on '+(type||''); setTimeout(()=>t.classList.remove('on'),3000); }

  init();
</script>
</body>
</html>
