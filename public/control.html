<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
  <title>Gestor Admin - La Vaca üêÑ</title>
  <style>
    :root {
      --bg: #0f1117;
      --card: #1a1d27;
      --border: #2a2e3d;
      --text: #e4e6ef;
      --text-muted: #8b8fa3;
      --primary: #22c55e;
      --primary-hover: #1da851;
      --danger: #ef4444;
      --warning: #f59e0b;
      --info: #3b82f6;
      --purple: #a855f7;
    }
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: var(--bg);
      color: var(--text);
      min-height: 100vh;
    }
    
    /* Header */
    .header {
      background: var(--card);
      padding: 1rem;
      border-bottom: 1px solid var(--border);
      display: flex;
      justify-content: space-between;
      align-items: center;
      position: sticky;
      top: 0;
      z-index: 100;
    }
    .header-left { display: flex; align-items: center; gap: 0.8rem; }
    .header h1 { font-size: 1.2rem; display: flex; align-items: center; gap: 0.5rem; }
    .header h1 span { color: var(--primary); }
    .header-right { display: flex; align-items: center; gap: 0.8rem; }
    .role-badge {
      background: linear-gradient(135deg, #f59e0b, #d97706);
      color: #fff;
      padding: 0.3rem 0.8rem;
      border-radius: 20px;
      font-size: 0.75rem;
      font-weight: 600;
    }
    .status-dot {
      width: 10px;
      height: 10px;
      border-radius: 50%;
      background: var(--primary);
    }
    .status-dot.disconnected { background: var(--danger); }
    .phone-number { font-size: 0.85rem; color: var(--text-muted); }
    .refresh-btn {
      background: none;
      border: none;
      color: var(--text-muted);
      font-size: 1.2rem;
      cursor: pointer;
      padding: 0.3rem;
    }
    .refresh-btn:hover { color: var(--text); }
    
    /* Tabs */
    .tabs {
      display: flex;
      background: var(--card);
      border-bottom: 1px solid var(--border);
    }
    .tab {
      flex: 1;
      padding: 1rem 0.5rem;
      text-align: center;
      cursor: pointer;
      border: none;
      background: none;
      color: var(--text-muted);
      font-size: 0.9rem;
      font-weight: 500;
      transition: all 0.2s;
      border-bottom: 3px solid transparent;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 0.5rem;
    }
    .tab:hover { color: var(--text); background: rgba(255,255,255,0.02); }
    .tab.active {
      color: var(--primary);
      border-bottom-color: var(--primary);
    }
    .tab-icon { font-size: 1rem; }
    .tab-badge {
      background: var(--danger);
      color: #fff;
      font-size: 0.65rem;
      padding: 0.15rem 0.4rem;
      border-radius: 10px;
      font-weight: 700;
    }
    
    /* Content */
    .content { display: none; padding: 1rem; max-width: 1200px; margin: 0 auto; }
    .content.active { display: block; }
    .hidden { display: none !important; }
    
    /* Cards */
    .card {
      background: var(--card);
      border-radius: 12px;
      padding: 1rem;
      margin-bottom: 1rem;
      border: 1px solid var(--border);
    }
    .card-title {
      font-size: 0.85rem;
      color: var(--text-muted);
      margin-bottom: 0.8rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }
    
    /* Metrics Grid */
    .metrics-grid {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 1rem;
      margin-bottom: 1rem;
    }
    @media (max-width: 768px) {
      .metrics-grid { grid-template-columns: repeat(2, 1fr); }
    }
    .metric-card {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 1.2rem;
      text-align: center;
    }
    .metric-value {
      font-size: 2rem;
      font-weight: 700;
      color: var(--primary);
      line-height: 1;
    }
    .metric-label {
      font-size: 0.8rem;
      color: var(--text-muted);
      margin-top: 0.3rem;
    }
    .metric-sub {
      font-size: 0.75rem;
      color: var(--text-muted);
      margin-top: 0.2rem;
    }
    
    /* Filters */
    .filters {
      display: flex;
      gap: 0.8rem;
      margin-bottom: 1rem;
      flex-wrap: wrap;
      align-items: center;
    }
    .filter-select {
      background: var(--card);
      border: 1px solid var(--border);
      color: var(--text);
      padding: 0.6rem 1rem;
      border-radius: 8px;
      font-size: 0.85rem;
      cursor: pointer;
    }
    .filter-input {
      background: var(--card);
      border: 1px solid var(--border);
      color: var(--text);
      padding: 0.6rem 1rem;
      border-radius: 8px;
      font-size: 0.85rem;
      flex: 1;
      min-width: 150px;
    }
    .filter-input::placeholder { color: var(--text-muted); }
    .filter-count {
      color: var(--text-muted);
      font-size: 0.85rem;
    }
    
    /* Sales List */
    .sale-item {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 1rem;
      margin-bottom: 0.8rem;
    }
    .sale-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 0.8rem;
    }
    .sale-product {
      font-weight: 600;
      font-size: 1rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
      flex-wrap: wrap;
    }
    .sale-method {
      font-size: 0.7rem;
      padding: 0.2rem 0.5rem;
      border-radius: 12px;
      font-weight: 600;
    }
    .sale-method.envio { background: rgba(34,197,94,0.2); color: #22c55e; }
    .sale-method.retiro { background: rgba(59,130,246,0.2); color: #3b82f6; }
    .sale-status {
      font-size: 0.7rem;
      padding: 0.2rem 0.5rem;
      border-radius: 12px;
      font-weight: 600;
    }
    .sale-status.pendiente { background: rgba(245,158,11,0.2); color: #f59e0b; }
    .sale-status.facturado { background: rgba(168,85,247,0.2); color: #a855f7; }
    .sale-status.enviado { background: rgba(59,130,246,0.2); color: #3b82f6; }
    .sale-status.entregado { background: rgba(34,197,94,0.2); color: #22c55e; }
    .sale-price {
      font-size: 1.3rem;
      font-weight: 700;
      color: var(--primary);
      text-align: right;
    }
    .sale-shipping {
      font-size: 0.75rem;
      color: var(--text-muted);
    }
    .sale-details {
      font-size: 0.85rem;
      color: var(--text-muted);
      margin-bottom: 0.8rem;
    }
    .sale-details span { margin-right: 1rem; }
    
    /* Status Buttons */
    .status-buttons {
      display: flex;
      gap: 0.5rem;
      margin-bottom: 1rem;
      flex-wrap: wrap;
    }
    .status-btn {
      padding: 0.5rem 1rem;
      border-radius: 20px;
      border: 2px solid;
      background: transparent;
      font-size: 0.8rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
    }
    .status-btn.pendiente { border-color: #f59e0b; color: #f59e0b; }
    .status-btn.pendiente.active, .status-btn.pendiente:hover { background: #f59e0b; color: #000; }
    .status-btn.facturado { border-color: #a855f7; color: #a855f7; }
    .status-btn.facturado.active, .status-btn.facturado:hover { background: #a855f7; color: #fff; }
    .status-btn.enviado { border-color: #3b82f6; color: #3b82f6; }
    .status-btn.enviado.active, .status-btn.enviado:hover { background: #3b82f6; color: #fff; }
    .status-btn.entregado { border-color: #22c55e; color: #22c55e; }
    .status-btn.entregado.active, .status-btn.entregado:hover { background: #22c55e; color: #fff; }
    
    /* Form Fields */
    .sale-form {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 0.8rem;
      padding-top: 0.8rem;
      border-top: 1px solid var(--border);
    }
    @media (max-width: 768px) {
      .sale-form { grid-template-columns: repeat(2, 1fr); }
    }
    .form-group { display: flex; flex-direction: column; gap: 0.3rem; }
    .form-label {
      font-size: 0.7rem;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    .form-input {
      background: var(--bg);
      border: 1px solid var(--border);
      color: var(--text);
      padding: 0.5rem;
      border-radius: 6px;
      font-size: 0.85rem;
    }
    .form-input:focus {
      outline: none;
      border-color: var(--primary);
    }
    
    /* Status Select */
    .status-select {
      background: var(--bg);
      border: 1px solid var(--border);
      color: var(--text);
      padding: 0.5rem;
      border-radius: 6px;
      font-size: 0.85rem;
      cursor: pointer;
    }
    
    /* Alerts */
    .alert-item {
      background: var(--card);
      border: 1px solid var(--border);
      border-left: 4px solid var(--warning);
      border-radius: 8px;
      padding: 1rem;
      margin-bottom: 0.8rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .alert-item.danger { border-left-color: var(--danger); }
    .alert-info { flex: 1; }
    .alert-title { font-weight: 600; margin-bottom: 0.3rem; }
    .alert-detail { font-size: 0.85rem; color: var(--text-muted); }
    .alert-time {
      font-size: 0.75rem;
      color: var(--text-muted);
      text-align: right;
    }
    
    /* Chat List */
    .chat-item {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 0.9rem 1rem;
      margin-bottom: 0.5rem;
      display: flex;
      align-items: center;
      gap: 1rem;
      cursor: pointer;
      transition: all 0.2s;
    }
    .chat-item:hover { background: rgba(255,255,255,0.03); }
    .chat-item.active { border-color: var(--primary); background: rgba(34,197,94,0.05); }
    .chat-avatar {
      width: 45px;
      height: 45px;
      border-radius: 50%;
      background: var(--primary);
      color: #fff;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 700;
      flex-shrink: 0;
    }
    .chat-info { flex: 1; min-width: 0; }
    .chat-name { font-weight: 600; font-size: 1.05rem; }
    .chat-preview {
      font-size: 0.9rem;
      color: var(--text-muted);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .chat-time {
      font-size: 0.8rem;
      color: var(--text-muted);
    }
    .chat-detail {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 8px;
      margin: -0.3rem 0 0.5rem;
      padding: 1rem;
      max-height: 400px;
      overflow-y: auto;
    }
    .msg-row { 
      margin-bottom: 0.5rem; 
      display: flex; 
      flex-direction: column; 
    }
    .msg-row.bot { align-items: flex-start; }
    .msg-row.client { align-items: flex-end; }
    .msg-bubble {
      max-width: 85%;
      padding: 0.6rem 0.9rem;
      border-radius: 10px;
      font-size: 0.9rem;
      line-height: 1.4;
      word-wrap: break-word;
    }
    .msg-row.client .msg-bubble {
      background: #0b5e2e;
      color: #e4e6ef;
      border-bottom-right-radius: 2px;
    }
    .msg-row.bot .msg-bubble {
      background: #2a2e3d;
      color: #e4e6ef;
      border-bottom-left-radius: 2px;
    }
    .msg-time {
      font-size: 0.7rem;
      color: var(--text-muted);
      margin-top: 2px;
    }
    
    /* Empty State */
    .empty-state {
      text-align: center;
      padding: 3rem;
      color: var(--text-muted);
    }
    .empty-icon { font-size: 3rem; margin-bottom: 1rem; }
    
    /* Loading */
    .loading {
      text-align: center;
      padding: 2rem;
      color: var(--text-muted);
    }
    
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    .spinner {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 2px solid var(--border);
      border-top-color: var(--primary);
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }
  </style>
</head>
<body>

  <!-- Header -->
  <header class="header">
    <div class="header-left">
      <h1>üêÑ <span>La Vaca</span> Admin</h1>
    </div>
    <div class="header-right">
      <span class="role-badge">üëë Due√±o</span>
      <span class="status-dot" id="statusDot"></span>
      <span class="phone-number" id="phoneNumber">Conectando...</span>
      <button class="refresh-btn" onclick="loadDashboard()" title="Actualizar">‚Üª</button>
    </div>
  </header>

  <!-- Tabs -->
  <nav class="tabs">
    <button class="tab active" data-tab="resumen">
      <span class="tab-icon">üìä</span> Resumen
    </button>
    <button class="tab" data-tab="ventas">
      <span class="tab-icon">üì¶</span> Ventas WA
    </button>
    <button class="tab" data-tab="alertas">
      <span class="tab-icon">üö®</span> Alertas
      <span class="tab-badge" id="alertCount" style="display:none;">0</span>
    </button>
    <button class="tab" data-tab="chats">
      <span class="tab-icon">üí¨</span> Chats
    </button>
  </nav>

  <!-- Tab: Resumen -->
  <div class="content active" id="tab-resumen">
    <div class="metrics-grid">
      <div class="metric-card">
        <div class="metric-value" id="salesToday">0</div>
        <div class="metric-label">Ventas Hoy</div>
        <div class="metric-sub" id="revenueToday">‚Ç°0</div>
      </div>
      <div class="metric-card">
        <div class="metric-value" id="salesWeek">0</div>
        <div class="metric-label">Esta Semana</div>
        <div class="metric-sub" id="revenueWeek">‚Ç°0</div>
      </div>
      <div class="metric-card">
        <div class="metric-value" id="salesMonth">0</div>
        <div class="metric-label">Este Mes</div>
        <div class="metric-sub" id="revenueMonth">‚Ç°0</div>
      </div>
      <div class="metric-card">
        <div class="metric-value" id="salesTotal">0</div>
        <div class="metric-label">Total</div>
        <div class="metric-sub" id="revenueTotal">‚Ç°0</div>
      </div>
    </div>
    
    <div class="card">
      <div class="card-title">üìä Embudo de Conversi√≥n</div>
      <div class="metrics-grid">
        <div class="metric-card">
          <div class="metric-value" id="chatsToday">0</div>
          <div class="metric-label">Chats Hoy</div>
        </div>
        <div class="metric-card" style="border-color:rgba(59,130,246,0.3);">
          <div class="metric-value" style="color:#3b82f6;" id="quotesTotal">0</div>
          <div class="metric-label">üìã Consultaron</div>
          <div class="metric-sub">Pidieron producto</div>
        </div>
        <div class="metric-card" style="border-color:rgba(168,85,247,0.3);">
          <div class="metric-value" style="color:#a855f7;" id="metodoTotal">0</div>
          <div class="metric-label">üöö Eligieron Env√≠o</div>
          <div class="metric-sub">Env√≠o + Retiro</div>
        </div>
        <div class="metric-card" style="border-color:rgba(34,197,94,0.3);">
          <div class="metric-value" style="color:#22c55e;" id="salesCount">0</div>
          <div class="metric-label">‚úÖ Ventas</div>
          <div class="metric-sub">Pagaron SINPE</div>
        </div>
      </div>
      <div class="metrics-grid" style="grid-template-columns: repeat(3, 1fr); margin-top: 0;">
        <div class="metric-card">
          <div class="metric-value" style="font-size:1.4rem;" id="convConsulta">0%</div>
          <div class="metric-label">Chat ‚Üí Consulta</div>
        </div>
        <div class="metric-card">
          <div class="metric-value" style="font-size:1.4rem;" id="convMetodo">0%</div>
          <div class="metric-label">Consulta ‚Üí Env√≠o</div>
        </div>
        <div class="metric-card">
          <div class="metric-value" style="font-size:1.4rem;" id="convVenta">0%</div>
          <div class="metric-label">Chat ‚Üí Venta</div>
        </div>
      </div>
    </div>
    
    <div class="card" style="border-color:rgba(239,68,68,0.2);">
      <div class="card-title" style="cursor:pointer;" onclick="document.getElementById('purgePanel').classList.toggle('hidden')">üóëÔ∏è Limpiar datos antiguos <span style="font-size:0.75rem;color:var(--text-muted);">‚ñº</span></div>
      <div id="purgePanel" class="hidden">
        <p style="color:var(--text-muted);font-size:0.85rem;margin-bottom:12px;">Eliminar datos anteriores a la fecha seleccionada. No se puede deshacer.</p>
        <div style="display:flex;gap:10px;align-items:end;flex-wrap:wrap;">
          <div style="flex:1;min-width:150px;">
            <label style="color:var(--text-muted);font-size:0.75rem;">Antes de:</label>
            <input type="date" id="purgeDate" class="form-input" style="margin-top:4px;">
          </div>
          <button onclick="purgarDatos()" style="background:#ef4444;color:#fff;border:none;padding:0.6rem 1.2rem;border-radius:8px;font-weight:600;cursor:pointer;white-space:nowrap;">üóëÔ∏è Eliminar</button>
        </div>
        <div style="display:flex;gap:15px;margin-top:10px;flex-wrap:wrap;">
          <label style="color:var(--text);font-size:0.85rem;display:flex;align-items:center;gap:5px;cursor:pointer;"><input type="checkbox" id="purgeSessions" checked> Sesiones</label>
          <label style="color:var(--text);font-size:0.85rem;display:flex;align-items:center;gap:5px;cursor:pointer;"><input type="checkbox" id="purgeSales"> Ventas</label>
          <label style="color:var(--text);font-size:0.85rem;display:flex;align-items:center;gap:5px;cursor:pointer;"><input type="checkbox" id="purgeHistory" checked> Historial</label>
        </div>
        <div id="purgeResult" style="margin-top:10px;"></div>
      </div>
    </div>
  </div>
  <div class="content" id="tab-ventas">
    <div class="filters">
      <select class="filter-select" id="filterStatus">
        <option value="">Todos los estados</option>
        <option value="pendiente">Pendiente</option>
        <option value="facturado">Facturado</option>
        <option value="enviado">Enviado</option>
        <option value="entregado">Entregado</option>
      </select>
      <select class="filter-select" id="filterMethod">
        <option value="">Todos los m√©todos</option>
        <option value="envio">Env√≠o</option>
        <option value="recoger">Retiro</option>
      </select>
      <input type="text" class="filter-input" id="filterSearch" placeholder="Buscar cliente/producto">
      <span class="filter-count" id="salesCount">0 pedidos</span>
    </div>
    
    <div id="salesList">
      <div class="loading"><span class="spinner"></span> Cargando ventas...</div>
    </div>
  </div>

  <!-- Tab: Alertas -->
  <div class="content" id="tab-alertas">
    <div class="card">
      <div class="card-title">‚ö†Ô∏è Clientes Abandonados (sin responder +2h)</div>
      <div id="abandonedList">
        <div class="empty-state">
          <div class="empty-icon">‚úÖ</div>
          <div>No hay clientes abandonados</div>
        </div>
      </div>
    </div>
    
    <div class="card">
      <div class="card-title">üîî Sin Seguimiento (esperando tu respuesta +30min)</div>
      <div id="noFollowupList">
        <div class="empty-state">
          <div class="empty-icon">‚úÖ</div>
          <div>Todo al d√≠a</div>
        </div>
      </div>
    </div>
  </div>

  <!-- Tab: Chats -->
  <div class="content" id="tab-chats">
    <div class="filters">
      <input type="text" class="filter-input" id="filterChats" placeholder="Buscar chat...">
    </div>
    <div id="chatsList">
      <div class="loading"><span class="spinner"></span> Cargando chats...</div>
    </div>
  </div>

  <script src="/socket.io/socket.io.js"></script>
  <script>
    const ADMIN_TOKEN_INJECTED = '';
    const API_BASE = '';
    
    // Helper: agregar token a cualquier URL
    function authUrl(url) {
      if(!ADMIN_TOKEN_INJECTED) return url;
      const sep = url.includes('?') ? '&' : '?';
      return url + sep + 'token=' + encodeURIComponent(ADMIN_TOKEN_INJECTED);
    }
    let socket;
    let allSales = [];
    let allChats = [];
    let dashboard = {};
    
    // Tabs
    document.querySelectorAll('.tab').forEach(tab => {
      tab.addEventListener('click', () => {
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('.content').forEach(c => c.classList.remove('active'));
        tab.classList.add('active');
        document.getElementById('tab-' + tab.dataset.tab).classList.add('active');
      });
    });
    
    // Auto-connect (sin login)
    async function init() {
      // Conectar socket
      socket = io({ transports: ['websocket', 'polling'] });
      
      socket.on('connect', () => {
        console.log('üîå Socket conectado');
        socket.emit('auth', 'auto'); // PIN auto para entrar directo
      });
      
      socket.on('auth_success', (data) => {
        console.log('‚úÖ Autenticado:', data);
        document.getElementById('statusDot').classList.remove('disconnected');
      });
      
      socket.on('auth_error', () => {
        // Intentar con PIN por defecto
        socket.emit('auth', '1234');
      });
      
      socket.on('connection_status', (data) => {
        const dot = document.getElementById('statusDot');
        const phone = document.getElementById('phoneNumber');
        if (data.status === 'connected') {
          dot.classList.remove('disconnected');
          phone.textContent = data.phone || 'Conectado';
        } else {
          dot.classList.add('disconnected');
          phone.textContent = 'Desconectado';
        }
      });
      
      socket.on('init_data', (data) => {
        console.log('üì¶ Datos iniciales:', data);
        if (data.sales) {
          allSales = data.sales;
          renderSales();
        }
        if (data.history) {
          processChats(data.history);
        }
      });
      
      socket.on('sale_completed', (sale) => {
        allSales.push(sale);
        renderSales();
        loadDashboard();
      });
      
      // Cargar dashboard via API
      loadDashboard();
    }
    
    async function loadDashboard() {
      try {
        const res = await fetch(authUrl(API_BASE + '/api/admin/dashboard'));
        if (res.ok) {
          dashboard = await res.json();
          renderDashboard();
        }
      } catch (e) {
        console.error('Error cargando dashboard:', e);
      }
      
      // Tambi√©n cargar ventas
      try {
        const res = await fetch(authUrl(API_BASE + '/api/admin/sales?limit=100'));
        if (res.ok) {
          const data = await res.json();
          allSales = data.sales || [];
          renderSales();
        }
      } catch (e) {
        console.error('Error cargando ventas:', e);
      }
    }
    
    function renderDashboard() {
      const d = dashboard;
      
      // Conexi√≥n
      const dot = document.getElementById('statusDot');
      const phone = document.getElementById('phoneNumber');
      if (d.connection === 'connected') {
        dot.classList.remove('disconnected');
        phone.textContent = d.phone || 'Conectado';
      } else {
        dot.classList.add('disconnected');
        phone.textContent = 'Desconectado';
      }
      
      // Ventas
      if (d.sales) {
        document.getElementById('salesToday').textContent = d.sales.today?.count || 0;
        document.getElementById('revenueToday').textContent = '‚Ç°' + (d.sales.today?.revenue || 0).toLocaleString();
        document.getElementById('salesWeek').textContent = d.sales.week?.count || 0;
        document.getElementById('revenueWeek').textContent = '‚Ç°' + (d.sales.week?.revenue || 0).toLocaleString();
        document.getElementById('salesMonth').textContent = d.sales.month?.count || 0;
        document.getElementById('revenueMonth').textContent = '‚Ç°' + (d.sales.month?.revenue || 0).toLocaleString();
        document.getElementById('salesTotal').textContent = d.sales.all?.count || 0;
        document.getElementById('revenueTotal').textContent = '‚Ç°' + (d.sales.all?.revenue || 0).toLocaleString();
      }
      
      // M√©tricas de embudo
      if (d.chats) {
        document.getElementById('chatsToday').textContent = d.chats.today || 0;
      }
      if (d.metrics) {
        const totalChats = d.metrics.chats_total || 0;
        const consultas = d.metrics.quotes_sent || 0;
        const metodo = (d.metrics.delivery_envio || 0) + (d.metrics.delivery_recoger || 0);
        const ventas = d.metrics.sales_completed || 0;
        
        document.getElementById('quotesTotal').textContent = consultas;
        document.getElementById('metodoTotal').textContent = metodo;
        document.getElementById('salesCount').textContent = ventas;
        
        const pctConsulta = totalChats > 0 ? Math.round((consultas / totalChats) * 100) : 0;
        const pctMetodo = consultas > 0 ? Math.round((metodo / consultas) * 100) : 0;
        const pctVenta = totalChats > 0 ? Math.round((ventas / totalChats) * 100) : 0;
        
        document.getElementById('convConsulta').textContent = pctConsulta + '%';
        document.getElementById('convMetodo').textContent = pctMetodo + '%';
        document.getElementById('convVenta').textContent = pctVenta + '%';
        
        document.getElementById('convConsulta').style.color = pctConsulta >= 30 ? '#22c55e' : pctConsulta >= 15 ? '#f59e0b' : '#ef4444';
        document.getElementById('convMetodo').style.color = pctMetodo >= 50 ? '#22c55e' : pctMetodo >= 25 ? '#f59e0b' : '#ef4444';
        document.getElementById('convVenta').style.color = pctVenta >= 15 ? '#22c55e' : pctVenta >= 5 ? '#f59e0b' : '#ef4444';
      }
      
      // Alertas
      renderAlerts(d.alerts || {});
    }
    
    function renderAlerts(alerts) {
      const abandoned = alerts.abandoned || [];
      const noFollowup = alerts.no_followup || [];
      
      const totalAlerts = abandoned.length + noFollowup.length;
      const badge = document.getElementById('alertCount');
      if (totalAlerts > 0) {
        badge.textContent = totalAlerts;
        badge.style.display = 'inline';
      } else {
        badge.style.display = 'none';
      }
      
      // Abandonados
      const abandList = document.getElementById('abandonedList');
      if (abandoned.length === 0) {
        abandList.innerHTML = '<div class="empty-state"><div class="empty-icon">‚úÖ</div><div>No hay clientes abandonados</div></div>';
      } else {
        abandList.innerHTML = abandoned.map(a => `
          <div class="alert-item danger">
            <div class="alert-info">
              <div class="alert-title">${a.name || formatPhone(a.phone)}</div>
              <div class="alert-detail">${a.producto || 'Sin producto'} ¬∑ Estado: ${a.state}</div>
            </div>
            <div class="alert-time">${a.age_minutes} min</div>
          </div>
        `).join('');
      }
      
      // Sin seguimiento
      const nofList = document.getElementById('noFollowupList');
      if (noFollowup.length === 0) {
        nofList.innerHTML = '<div class="empty-state"><div class="empty-icon">‚úÖ</div><div>Todo al d√≠a</div></div>';
      } else {
        nofList.innerHTML = noFollowup.map(a => `
          <div class="alert-item">
            <div class="alert-info">
              <div class="alert-title">${a.name || formatPhone(a.phone)}</div>
              <div class="alert-detail">${a.producto || 'Sin producto'} ¬∑ Estado: ${a.state}</div>
            </div>
            <div class="alert-time">${a.age_minutes} min</div>
          </div>
        `).join('');
      }
    }
    
    function renderSales() {
      const container = document.getElementById('salesList');
      const filterStatus = document.getElementById('filterStatus').value;
      const filterMethod = document.getElementById('filterMethod').value;
      const filterSearch = document.getElementById('filterSearch').value.toLowerCase();
      
      let filtered = [...allSales].reverse();
      
      if (filterStatus) {
        filtered = filtered.filter(s => s.status === filterStatus);
      }
      if (filterMethod) {
        filtered = filtered.filter(s => s.method === filterMethod);
      }
      if (filterSearch) {
        filtered = filtered.filter(s => 
          (s.producto || '').toLowerCase().includes(filterSearch) ||
          (s.name || '').toLowerCase().includes(filterSearch) ||
          (s.phone || '').includes(filterSearch)
        );
      }
      
      document.getElementById('salesCount').textContent = filtered.length + ' pedidos';
      
      if (filtered.length === 0) {
        container.innerHTML = '<div class="empty-state"><div class="empty-icon">üì¶</div><div>No hay pedidos</div></div>';
        return;
      }
      
      container.innerHTML = filtered.map(sale => {
        const date = new Date(sale.date);
        const dateStr = date.toLocaleDateString('es-CR', { day: '2-digit', month: 'short' });
        const timeStr = date.toLocaleTimeString('es-CR', { hour: '2-digit', minute: '2-digit' });
        const method = sale.method === 'envio' ? 'Env√≠o' : 'Retiro';
        const methodClass = sale.method === 'envio' ? 'envio' : 'retiro';
        const methodIcon = sale.method === 'envio' ? 'üöö' : 'üè™';
        const status = sale.status || 'pendiente';
        
        return `
          <div class="sale-item" data-id="${sale.id}">
            <div class="sale-header">
              <div class="sale-product">
                ${sale.producto || 'Art√≠culo'}
                <span class="sale-method ${methodClass}">${methodIcon} ${method}</span>
                <span class="sale-status ${status}">${status.charAt(0).toUpperCase() + status.slice(1)}</span>
              </div>
              <div class="sale-price">
                ‚Ç°${(sale.total || 0).toLocaleString()}
                ${sale.shipping ? `<div class="sale-shipping">Env√≠o: ‚Ç°${sale.shipping.toLocaleString()}</div>` : ''}
              </div>
            </div>
            <div class="sale-details">
              <span>üë§ ${sale.name || formatPhone(sale.phone || sale.waId || '')}</span>
              <span>üëï ${sale.talla_color || '-'}</span>
              <span>üìÖ ${dateStr}, ${timeStr}</span>
              ${sale.zone ? `<span>üìç ${sale.zone}</span>` : ''}
              <span>üîñ Ref: ${sale.id || sale.sinpe_reference || '-'}</span>
            </div>
            <div class="status-buttons">
              <button class="status-btn pendiente ${status === 'pendiente' ? 'active' : ''}" onclick="updateStatus('${sale.id}', 'pendiente')">Pendiente</button>
              <button class="status-btn facturado ${status === 'facturado' ? 'active' : ''}" onclick="updateStatus('${sale.id}', 'facturado')">Facturado</button>
              <button class="status-btn enviado ${status === 'enviado' ? 'active' : ''}" onclick="updateStatus('${sale.id}', 'enviado')">Enviado</button>
              <button class="status-btn entregado ${status === 'entregado' ? 'active' : ''}" onclick="updateStatus('${sale.id}', 'entregado')">Entregado</button>
            </div>
            <div class="sale-form">
              <div class="form-group">
                <label class="form-label">Gu√≠a Correos</label>
                <input type="text" class="form-input" value="${sale.guia_correos || ''}" 
                       onchange="updateField('${sale.id}', 'guia_correos', this.value)" placeholder="RR123456789CR">
              </div>
              <div class="form-group">
                <label class="form-label">Fecha Factura</label>
                <input type="date" class="form-input" value="${sale.fecha_factura || ''}"
                       onchange="updateField('${sale.id}', 'fecha_factura', this.value)">
              </div>
              <div class="form-group">
                <label class="form-label">Fecha Env√≠o</label>
                <input type="date" class="form-input" value="${sale.fecha_envio || ''}"
                       onchange="updateField('${sale.id}', 'fecha_envio', this.value)">
              </div>
              <div class="form-group">
                <label class="form-label">Fecha Entregado</label>
                <input type="date" class="form-input" value="${sale.fecha_entregado || sale.fecha_recibido || ''}"
                       onchange="updateField('${sale.id}', 'fecha_recibido', this.value)">
              </div>
            </div>
          </div>
        `;
      }).join('');
    }
    
    async function updateStatus(saleId, status) {
      await updateField(saleId, 'status', status);
    }
    
    async function updateField(saleId, field, value) {
      try {
        const res = await fetch(authUrl(API_BASE + '/api/admin/sales/update'), {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ saleId, field, value })
        });
        if (res.ok) {
          const data = await res.json();
          // Actualizar en memoria
          const idx = allSales.findIndex(s => s.id === saleId);
          if (idx >= 0 && data.sale) {
            allSales[idx] = data.sale;
          }
          renderSales();
        }
      } catch (e) {
        console.error('Error actualizando:', e);
      }
    }
    
    function processChats(history) {
      // Agrupar mensajes por waId
      const chatMap = new Map();
      history.forEach(msg => {
        if (!chatMap.has(msg.waId)) {
          chatMap.set(msg.waId, { waId: msg.waId, messages: [], lastMsg: null });
        }
        const chat = chatMap.get(msg.waId);
        chat.messages.push(msg);
        if (!chat.lastMsg || new Date(msg.timestamp) > new Date(chat.lastMsg.timestamp)) {
          chat.lastMsg = msg;
        }
      });
      
      allChats = Array.from(chatMap.values())
        .sort((a, b) => new Date(b.lastMsg?.timestamp || 0) - new Date(a.lastMsg?.timestamp || 0));
      
      renderChats();
    }
    
    function renderChats() {
      const container = document.getElementById('chatsList');
      const filter = document.getElementById('filterChats').value.toLowerCase();
      
      let filtered = allChats;
      if (filter) {
        filtered = allChats.filter(c => 
          c.waId.includes(filter) ||
          (c.lastMsg?.text || '').toLowerCase().includes(filter)
        );
      }
      
      if (filtered.length === 0) {
        container.innerHTML = '<div class="empty-state"><div class="empty-icon">üí¨</div><div>No hay chats</div></div>';
        return;
      }
      
      container.innerHTML = filtered.slice(0, 50).map((chat, idx) => {
        const lastMsg = chat.lastMsg;
        const time = lastMsg ? new Date(lastMsg.timestamp).toLocaleTimeString('es-CR', { hour: '2-digit', minute: '2-digit' }) : '';
        const preview = lastMsg?.text || (lastMsg?.hasImage ? 'üì∑ Imagen' : '...');
        const initials = chat.waId.slice(-4, -2);
        const msgCount = chat.messages ? chat.messages.length : 0;
        
        return `
          <div class="chat-item" onclick="toggleChat(this, '${chat.waId}')" id="chat-${idx}">
            <div class="chat-avatar">${initials}</div>
            <div class="chat-info">
              <div class="chat-name">${formatPhone(chat.waId)}${msgCount ? ' <span style="font-size:0.75rem;color:var(--text-muted);">(' + msgCount + ' msgs)</span>' : ''}</div>
              <div class="chat-preview">${preview.substring(0, 60)}${preview.length > 60 ? '...' : ''}</div>
            </div>
            <div class="chat-time">${time}</div>
          </div>
          <div class="chat-detail" id="detail-${chat.waId}" style="display:none;"></div>
        `;
      }).join('');
    }
    
    let openChatId = null;
    
    async function toggleChat(el, waId) {
      const detail = document.getElementById('detail-' + waId);
      if(!detail) return;
      
      // Si ya est√° abierto, cerrar
      if(openChatId === waId) {
        detail.style.display = 'none';
        el.classList.remove('active');
        openChatId = null;
        return;
      }
      
      // Cerrar el anterior
      if(openChatId) {
        const prev = document.getElementById('detail-' + openChatId);
        if(prev) prev.style.display = 'none';
        document.querySelectorAll('.chat-item.active').forEach(e => e.classList.remove('active'));
      }
      
      // Buscar mensajes en allChats
      const chat = allChats.find(c => c.waId === waId);
      if(!chat || !chat.messages || chat.messages.length === 0) {
        detail.innerHTML = '<div style="text-align:center;color:var(--text-muted);padding:1rem;">Sin mensajes guardados</div>';
      } else {
        detail.innerHTML = chat.messages.map(m => {
          const isBot = m.from === 'bot';
          const t = new Date(m.timestamp).toLocaleTimeString('es-CR', { hour: '2-digit', minute: '2-digit' });
          const txt = m.text || (m.hasImage ? 'üì∑ Imagen' : '...');
          return `<div class="msg-row ${isBot ? 'bot' : 'client'}">
            <div class="msg-bubble">${txt.replace(/\n/g, '<br>')}</div>
            <div class="msg-time">${isBot ? 'ü§ñ ' : 'üë§ '}${t}</div>
          </div>`;
        }).join('');
        
        // Scroll al final
        detail.scrollTop = detail.scrollHeight;
      }
      
      detail.style.display = 'block';
      el.classList.add('active');
      openChatId = waId;
    }
    
    function formatPhone(waId) {
      if (!waId) return 'Desconocido';
      const num = waId.replace('@s.whatsapp.net', '').replace(/\D/g, '');
      if (num.length >= 8) {
        return num.slice(-8, -4) + '-' + num.slice(-4);
      }
      return num;
    }
    
    // Event listeners para filtros
    document.getElementById('filterStatus').addEventListener('change', renderSales);
    document.getElementById('filterMethod').addEventListener('change', renderSales);
    document.getElementById('filterSearch').addEventListener('input', renderSales);
    document.getElementById('filterChats').addEventListener('input', renderChats);
    
    async function purgarDatos() {
      const fecha = document.getElementById('purgeDate').value;
      if (!fecha) { alert('Seleccion√° una fecha'); return; }
      const purgeSessions = document.getElementById('purgeSessions').checked;
      const purgeSales = document.getElementById('purgeSales').checked;
      const purgeHistory = document.getElementById('purgeHistory').checked;
      if (!purgeSessions && !purgeSales && !purgeHistory) { alert('Seleccion√° al menos una opci√≥n'); return; }
      
      var items = [];
      if (purgeSessions) items.push('sesiones');
      if (purgeSales) items.push('ventas');
      if (purgeHistory) items.push('historial');
      
      if (!confirm('¬øSeguro? Esto eliminar√° ' + items.join(', ') + ' anteriores al ' + fecha + '.\n\nNo se puede deshacer.')) return;
      
      try {
        console.log('Purge token:', ADMIN_TOKEN_INJECTED ? 'SI' : 'NO');
        const res = await fetch(authUrl(API_BASE + '/api/admin/purge'), {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'same-origin',
          body: JSON.stringify({ beforeDate: fecha + 'T23:59:59.999Z', purgeSessions, purgeSales, purgeHistory })
        });
        const data = await res.json();
        if (data.success) {
          var msg = '‚úÖ Limpieza completada:';
          if (data.sessionsDeleted > 0) msg += ' ' + data.sessionsDeleted + ' sesiones';
          if (data.salesDeleted > 0) msg += ' ' + data.salesDeleted + ' ventas';
          if (data.historyDeleted > 0) msg += ' ' + data.historyDeleted + ' mensajes';
          if (data.sessionsDeleted === 0 && data.salesDeleted === 0 && data.historyDeleted === 0) msg += ' No hab√≠a datos anteriores a esa fecha';
          document.getElementById('purgeResult').innerHTML = '<div style="background:rgba(34,197,94,0.1);border:1px solid rgba(34,197,94,0.3);color:#22c55e;padding:10px;border-radius:8px;font-size:0.85rem;">' + msg + '</div>';
          loadDashboard();
        } else {
          document.getElementById('purgeResult').innerHTML = '<div style="background:rgba(239,68,68,0.1);border:1px solid rgba(239,68,68,0.3);color:#ef4444;padding:10px;border-radius:8px;font-size:0.85rem;">' + (data.error || 'Error al limpiar') + '</div>';
        }
      } catch(e) {
        document.getElementById('purgeResult').innerHTML = '<div style="background:rgba(239,68,68,0.1);border:1px solid rgba(239,68,68,0.3);color:#ef4444;padding:10px;border-radius:8px;font-size:0.85rem;">Error de conexi√≥n: ' + e.message + '</div>';
      }
    }

    // Iniciar
    init();
    
    // Refresh cada 30 segundos
    setInterval(loadDashboard, 30000);
  </script>

</body>
</html>
