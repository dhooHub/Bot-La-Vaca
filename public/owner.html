<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Due√±o | La Vaca CR</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    *, *::before, *::after { margin:0; padding:0; box-sizing:border-box; }
    :root {
      --rose: #c8364a;
      --rose-dark: #9f1239;
      --rose-pale: #fff1f2;
      --rose-border: rgba(200,54,74,0.2);
      --text: #1a1a1a;
      --muted: #4b5563;
      --border: #e5e7eb;
      --bg: #f9fafb;
      --white: #ffffff;
      --green: #16a34a;
      --green-pale: #f0fdf4;
      --red: #dc2626;
      --orange: #d97706;
      --blue: #2563eb;
      --blue-pale: #eff6ff;
      --purple: #7c3aed;
      --purple-pale: #f5f3ff;
      --radius: 10px;
      --shadow: 0 1px 4px rgba(0,0,0,0.08);
      --shadow-md: 0 4px 16px rgba(0,0,0,0.10);
    }
    html, body { font-family:'DM Sans',sans-serif; background:var(--bg); color:var(--text); min-height:100vh; }

    /* ‚îÄ‚îÄ HEADER ‚îÄ‚îÄ */
    .owner-header {
      background:var(--white); border-bottom:1px solid var(--border);
      padding:0 32px; height:60px;
      display:flex; align-items:center; justify-content:space-between;
      position:sticky; top:0; z-index:100;
      box-shadow:var(--shadow);
    }
    .brand { display:flex; align-items:center; gap:12px; }
    .brand-icon { width:36px; height:36px; background:var(--rose); border-radius:10px; display:flex; align-items:center; justify-content:center; font-size:1.1rem; }
    .brand-title { font-size:0.9rem; font-weight:700; }
    .brand-sub   { font-size:0.72rem; color:var(--muted); }
    .header-right { display:flex; align-items:center; gap:12px; }
    .conn-pill {
      display:flex; align-items:center; gap:7px;
      padding:5px 13px; border:1px solid var(--border); border-radius:8px;
      font-size:0.78rem; font-weight:600; color:var(--muted); background:var(--white);
    }
    .dot { width:8px; height:8px; border-radius:50%; flex-shrink:0; }
    .dot.on   { background:#22c55e; box-shadow:0 0 6px #22c55e; }
    .dot.off  { background:var(--red); }
    .dot.wait { background:var(--orange); animation:blink 1s infinite; }
    .btn-ref {
      padding:7px 14px; border:1px solid var(--border); border-radius:8px;
      color:var(--muted); font-size:0.82rem; font-weight:500; background:var(--white);
      cursor:pointer; font-family:'DM Sans',sans-serif; transition:all .2s;
    }
    .btn-ref:hover { border-color:var(--rose); color:var(--rose); }
    .upd-text { font-size:0.72rem; color:var(--muted); }

    /* ‚îÄ‚îÄ TABS ‚îÄ‚îÄ */
    .nav-tabs {
      display:flex; gap:6px; padding:10px 16px;
      background:var(--bg); border-bottom:1px solid var(--border);
      box-shadow:0 2px 8px rgba(0,0,0,0.06);
      position:sticky; top:60px; z-index:99;
      overflow-x:auto; scrollbar-width:none;
    }
    .nav-tabs::-webkit-scrollbar { display:none; }
    .nav-tab {
      padding:7px 16px; border:1px solid var(--border); border-radius:8px;
      background:var(--white); color:var(--text); font-size:0.82rem; font-weight:600;
      cursor:pointer; font-family:'DM Sans',sans-serif; white-space:nowrap;
      transition:all .2s;
    }
    .nav-tab:hover  { border-color:var(--rose); background:var(--rose-pale); color:var(--text); }
    .nav-tab.active { background:var(--rose); border-color:var(--rose); color:#fff; }

    /* ‚îÄ‚îÄ CONTENT ‚îÄ‚îÄ */
    .panel { display:none; padding:24px 32px 60px; max-width:1200px; margin:0 auto; }
    .panel.active { display:block; }

    /* ‚îÄ‚îÄ SECTION LABEL ‚îÄ‚îÄ */
    .slabel { font-size:0.7rem; font-weight:700; text-transform:uppercase; letter-spacing:2px; color:var(--muted); margin-bottom:12px; }

    /* ‚îÄ‚îÄ KPI CARDS ‚îÄ‚îÄ */
    .kpis { display:grid; grid-template-columns:repeat(auto-fill,minmax(160px,1fr)); gap:14px; margin-bottom:24px; }
    .kpi {
      background:var(--white); border:1px solid var(--border);
      border-radius:var(--radius); padding:18px 18px;
      box-shadow:var(--shadow);
    }
    .kpi-lbl { font-size:0.72rem; font-weight:600; color:var(--muted); margin-bottom:7px; text-transform:uppercase; letter-spacing:.5px; }
    .kpi-val { font-size:2rem; font-weight:700; line-height:1; color:var(--text); }
    .kpi-sub { font-size:0.72rem; color:var(--muted); margin-top:5px; }
    .kpi.green .kpi-val { color:var(--green); }
    .kpi.rose  .kpi-val { color:var(--rose); }
    .kpi.orange .kpi-val { color:var(--orange); }
    .kpi.blue   .kpi-val { color:var(--blue); }
    .kpi.purple .kpi-val { color:var(--purple); }
    .kpi.red    .kpi-val { color:var(--red); }

    /* ‚îÄ‚îÄ EFF BARS ‚îÄ‚îÄ */
    .effs { display:grid; grid-template-columns:1fr 1fr; gap:14px; margin-bottom:24px; }
    .eff-card {
      background:var(--white); border:1px solid var(--border);
      border-radius:var(--radius); padding:18px 18px; box-shadow:var(--shadow);
    }
    .eff-top { display:flex; justify-content:space-between; align-items:baseline; margin-bottom:10px; }
    .eff-name { font-size:0.78rem; font-weight:600; color:var(--muted); }
    .eff-pct  { font-size:1.6rem; font-weight:700; }
    .bar-bg   { height:6px; background:var(--bg); border-radius:999px; border:1px solid var(--border); overflow:hidden; }
    .bar-fill { height:100%; border-radius:999px; transition:width .9s ease; }
    .eff-note { font-size:0.7rem; color:var(--muted); margin-top:7px; }

    /* ‚îÄ‚îÄ FILTERS ‚îÄ‚îÄ */
    .filters {
      display:flex; gap:8px; flex-wrap:wrap; align-items:center;
      margin-bottom:16px; padding:14px 16px;
      background:var(--white); border:1px solid var(--border);
      border-radius:var(--radius); box-shadow:var(--shadow);
    }
    .filters input, .filters select {
      padding:7px 11px; background:var(--bg); border:1.5px solid var(--border);
      border-radius:8px; color:var(--text); font-family:'DM Sans',sans-serif;
      font-size:0.82rem; outline:none; transition:border-color .2s;
    }
    .filters input:focus, .filters select:focus { border-color:var(--rose); background:var(--white); }
    .filters input[type=text] { flex:1; min-width:160px; }
    .filters label { font-size:0.75rem; font-weight:600; color:var(--muted); white-space:nowrap; }
    .btn-filter {
      padding:7px 18px; background:var(--rose); color:#fff; border:none;
      border-radius:8px; font-size:0.82rem; font-weight:600; cursor:pointer;
      font-family:'DM Sans',sans-serif; transition:background .2s;
    }
    .btn-filter:hover { background:var(--rose-dark); }

    /* ‚îÄ‚îÄ SUMMARY STRIP ‚îÄ‚îÄ */
    .summary-strip {
      display:flex; gap:8px; flex-wrap:wrap; margin-bottom:16px;
      padding:12px 16px; background:var(--white); border:1px solid var(--border);
      border-radius:var(--radius); box-shadow:var(--shadow);
    }
    .sum-item { display:flex; flex-direction:column; gap:2px; padding:0 14px; border-right:1px solid var(--border); }
    .sum-item:last-child { border-right:none; }
    .sum-lbl { font-size:0.68rem; font-weight:600; color:var(--muted); text-transform:uppercase; letter-spacing:.4px; }
    .sum-val { font-size:1.1rem; font-weight:700; }

    /* ‚îÄ‚îÄ VENTA CARDS ‚îÄ‚îÄ */
    .venta-card {
      background:var(--white); border:1px solid var(--border);
      border-radius:var(--radius); margin-bottom:10px;
      box-shadow:var(--shadow); overflow:hidden; transition:box-shadow .2s;
    }
    .venta-card:hover { box-shadow:var(--shadow-md); }
    .venta-head {
      display:flex; align-items:flex-start; justify-content:space-between;
      gap:12px; padding:14px 18px; cursor:pointer;
    }
    .venta-left { flex:1; min-width:0; }
    .venta-prod { font-size:0.92rem; font-weight:700; margin-bottom:4px; }
    .venta-meta { font-size:0.76rem; color:var(--muted); line-height:1.7; }
    .venta-right { text-align:right; flex-shrink:0; }
    .venta-total { font-size:1.2rem; font-weight:700; color:var(--green); }
    .venta-id { font-size:0.62rem; color:var(--muted); margin-top:2px; }

    .venta-body { display:none; border-top:1px solid var(--border); padding:18px; background:var(--bg); }
    .venta-body.open { display:block; }

    /* Steps */
    .steps { display:flex; gap:6px; flex-wrap:wrap; margin-bottom:14px; align-items:center; }
    .step {
      padding:4px 12px; border-radius:999px; font-size:0.7rem; font-weight:700;
      border:1.5px solid; opacity:.3;
    }
    .step.done { opacity:1; }
    .step-alist  { border-color:var(--orange); color:var(--orange); background:#fffbeb; }
    .step-trans  { border-color:var(--blue);   color:var(--blue);   background:var(--blue-pale); }
    .step-ent    { border-color:var(--green);  color:var(--green);  background:var(--green-pale); }
    .step-arrow  { color:var(--muted); font-size:.8rem; opacity:.4; }

    /* Info grid */
    .info-grid { display:grid; grid-template-columns:repeat(auto-fill,minmax(180px,1fr)); gap:10px; margin-bottom:14px; }
    .info-block {
      background:var(--white); border:1px solid var(--border);
      border-radius:8px; padding:10px 12px; box-shadow:var(--shadow);
    }
    .info-lbl { font-size:0.63rem; font-weight:700; text-transform:uppercase; letter-spacing:.5px; color:var(--muted); margin-bottom:4px; }
    .info-val { font-size:0.84rem; font-weight:600; word-break:break-word; line-height:1.4; }

    /* Edit row */
    .edit-section {
      background:var(--white); border:1.5px solid var(--border);
      border-radius:var(--radius); padding:16px 16px; margin-top:4px;
    }
    .edit-section-title { font-size:0.72rem; font-weight:700; color:var(--muted); text-transform:uppercase; letter-spacing:1px; margin-bottom:12px; }
    .edit-row { display:flex; gap:10px; flex-wrap:wrap; align-items:flex-end; }
    .edit-group { display:flex; flex-direction:column; gap:4px; }
    .edit-group label { font-size:0.7rem; font-weight:600; color:var(--muted); }
    .edit-group input, .edit-group select {
      padding:7px 10px; background:var(--bg); border:1.5px solid var(--border);
      border-radius:8px; color:var(--text); font-family:'DM Sans',sans-serif;
      font-size:0.82rem; outline:none; transition:border-color .2s;
    }
    .edit-group input:focus, .edit-group select:focus { border-color:var(--rose); background:var(--white); }
    .btn-save {
      padding:8px 16px; background:var(--rose); color:#fff; border:none;
      border-radius:8px; font-size:0.8rem; font-weight:700; cursor:pointer;
      font-family:'DM Sans',sans-serif; align-self:flex-end; transition:background .2s;
    }
    .btn-save:hover { background:var(--rose-dark); }
    .save-ok { font-size:0.75rem; color:var(--green); font-weight:600; align-self:center; opacity:0; transition:opacity .3s; }
    .save-ok.show { opacity:1; }

    /* ‚îÄ‚îÄ BADGES ‚îÄ‚îÄ */
    .badge { display:inline-flex; align-items:center; padding:3px 9px; border-radius:999px; font-size:0.7rem; font-weight:700; }
    .bg { background:var(--green-pale); color:var(--green); border:1px solid #bbf7d0; }
    .br { background:var(--rose-pale);  color:var(--rose);  border:1px solid #fecdd3; }
    .by { background:#fffbeb;           color:var(--orange);border:1px solid #fde68a; }
    .bb { background:var(--blue-pale);  color:var(--blue);  border:1px solid #bfdbfe; }
    .bp { background:var(--purple-pale);color:var(--purple);border:1px solid #ddd6fe; }

    /* ‚îÄ‚îÄ CHATS ‚îÄ‚îÄ */
    .chat-card {
      background:var(--white); border:1px solid var(--border);
      border-radius:var(--radius); margin-bottom:10px;
      box-shadow:var(--shadow); overflow:hidden;
    }
    .chat-head { display:flex; justify-content:space-between; align-items:flex-start; gap:10px; padding:13px 16px; cursor:pointer; transition:background .2s; }
    .chat-head:hover { background:var(--bg); }
    .chat-name  { font-weight:700; font-size:0.9rem; }
    .chat-phone { font-size:0.72rem; color:var(--muted); }
    .chat-preview { font-size:0.78rem; color:var(--muted); margin-top:3px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; max-width:420px; }
    .chat-meta { text-align:right; flex-shrink:0; }
    .chat-time  { font-size:0.7rem; color:var(--muted); }
    .chat-count { font-size:0.68rem; color:var(--muted); }
    .chat-msgs { display:none; border-top:1px solid var(--border); padding:14px 16px; max-height:360px; overflow-y:auto; background:var(--bg); }
    .chat-msgs.open { display:block; }
    .msg-row { display:flex; gap:8px; margin-bottom:8px; }
    .msg-row.bot { flex-direction:row-reverse; }
    .msg-bub { max-width:76%; padding:9px 13px; border-radius:12px; font-size:0.82rem; line-height:1.5; }
    .msg-row.user .msg-bub { background:var(--white); border:1px solid var(--border); }
    .msg-row.bot  .msg-bub { background:var(--rose-pale); border:1px solid var(--rose-border); color:var(--text); }
    .msg-ts { font-size:0.62rem; color:var(--muted); align-self:flex-end; white-space:nowrap; }

    /* ‚îÄ‚îÄ ALERTS ‚îÄ‚îÄ */
    .alert-card {
      display:flex; gap:12px; align-items:flex-start;
      background:var(--white); border:1px solid var(--border);
      border-radius:var(--radius); padding:14px 16px; margin-bottom:8px;
      box-shadow:var(--shadow);
    }
    .alert-card.atendida { border-color:#bbf7d0; background:var(--green-pale); }
    .alert-card.pendiente { border-color:#fde68a; }
    .alert-icon { font-size:1.3rem; flex-shrink:0; }
    .alert-title { font-weight:700; font-size:0.88rem; margin-bottom:3px; display:flex; align-items:center; gap:8px; }
    .alert-detail { font-size:0.76rem; color:var(--muted); line-height:1.65; }
    .alert-time { font-size:0.68rem; color:var(--muted); margin-left:auto; flex-shrink:0; white-space:nowrap; }

    /* Por tipo stats */
    .tipo-table {
      background:var(--white); border:1px solid var(--border);
      border-radius:var(--radius); overflow:hidden; margin-bottom:20px;
      box-shadow:var(--shadow);
    }
    .tipo-row {
      display:flex; justify-content:space-between; align-items:center;
      padding:11px 16px; border-bottom:1px solid var(--border);
      font-size:0.82rem;
    }
    .tipo-row:last-child { border-bottom:none; }
    .tipo-row:hover { background:var(--bg); }
    .tipo-name { font-weight:600; }
    .tipo-stats { display:flex; gap:16px; align-items:center; }
    .tipo-pct { font-size:0.9rem; font-weight:700; min-width:40px; text-align:right; }

    /* ‚îÄ‚îÄ CHAT MODAL ‚îÄ‚îÄ */
    #chatModal { display:none; position:fixed; inset:0; background:rgba(0,0,0,0.5); z-index:998; align-items:flex-end; justify-content:center; }
    .cm-sheet { background:#fff; border-radius:20px 20px 0 0; width:100%; max-width:700px; height:92vh; display:flex; flex-direction:column; overflow:hidden; }
    .cm-header { padding:16px 20px 12px; border-bottom:1px solid var(--border); flex-shrink:0; display:flex; align-items:flex-start; justify-content:space-between; gap:10px; }
    .cm-title  { font-size:1.05rem; font-weight:700; color:var(--text); }
    .cm-sub    { font-size:0.78rem; color:var(--muted); margin-top:3px; }
    .cm-close  { width:32px; height:32px; border-radius:50%; background:var(--bg); border:1px solid var(--border); cursor:pointer; font-size:1rem; display:flex; align-items:center; justify-content:center; flex-shrink:0; }
    .cm-close:hover { background:var(--border); }
    #chatModalMsgs { flex:1; overflow-y:auto; padding:16px 16px; display:flex; flex-direction:column; gap:10px; background:#f0f0f0; }
    .cm-row { display:flex; gap:8px; align-items:flex-end; }
    .cm-row.bot { flex-direction:row-reverse; }
    .cm-bub { max-width:78%; padding:11px 15px; border-radius:18px; font-size:0.96rem; line-height:1.55; color:#111; word-break:break-word; }
    .cm-row.user .cm-bub { background:#ffffff; border-radius:18px 18px 18px 4px; box-shadow:0 1px 3px rgba(0,0,0,0.1); }
    .cm-row.bot  .cm-bub { background:#c8364a; color:#fff; border-radius:18px 18px 4px 18px; }
    .cm-row.bot  .cm-bub a { color:#ffd6db; }
    .cm-ts { font-size:0.65rem; color:#9ca3af; white-space:nowrap; margin-bottom:4px; flex-shrink:0; }

    /* ‚îÄ‚îÄ CHAT MODAL ‚îÄ‚îÄ */
    .loading { text-align:center; padding:60px 20px; }
    .spin { width:30px; height:30px; border:3px solid var(--border); border-top-color:var(--rose); border-radius:50%; animation:spin .7s linear infinite; margin:0 auto 12px; }
    .loading p { font-size:0.82rem; color:var(--muted); }
    .empty { text-align:center; padding:48px 20px; color:var(--muted); font-size:0.85rem; }
    .empty-icon { font-size:2.5rem; margin-bottom:10px; }

    /* ‚îÄ‚îÄ DIVIDER ‚îÄ‚îÄ */
    .divider { height:1px; background:var(--border); margin:20px 0; }

    @media(max-width:640px) {
      .owner-header { padding:0 16px; }
      .panel { padding:16px 16px 60px; }
      .kpis { grid-template-columns:1fr 1fr; }
      .effs { grid-template-columns:1fr; }
      .upd-text, .brand-sub { display:none; }
      .info-grid { grid-template-columns:1fr 1fr; }
      .edit-row { flex-direction:column; }
    }
    @keyframes spin  { to{transform:rotate(360deg);} }
    @keyframes blink { 0%,100%{opacity:1} 50%{opacity:.4} }
    @keyframes fadeUp { from{opacity:0;transform:translateY(8px)} to{opacity:1;transform:translateY(0)} }
    .fade-up { animation:fadeUp .3s ease; }
  </style>
</head>
<body>

<header class="owner-header">
  <div class="brand">
    <div class="brand-icon">üêÑ</div>
    <div>
      <div class="brand-title">Panel Due√±o</div>
      <div class="brand-sub">La Vaca CR</div>
    </div>
  </div>
  <div class="header-right">
    <span class="upd-text" id="updText"></span>
    <div class="conn-pill">
      <span class="dot wait" id="connDot"></span>
      <span id="connText">Conectando...</span>
    </div>
    <button class="btn-ref" onclick="loadAll()">‚Üª Actualizar</button>
  </div>
</header>

<div class="nav-tabs">
  <button class="nav-tab active" onclick="showTab('resumen',this)">üìä Resumen</button>
  <button class="nav-tab" onclick="showTab('ventas',this)">üí∞ Ventas</button>
  <button class="nav-tab" onclick="showTab('chats',this)">üí¨ Chats</button>
  <button class="nav-tab" onclick="showTab('alertas',this)">üîî Alertas</button>
  <button class="nav-tab" onclick="showTab('likes',this);loadLikesStats();">‚ù§Ô∏è Likes</button>
</div>

<div id="p-resumen" class="panel active"><div class="loading"><div class="spin"></div><p>Cargando datos...</p></div></div>

<div id="p-ventas" class="panel">
  <div class="filters">
    <label>Desde</label><input type="date" id="vFrom">
    <label>Hasta</label><input type="date" id="vTo">
    <select id="vOrigen"><option value="all">Todos</option><option value="bot">ü§ñ Bot</option><option value="manual">‚úçÔ∏è Manual</option></select>
    <select id="vMethod"><option value="all">Todos m√©todos</option><option value="envio">üì¶ Env√≠o</option><option value="recoger">üè™ Retiro</option></select>
    <select id="vStatus"><option value="all">Todos estados</option><option value="pendiente">üü° Pendiente</option><option value="facturado">üîµ Facturado</option><option value="enviado">üü£ Enviado</option><option value="recibido">üü¢ Recibido</option></select>
    <input type="text" id="vSearch" placeholder="Buscar cliente o producto...">
    <button class="btn-filter" onclick="loadVentas()">Filtrar</button>
    <button onclick="showPurgeModal('ventas')" style="padding:7px 14px;background:#fff0f0;color:var(--red);border:1px solid #fecaca;border-radius:8px;font-size:0.82rem;font-weight:600;cursor:pointer;font-family:'DM Sans',sans-serif;">üóëÔ∏è Limpiar</button>
  </div>
  <div id="ventasContent"><div class="loading"><div class="spin"></div><p>Cargando ventas...</p></div></div>
</div>

<div id="p-chats" class="panel">
  <div class="filters">
    <label>Desde</label><input type="date" id="cFrom">
    <label>Hasta</label><input type="date" id="cTo">
    <input type="text" id="cSearch" placeholder="Nombre o tel√©fono...">
    <button class="btn-filter" onclick="loadChats()">Filtrar</button>
    <button onclick="showPurgeModal('chats')" style="padding:7px 14px;background:#fff0f0;color:var(--red);border:1px solid #fecaca;border-radius:8px;font-size:0.82rem;font-weight:600;cursor:pointer;font-family:'DM Sans',sans-serif;">üóëÔ∏è Limpiar</button>
  </div>
  <div id="chatsContent"><div class="loading"><div class="spin"></div><p>Cargando chats...</p></div></div>
</div>

<div id="p-alertas" class="panel"><div class="loading"><div class="spin"></div><p>Cargando alertas...</p></div></div>

<div id="p-likes" class="panel">
  <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:16px;">
    <h2 style="margin:0;font-size:1.1rem;font-weight:700;">‚ù§Ô∏è Estad√≠sticas de Likes</h2>
    <button onclick="loadLikesStats()" style="background:var(--rose,#6b1225);color:#fff;border:none;border-radius:8px;padding:7px 16px;font-size:0.8rem;font-weight:600;cursor:pointer;">‚Üª Actualizar</button>
  </div>
  <div id="msgLikesOwner" style="margin-bottom:12px;"></div>
  <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-bottom:24px;">
    <div>
      <div style="font-weight:700;font-size:0.85rem;color:#dc2626;margin-bottom:10px;">üî• Top 20 ‚Äî M√°s gustados</div>
      <div id="ownerLikesTop" style="display:flex;flex-direction:column;gap:7px;"></div>
    </div>
    <div>
      <div style="font-weight:700;font-size:0.85rem;color:#6b7280;margin-bottom:10px;">üìâ Bottom 20 ‚Äî Menos gustados</div>
      <div id="ownerLikesBottom" style="display:flex;flex-direction:column;gap:7px;"></div>
    </div>
  </div>
  <div>
    <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:10px;">
      <div style="font-weight:700;font-size:0.85rem;">üìã Todos los productos</div>
      <div style="display:flex;gap:8px;">
        <input type="text" id="ownerLikesSearch" placeholder="Buscar..." oninput="filterOwnerLikes()" style="padding:6px 10px;border:1px solid #e5e7eb;border-radius:7px;font-size:0.8rem;width:140px;">
        <select id="ownerLikesSort" onchange="filterOwnerLikes()" style="padding:6px 10px;border:1px solid #e5e7eb;border-radius:7px;font-size:0.8rem;">
          <option value="desc">Mayor a menor</option>
          <option value="asc">Menor a mayor</option>
        </select>
      </div>
    </div>
    <div id="ownerLikesAll" style="display:flex;flex-direction:column;gap:6px;"></div>
  </div>
</div>



<!-- Chat Modal -->
<div id="chatModal" onclick="if(event.target===this)closeChatModal()">
  <div class="cm-sheet">
    <div class="cm-header">
      <div>
        <div class="cm-title" id="chatModalName"></div>
        <div class="cm-sub" id="chatModalPhone"></div>
        <div class="cm-sub" id="chatModalCount"></div>
      </div>
      <button class="cm-close" onclick="closeChatModal()">‚úï</button>
    </div>
    <div id="chatModalMsgs"></div>
  </div>
</div>

<!-- Modal de limpieza -->
<div id="purgeModal" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,0.4);z-index:999;align-items:center;justify-content:center;">
  <div style="background:#fff;border-radius:14px;padding:28px 28px 24px;max-width:400px;width:92%;box-shadow:0 8px 32px rgba(0,0,0,0.18);">
    <div style="font-size:1rem;font-weight:700;margin-bottom:6px;">üóëÔ∏è Limpiar datos</div>
    <p style="font-size:0.82rem;color:var(--muted);margin-bottom:16px;" id="purgeDesc"></p>
    <div style="margin-bottom:16px;">
      <label style="font-size:0.72rem;font-weight:700;color:var(--muted);display:block;margin-bottom:6px;text-transform:uppercase;">Borrar todo hasta (incluyendo):</label>
      <input type="date" id="purgeDate" style="width:100%;padding:9px 12px;border:1.5px solid var(--border);border-radius:8px;font-family:'DM Sans',sans-serif;font-size:0.9rem;">
    </div>
    <div style="background:#fff0f0;border:1px solid #fecaca;border-radius:8px;padding:10px 14px;font-size:0.78rem;color:var(--red);margin-bottom:18px;">
      ‚ö†Ô∏è Esta acci√≥n es <strong>irreversible</strong>. Los datos eliminados no se pueden recuperar.
    </div>
    <div style="display:flex;gap:10px;justify-content:flex-end;">
      <button onclick="closePurgeModal()" style="padding:9px 18px;border:1px solid var(--border);border-radius:8px;background:#fff;font-family:'DM Sans',sans-serif;font-size:0.82rem;font-weight:600;cursor:pointer;">Cancelar</button>
      <button onclick="executePurge()" style="padding:9px 18px;background:var(--red);color:#fff;border:none;border-radius:8px;font-family:'DM Sans',sans-serif;font-size:0.82rem;font-weight:700;cursor:pointer;">Borrar datos</button>
    </div>
  </div>
</div>


<script>
const BOT = "https://tico-bot-lite.onrender.com";
const PWD = "lavaca2026";
let dash = null;
let allSales = [];
let dashAlerts = null;

const $  = id => document.getElementById(id);
const fmtM  = n => '‚Ç°' + (n||0).toLocaleString('es-CR');
const fmtDt = iso => {
  if(!iso) return '‚Äî';
  const d = new Date(iso);
  return d.toLocaleDateString('es-CR',{day:'2-digit',month:'short'}) + ' ' +
         d.toLocaleTimeString('es-CR',{hour:'2-digit',minute:'2-digit'});
};
const pct = (a,b) => b>0 ? Math.round((a/b)*100) : 0;
const esc = t => String(t||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
function bar(v,c){ return `<div class="bar-bg"><div class="bar-fill" style="width:${Math.min(v,100)}%;background:${c}"></div></div>`; }
function bColor(v,lo,hi){ return v>=hi?'var(--green)':v>=lo?'var(--orange)':'var(--red)'; }

// ===== LIKES STATS =====
const SITE = 'https://www.lavacacr.com';
var _ownerLikesData = null;

async function loadLikesStats() {
  var topEl = $('ownerLikesTop');
  var botEl = $('ownerLikesBottom');
  var msgEl = $('msgLikesOwner');
  if (!topEl) return;
  topEl.innerHTML = '<div style="color:#9ca3af;font-size:0.82rem;">‚è≥ Cargando...</div>';
  botEl.innerHTML = '';
  if (msgEl) msgEl.innerHTML = '';
  try {
    var r = await fetch(SITE + '/admin.php?action=likes_stats&pass=2002');
    var d = await r.json();
    if (!d.success) { if(msgEl) msgEl.innerHTML = '<div style="color:red;font-size:0.82rem;">' + (d.error||'Error') + '</div>'; return; }
    // Load product names
    var nameMap = {};
    try {
      var pr = await fetch(SITE + '/products.js?v=' + Date.now());
      var pt = await pr.text();
      var pm = pt.match(/\["([^"]+)",\s*"([^"]+)"/g);
      if (pm) pm.forEach(function(m) {
        var parts = m.match(/\["([^"]+)",\s*"([^"]+)"/);
        if (parts) nameMap[parts[1].replace(/_[B-Z]$/, '')] = parts[2];
      });
    } catch(ex) {}
    _ownerLikesData = { all: d.all, nameMap: nameMap, maxCount: d.maxCount || 0 };
    function renderLikeList(el, obj, isTop) {
      var entries = Object.entries(obj);
      if (isTop && entries.length === 0) {
        el.innerHTML = '<div style="color:#9ca3af;font-size:0.82rem;padding:8px;">A√∫n no hay likes ‚Äî aparecer√°n cuando las clientas comiencen a dar ‚ù§Ô∏è</div>';
        return;
      }
      if (entries.length === 0) { el.innerHTML = '<div style="color:#9ca3af;font-size:0.82rem;padding:8px;">Sin datos a√∫n</div>'; return; }
      el.innerHTML = entries.map(function(e, i) {
        var cb = e[0].replace(/_[B-Z]$/, '');
        var nm = nameMap[cb] || nameMap[e[0]] || cb;
        var medal = isTop ? (i===0?'ü•á':i===1?'ü•à':i===2?'ü•â':'') : '';
        var cc = e[1] === 0 ? '#9ca3af' : '#6b1225';
        return '<div style="display:flex;align-items:center;gap:8px;padding:7px 10px;background:#fff;border:1px solid #e5e7eb;border-radius:8px;">'
          + '<img src="' + SITE + '/img/' + cb + '.webp" onerror="this.style.opacity=0.1" style="width:36px;height:36px;object-fit:cover;border-radius:5px;flex-shrink:0;">'
          + '<div style="flex:1;min-width:0;"><div style="font-size:0.78rem;font-weight:600;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">' + medal + ' ' + nm + '</div>'
          + '<div style="font-size:0.7rem;color:#9ca3af;">C√≥digo: ' + cb + '</div></div>'
          + '<div style="display:flex;align-items:center;gap:3px;flex-shrink:0;">'
          + '<svg viewBox="0 0 24 24" width="13" height="13" fill="' + cc + '"><path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"/></svg>'
          + '<span style="font-size:0.85rem;font-weight:800;color:' + cc + ';">' + e[1] + '</span></div>'
          + '</div>';
      }).join('');
    }
    renderLikeList(topEl, d.top, true);
    renderLikeList(botEl, d.bottom, false);
    filterOwnerLikes();
  } catch(e) { if(msgEl) msgEl.innerHTML = '<div style="color:red;font-size:0.82rem;">Error de conexi√≥n</div>'; }
}

function filterOwnerLikes() {
  var el = $('ownerLikesAll');
  if (!el || !_ownerLikesData) return;
  var query = ($('ownerLikesSearch') ? $('ownerLikesSearch').value.toLowerCase().trim() : '');
  var sort  = $('ownerLikesSort') ? $('ownerLikesSort').value : 'desc';
  var nm    = _ownerLikesData.nameMap;
  var entries = Object.entries(_ownerLikesData.all || {});
  entries.sort(function(a,b){ return sort==='desc' ? b[1]-a[1] : a[1]-b[1]; });
  if (query) entries = entries.filter(function(e){
    var cb = e[0].replace(/_[B-Z]$/,'');
    return (nm[cb]||cb).toLowerCase().includes(query) || cb.includes(query);
  });
  if (!entries.length) { el.innerHTML = '<div style="color:#9ca3af;font-size:0.82rem;padding:8px;">Sin resultados</div>'; return; }
  var max = _ownerLikesData.maxCount || 1;
  el.innerHTML = entries.map(function(e,i){
    var cb = e[0].replace(/_[B-Z]$/,'');
    var nombre = nm[cb] || nm[e[0]] || cb;
    var pct = Math.round((e[1]/max)*100);
    return '<div style="display:flex;align-items:center;gap:8px;padding:7px 10px;background:#fff;border:1px solid #e5e7eb;border-radius:8px;">'
      + '<span style="font-size:0.7rem;color:#9ca3af;width:20px;text-align:right;flex-shrink:0;">' + (i+1) + '</span>'
      + '<img src="' + SITE + '/img/' + cb + '.webp" onerror="this.style.opacity=0.1" style="width:36px;height:36px;object-fit:cover;border-radius:5px;flex-shrink:0;">'
      + '<div style="flex:1;min-width:0;">'
        + '<div style="font-size:0.78rem;font-weight:600;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">' + nombre + '</div>'
        + '<div style="height:4px;background:#f3e8eb;border-radius:2px;margin-top:3px;"><div style="height:4px;background:#6b1225;border-radius:2px;width:' + pct + '%;"></div></div>'
      + '</div>'
      + '<div style="display:flex;align-items:center;gap:3px;flex-shrink:0;">'
        + '<svg viewBox="0 0 24 24" width="13" height="13" fill="#6b1225"><path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"/></svg>'
        + '<span style="font-size:0.85rem;font-weight:800;color:#6b1225;">' + e[1] + '</span>'
      + '</div>'
    + '</div>';
  }).join('');
}
// ========================

function showTab(name,el){
  document.querySelectorAll('.nav-tab').forEach(t=>t.classList.remove('active'));
  document.querySelectorAll('.panel').forEach(p=>p.classList.remove('active'));
  el.classList.add('active');
  $('p-'+name).classList.add('active');
}

function setConn(state,text){ $('connDot').className='dot '+state; $('connText').textContent=text; }

async function loadAll(){
  setConn('wait','Conectando...');
  try {
    const r = await fetch(`${BOT}/api/admin/dashboard?pwd=${PWD}`);
    if(!r.ok) throw new Error('HTTP '+r.status);
    dash = await r.json();
    setConn(dash.connection==='connected'?'on':'off', dash.connection==='connected'?'‚úì Conectado':'Desconectado');
    $('updText').textContent = 'Actualizado: ' + new Date().toLocaleTimeString('es-CR');
    dashAlerts = dash.alerts;
    renderResumen(dash);
  } catch(e){
    setConn('off','Sin conexi√≥n');
    $('p-resumen').innerHTML=`<div class="empty"><div class="empty-icon">‚ö°</div>Sin conexi√≥n al bot.<br><small>${esc(e.message)}</small></div>`;
  }
  loadVentas();
  loadChats();
  loadAlerts();
}

// ‚îÄ‚îÄ RESUMEN ‚îÄ‚îÄ
function renderResumen(d){
  const m  = d.metrics||{};
  const s  = d.sales||{};
  const ch = d.chats||{};
  const ab = (d.alerts?.abandoned||[]).length;
  const nf = (d.alerts?.no_followup||[]).length;
  const ct = m.chats_total||0;
  const sc = s.all?.count||0;

  const cvPct  = pct(sc,ct);
  const snpPct = pct(m.sinpe_confirmed||0, m.intent_yes||1);
  const retPct = Math.max(0, 100-pct(ab,Math.max(ct,1)));
  const resPct = pct(m.quotes_sent||0, ct||1);

  $('p-resumen').innerHTML = `<div class="fade-up">

    <div class="slabel">Hoy</div>
    <div class="kpis">
      <div class="kpi green"><div class="kpi-lbl">Ventas hoy</div><div class="kpi-val">${s.today?.count||0}</div><div class="kpi-sub">${fmtM(s.today?.revenue||0)}</div></div>
      <div class="kpi green"><div class="kpi-lbl">Neto hoy</div><div class="kpi-val">${fmtM(s.today?.net||0)}</div><div class="kpi-sub">sin env√≠os</div></div>
      <div class="kpi blue"><div class="kpi-lbl">Chats hoy</div><div class="kpi-val">${ch.today||0}</div><div class="kpi-sub">conversaciones</div></div>
      <div class="kpi purple"><div class="kpi-lbl">Activos ahora</div><div class="kpi-val">${ch.active||0}</div><div class="kpi-sub">sesiones abiertas</div></div>
    </div>

    <div class="slabel">Esta Semana</div>
    <div class="kpis">
      <div class="kpi orange"><div class="kpi-lbl">Ventas</div><div class="kpi-val">${s.week?.count||0}</div><div class="kpi-sub">${fmtM(s.week?.revenue||0)}</div></div>
      <div class="kpi orange"><div class="kpi-lbl">Neto</div><div class="kpi-val">${fmtM(s.week?.net||0)}</div><div class="kpi-sub">sin env√≠os</div></div>
      <div class="kpi blue"><div class="kpi-lbl">Chats</div><div class="kpi-val">${ch.week||0}</div><div class="kpi-sub">conversaciones</div></div>
      <div class="kpi red"><div class="kpi-lbl">Abandonados</div><div class="kpi-val">${ab}</div><div class="kpi-sub">&gt;2h sin responder</div></div>
    </div>

    <div class="slabel">Este Mes</div>
    <div class="kpis">
      <div class="kpi green"><div class="kpi-lbl">Ventas</div><div class="kpi-val">${s.month?.count||0}</div><div class="kpi-sub">${fmtM(s.month?.revenue||0)}</div></div>
      <div class="kpi green"><div class="kpi-lbl">Neto mes</div><div class="kpi-val">${fmtM(s.month?.net||0)}</div><div class="kpi-sub">sin env√≠os</div></div>
      <div class="kpi blue"><div class="kpi-lbl">Env√≠os cobrados</div><div class="kpi-val">${fmtM(s.month?.shipping||0)}</div><div class="kpi-sub">a clientes</div></div>
    </div>

    <div class="slabel">Hist√≥rico Total</div>
    <div class="kpis">
      <div class="kpi green"><div class="kpi-lbl">Total ventas</div><div class="kpi-val">${sc}</div><div class="kpi-sub">${fmtM(s.all?.revenue||0)}</div></div>
      <div class="kpi green"><div class="kpi-lbl">Neto total</div><div class="kpi-val">${fmtM(s.all?.net||0)}</div><div class="kpi-sub">sin env√≠os</div></div>
      <div class="kpi blue"><div class="kpi-lbl">Total chats</div><div class="kpi-val">${ct}</div><div class="kpi-sub">desde inicio</div></div>
      <div class="kpi orange"><div class="kpi-lbl">Cotizaciones</div><div class="kpi-val">${m.quotes_sent||0}</div><div class="kpi-sub">enviadas por bot</div></div>
      <div class="kpi orange"><div class="kpi-lbl">Interesados</div><div class="kpi-val">${m.intent_yes||0}</div><div class="kpi-sub">confirmaron inter√©s</div></div>
      <div class="kpi green"><div class="kpi-lbl">SINPE conf.</div><div class="kpi-val">${m.sinpe_confirmed||0}</div><div class="kpi-sub">pagos recibidos</div></div>
      <div class="kpi blue"><div class="kpi-lbl">A domicilio</div><div class="kpi-val">${m.delivery_envio||0}</div><div class="kpi-sub">env√≠os</div></div>
      <div class="kpi purple"><div class="kpi-lbl">En tienda</div><div class="kpi-val">${m.delivery_recoger||0}</div><div class="kpi-sub">retiros</div></div>
      <div class="kpi red"><div class="kpi-lbl">Sin seguim.</div><div class="kpi-val">${nf}</div><div class="kpi-sub">esperan al due√±o</div></div>
      <div class="kpi"><div class="kpi-lbl">Contactos</div><div class="kpi-val">${d.contacts_total||0}</div><div class="kpi-sub">en base</div></div>
      <div class="kpi"><div class="kpi-lbl">Msgs bot</div><div class="kpi-val">${m.mensajes_enviados||0}</div><div class="kpi-sub">enviados</div></div>
      <div class="kpi"><div class="kpi-lbl">Llamadas IA</div><div class="kpi-val">${m.ia_calls||0}</div><div class="kpi-sub">a OpenAI</div></div>
    </div>

    <div class="slabel">Indicadores de Eficiencia</div>
    <div class="effs">
      <div class="eff-card">
        <div class="eff-top"><div class="eff-name">Tasa de Conversi√≥n</div><div class="eff-pct" style="color:${bColor(cvPct,10,20)}">${cvPct}%</div></div>
        ${bar(cvPct,bColor(cvPct,10,20))}
        <div class="eff-note">${sc} ventas de ${ct} chats ¬∑ objetivo &gt;20%</div>
      </div>
      <div class="eff-card">
        <div class="eff-top"><div class="eff-name">Cierre SINPE</div><div class="eff-pct" style="color:${bColor(snpPct,30,60)}">${snpPct}%</div></div>
        ${bar(snpPct,bColor(snpPct,30,60))}
        <div class="eff-note">${m.sinpe_confirmed||0} pagos de ${m.intent_yes||0} interesados</div>
      </div>
      <div class="eff-card">
        <div class="eff-top"><div class="eff-name">Retenci√≥n (no abandono)</div><div class="eff-pct" style="color:${bColor(retPct,60,80)}">${retPct}%</div></div>
        ${bar(retPct,bColor(retPct,60,80))}
        <div class="eff-note">${ab} abandonados de ${ct} chats ¬∑ objetivo &gt;80%</div>
      </div>
      <div class="eff-card">
        <div class="eff-top"><div class="eff-name">Respuesta del bot</div><div class="eff-pct" style="color:var(--blue)">${resPct}%</div></div>
        ${bar(resPct,'var(--blue)')}
        <div class="eff-note">${m.quotes_sent||0} cotizaciones de ${ct} chats totales</div>
      </div>
    </div>
  </div>`;
}

// ‚îÄ‚îÄ VENTAS ‚îÄ‚îÄ
async function loadVentas(){
  const from   = $('vFrom')?.value||'';
  const to     = $('vTo')?.value||'';
  const origen = $('vOrigen')?.value||'all';
  const method = $('vMethod')?.value||'all';
  const status = $('vStatus')?.value||'all';
  const search = ($('vSearch')?.value||'').toLowerCase();
  const el = $('ventasContent');
  if(el) el.innerHTML='<div class="loading"><div class="spin"></div><p>Cargando ventas...</p></div>';

  try {
    let url = `${BOT}/api/admin/sales?pwd=${PWD}`;
    if(from) url+=`&from=${from}`;
    if(to)   url+=`&to=${to}`;
    const r = await fetch(url);
    const d = await r.json();
    allSales = d.sales||[];

    let list = [...allSales];
    if(origen==='bot')    list=list.filter(s=>!s.manual);
    if(origen==='manual') list=list.filter(s=>!!s.manual);
    if(method!=='all')    list=list.filter(s=>s.method===method);
    if(status!=='all')    list=list.filter(s=>(s.status||'pendiente')===status);
    if(search) list=list.filter(s=>JSON.stringify(s).toLowerCase().includes(search));

    if(!el) return;
    if(list.length===0){ el.innerHTML='<div class="empty"><div class="empty-icon">üí∞</div>No hay ventas con esos filtros.</div>'; return; }

    const tRev  = list.reduce((s,v)=>s+(v.total||0),0);
    const tShip = list.reduce((s,v)=>s+(v.shipping||0),0);
    const tNet  = tRev-tShip;
    const nBot  = list.filter(s=>!s.manual).length;
    const nMan  = list.filter(s=>!!s.manual).length;
    const nEnv  = list.filter(s=>s.method==='envio').length;
    const nRec  = list.filter(s=>s.method==='recoger').length;

    const STEPS_ENVIO   = ['alistado','en_transito','entregado'];
    const STEPS_RECOGER = ['alistado','entregado'];
    const stCls = {alistado:'step-alist',en_transito:'step-trans',entregado:'step-ent'};
    const stLbl = {alistado:'Alistado',en_transito:'En tr√°nsito',entregado:'Entregado'};

    el.innerHTML = `<div class="fade-up">
      <div class="summary-strip">
        <div class="sum-item"><div class="sum-lbl">Total</div><div class="sum-val" style="color:var(--text)">${list.length} ventas</div></div>
        <div class="sum-item"><div class="sum-lbl">Ingresos</div><div class="sum-val" style="color:var(--green)">${fmtM(tRev)}</div></div>
        <div class="sum-item"><div class="sum-lbl">Neto</div><div class="sum-val" style="color:var(--green)">${fmtM(tNet)}</div></div>
        <div class="sum-item"><div class="sum-lbl">Env√≠os</div><div class="sum-val" style="color:var(--blue)">${fmtM(tShip)}</div></div>
        <div class="sum-item"><div class="sum-lbl">Bot</div><div class="sum-val" style="color:var(--text)">${nBot}</div></div>
        <div class="sum-item"><div class="sum-lbl">Manual</div><div class="sum-val" style="color:var(--purple)">${nMan}</div></div>
        <div class="sum-item"><div class="sum-lbl">A domicilio</div><div class="sum-val" style="color:var(--text)">${nEnv}</div></div>
        <div class="sum-item"><div class="sum-lbl">Retiros</div><div class="sum-val" style="color:var(--text)">${nRec}</div></div>
      </div>

      ${list.map((s,i)=>{
        const st    = s.status||'pendiente';
        const isEnv = s.method==='envio';
        const STEPS = isEnv ? STEPS_ENVIO : STEPS_RECOGER;
        const stIdx = STEPS.indexOf(st);
        const stepsHtml = STEPS.map((p,pi)=>`
          ${pi>0?'<span class="step-arrow">‚Ä∫</span>':''}
          <span class="step ${stCls[p]} ${pi<=stIdx?'done':''}">${stLbl[p]}</span>
        `).join('');

        return `<div class="venta-card">
          <div class="venta-head" onclick="toggleVenta(${i})">
            <div class="venta-left">
              <div class="venta-prod">
                ${esc(s.producto||'‚Äî')}
                ${s.talla_color?`<span style="font-weight:500;color:var(--muted);font-size:.84rem"> ¬∑ ${esc(s.talla_color)}</span>`:''}
                &nbsp;
                <span class="badge ${isEnv?'bb':'bg'}">${isEnv?'üì¶ Env√≠o':'üè™ Retiro'}</span>
                <span class="badge ${s.manual?'bp':'bg'}">${s.manual?'‚úçÔ∏è Manual':'ü§ñ Bot'}</span>
              </div>
              <div class="venta-meta">
                üë§ ${esc(s.name||'‚Äî')} ¬∑ üì± ${esc(s.phone||'‚Äî')} ¬∑ üìÖ ${fmtDt(s.date)}
                ${s.sinpe_reference?' ¬∑ üí≥ Ref: '+esc(s.sinpe_reference):''}
                ${s.guia_correos?`<br>üì¶ Gu√≠a Correos: <strong style="color:var(--blue)">${esc(s.guia_correos)}</strong>`:''}
                ${s.notas?'<br>üìù '+esc(s.notas):''}
              </div>
            </div>
            <div class="venta-right">
              <div class="venta-total">${fmtM(s.total)}</div>
              ${isEnv&&s.shipping?`<div style="font-size:.72rem;color:var(--muted)">+${fmtM(s.shipping)} env√≠o</div>`:''}
              <div class="venta-id">${esc(s.id)}</div>
            </div>
          </div>
          <div class="venta-body" id="vb-${i}">
            <div class="steps">${stepsHtml}</div>

            <div class="info-grid">
              <div class="info-block"><div class="info-lbl">Producto</div><div class="info-val">${esc(s.producto||'‚Äî')}</div></div>
              <div class="info-block"><div class="info-lbl">C√≥digo</div><div class="info-val">${esc(s.codigo||'‚Äî')}</div></div>
              <div class="info-block"><div class="info-lbl">Talla / Color</div><div class="info-val">${esc(s.talla_color||'‚Äî')}</div></div>
              <div class="info-block"><div class="info-lbl">Cliente</div><div class="info-val">${esc(s.name||'‚Äî')}</div></div>
              <div class="info-block"><div class="info-lbl">Tel√©fono</div><div class="info-val">${esc(s.phone||'‚Äî')}</div></div>
              <div class="info-block"><div class="info-lbl">Precio</div><div class="info-val">${fmtM(s.precio)}</div></div>
              <div class="info-block"><div class="info-lbl">Env√≠o</div><div class="info-val">${fmtM(s.shipping)}</div></div>
              <div class="info-block"><div class="info-lbl" style="color:var(--green)">Total</div><div class="info-val" style="color:var(--green)">${fmtM(s.total)}</div></div>
              <div class="info-block"><div class="info-lbl">M√©todo</div><div class="info-val">${isEnv?'üì¶ Env√≠o a domicilio':'üè™ Retiro en tienda'}</div></div>
              <div class="info-block"><div class="info-lbl">Origen</div><div class="info-val">${s.manual?'‚úçÔ∏è Manual':'ü§ñ Bot'}</div></div>
              ${s.sinpe_reference?`<div class="info-block"><div class="info-lbl">Ref SINPE</div><div class="info-val">${esc(s.sinpe_reference)}</div></div>`:''}
              ${isEnv?`
                <div class="info-block" style="${s.guia_correos?'border-color:#bfdbfe;':'border-color:#fde68a;'}">
                  <div class="info-lbl">Gu√≠a Correos CR</div>
                  <div class="info-val" style="color:${s.guia_correos?'var(--blue)':'var(--muted)'}">
                    ${esc(s.guia_correos||'Sin asignar')}
                  </div>
                </div>

                <div class="info-block"><div class="info-lbl">Zona</div><div class="info-val">${esc(s.zone||'‚Äî')}</div></div>
                <div class="info-block" style="grid-column:span 2"><div class="info-lbl">Direcci√≥n</div><div class="info-val">${esc(s.envio_datos||'‚Äî')}</div></div>
                ${s.fecha_alistado?`<div class="info-block"><div class="info-lbl">Fecha Alistado</div><div class="info-val">${esc(s.fecha_alistado)}</div></div>`:''}
                ${s.fecha_envio?`<div class="info-block"><div class="info-lbl">Fecha Env√≠o</div><div class="info-val">${esc(s.fecha_envio)}</div></div>`:''}
                ${s.fecha_entregado?`<div class="info-block"><div class="info-lbl">Fecha Entregado</div><div class="info-val">${esc(s.fecha_entregado)}</div></div>`:''}
              `:''}
              ${s.notas?`<div class="info-block" style="grid-column:span 2"><div class="info-lbl">Notas</div><div class="info-val">${esc(s.notas)}</div></div>`:''}
            </div>

            ${isEnv ? `
            <div class="edit-section">
              <div class="edit-section-title">‚úèÔ∏è Actualizar Env√≠o</div>
              <div class="edit-row">
                <div class="edit-group">
                  <label>Estado</label>
                  <select id="est-${i}" style="width:140px;">
                    ${STEPS_ENVIO.map(p=>`<option value="${p}"${st===p?' selected':''}>${stLbl[p]}</option>`).join('')}
                  </select>
                </div>
                <div class="edit-group">
                  <label>Gu√≠a Correos CR</label>
                  <input type="text" id="guia-${i}" value="${esc(s.guia_correos||'')}" placeholder="Ej: 12345678CR" style="width:155px;">
                </div>

                <div class="edit-group">
                  <label>Fecha Alistado</label>
                  <input type="date" id="falist-${i}" value="${s.fecha_alistado||''}">
                </div>
                <div class="edit-group">
                  <label>Fecha Env√≠o</label>
                  <input type="date" id="fenv-${i}" value="${s.fecha_envio||''}">
                </div>
                <div class="edit-group">
                  <label>Fecha Entregado</label>
                  <input type="date" id="fent-${i}" value="${s.fecha_entregado||''}">
                </div>
                <button class="btn-save" onclick="saveEnvio(${i},'${esc(s.id)}')">üíæ Guardar</button>
                <span class="save-ok" id="ok-${i}">‚úì Guardado</span>
              </div>
            </div>
            ` : `
            <div class="edit-section">
              <div class="edit-section-title">‚úèÔ∏è Estado del Pedido</div>
              <div class="edit-row">
                <div class="edit-group">
                  <label>Estado</label>
                  <select id="est-${i}" onchange="saveField(${i},'${esc(s.id)}','status',this.value)">
                    ${(isEnv?STEPS_ENVIO:STEPS_RECOGER).map(p=>`<option value="${p}"${st===p?' selected':''}>${stLbl[p]}</option>`).join('')}
                  </select>
                </div>
                <span class="save-ok" id="ok-${i}">‚úì Guardado</span>
              </div>
            </div>
            `}
          </div>
        </div>`;
      }).join('')}
    </div>`;
  } catch(e){
    if(el) el.innerHTML=`<div class="empty"><div class="empty-icon">‚ö°</div>Error: ${esc(e.message)}</div>`;
  }
}

function toggleVenta(i){ const b=$('vb-'+i); if(b) b.classList.toggle('open'); }

async function saveField(i,saleId,field,value){
  try {
    const r=await fetch(`${BOT}/api/admin/sales/update?pwd=${PWD}`,{
      method:'POST', headers:{'Content-Type':'application/json'},
      body:JSON.stringify({saleId,field,value})
    });
    const d=await r.json();
    if(d.success){
      const ok=$('ok-'+i);
      if(ok){ ok.classList.add('show'); setTimeout(()=>ok.classList.remove('show'),2200); }
      const sale=allSales.find(s=>s.id===saleId);
      if(sale&&d.sale) Object.assign(sale,d.sale);
    } else { alert('Error: '+(d.error||'desconocido')); }
  } catch(e){ alert('Error de conexi√≥n'); }
}

async function saveEnvio(i,saleId){
  // Estado primero si cambi√≥
  const estEl=$('est-'+i);
  if(estEl) await saveField(i,saleId,'status',estEl.value);
  const fields=[
    ['guia_correos',   $('guia-'+i)?.value||''],
    ['fecha_alistado', $('falist-'+i)?.value||''],
    ['fecha_envio',    $('fenv-'+i)?.value||''],
    ['fecha_entregado',$('fent-'+i)?.value||'']
  ];
  for(const [f,v] of fields){ if(v) await saveField(i,saleId,f,v); }
  const ok=$('ok-'+i); if(ok){ ok.classList.add('show'); setTimeout(()=>ok.classList.remove('show'),2200); }
}

// ‚îÄ‚îÄ CHATS ‚îÄ‚îÄ
async function loadChats(){
  const from   = $('cFrom')?.value||'';
  const to     = $('cTo')?.value||'';
  const search = ($('cSearch')?.value||'').toLowerCase();
  const el = $('chatsContent');
  if(el) el.innerHTML='<div class="loading"><div class="spin"></div><p>Cargando chats...</p></div>';
  try {
    let url=`${BOT}/api/admin/chats?pwd=${PWD}&limit=150`;
    if(from) url+=`&from=${from}`;
    if(to)   url+=`&to=${to}`;
    const r=await fetch(url);
    const d=await r.json();
    let convos=d.conversations||[];
    if(search) convos=convos.filter(c=>(c.name||'').toLowerCase().includes(search)||(c.phone||'').includes(search)||(c.waId||'').includes(search));
    if(!el) return;
    chatData = convos;
    if(convos.length===0){ el.innerHTML='<div class="empty"><div class="empty-icon">üí¨</div>No hay conversaciones.</div>'; return; }

    el.innerHTML=`<div class="fade-up">${convos.map((c,i)=>{
      const last=c.messages?.[c.messages.length-1];
      const prev=last?.text||'(multimedia)';
      return `<div class="chat-card">
        <div class="chat-head" onclick="openChatModal(${i})">
          <div style="flex:1;min-width:0">
            <div class="chat-name">${esc(c.name||'Sin nombre')}</div>
            <div class="chat-phone">${esc(c.phone||c.waId||'')}</div>
            <div class="chat-preview">${esc(prev.substring(0,120))}</div>
          </div>
          <div class="chat-meta">
            <div class="chat-time">${fmtDt(c.last)}</div>
            <div class="chat-count">${c.messages?.length||0} mensajes</div>
          </div>
        </div>
      </div>`;
    }).join('')}</div>`;
  } catch(e){
    if(el) el.innerHTML=`<div class="empty"><div class="empty-icon">‚ö°</div>Error: ${esc(e.message)}</div>`;
  }
}
let chatData = [];
function openChatModal(i) {
  const c = chatData[i];
  if (!c) return;
  const modal = $('chatModal');
  $('chatModalName').textContent  = c.name || 'Sin nombre';
  $('chatModalPhone').textContent = c.phone || c.waId || '';
  $('chatModalCount').textContent = (c.messages?.length||0) + ' mensajes ¬∑ ' + fmtDt(c.last);
  const msgs = (c.messages||[]).map(m => {
    const isBot = m.from==='bot'||m.role==='bot'||m.type==='bot';
    const txt   = linkify(esc(m.text||'')).replace(/\n/g,'<br>');
    const ts    = m.timestamp ? new Date(m.timestamp).toLocaleTimeString('es-CR',{hour:'2-digit',minute:'2-digit'}) : '';
    return `<div class="cm-row ${isBot?'bot':'user'}">
      <div class="cm-bub">${txt}</div>
      <div class="cm-ts">${ts}</div>
    </div>`;
  }).join('');
  $('chatModalMsgs').innerHTML = msgs || '<div style="text-align:center;color:#9ca3af;padding:40px">Sin mensajes</div>';
  modal.style.display = 'flex';
  setTimeout(() => { const el=$('chatModalMsgs'); el.scrollTop=el.scrollHeight; }, 50);
}
function closeChatModal() {
  $('chatModal').style.display = 'none';
}
function linkify(text) {
  return text.replace(/(https?:\/\/[^\s<]+)/g, '<a href="$1" target="_blank" style="color:#2563eb;text-decoration:underline;word-break:break-all">$1</a>');
}

// ‚îÄ‚îÄ ALERTAS ‚îÄ‚îÄ
async function loadAlerts(){
  const el = $('p-alertas');
  if(!el) return;
  try {
    const r = await fetch(`${BOT}/api/admin/alerts?pwd=${PWD}&limit=100`);
    const d = await r.json();
    const st = d.stats||{};
    const alerts = d.alerts||[];
    const ab = dashAlerts?.abandoned||[];
    const nf = dashAlerts?.no_followup||[];

    const tipoLabel = {
      PRODUCTO_FOTO:'üì∑ Consulta foto', PRODUCTO_CATALOGO:'üì¶ Consulta cat√°logo',
      SINPE:'üí∞ Pago SINPE', ZONA:'üìç Zona env√≠o', MULTI_PRODUCTO:'üìã Multi-producto',
      RAFAGA:'‚ö° R√°faga de msgs', FUERA_LOGICA:'‚ö†Ô∏è Fuera de l√≥gica'
    };

    const activeCard=(a,tipo)=>`<div class="alert-card pendiente">
      <div class="alert-icon">${tipo==='ab'?'‚è∞':'üì£'}</div>
      <div style="flex:1">
        <div class="alert-title">${tipo==='ab'?'Cliente abandon√≥':'Esperando tu respuesta'}</div>
        <div class="alert-detail">
          üë§ ${esc(a.name||a.phone||a.waId||'‚Äî')}<br>
          üì¶ ${esc(a.producto||'‚Äî')}${a.talla?' ¬∑ '+esc(a.talla):''}<br>
          üìç Estado: <strong>${esc(a.state||'‚Äî')}</strong> ¬∑ Hace ${a.age_minutes||0} min
          ${a.method?' ¬∑ '+(a.method==='envio'?'üì¶ Env√≠o':'üè™ Retiro'):''}
        </div>
      </div>
      <div class="alert-time">${fmtDt(a.last_activity)}</div>
    </div>`;

    const logCard=(a)=>{
      const isOk = a.estado==='atendida';
      return `<div class="alert-card ${isOk?'atendida':'pendiente'}">
        <div class="alert-icon">${isOk?'‚úÖ':'üîî'}</div>
        <div style="flex:1">
          <div class="alert-title">
            ${esc(tipoLabel[a.tipo]||a.tipo)}
            <span class="badge ${isOk?'bg':'by'}">${isOk?'‚úì Atendida':'‚è≥ Pendiente'}</span>
          </div>
          <div class="alert-detail">
            üë§ ${esc(a.phone||'‚Äî')} ${a.producto?'¬∑ üì¶ '+esc(a.producto):''}<br>
            üìÖ Enviada: ${fmtDt(a.fecha)}
            ${isOk?`<br>‚úÖ Atendida: ${fmtDt(a.fecha_atendida)} ¬∑ <strong style="color:var(--green)">${a.minutos_respuesta} min de respuesta</strong>`:''}
          </div>
        </div>
      </div>`;
    };

    const byTipo = st.by_tipo||{};
    const tipoRows = Object.entries(byTipo).map(([t,v])=>{
      const p = v.total>0?pct(v.atendidas,v.total):0;
      return `<div class="tipo-row">
        <span class="tipo-name">${tipoLabel[t]||t}</span>
        <div class="tipo-stats">
          <span style="font-size:.78rem;color:var(--muted)">${v.total} enviadas</span>
          <span style="font-size:.78rem;color:var(--green)">${v.atendidas} atendidas</span>
          <span class="tipo-pct" style="color:${bColor(p,40,70)}">${p}%</span>
        </div>
      </div>`;
    }).join('');

    el.innerHTML=`<div class="fade-up">

      <div class="slabel">Resumen de Alertas Pushover</div>
      <div style="display:flex;justify-content:flex-end;margin-bottom:12px;">
        <button onclick="showPurgeModal('alertas')" style="padding:7px 14px;background:#fff0f0;color:var(--red);border:1px solid #fecaca;border-radius:8px;font-size:0.82rem;font-weight:600;cursor:pointer;font-family:'DM Sans',sans-serif;">üóëÔ∏è Limpiar alertas</button>
      </div>
      <div class="kpis" style="margin-bottom:20px;">
        <div class="kpi blue"><div class="kpi-lbl">Total enviadas</div><div class="kpi-val">${st.total||0}</div><div class="kpi-sub">hist√≥ricas</div></div>
        <div class="kpi green"><div class="kpi-lbl">Atendidas</div><div class="kpi-val">${st.atendidas||0}</div><div class="kpi-sub">${st.pct_atendidas||0}% del total</div></div>
        <div class="kpi orange"><div class="kpi-lbl">Pendientes</div><div class="kpi-val">${st.pendientes||0}</div><div class="kpi-sub">sin acknowledge</div></div>
        <div class="kpi ${(st.tiempo_promedio_min||99)<5?'green':(st.tiempo_promedio_min||99)<15?'orange':'red'}">
          <div class="kpi-lbl">Tiempo prom.</div>
          <div class="kpi-val">${st.tiempo_promedio_min!=null?st.tiempo_promedio_min+'m':'‚Äî'}</div>
          <div class="kpi-sub">de respuesta</div>
        </div>
        <div class="kpi blue"><div class="kpi-lbl">Hoy</div><div class="kpi-val">${st.today?.total||0}</div><div class="kpi-sub">${st.today?.atendidas||0} atendidas</div></div>
        <div class="kpi blue"><div class="kpi-lbl">Esta semana</div><div class="kpi-val">${st.week?.total||0}</div><div class="kpi-sub">${st.week?.atendidas||0} atendidas</div></div>
      </div>

      ${Object.keys(byTipo).length>0?`
        <div class="slabel">Por Tipo de Alerta</div>
        <div class="tipo-table">${tipoRows}</div>
      `:''}

      <div class="slabel">‚ö†Ô∏è Alertas Activas Ahora</div>
      ${(nf.length+ab.length)>0
        ? nf.map(a=>activeCard(a,'nf')).join('')+ab.map(a=>activeCard(a,'ab')).join('')
        : '<p style="font-size:.82rem;color:var(--muted);padding:8px 0 16px">‚úÖ Sin alertas activas en este momento.</p>'
      }

      ${alerts.length>0?`
        <div class="divider"></div>
        <div class="slabel">Historial de Alertas</div>
        ${alerts.map(a=>logCard(a)).join('')}
      `:''}
    </div>`;
  } catch(e){
    if(el) el.innerHTML=`<div class="empty"><div class="empty-icon">‚ö°</div>Error cargando alertas: ${esc(e.message)}</div>`;
  }
}

var purgeTarget = null;
function showPurgeModal(target) {
  purgeTarget = target;
  const labels = { ventas:'ventas', chats:'conversaciones', alertas:'alertas' };
  document.getElementById('purgeDesc').textContent = 'Se eliminar√°n todas las ' + (labels[target]||target) + ' anteriores a la fecha seleccionada (incluyendo ese d√≠a).';
  const d = new Date(); d.setDate(0);
  document.getElementById('purgeDate').value = d.toISOString().slice(0,10);
  document.getElementById('purgeModal').style.display = 'flex';
}
function closePurgeModal() {
  document.getElementById('purgeModal').style.display = 'none';
  purgeTarget = null;
}
async function executePurge() {
  const date = document.getElementById('purgeDate').value;
  if (!date) { alert('Seleccion√° una fecha'); return; }
  const cutoff = new Date(date); cutoff.setDate(cutoff.getDate()+1);
  const body = {
    beforeDate:    cutoff.toISOString(),
    purgeSales:    purgeTarget === 'ventas',
    purgeHistory:  purgeTarget === 'chats',
    purgeAlerts:   purgeTarget === 'alertas',
    purgeSessions: purgeTarget === 'chats'
  };
  try {
    const r = await fetch(BOT + '/api/admin/purge?pwd=' + PWD, {
      method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(body)
    });
    const d = await r.json();
    if (d.success) {
      const n = (d.salesDeleted||0) + (d.historyDeleted||0) + (d.alertsDeleted||0);
      closePurgeModal();
      alert('‚úÖ Limpieza completada ‚Äî ' + n + ' registros eliminados');
      loadAll();
    } else { alert('Error: ' + (d.error||'desconocido')); }
  } catch(e) { alert('Error de conexi√≥n: ' + e.message); }
}
const today = new Date().toISOString().slice(0,10);
const month  = new Date(Date.now()-30*24*60*60*1000).toISOString().slice(0,10);
$('vFrom').value=month; $('vTo').value=today;
$('cFrom').value=month; $('cTo').value=today;
loadAll();

</script>
</body>
</html>
